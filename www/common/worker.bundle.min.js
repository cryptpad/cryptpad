!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self)["cryptpad-worker-min"]={})}(this,function(e){"use strict";function n(e,n){return n.forEach(function(n){n&&"string"!=typeof n&&!Array.isArray(n)&&Object.keys(n).forEach(function(t){if("default"!==t&&!(t in e)){var r=Object.getOwnPropertyDescriptor(n,t);Object.defineProperty(e,t,r.get?r:{enumerable:!0,get:function(){return n[t]}})}})}),Object.freeze(e)}var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function o(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var n=e.default;if("function"==typeof n){var t=function e(){var t=!1;try{t=this instanceof e}catch{}return t?Reflect.construct(n,arguments,this.constructor):n.apply(this,arguments)};t.prototype=n.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(e).forEach(function(n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}),t}var a,i={exports:{}},s={exports:{}},c={exports:{}};function u(){return a||(a=1,function(e){var n;n=function(){var e=function(){},n=function(){return(new Date).getTime()},t=function(e,n,t){e.timeouts.push(setTimeout(n,t))},r=function(n,r){n.ws&&(n.ws.onmessage=e,n.ws.onopen=e,n.ws.close(),r?n.ws.onclose({reason:"offline"}):t(n,function(){n.ws&&n.ws.onclose({reason:"forced closed because websocket failed to close"})},1e4))},o=function(e,n){return!!e.ws&&(e.ws.send(JSON.stringify(n)),!0)},a=function(e,n){return function(e,t){var r=n[e];if(!r)throw new Error("no such event "+e);r.push(t)}},i=function(e,n,t,r){var o=r[n];if(!o)throw new Error("no such event "+n);var a=o.indexOf(t);-1!==a&&o.splice(a,1)},s=function(e,t,r){if(e.channels[t])return new Promise(function(n){n(e.channels[t])});var s=e.queues.p2;1===r?s=e.queues.p1:3===r&&(s=e.queues.p3);var c={queue:s,onMessage:[],onJoin:[],onLeave:[],members:[],jSeq:e.seq++},u={message:c.onMessage,join:c.onJoin,leave:c.onLeave},f={_:c,time:n(),id:t,members:c.members,bcast:function(t){return function(e,t,r){var a=e.channels[t],i=e.seq++,s=[i,"MSG",t,r];if(!a)return new Promise(function(e,n){n({type:"NO_SUCH_CHANNEL",message:JSON.stringify(s)})});var c=o(e,s);return new Promise(function(t,r){c?e.requests[i]={reject:r,resolve:t,time:n()}:r({type:"DISCONNECTED",message:JSON.stringify(s)})})}(e,f.id,t)},leave:function(t){return function(e,t,r){if(e.channels[t]){if(delete e.channels[t],e.ws&&1===e.ws.readyState){var a=e.seq++;o(e,[a,"LEAVE",t,r]);var i=function(){};e.requests[a]={reject:i,resolve:i,time:n()}}}else console.debug("no such channel",t)}(e,f.id,t)},on:a(0,u),off:function(e,n){i(0,e,n,u)}};e.requests[c.jSeq]=f;var l=[c.jSeq,"JOIN",t],d=o(e,l);return new Promise(function(e,n){d?(f._.resolve=e,f._.reject=n):n({type:"DISCONNECTED",message:JSON.stringify(l)})})},c=function(t){var r={message:t.onMessage,disconnect:t.onDisconnect,reconnect:t.onReconnect},c={webChannels:t.channels,getLag:function(){return function(e){return e.ws?e.pingOutstanding?Math.max(n()-e.timeOfLastPingSent,e.lastObservedLag):e.lastObservedLag:null}(t)},sendto:function(e,r){return function(e,t,r){var a=e.seq++,i=[a,"MSG",t,r],s=o(e,i);return new Promise(function(t,r){s?e.requests[a]={reject:r,resolve:t,time:n()}:r({type:"DISCONNECTED",message:JSON.stringify(i)})})}(t,e,r)},join:function(e,n){return s(t,e,n)},disconnect:function(){return function(n){if(n.ws){var t=n.ws.onclose;n.ws.onclose=e,n.ws.close(),t({reason:"network.disconnect() called"})}n.timeouts.forEach(clearTimeout),n.timeouts=[]}(t)},on:a(0,r),off:function(e,n){i(0,e,n,r)}};return c.__defineGetter__("webChannels",function(){return Object.keys(t.channels).map(function(e){return t.channels[e]})}),c},u=function(e,t){var a=void 0;try{a=JSON.parse(t.data)}catch(e){return void console.log(e.stack)}if(e.timeOfLastMsgReceived=n(),0===a[0]){if("IDENT"===a[2])return e.uid=a[3],e.ws._onident(),void(e.pingInterval=setInterval(function(){if(!(n()-e.timeOfLastPingReceived<15e3||(n()-e.timeOfLastMsgReceived>6e4&&r(e),e.pingOutstanding))){var t=e.seq++,a=n();e.timeOfLastPingSent=a,e.pingOutstanding++,e.requests[t]={time:a,ping:a},o(e,[t,"PING"])}},5e3));if(e.uid){if("PING"===a[2])return a[2]="PONG",void o(e,a);if("MSG"===a[2]){var i=void 0,s=e.queues.p2;if(a[3]===e.uid)i=e.onMessage,"number"==typeof a[5]&&(1===a[5]&&(s=e.queues.p1),3===a[5]&&(s=e.queues.p3));else{var c=e.channels[a[3]];if(!c)return void console.log("message to non-existent chan "+JSON.stringify(a));i=c._.onMessage,c._.queue&&(s=c._.queue)}s.push({msg:a,h:i}),function(e){if(!e.queues.busy){var n=function(){var t=e.queues.p1.shift()||e.queues.p2.shift()||e.queues.p3.shift();if(t){e.queues.busy=!0;var r=t.h,o=t.msg;r.forEach(function(e){setTimeout(function(){try{e(o[4],o[1])}catch(e){console.error(e)}})}),setTimeout(function(){n()})}else e.queues.busy=!1};n()}}(e)}if("LEAVE"===a[2]){var u=e.channels[a[3]];if(!u)return void(a[1]!==e.uid&&console.log("leaving non-existent chan "+JSON.stringify(a)));var f=u._.members.indexOf(a[1]);-1!==f&&u._.members.splice(f,1),u._.onLeave.forEach(function(e){try{e(a[1],a[4])}catch(e){console.log(e.stack)}})}if("JOIN"===a[2]){var l=e.channels[a[3]];if(!l)return void console.log("ERROR: join to non-existent chan "+JSON.stringify(a));if(-1!==l._.members.indexOf(a[1]))return;var d=-1!==l._.members.indexOf(e.uid);l._.members.push(a[1]),d||a[1]!==e.uid||(l.myID=e.uid,l._.resolve(l)),d&&l._.onJoin.forEach(function(e){try{e(a[1])}catch(e){console.log(e.stack)}})}}}else{var h=e.requests[a[0]];if(!h)return void console.log("error: "+JSON.stringify(a));if(delete e.requests[a[0]],"ACK"===a[1]){if(h.ping)return e.lastObservedLag=n()-Number(h.ping),e.timeOfLastPingReceived=n(),void e.pingOutstanding--;h.resolve()}else if("JACK"===a[1]){if(h._){if(!a[2])throw new Error("wrong type of ACK for channel join");return h.id=a[2],void(e.channels[h.id]=h)}h.resolve()}else if("ERROR"===a[1])if("function"==typeof h.reject)h.reject({type:a[2],message:a[3]});else if(h._&&"function"==typeof h._.reject){if("EJOINED"===a[2]&&!e.channels[a[3]])return h.id=a[3],void(e.channels[h.id]=h);h._.reject({type:a[2],message:a[3]})}else console.error(a);else h.reject({type:"UNKNOWN",message:JSON.stringify(a)})}};return{connect:function(o,a){a=a||function(e){return new globalThis.WebSocket(e)};var i={ws:null,seq:1,uid:null,network:null,channels:{},onMessage:[],onDisconnect:[],onReconnect:[],timeouts:[],requests:{},pingInterval:null,queues:{p1:[],p2:[],p3:[]},timeOfLastPingSent:-1,timeOfLastPingReceived:-1,timeOfLastMsgReceived:-1,lastObservedLag:0,pingOutstanding:0};i.network=c(i);var s=e,f=e;"undefined"!=typeof window&&window.addEventListener("offline",function(){-1===["localhost","127.0.0.1",""].indexOf(window.location.hostname)&&r(i,!0)});var l=function(){var c=i.ws=a(o);i.timeOfLastPingSent=i.timeOfLastPingReceived=n(),i.timeOfLastMsgReceived=n(),c.onmessage=function(e){return u(i,e)},c.onclose=function(n){c.onclose=e,clearInterval(i.pingInterval),i.timeouts.forEach(clearTimeout),i.ws=null,i.uid&&(i.uid=null,i.onDisconnect.forEach(function(e){try{e(n.reason)}catch(e){console.log(e.stack)}})),t(i,l,i.uid?0:7e3)},c.onopen=function(){t(i,function(){i.uid||(f({type:"TIMEOUT",message:"waited 30000ms"}),s=f=e,r(i))},3e4)},i.ws._onident=function(){i.timeOfLastPingReceived=n(),i.timeOfLastMsgReceived=n(),i.lastObservedLag=n()-i.timeOfLastPingSent,s!==e?(s(i.network),s=f=e):(i.channels={},i.requests={},i.pingOutstanding=0,i.onReconnect.forEach(function(e){try{e(i.uid)}catch(e){console.log(e.stack)}}))}};return new Promise(function(e,n){s=e,f=n,l()})}}},e.exports?e.exports=n():window.netflux_websocket=n()}(c)),c.exports}function f(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var l,d={exports:{}};function h(){return l||(l=1,function(e){!function(e){var n=function(e){var n,t=new Float64Array(16);if(e)for(n=0;n<e.length;n++)t[n]=e[n];return t},t=function(){throw new Error("no PRNG")},r=new Uint8Array(16),o=new Uint8Array(32);o[0]=9;var a=n(),i=n([1]),s=n([56129,1]),c=n([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),u=n([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),l=n([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),d=n([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),h=n([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function p(e,n,t,r){e[n]=t>>24&255,e[n+1]=t>>16&255,e[n+2]=t>>8&255,e[n+3]=255&t,e[n+4]=r>>24&255,e[n+5]=r>>16&255,e[n+6]=r>>8&255,e[n+7]=255&r}function v(e,n,t,r,o){var a,i=0;for(a=0;a<o;a++)i|=e[n+a]^t[r+a];return(1&i-1>>>8)-1}function y(e,n,t,r){return v(e,n,t,r,16)}function m(e,n,t,r){return v(e,n,t,r,32)}function g(e,n,t,r){!function(e,n,t,r){for(var o,a=255&r[0]|(255&r[1])<<8|(255&r[2])<<16|(255&r[3])<<24,i=255&t[0]|(255&t[1])<<8|(255&t[2])<<16|(255&t[3])<<24,s=255&t[4]|(255&t[5])<<8|(255&t[6])<<16|(255&t[7])<<24,c=255&t[8]|(255&t[9])<<8|(255&t[10])<<16|(255&t[11])<<24,u=255&t[12]|(255&t[13])<<8|(255&t[14])<<16|(255&t[15])<<24,f=255&r[4]|(255&r[5])<<8|(255&r[6])<<16|(255&r[7])<<24,l=255&n[0]|(255&n[1])<<8|(255&n[2])<<16|(255&n[3])<<24,d=255&n[4]|(255&n[5])<<8|(255&n[6])<<16|(255&n[7])<<24,h=255&n[8]|(255&n[9])<<8|(255&n[10])<<16|(255&n[11])<<24,p=255&n[12]|(255&n[13])<<8|(255&n[14])<<16|(255&n[15])<<24,v=255&r[8]|(255&r[9])<<8|(255&r[10])<<16|(255&r[11])<<24,y=255&t[16]|(255&t[17])<<8|(255&t[18])<<16|(255&t[19])<<24,m=255&t[20]|(255&t[21])<<8|(255&t[22])<<16|(255&t[23])<<24,g=255&t[24]|(255&t[25])<<8|(255&t[26])<<16|(255&t[27])<<24,E=255&t[28]|(255&t[29])<<8|(255&t[30])<<16|(255&t[31])<<24,b=255&r[12]|(255&r[13])<<8|(255&r[14])<<16|(255&r[15])<<24,O=a,A=i,w=s,D=c,_=u,T=f,S=l,N=d,I=h,x=p,C=v,R=y,P=m,k=g,M=E,F=b,L=0;L<20;L+=2)O^=(o=(P^=(o=(I^=(o=(_^=(o=O+P|0)<<7|o>>>25)+O|0)<<9|o>>>23)+_|0)<<13|o>>>19)+I|0)<<18|o>>>14,T^=(o=(A^=(o=(k^=(o=(x^=(o=T+A|0)<<7|o>>>25)+T|0)<<9|o>>>23)+x|0)<<13|o>>>19)+k|0)<<18|o>>>14,C^=(o=(S^=(o=(w^=(o=(M^=(o=C+S|0)<<7|o>>>25)+C|0)<<9|o>>>23)+M|0)<<13|o>>>19)+w|0)<<18|o>>>14,F^=(o=(R^=(o=(N^=(o=(D^=(o=F+R|0)<<7|o>>>25)+F|0)<<9|o>>>23)+D|0)<<13|o>>>19)+N|0)<<18|o>>>14,O^=(o=(D^=(o=(w^=(o=(A^=(o=O+D|0)<<7|o>>>25)+O|0)<<9|o>>>23)+A|0)<<13|o>>>19)+w|0)<<18|o>>>14,T^=(o=(_^=(o=(N^=(o=(S^=(o=T+_|0)<<7|o>>>25)+T|0)<<9|o>>>23)+S|0)<<13|o>>>19)+N|0)<<18|o>>>14,C^=(o=(x^=(o=(I^=(o=(R^=(o=C+x|0)<<7|o>>>25)+C|0)<<9|o>>>23)+R|0)<<13|o>>>19)+I|0)<<18|o>>>14,F^=(o=(M^=(o=(k^=(o=(P^=(o=F+M|0)<<7|o>>>25)+F|0)<<9|o>>>23)+P|0)<<13|o>>>19)+k|0)<<18|o>>>14;O=O+a|0,A=A+i|0,w=w+s|0,D=D+c|0,_=_+u|0,T=T+f|0,S=S+l|0,N=N+d|0,I=I+h|0,x=x+p|0,C=C+v|0,R=R+y|0,P=P+m|0,k=k+g|0,M=M+E|0,F=F+b|0,e[0]=O>>>0&255,e[1]=O>>>8&255,e[2]=O>>>16&255,e[3]=O>>>24&255,e[4]=A>>>0&255,e[5]=A>>>8&255,e[6]=A>>>16&255,e[7]=A>>>24&255,e[8]=w>>>0&255,e[9]=w>>>8&255,e[10]=w>>>16&255,e[11]=w>>>24&255,e[12]=D>>>0&255,e[13]=D>>>8&255,e[14]=D>>>16&255,e[15]=D>>>24&255,e[16]=_>>>0&255,e[17]=_>>>8&255,e[18]=_>>>16&255,e[19]=_>>>24&255,e[20]=T>>>0&255,e[21]=T>>>8&255,e[22]=T>>>16&255,e[23]=T>>>24&255,e[24]=S>>>0&255,e[25]=S>>>8&255,e[26]=S>>>16&255,e[27]=S>>>24&255,e[28]=N>>>0&255,e[29]=N>>>8&255,e[30]=N>>>16&255,e[31]=N>>>24&255,e[32]=I>>>0&255,e[33]=I>>>8&255,e[34]=I>>>16&255,e[35]=I>>>24&255,e[36]=x>>>0&255,e[37]=x>>>8&255,e[38]=x>>>16&255,e[39]=x>>>24&255,e[40]=C>>>0&255,e[41]=C>>>8&255,e[42]=C>>>16&255,e[43]=C>>>24&255,e[44]=R>>>0&255,e[45]=R>>>8&255,e[46]=R>>>16&255,e[47]=R>>>24&255,e[48]=P>>>0&255,e[49]=P>>>8&255,e[50]=P>>>16&255,e[51]=P>>>24&255,e[52]=k>>>0&255,e[53]=k>>>8&255,e[54]=k>>>16&255,e[55]=k>>>24&255,e[56]=M>>>0&255,e[57]=M>>>8&255,e[58]=M>>>16&255,e[59]=M>>>24&255,e[60]=F>>>0&255,e[61]=F>>>8&255,e[62]=F>>>16&255,e[63]=F>>>24&255}(e,n,t,r)}function E(e,n,t,r){!function(e,n,t,r){for(var o,a=255&r[0]|(255&r[1])<<8|(255&r[2])<<16|(255&r[3])<<24,i=255&t[0]|(255&t[1])<<8|(255&t[2])<<16|(255&t[3])<<24,s=255&t[4]|(255&t[5])<<8|(255&t[6])<<16|(255&t[7])<<24,c=255&t[8]|(255&t[9])<<8|(255&t[10])<<16|(255&t[11])<<24,u=255&t[12]|(255&t[13])<<8|(255&t[14])<<16|(255&t[15])<<24,f=255&r[4]|(255&r[5])<<8|(255&r[6])<<16|(255&r[7])<<24,l=255&n[0]|(255&n[1])<<8|(255&n[2])<<16|(255&n[3])<<24,d=255&n[4]|(255&n[5])<<8|(255&n[6])<<16|(255&n[7])<<24,h=255&n[8]|(255&n[9])<<8|(255&n[10])<<16|(255&n[11])<<24,p=255&n[12]|(255&n[13])<<8|(255&n[14])<<16|(255&n[15])<<24,v=255&r[8]|(255&r[9])<<8|(255&r[10])<<16|(255&r[11])<<24,y=255&t[16]|(255&t[17])<<8|(255&t[18])<<16|(255&t[19])<<24,m=255&t[20]|(255&t[21])<<8|(255&t[22])<<16|(255&t[23])<<24,g=255&t[24]|(255&t[25])<<8|(255&t[26])<<16|(255&t[27])<<24,E=255&t[28]|(255&t[29])<<8|(255&t[30])<<16|(255&t[31])<<24,b=255&r[12]|(255&r[13])<<8|(255&r[14])<<16|(255&r[15])<<24,O=0;O<20;O+=2)a^=(o=(m^=(o=(h^=(o=(u^=(o=a+m|0)<<7|o>>>25)+a|0)<<9|o>>>23)+u|0)<<13|o>>>19)+h|0)<<18|o>>>14,f^=(o=(i^=(o=(g^=(o=(p^=(o=f+i|0)<<7|o>>>25)+f|0)<<9|o>>>23)+p|0)<<13|o>>>19)+g|0)<<18|o>>>14,v^=(o=(l^=(o=(s^=(o=(E^=(o=v+l|0)<<7|o>>>25)+v|0)<<9|o>>>23)+E|0)<<13|o>>>19)+s|0)<<18|o>>>14,b^=(o=(y^=(o=(d^=(o=(c^=(o=b+y|0)<<7|o>>>25)+b|0)<<9|o>>>23)+c|0)<<13|o>>>19)+d|0)<<18|o>>>14,a^=(o=(c^=(o=(s^=(o=(i^=(o=a+c|0)<<7|o>>>25)+a|0)<<9|o>>>23)+i|0)<<13|o>>>19)+s|0)<<18|o>>>14,f^=(o=(u^=(o=(d^=(o=(l^=(o=f+u|0)<<7|o>>>25)+f|0)<<9|o>>>23)+l|0)<<13|o>>>19)+d|0)<<18|o>>>14,v^=(o=(p^=(o=(h^=(o=(y^=(o=v+p|0)<<7|o>>>25)+v|0)<<9|o>>>23)+y|0)<<13|o>>>19)+h|0)<<18|o>>>14,b^=(o=(E^=(o=(g^=(o=(m^=(o=b+E|0)<<7|o>>>25)+b|0)<<9|o>>>23)+m|0)<<13|o>>>19)+g|0)<<18|o>>>14;e[0]=a>>>0&255,e[1]=a>>>8&255,e[2]=a>>>16&255,e[3]=a>>>24&255,e[4]=f>>>0&255,e[5]=f>>>8&255,e[6]=f>>>16&255,e[7]=f>>>24&255,e[8]=v>>>0&255,e[9]=v>>>8&255,e[10]=v>>>16&255,e[11]=v>>>24&255,e[12]=b>>>0&255,e[13]=b>>>8&255,e[14]=b>>>16&255,e[15]=b>>>24&255,e[16]=l>>>0&255,e[17]=l>>>8&255,e[18]=l>>>16&255,e[19]=l>>>24&255,e[20]=d>>>0&255,e[21]=d>>>8&255,e[22]=d>>>16&255,e[23]=d>>>24&255,e[24]=h>>>0&255,e[25]=h>>>8&255,e[26]=h>>>16&255,e[27]=h>>>24&255,e[28]=p>>>0&255,e[29]=p>>>8&255,e[30]=p>>>16&255,e[31]=p>>>24&255}(e,n,t,r)}var b=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function O(e,n,t,r,o,a,i){var s,c,u=new Uint8Array(16),f=new Uint8Array(64);for(c=0;c<16;c++)u[c]=0;for(c=0;c<8;c++)u[c]=a[c];for(;o>=64;){for(g(f,u,i,b),c=0;c<64;c++)e[n+c]=t[r+c]^f[c];for(s=1,c=8;c<16;c++)s=s+(255&u[c])|0,u[c]=255&s,s>>>=8;o-=64,n+=64,r+=64}if(o>0)for(g(f,u,i,b),c=0;c<o;c++)e[n+c]=t[r+c]^f[c];return 0}function A(e,n,t,r,o){var a,i,s=new Uint8Array(16),c=new Uint8Array(64);for(i=0;i<16;i++)s[i]=0;for(i=0;i<8;i++)s[i]=r[i];for(;t>=64;){for(g(c,s,o,b),i=0;i<64;i++)e[n+i]=c[i];for(a=1,i=8;i<16;i++)a=a+(255&s[i])|0,s[i]=255&a,a>>>=8;t-=64,n+=64}if(t>0)for(g(c,s,o,b),i=0;i<t;i++)e[n+i]=c[i];return 0}function w(e,n,t,r,o){var a=new Uint8Array(32);E(a,r,o,b);for(var i=new Uint8Array(8),s=0;s<8;s++)i[s]=r[s+16];return A(e,n,t,i,a)}function D(e,n,t,r,o,a,i){var s=new Uint8Array(32);E(s,a,i,b);for(var c=new Uint8Array(8),u=0;u<8;u++)c[u]=a[u+16];return O(e,n,t,r,o,c,s)}var _=function(e){var n,t,r,o,a,i,s,c;this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.leftover=0,this.fin=0,n=255&e[0]|(255&e[1])<<8,this.r[0]=8191&n,t=255&e[2]|(255&e[3])<<8,this.r[1]=8191&(n>>>13|t<<3),r=255&e[4]|(255&e[5])<<8,this.r[2]=7939&(t>>>10|r<<6),o=255&e[6]|(255&e[7])<<8,this.r[3]=8191&(r>>>7|o<<9),a=255&e[8]|(255&e[9])<<8,this.r[4]=255&(o>>>4|a<<12),this.r[5]=a>>>1&8190,i=255&e[10]|(255&e[11])<<8,this.r[6]=8191&(a>>>14|i<<2),s=255&e[12]|(255&e[13])<<8,this.r[7]=8065&(i>>>11|s<<5),c=255&e[14]|(255&e[15])<<8,this.r[8]=8191&(s>>>8|c<<8),this.r[9]=c>>>5&127,this.pad[0]=255&e[16]|(255&e[17])<<8,this.pad[1]=255&e[18]|(255&e[19])<<8,this.pad[2]=255&e[20]|(255&e[21])<<8,this.pad[3]=255&e[22]|(255&e[23])<<8,this.pad[4]=255&e[24]|(255&e[25])<<8,this.pad[5]=255&e[26]|(255&e[27])<<8,this.pad[6]=255&e[28]|(255&e[29])<<8,this.pad[7]=255&e[30]|(255&e[31])<<8};function T(e,n,t,r,o,a){var i=new _(a);return i.update(t,r,o),i.finish(e,n),0}function S(e,n,t,r,o,a){var i=new Uint8Array(16);return T(i,0,t,r,o,a),y(e,n,i,0)}function N(e,n,t,r,o){var a;if(t<32)return-1;for(D(e,0,n,0,t,r,o),T(e,16,e,32,t-32,e),a=0;a<16;a++)e[a]=0;return 0}function I(e,n,t,r,o){var a,i=new Uint8Array(32);if(t<32)return-1;if(w(i,0,32,r,o),0!==S(n,16,n,32,t-32,i))return-1;for(D(e,0,n,0,t,r,o),a=0;a<32;a++)e[a]=0;return 0}function x(e,n){var t;for(t=0;t<16;t++)e[t]=0|n[t]}function C(e){var n,t,r=1;for(n=0;n<16;n++)t=e[n]+r+65535,r=Math.floor(t/65536),e[n]=t-65536*r;e[0]+=r-1+37*(r-1)}function R(e,n,t){for(var r,o=~(t-1),a=0;a<16;a++)r=o&(e[a]^n[a]),e[a]^=r,n[a]^=r}function P(e,t){var r,o,a,i=n(),s=n();for(r=0;r<16;r++)s[r]=t[r];for(C(s),C(s),C(s),o=0;o<2;o++){for(i[0]=s[0]-65517,r=1;r<15;r++)i[r]=s[r]-65535-(i[r-1]>>16&1),i[r-1]&=65535;i[15]=s[15]-32767-(i[14]>>16&1),a=i[15]>>16&1,i[14]&=65535,R(s,i,1-a)}for(r=0;r<16;r++)e[2*r]=255&s[r],e[2*r+1]=s[r]>>8}function k(e,n){var t=new Uint8Array(32),r=new Uint8Array(32);return P(t,e),P(r,n),m(t,0,r,0)}function M(e){var n=new Uint8Array(32);return P(n,e),1&n[0]}function F(e,n){var t;for(t=0;t<16;t++)e[t]=n[2*t]+(n[2*t+1]<<8);e[15]&=32767}function L(e,n,t){for(var r=0;r<16;r++)e[r]=n[r]+t[r]}function H(e,n,t){for(var r=0;r<16;r++)e[r]=n[r]-t[r]}function j(e,n,t){var r,o,a=0,i=0,s=0,c=0,u=0,f=0,l=0,d=0,h=0,p=0,v=0,y=0,m=0,g=0,E=0,b=0,O=0,A=0,w=0,D=0,_=0,T=0,S=0,N=0,I=0,x=0,C=0,R=0,P=0,k=0,M=0,F=t[0],L=t[1],H=t[2],j=t[3],K=t[4],U=t[5],B=t[6],V=t[7],Y=t[8],G=t[9],J=t[10],q=t[11],W=t[12],z=t[13],Q=t[14],Z=t[15];a+=(r=n[0])*F,i+=r*L,s+=r*H,c+=r*j,u+=r*K,f+=r*U,l+=r*B,d+=r*V,h+=r*Y,p+=r*G,v+=r*J,y+=r*q,m+=r*W,g+=r*z,E+=r*Q,b+=r*Z,i+=(r=n[1])*F,s+=r*L,c+=r*H,u+=r*j,f+=r*K,l+=r*U,d+=r*B,h+=r*V,p+=r*Y,v+=r*G,y+=r*J,m+=r*q,g+=r*W,E+=r*z,b+=r*Q,O+=r*Z,s+=(r=n[2])*F,c+=r*L,u+=r*H,f+=r*j,l+=r*K,d+=r*U,h+=r*B,p+=r*V,v+=r*Y,y+=r*G,m+=r*J,g+=r*q,E+=r*W,b+=r*z,O+=r*Q,A+=r*Z,c+=(r=n[3])*F,u+=r*L,f+=r*H,l+=r*j,d+=r*K,h+=r*U,p+=r*B,v+=r*V,y+=r*Y,m+=r*G,g+=r*J,E+=r*q,b+=r*W,O+=r*z,A+=r*Q,w+=r*Z,u+=(r=n[4])*F,f+=r*L,l+=r*H,d+=r*j,h+=r*K,p+=r*U,v+=r*B,y+=r*V,m+=r*Y,g+=r*G,E+=r*J,b+=r*q,O+=r*W,A+=r*z,w+=r*Q,D+=r*Z,f+=(r=n[5])*F,l+=r*L,d+=r*H,h+=r*j,p+=r*K,v+=r*U,y+=r*B,m+=r*V,g+=r*Y,E+=r*G,b+=r*J,O+=r*q,A+=r*W,w+=r*z,D+=r*Q,_+=r*Z,l+=(r=n[6])*F,d+=r*L,h+=r*H,p+=r*j,v+=r*K,y+=r*U,m+=r*B,g+=r*V,E+=r*Y,b+=r*G,O+=r*J,A+=r*q,w+=r*W,D+=r*z,_+=r*Q,T+=r*Z,d+=(r=n[7])*F,h+=r*L,p+=r*H,v+=r*j,y+=r*K,m+=r*U,g+=r*B,E+=r*V,b+=r*Y,O+=r*G,A+=r*J,w+=r*q,D+=r*W,_+=r*z,T+=r*Q,S+=r*Z,h+=(r=n[8])*F,p+=r*L,v+=r*H,y+=r*j,m+=r*K,g+=r*U,E+=r*B,b+=r*V,O+=r*Y,A+=r*G,w+=r*J,D+=r*q,_+=r*W,T+=r*z,S+=r*Q,N+=r*Z,p+=(r=n[9])*F,v+=r*L,y+=r*H,m+=r*j,g+=r*K,E+=r*U,b+=r*B,O+=r*V,A+=r*Y,w+=r*G,D+=r*J,_+=r*q,T+=r*W,S+=r*z,N+=r*Q,I+=r*Z,v+=(r=n[10])*F,y+=r*L,m+=r*H,g+=r*j,E+=r*K,b+=r*U,O+=r*B,A+=r*V,w+=r*Y,D+=r*G,_+=r*J,T+=r*q,S+=r*W,N+=r*z,I+=r*Q,x+=r*Z,y+=(r=n[11])*F,m+=r*L,g+=r*H,E+=r*j,b+=r*K,O+=r*U,A+=r*B,w+=r*V,D+=r*Y,_+=r*G,T+=r*J,S+=r*q,N+=r*W,I+=r*z,x+=r*Q,C+=r*Z,m+=(r=n[12])*F,g+=r*L,E+=r*H,b+=r*j,O+=r*K,A+=r*U,w+=r*B,D+=r*V,_+=r*Y,T+=r*G,S+=r*J,N+=r*q,I+=r*W,x+=r*z,C+=r*Q,R+=r*Z,g+=(r=n[13])*F,E+=r*L,b+=r*H,O+=r*j,A+=r*K,w+=r*U,D+=r*B,_+=r*V,T+=r*Y,S+=r*G,N+=r*J,I+=r*q,x+=r*W,C+=r*z,R+=r*Q,P+=r*Z,E+=(r=n[14])*F,b+=r*L,O+=r*H,A+=r*j,w+=r*K,D+=r*U,_+=r*B,T+=r*V,S+=r*Y,N+=r*G,I+=r*J,x+=r*q,C+=r*W,R+=r*z,P+=r*Q,k+=r*Z,b+=(r=n[15])*F,i+=38*(A+=r*H),s+=38*(w+=r*j),c+=38*(D+=r*K),u+=38*(_+=r*U),f+=38*(T+=r*B),l+=38*(S+=r*V),d+=38*(N+=r*Y),h+=38*(I+=r*G),p+=38*(x+=r*J),v+=38*(C+=r*q),y+=38*(R+=r*W),m+=38*(P+=r*z),g+=38*(k+=r*Q),E+=38*(M+=r*Z),a=(r=(a+=38*(O+=r*L))+(o=1)+65535)-65536*(o=Math.floor(r/65536)),i=(r=i+o+65535)-65536*(o=Math.floor(r/65536)),s=(r=s+o+65535)-65536*(o=Math.floor(r/65536)),c=(r=c+o+65535)-65536*(o=Math.floor(r/65536)),u=(r=u+o+65535)-65536*(o=Math.floor(r/65536)),f=(r=f+o+65535)-65536*(o=Math.floor(r/65536)),l=(r=l+o+65535)-65536*(o=Math.floor(r/65536)),d=(r=d+o+65535)-65536*(o=Math.floor(r/65536)),h=(r=h+o+65535)-65536*(o=Math.floor(r/65536)),p=(r=p+o+65535)-65536*(o=Math.floor(r/65536)),v=(r=v+o+65535)-65536*(o=Math.floor(r/65536)),y=(r=y+o+65535)-65536*(o=Math.floor(r/65536)),m=(r=m+o+65535)-65536*(o=Math.floor(r/65536)),g=(r=g+o+65535)-65536*(o=Math.floor(r/65536)),E=(r=E+o+65535)-65536*(o=Math.floor(r/65536)),b=(r=b+o+65535)-65536*(o=Math.floor(r/65536)),a=(r=(a+=o-1+37*(o-1))+(o=1)+65535)-65536*(o=Math.floor(r/65536)),i=(r=i+o+65535)-65536*(o=Math.floor(r/65536)),s=(r=s+o+65535)-65536*(o=Math.floor(r/65536)),c=(r=c+o+65535)-65536*(o=Math.floor(r/65536)),u=(r=u+o+65535)-65536*(o=Math.floor(r/65536)),f=(r=f+o+65535)-65536*(o=Math.floor(r/65536)),l=(r=l+o+65535)-65536*(o=Math.floor(r/65536)),d=(r=d+o+65535)-65536*(o=Math.floor(r/65536)),h=(r=h+o+65535)-65536*(o=Math.floor(r/65536)),p=(r=p+o+65535)-65536*(o=Math.floor(r/65536)),v=(r=v+o+65535)-65536*(o=Math.floor(r/65536)),y=(r=y+o+65535)-65536*(o=Math.floor(r/65536)),m=(r=m+o+65535)-65536*(o=Math.floor(r/65536)),g=(r=g+o+65535)-65536*(o=Math.floor(r/65536)),E=(r=E+o+65535)-65536*(o=Math.floor(r/65536)),b=(r=b+o+65535)-65536*(o=Math.floor(r/65536)),a+=o-1+37*(o-1),e[0]=a,e[1]=i,e[2]=s,e[3]=c,e[4]=u,e[5]=f,e[6]=l,e[7]=d,e[8]=h,e[9]=p,e[10]=v,e[11]=y,e[12]=m,e[13]=g,e[14]=E,e[15]=b}function K(e,n){j(e,n,n)}function U(e,t){var r,o=n();for(r=0;r<16;r++)o[r]=t[r];for(r=253;r>=0;r--)K(o,o),2!==r&&4!==r&&j(o,o,t);for(r=0;r<16;r++)e[r]=o[r]}function B(e,t){var r,o=n();for(r=0;r<16;r++)o[r]=t[r];for(r=250;r>=0;r--)K(o,o),1!==r&&j(o,o,t);for(r=0;r<16;r++)e[r]=o[r]}function V(e,t,r){var o,a,i=new Uint8Array(32),c=new Float64Array(80),u=n(),f=n(),l=n(),d=n(),h=n(),p=n();for(a=0;a<31;a++)i[a]=t[a];for(i[31]=127&t[31]|64,i[0]&=248,F(c,r),a=0;a<16;a++)f[a]=c[a],d[a]=u[a]=l[a]=0;for(u[0]=d[0]=1,a=254;a>=0;--a)R(u,f,o=i[a>>>3]>>>(7&a)&1),R(l,d,o),L(h,u,l),H(u,u,l),L(l,f,d),H(f,f,d),K(d,h),K(p,u),j(u,l,u),j(l,f,h),L(h,u,l),H(u,u,l),K(f,u),H(l,d,p),j(u,l,s),L(u,u,d),j(l,l,u),j(u,d,p),j(d,f,c),K(f,h),R(u,f,o),R(l,d,o);for(a=0;a<16;a++)c[a+16]=u[a],c[a+32]=l[a],c[a+48]=f[a],c[a+64]=d[a];var v=c.subarray(32),y=c.subarray(16);return U(v,v),j(y,y,v),P(e,y),0}function Y(e,n){return V(e,n,o)}function G(e,n){return t(n,32),Y(e,n)}function J(e,n,t){var o=new Uint8Array(32);return V(o,t,n),E(e,r,o,b)}_.prototype.blocks=function(e,n,t){for(var r,o,a,i,s,c,u,f,l,d,h,p,v,y,m,g,E,b,O,A=this.fin?0:2048,w=this.h[0],D=this.h[1],_=this.h[2],T=this.h[3],S=this.h[4],N=this.h[5],I=this.h[6],x=this.h[7],C=this.h[8],R=this.h[9],P=this.r[0],k=this.r[1],M=this.r[2],F=this.r[3],L=this.r[4],H=this.r[5],j=this.r[6],K=this.r[7],U=this.r[8],B=this.r[9];t>=16;)d=l=0,d+=(w+=8191&(r=255&e[n+0]|(255&e[n+1])<<8))*P,d+=(D+=8191&(r>>>13|(o=255&e[n+2]|(255&e[n+3])<<8)<<3))*(5*B),d+=(_+=8191&(o>>>10|(a=255&e[n+4]|(255&e[n+5])<<8)<<6))*(5*U),d+=(T+=8191&(a>>>7|(i=255&e[n+6]|(255&e[n+7])<<8)<<9))*(5*K),l=(d+=(S+=8191&(i>>>4|(s=255&e[n+8]|(255&e[n+9])<<8)<<12))*(5*j))>>>13,d&=8191,d+=(N+=s>>>1&8191)*(5*H),d+=(I+=8191&(s>>>14|(c=255&e[n+10]|(255&e[n+11])<<8)<<2))*(5*L),d+=(x+=8191&(c>>>11|(u=255&e[n+12]|(255&e[n+13])<<8)<<5))*(5*F),d+=(C+=8191&(u>>>8|(f=255&e[n+14]|(255&e[n+15])<<8)<<8))*(5*M),h=l+=(d+=(R+=f>>>5|A)*(5*k))>>>13,h+=w*k,h+=D*P,h+=_*(5*B),h+=T*(5*U),l=(h+=S*(5*K))>>>13,h&=8191,h+=N*(5*j),h+=I*(5*H),h+=x*(5*L),h+=C*(5*F),l+=(h+=R*(5*M))>>>13,h&=8191,p=l,p+=w*M,p+=D*k,p+=_*P,p+=T*(5*B),l=(p+=S*(5*U))>>>13,p&=8191,p+=N*(5*K),p+=I*(5*j),p+=x*(5*H),p+=C*(5*L),v=l+=(p+=R*(5*F))>>>13,v+=w*F,v+=D*M,v+=_*k,v+=T*P,l=(v+=S*(5*B))>>>13,v&=8191,v+=N*(5*U),v+=I*(5*K),v+=x*(5*j),v+=C*(5*H),y=l+=(v+=R*(5*L))>>>13,y+=w*L,y+=D*F,y+=_*M,y+=T*k,l=(y+=S*P)>>>13,y&=8191,y+=N*(5*B),y+=I*(5*U),y+=x*(5*K),y+=C*(5*j),m=l+=(y+=R*(5*H))>>>13,m+=w*H,m+=D*L,m+=_*F,m+=T*M,l=(m+=S*k)>>>13,m&=8191,m+=N*P,m+=I*(5*B),m+=x*(5*U),m+=C*(5*K),g=l+=(m+=R*(5*j))>>>13,g+=w*j,g+=D*H,g+=_*L,g+=T*F,l=(g+=S*M)>>>13,g&=8191,g+=N*k,g+=I*P,g+=x*(5*B),g+=C*(5*U),E=l+=(g+=R*(5*K))>>>13,E+=w*K,E+=D*j,E+=_*H,E+=T*L,l=(E+=S*F)>>>13,E&=8191,E+=N*M,E+=I*k,E+=x*P,E+=C*(5*B),b=l+=(E+=R*(5*U))>>>13,b+=w*U,b+=D*K,b+=_*j,b+=T*H,l=(b+=S*L)>>>13,b&=8191,b+=N*F,b+=I*M,b+=x*k,b+=C*P,O=l+=(b+=R*(5*B))>>>13,O+=w*B,O+=D*U,O+=_*K,O+=T*j,l=(O+=S*H)>>>13,O&=8191,O+=N*L,O+=I*F,O+=x*M,O+=C*k,w=d=8191&(l=(l=((l+=(O+=R*P)>>>13)<<2)+l|0)+(d&=8191)|0),D=h+=l>>>=13,_=p&=8191,T=v&=8191,S=y&=8191,N=m&=8191,I=g&=8191,x=E&=8191,C=b&=8191,R=O&=8191,n+=16,t-=16;this.h[0]=w,this.h[1]=D,this.h[2]=_,this.h[3]=T,this.h[4]=S,this.h[5]=N,this.h[6]=I,this.h[7]=x,this.h[8]=C,this.h[9]=R},_.prototype.finish=function(e,n){var t,r,o,a,i=new Uint16Array(10);if(this.leftover){for(a=this.leftover,this.buffer[a++]=1;a<16;a++)this.buffer[a]=0;this.fin=1,this.blocks(this.buffer,0,16)}for(t=this.h[1]>>>13,this.h[1]&=8191,a=2;a<10;a++)this.h[a]+=t,t=this.h[a]>>>13,this.h[a]&=8191;for(this.h[0]+=5*t,t=this.h[0]>>>13,this.h[0]&=8191,this.h[1]+=t,t=this.h[1]>>>13,this.h[1]&=8191,this.h[2]+=t,i[0]=this.h[0]+5,t=i[0]>>>13,i[0]&=8191,a=1;a<10;a++)i[a]=this.h[a]+t,t=i[a]>>>13,i[a]&=8191;for(i[9]-=8192,r=(1^t)-1,a=0;a<10;a++)i[a]&=r;for(r=~r,a=0;a<10;a++)this.h[a]=this.h[a]&r|i[a];for(this.h[0]=65535&(this.h[0]|this.h[1]<<13),this.h[1]=65535&(this.h[1]>>>3|this.h[2]<<10),this.h[2]=65535&(this.h[2]>>>6|this.h[3]<<7),this.h[3]=65535&(this.h[3]>>>9|this.h[4]<<4),this.h[4]=65535&(this.h[4]>>>12|this.h[5]<<1|this.h[6]<<14),this.h[5]=65535&(this.h[6]>>>2|this.h[7]<<11),this.h[6]=65535&(this.h[7]>>>5|this.h[8]<<8),this.h[7]=65535&(this.h[8]>>>8|this.h[9]<<5),o=this.h[0]+this.pad[0],this.h[0]=65535&o,a=1;a<8;a++)o=(this.h[a]+this.pad[a]|0)+(o>>>16)|0,this.h[a]=65535&o;e[n+0]=this.h[0]>>>0&255,e[n+1]=this.h[0]>>>8&255,e[n+2]=this.h[1]>>>0&255,e[n+3]=this.h[1]>>>8&255,e[n+4]=this.h[2]>>>0&255,e[n+5]=this.h[2]>>>8&255,e[n+6]=this.h[3]>>>0&255,e[n+7]=this.h[3]>>>8&255,e[n+8]=this.h[4]>>>0&255,e[n+9]=this.h[4]>>>8&255,e[n+10]=this.h[5]>>>0&255,e[n+11]=this.h[5]>>>8&255,e[n+12]=this.h[6]>>>0&255,e[n+13]=this.h[6]>>>8&255,e[n+14]=this.h[7]>>>0&255,e[n+15]=this.h[7]>>>8&255},_.prototype.update=function(e,n,t){var r,o;if(this.leftover){for((o=16-this.leftover)>t&&(o=t),r=0;r<o;r++)this.buffer[this.leftover+r]=e[n+r];if(t-=o,n+=o,this.leftover+=o,this.leftover<16)return;this.blocks(this.buffer,0,16),this.leftover=0}if(t>=16&&(o=t-t%16,this.blocks(e,n,o),n+=o,t-=o),t){for(r=0;r<t;r++)this.buffer[this.leftover+r]=e[n+r];this.leftover+=t}};var q=N,W=I;var z=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function Q(e,n,t,r){for(var o,a,i,s,c,u,f,l,d,h,p,v,y,m,g,E,b,O,A,w,D,_,T,S,N,I,x=new Int32Array(16),C=new Int32Array(16),R=e[0],P=e[1],k=e[2],M=e[3],F=e[4],L=e[5],H=e[6],j=e[7],K=n[0],U=n[1],B=n[2],V=n[3],Y=n[4],G=n[5],J=n[6],q=n[7],W=0;r>=128;){for(A=0;A<16;A++)w=8*A+W,x[A]=t[w+0]<<24|t[w+1]<<16|t[w+2]<<8|t[w+3],C[A]=t[w+4]<<24|t[w+5]<<16|t[w+6]<<8|t[w+7];for(A=0;A<80;A++)if(o=R,a=P,i=k,s=M,c=F,u=L,f=H,j,d=K,h=U,p=B,v=V,y=Y,m=G,g=J,q,T=65535&(_=q),S=_>>>16,N=65535&(D=j),I=D>>>16,T+=65535&(_=(Y>>>14|F<<18)^(Y>>>18|F<<14)^(F>>>9|Y<<23)),S+=_>>>16,N+=65535&(D=(F>>>14|Y<<18)^(F>>>18|Y<<14)^(Y>>>9|F<<23)),I+=D>>>16,T+=65535&(_=Y&G^~Y&J),S+=_>>>16,N+=65535&(D=F&L^~F&H),I+=D>>>16,T+=65535&(_=z[2*A+1]),S+=_>>>16,N+=65535&(D=z[2*A]),I+=D>>>16,D=x[A%16],S+=(_=C[A%16])>>>16,N+=65535&D,I+=D>>>16,N+=(S+=(T+=65535&_)>>>16)>>>16,T=65535&(_=O=65535&T|S<<16),S=_>>>16,N=65535&(D=b=65535&N|(I+=N>>>16)<<16),I=D>>>16,T+=65535&(_=(K>>>28|R<<4)^(R>>>2|K<<30)^(R>>>7|K<<25)),S+=_>>>16,N+=65535&(D=(R>>>28|K<<4)^(K>>>2|R<<30)^(K>>>7|R<<25)),I+=D>>>16,S+=(_=K&U^K&B^U&B)>>>16,N+=65535&(D=R&P^R&k^P&k),I+=D>>>16,l=65535&(N+=(S+=(T+=65535&_)>>>16)>>>16)|(I+=N>>>16)<<16,E=65535&T|S<<16,T=65535&(_=v),S=_>>>16,N=65535&(D=s),I=D>>>16,S+=(_=O)>>>16,N+=65535&(D=b),I+=D>>>16,P=o,k=a,M=i,F=s=65535&(N+=(S+=(T+=65535&_)>>>16)>>>16)|(I+=N>>>16)<<16,L=c,H=u,j=f,R=l,U=d,B=h,V=p,Y=v=65535&T|S<<16,G=y,J=m,q=g,K=E,A%16==15)for(w=0;w<16;w++)D=x[w],T=65535&(_=C[w]),S=_>>>16,N=65535&D,I=D>>>16,D=x[(w+9)%16],T+=65535&(_=C[(w+9)%16]),S+=_>>>16,N+=65535&D,I+=D>>>16,b=x[(w+1)%16],T+=65535&(_=((O=C[(w+1)%16])>>>1|b<<31)^(O>>>8|b<<24)^(O>>>7|b<<25)),S+=_>>>16,N+=65535&(D=(b>>>1|O<<31)^(b>>>8|O<<24)^b>>>7),I+=D>>>16,b=x[(w+14)%16],S+=(_=((O=C[(w+14)%16])>>>19|b<<13)^(b>>>29|O<<3)^(O>>>6|b<<26))>>>16,N+=65535&(D=(b>>>19|O<<13)^(O>>>29|b<<3)^b>>>6),I+=D>>>16,I+=(N+=(S+=(T+=65535&_)>>>16)>>>16)>>>16,x[w]=65535&N|I<<16,C[w]=65535&T|S<<16;T=65535&(_=K),S=_>>>16,N=65535&(D=R),I=D>>>16,D=e[0],S+=(_=n[0])>>>16,N+=65535&D,I+=D>>>16,I+=(N+=(S+=(T+=65535&_)>>>16)>>>16)>>>16,e[0]=R=65535&N|I<<16,n[0]=K=65535&T|S<<16,T=65535&(_=U),S=_>>>16,N=65535&(D=P),I=D>>>16,D=e[1],S+=(_=n[1])>>>16,N+=65535&D,I+=D>>>16,I+=(N+=(S+=(T+=65535&_)>>>16)>>>16)>>>16,e[1]=P=65535&N|I<<16,n[1]=U=65535&T|S<<16,T=65535&(_=B),S=_>>>16,N=65535&(D=k),I=D>>>16,D=e[2],S+=(_=n[2])>>>16,N+=65535&D,I+=D>>>16,I+=(N+=(S+=(T+=65535&_)>>>16)>>>16)>>>16,e[2]=k=65535&N|I<<16,n[2]=B=65535&T|S<<16,T=65535&(_=V),S=_>>>16,N=65535&(D=M),I=D>>>16,D=e[3],S+=(_=n[3])>>>16,N+=65535&D,I+=D>>>16,I+=(N+=(S+=(T+=65535&_)>>>16)>>>16)>>>16,e[3]=M=65535&N|I<<16,n[3]=V=65535&T|S<<16,T=65535&(_=Y),S=_>>>16,N=65535&(D=F),I=D>>>16,D=e[4],S+=(_=n[4])>>>16,N+=65535&D,I+=D>>>16,I+=(N+=(S+=(T+=65535&_)>>>16)>>>16)>>>16,e[4]=F=65535&N|I<<16,n[4]=Y=65535&T|S<<16,T=65535&(_=G),S=_>>>16,N=65535&(D=L),I=D>>>16,D=e[5],S+=(_=n[5])>>>16,N+=65535&D,I+=D>>>16,I+=(N+=(S+=(T+=65535&_)>>>16)>>>16)>>>16,e[5]=L=65535&N|I<<16,n[5]=G=65535&T|S<<16,T=65535&(_=J),S=_>>>16,N=65535&(D=H),I=D>>>16,D=e[6],S+=(_=n[6])>>>16,N+=65535&D,I+=D>>>16,I+=(N+=(S+=(T+=65535&_)>>>16)>>>16)>>>16,e[6]=H=65535&N|I<<16,n[6]=J=65535&T|S<<16,T=65535&(_=q),S=_>>>16,N=65535&(D=j),I=D>>>16,D=e[7],S+=(_=n[7])>>>16,N+=65535&D,I+=D>>>16,I+=(N+=(S+=(T+=65535&_)>>>16)>>>16)>>>16,e[7]=j=65535&N|I<<16,n[7]=q=65535&T|S<<16,W+=128,r-=128}return r}function Z(e,n,t){var r,o=new Int32Array(8),a=new Int32Array(8),i=new Uint8Array(256),s=t;for(o[0]=1779033703,o[1]=3144134277,o[2]=1013904242,o[3]=2773480762,o[4]=1359893119,o[5]=2600822924,o[6]=528734635,o[7]=1541459225,a[0]=4089235720,a[1]=2227873595,a[2]=4271175723,a[3]=1595750129,a[4]=2917565137,a[5]=725511199,a[6]=4215389547,a[7]=327033209,Q(o,a,n,t),t%=128,r=0;r<t;r++)i[r]=n[s-t+r];for(i[t]=128,i[(t=256-128*(t<112?1:0))-9]=0,p(i,t-8,s/536870912|0,s<<3),Q(o,a,i,t),r=0;r<8;r++)p(e,8*r,o[r],a[r]);return 0}function X(e,t){var r=n(),o=n(),a=n(),i=n(),s=n(),c=n(),f=n(),l=n(),d=n();H(r,e[1],e[0]),H(d,t[1],t[0]),j(r,r,d),L(o,e[0],e[1]),L(d,t[0],t[1]),j(o,o,d),j(a,e[3],t[3]),j(a,a,u),j(i,e[2],t[2]),L(i,i,i),H(s,o,r),H(c,i,a),L(f,i,a),L(l,o,r),j(e[0],s,c),j(e[1],l,f),j(e[2],f,c),j(e[3],s,l)}function $(e,n,t){var r;for(r=0;r<4;r++)R(e[r],n[r],t)}function ee(e,t){var r=n(),o=n(),a=n();U(a,t[2]),j(r,t[0],a),j(o,t[1],a),P(e,o),e[31]^=M(r)<<7}function ne(e,n,t){var r,o;for(x(e[0],a),x(e[1],i),x(e[2],i),x(e[3],a),o=255;o>=0;--o)$(e,n,r=t[o/8|0]>>(7&o)&1),X(n,e),X(e,e),$(e,n,r)}function te(e,t){var r=[n(),n(),n(),n()];x(r[0],l),x(r[1],d),x(r[2],i),j(r[3],l,d),ne(e,r,t)}function re(e,r,o){var a,i=new Uint8Array(64),s=[n(),n(),n(),n()];for(o||t(r,32),Z(i,r,32),i[0]&=248,i[31]&=127,i[31]|=64,te(s,i),ee(e,s),a=0;a<32;a++)r[a+32]=e[a];return 0}var oe=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function ae(e,n){var t,r,o,a;for(r=63;r>=32;--r){for(t=0,o=r-32,a=r-12;o<a;++o)n[o]+=t-16*n[r]*oe[o-(r-32)],t=Math.floor((n[o]+128)/256),n[o]-=256*t;n[o]+=t,n[r]=0}for(t=0,o=0;o<32;o++)n[o]+=t-(n[31]>>4)*oe[o],t=n[o]>>8,n[o]&=255;for(o=0;o<32;o++)n[o]-=t*oe[o];for(r=0;r<32;r++)n[r+1]+=n[r]>>8,e[r]=255&n[r]}function ie(e){var n,t=new Float64Array(64);for(n=0;n<64;n++)t[n]=e[n];for(n=0;n<64;n++)e[n]=0;ae(e,t)}function se(e,t,r,o){var a,i,s=new Uint8Array(64),c=new Uint8Array(64),u=new Uint8Array(64),f=new Float64Array(64),l=[n(),n(),n(),n()];Z(s,o,32),s[0]&=248,s[31]&=127,s[31]|=64;var d=r+64;for(a=0;a<r;a++)e[64+a]=t[a];for(a=0;a<32;a++)e[32+a]=s[32+a];for(Z(u,e.subarray(32),r+32),ie(u),te(l,u),ee(e,l),a=32;a<64;a++)e[a]=o[a];for(Z(c,e,r+64),ie(c),a=0;a<64;a++)f[a]=0;for(a=0;a<32;a++)f[a]=u[a];for(a=0;a<32;a++)for(i=0;i<32;i++)f[a+i]+=c[a]*s[i];return ae(e.subarray(32),f),d}function ce(e,t,r,o){var s,u=new Uint8Array(32),f=new Uint8Array(64),l=[n(),n(),n(),n()],d=[n(),n(),n(),n()];if(r<64)return-1;if(function(e,t){var r=n(),o=n(),s=n(),u=n(),f=n(),l=n(),d=n();return x(e[2],i),F(e[1],t),K(s,e[1]),j(u,s,c),H(s,s,e[2]),L(u,e[2],u),K(f,u),K(l,f),j(d,l,f),j(r,d,s),j(r,r,u),B(r,r),j(r,r,s),j(r,r,u),j(r,r,u),j(e[0],r,u),K(o,e[0]),j(o,o,u),k(o,s)&&j(e[0],e[0],h),K(o,e[0]),j(o,o,u),k(o,s)?-1:(M(e[0])===t[31]>>7&&H(e[0],a,e[0]),j(e[3],e[0],e[1]),0)}(d,o))return-1;for(s=0;s<r;s++)e[s]=t[s];for(s=0;s<32;s++)e[s+32]=o[s];if(Z(f,e,r),ie(f),ne(l,d,f),te(d,t.subarray(32)),X(l,d),ee(u,l),r-=64,m(t,0,u,0)){for(s=0;s<r;s++)e[s]=0;return-1}for(s=0;s<r;s++)e[s]=t[s+64];return r}var ue=16,fe=64,le=32,de=64;function he(e,n){if(32!==e.length)throw new Error("bad key size");if(24!==n.length)throw new Error("bad nonce size")}function pe(){for(var e=0;e<arguments.length;e++)if(!(arguments[e]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function ve(e){for(var n=0;n<e.length;n++)e[n]=0}e.lowlevel={crypto_core_hsalsa20:E,crypto_stream_xor:D,crypto_stream:w,crypto_stream_salsa20_xor:O,crypto_stream_salsa20:A,crypto_onetimeauth:T,crypto_onetimeauth_verify:S,crypto_verify_16:y,crypto_verify_32:m,crypto_secretbox:N,crypto_secretbox_open:I,crypto_scalarmult:V,crypto_scalarmult_base:Y,crypto_box_beforenm:J,crypto_box_afternm:q,crypto_box:function(e,n,t,r,o,a){var i=new Uint8Array(32);return J(i,o,a),q(e,n,t,r,i)},crypto_box_open:function(e,n,t,r,o,a){var i=new Uint8Array(32);return J(i,o,a),W(e,n,t,r,i)},crypto_box_keypair:G,crypto_hash:Z,crypto_sign:se,crypto_sign_keypair:re,crypto_sign_open:ce,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:ue,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:fe,crypto_sign_PUBLICKEYBYTES:le,crypto_sign_SECRETKEYBYTES:de,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:n,D:c,L:oe,pack25519:P,unpack25519:F,M:j,A:L,S:K,Z:H,pow2523:B,add:X,set25519:x,modL:ae,scalarmult:ne,scalarbase:te},e.randomBytes=function(e){var n=new Uint8Array(e);return t(n,e),n},e.secretbox=function(e,n,t){pe(e,n,t),he(t,n);for(var r=new Uint8Array(32+e.length),o=new Uint8Array(r.length),a=0;a<e.length;a++)r[a+32]=e[a];return N(o,r,r.length,n,t),o.subarray(ue)},e.secretbox.open=function(e,n,t){pe(e,n,t),he(t,n);for(var r=new Uint8Array(ue+e.length),o=new Uint8Array(r.length),a=0;a<e.length;a++)r[a+ue]=e[a];return r.length<32||0!==I(o,r,r.length,n,t)?null:o.subarray(32)},e.secretbox.keyLength=32,e.secretbox.nonceLength=24,e.secretbox.overheadLength=ue,e.scalarMult=function(e,n){if(pe(e,n),32!==e.length)throw new Error("bad n size");if(32!==n.length)throw new Error("bad p size");var t=new Uint8Array(32);return V(t,e,n),t},e.scalarMult.base=function(e){if(pe(e),32!==e.length)throw new Error("bad n size");var n=new Uint8Array(32);return Y(n,e),n},e.scalarMult.scalarLength=32,e.scalarMult.groupElementLength=32,e.box=function(n,t,r,o){var a=e.box.before(r,o);return e.secretbox(n,t,a)},e.box.before=function(e,n){pe(e,n),function(e,n){if(32!==e.length)throw new Error("bad public key size");if(32!==n.length)throw new Error("bad secret key size")}(e,n);var t=new Uint8Array(32);return J(t,e,n),t},e.box.after=e.secretbox,e.box.open=function(n,t,r,o){var a=e.box.before(r,o);return e.secretbox.open(n,t,a)},e.box.open.after=e.secretbox.open,e.box.keyPair=function(){var e=new Uint8Array(32),n=new Uint8Array(32);return G(e,n),{publicKey:e,secretKey:n}},e.box.keyPair.fromSecretKey=function(e){if(pe(e),32!==e.length)throw new Error("bad secret key size");var n=new Uint8Array(32);return Y(n,e),{publicKey:n,secretKey:new Uint8Array(e)}},e.box.publicKeyLength=32,e.box.secretKeyLength=32,e.box.sharedKeyLength=32,e.box.nonceLength=24,e.box.overheadLength=e.secretbox.overheadLength,e.sign=function(e,n){if(pe(e,n),n.length!==de)throw new Error("bad secret key size");var t=new Uint8Array(fe+e.length);return se(t,e,e.length,n),t},e.sign.open=function(e,n){if(pe(e,n),n.length!==le)throw new Error("bad public key size");var t=new Uint8Array(e.length),r=ce(t,e,e.length,n);if(r<0)return null;for(var o=new Uint8Array(r),a=0;a<o.length;a++)o[a]=t[a];return o},e.sign.detached=function(n,t){for(var r=e.sign(n,t),o=new Uint8Array(fe),a=0;a<o.length;a++)o[a]=r[a];return o},e.sign.detached.verify=function(e,n,t){if(pe(e,n,t),n.length!==fe)throw new Error("bad signature size");if(t.length!==le)throw new Error("bad public key size");var r,o=new Uint8Array(fe+e.length),a=new Uint8Array(fe+e.length);for(r=0;r<fe;r++)o[r]=n[r];for(r=0;r<e.length;r++)o[r+fe]=e[r];return ce(a,o,o.length,t)>=0},e.sign.keyPair=function(){var e=new Uint8Array(le),n=new Uint8Array(de);return re(e,n),{publicKey:e,secretKey:n}},e.sign.keyPair.fromSecretKey=function(e){if(pe(e),e.length!==de)throw new Error("bad secret key size");for(var n=new Uint8Array(le),t=0;t<n.length;t++)n[t]=e[32+t];return{publicKey:n,secretKey:new Uint8Array(e)}},e.sign.keyPair.fromSeed=function(e){if(pe(e),32!==e.length)throw new Error("bad seed size");for(var n=new Uint8Array(le),t=new Uint8Array(de),r=0;r<32;r++)t[r]=e[r];return re(n,t,!0),{publicKey:n,secretKey:t}},e.sign.publicKeyLength=le,e.sign.secretKeyLength=de,e.sign.seedLength=32,e.sign.signatureLength=fe,e.hash=function(e){pe(e);var n=new Uint8Array(64);return Z(n,e,e.length),n},e.hash.hashLength=64,e.verify=function(e,n){return pe(e,n),0!==e.length&&0!==n.length&&(e.length===n.length&&0===v(e,0,n,0,e.length))},e.setPRNG=function(e){t=e},function(){var n="undefined"!=typeof self?self.crypto||self.msCrypto:null;if(n&&n.getRandomValues){e.setPRNG(function(e,t){var r,o=new Uint8Array(t);for(r=0;r<t;r+=65536)n.getRandomValues(o.subarray(r,r+Math.min(t-r,65536)));for(r=0;r<t;r++)e[r]=o[r];ve(o)})}else void 0!==f&&(n=require("crypto"))&&n.randomBytes&&e.setPRNG(function(e,t){var r,o=n.randomBytes(t);for(r=0;r<t;r++)e[r]=o[r];ve(o)})}()}(e.exports?e.exports:self.nacl=self.nacl||{})}(d)),d.exports}var p,v,y,m,g,E,b,O={exports:{}},A=O.exports;function w(){return p||(p=1,function(e){var n,t;n=A,t=function(){var e={};function n(e){if(!/^(?:[A-Za-z0-9+\/]{2}[A-Za-z0-9+\/]{2})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/.test(e))throw new TypeError("invalid encoding")}return e.decodeUTF8=function(e){if("string"!=typeof e)throw new TypeError("expected string");var n,t=unescape(encodeURIComponent(e)),r=new Uint8Array(t.length);for(n=0;n<t.length;n++)r[n]=t.charCodeAt(n);return r},e.encodeUTF8=function(e){var n,t=[];for(n=0;n<e.length;n++)t.push(String.fromCharCode(e[n]));return decodeURIComponent(escape(t.join("")))},"undefined"==typeof atob?void 0!==Buffer.from?(e.encodeBase64=function(e){return Buffer.from(e).toString("base64")},e.decodeBase64=function(e){return n(e),new Uint8Array(Array.prototype.slice.call(Buffer.from(e,"base64"),0))}):(e.encodeBase64=function(e){return new Buffer(e).toString("base64")},e.decodeBase64=function(e){return n(e),new Uint8Array(Array.prototype.slice.call(new Buffer(e,"base64"),0))}):(e.encodeBase64=function(e){var n,t=[],r=e.length;for(n=0;n<r;n++)t.push(String.fromCharCode(e[n]));return btoa(t.join(""))},e.decodeBase64=function(e){n(e);var t,r=atob(e),o=new Uint8Array(r.length);for(t=0;t<r.length;t++)o[t]=r.charCodeAt(t);return o}),e},e.exports?e.exports=t():(n.nacl||(n.nacl={}),n.nacl.util=t())}(O)),O.exports}function D(){return v||(v=1,function(e){var n,t,r,o,a,i;e.exports&&(e.exports=(n=u(),t=h(),r=w(),a=function(e){return e.replace(/^\d+:/,"")},i=(o={}).removeCp=function(e){return e.replace(/^cp\|([A-Za-z0-9+\/=]{0,20}\|)?/,"")},o.start=function(e){var o,s=(e=e||{}).network,c=e.websocketURL,u=e.userName,f=e.channel,l=e.crypto,d=e.readOnly||!1,h=!e.noChainPad&&(e.ChainPad||globalThis.ChainPad),p=void 0===e.useHistory||!!e.useHistory,v=!1,y=e.lastKnownHash,m={},g=[],E=e.priority||2,b=e.Cache,O=!1,A=Math.floor(1e6*Math.random()),w=e.metadata||{},D=w.validateKey=e.validateKey||w.validateKey;w.owners=e.owners||w.owners,w.expire=e.expire||w.expire;var _,T,S=!0,N=!1,I={setReadOnly:function(e,n){d=e,n&&(l=n)}},x=function(){},C=[],R={send:function(){}},P=function(){_&&"function"==typeof _.abort&&_.abort();var n=h.create({userName:u,initialState:e.initialState,transformFunction:e.transformFunction,patchTransformer:e.patchTransformer,validateContent:e.validateContent,avgSyncMilliseconds:e.avgSyncMilliseconds,logLevel:void 0!==e.logLevel?e.logLevel:1});return b&&Array.isArray(o)&&o.length&&(o.forEach(function(e){var t=e.patch;if(!/^\[/.test(t)){try{t=l.decrypt(t,D,!0)}catch(e){console.error(t,D,f),console.error(e)}t=a(t)}n.message(t)}),""===n.getUserDoc())?(n.abort(),o=[],b.clearChannel(f),P()):(n.onMessage(function(e,n,t){R.send(e,n,t)}),n.onPatch(function(t){e.onRemote&&e.onRemote({realtime:n,patch:t})}),n)},k={change:[],onChange:function(e){k.change.forEach(function(n){n(e)})},users:[]},M=function(n){e.onJoin&&e.onJoin(n),32===n.length&&(-1===k.users.indexOf(n)&&k.users.push(n),k.onChange())},F=function(){},L=function(n){e.onLeave&&e.onLeave(n);var t=k.users.indexOf(n);-1!==t&&k.users.splice(t,1),k.onChange()},H=function(n,t){if(S){try{var r=_&&_.getUserDoc();if(O&&_&&(""===r||r===e.initialState))return void I.resetCache()}catch(e){console.error(e)}_&&_.start(),e.setMyID&&e.setMyID({myID:n.myID}),S=!1,e.onReady&&e.onReady({realtime:_,network:t,userList:k,myId:n.myID,leave:n.leave,metadata:w}),g.length&&(g.forEach(function(e){"function"==typeof e&&e()}),g=[])}},j=function(n,t){if(e.onChannelError&&e.onChannelError({channel:t.id,type:n.error,loaded:!S,error:n.error,message:n.message}),"EUNKNOWN"===n.error)return y=void 0,t&&t.leave(),b?(o=[],void b.clearChannel(f,function(){h&&(I.realtime=_=P()),x(s,F)})):void x(s,F);if("function"==typeof I.stop)try{I.stop()}catch(e){}},K=!0,U=function(e){b&&(o.length&&o[o.length-1].hash===e.hash||(!o.length&&K&&(e.isCheckpoint=!0,K=!1),(o.length||e.isCheckpoint)&&(o.push(e),b.storeCache(f,D,o,function(e){if(e){b.clearChannel(f,function(){console.warn("Cache cleared",f)});var n=o;return o=[],void console.error(e,f,n,D)}}))))},B=function(n,t,r,o,s){var c=o.historyKeeper,u=n===c;if(!r||0!==t&&"0"!==t){if(!s||n===c){if(s){var d=JSON.parse(t);if(d.txid&&d.txid!==A)return;if(d.validateKey&&d.channel)return d.channel!==r.id||D||(D=d.validateKey),void(d.channel===r.id&&(w=d,e.onMetadataUpdate&&!S&&e.onMetadataUpdate(w)));if(d.state&&1===d.state&&d.channel)return void(d.channel===r.id&&(Object.keys(m).forEach(function(e){"function"==typeof m[e]&&m[e]("FAILED")}),m={},H(r,o)))}if(u){var h=JSON.parse(t);if(Array.isArray(h)&&h[0]&&h[0]!==A)return;if(h.channel===r.id&&h.error)return void j(h,r);if(t=h[4],h[3]!==r.id)return}if(y=t.slice(0,64),"function"==typeof m[y])return m[y](null,y),void delete m[y];var p,v=/^cp\|/.test(t);t=i(t);try{t=l.decrypt(t,D,u)}catch(e){console.error(t,D,f),console.error(e)}var E="string"==typeof t;!E&&t.content&&(p=t.author,t=t.content),S||e.onLocal&&e.onLocal(!0);var b=E?a(t):t,O=function(){try{if(_&&E&&_.message(b),e.onMessage){var t={time:h?h[5]:+new Date};e.onMessage(b,n,D,v,y,p,t)}var r=v;e.isCacheCheckpoint&&(r=e.isCacheCheckpoint(b,p)),U({patch:b,hash:y,isCheckpoint:r,author:p,time:h?h[5]:+new Date})}catch(e){console.error(e)}};S&&n!==c?g.push(O):O()}}else H(r,o)},V=function(n,a,s){R.wc=n,f=n.id,n.members.forEach(M);var c,u=function(e,t){B(t,e,n,a)};n.on("message",u),n.on("join",M),n.on("leave",L),R.stop=function(){n.off("message",u),n.off("join",M),n.off("leave",L),n.leave(),_&&_.abort()},s&&(R.send=function(n,o,s){var c=function(e,n){if(!d)try{var o=l.encrypt(e,n);if(0===e.indexOf("[4")){var a="";if(t&&r){var i=t.hash(r.decodeUTF8(e));a=r.encodeBase64(i.slice(0,8))+"|"}else console.log("Checkpoint sent without an ID. Nacl is missing.");o="cp|"+a+o}return o}catch(n){throw console.log(e),n}}(n,s);if(c){var u=c.slice(0,64),h=/^cp\|/.test(c);e.isCacheCheckpoint&&(h=e.isCacheCheckpoint(n,s)),m[u]=function(e,t){!e&&t&&U({patch:i(n),hash:u,isCheckpoint:h,author:s,time:+new Date}),o(e,t)},R.wc.bcast(c).then(function(){y=u,delete m[u],U({patch:i(n),hash:u,isCheckpoint:h,author:s,time:+new Date}),o(null,u)},function(e){if(console.error(e),!e||"enoent"!==e.type&&"ENOENT"!==e.type)delete m[u],o(e&&e.type||e);else{if(R.wc.leave(),v)return delete m[u],void o("STOPPED");S=!0,a.join(f,E).then(function(e){V(e,a,!1),R.send(n,o,s)})}})}},h&&!_&&(I.realtime=_=P()),e.onInit&&e.onInit({myID:n.myID,realtime:_,getLag:a.getLag,userList:k,network:a,channel:f})),e.onConnect&&e.onConnect(n,R.send),p?(n.members.forEach(function(e){16===e.length&&(c=e)}),T!==c&&(a.historyKeeper=c,T=c,C.forEach(function(e){e(c)})),function(){var e={txid:A,priority:E,lastKnownHash:y,metadata:w};b&&Array.isArray(o)&&o.length&&(e.lastKnownHash=o[o.length-1].hash),g=[];var t=["GET_HISTORY",n.id,e];c&&a.sendto(c,JSON.stringify(t))}(),I.resetCache=function(){S=!0,o=[],b&&b.clearChannel(f),A=Math.floor(1e6*Math.random()),j({error:"EUNKNOWN",message:"Corrupted cache"},n)}):H(n,a)},Y=!1;"undefined"!=typeof window&&window.addEventListener("beforeunload",function(){Y=!0});var G=function(e,n){var t;return e.some(function(e){if(e.id===n)return t=e,!0}),t},J=function(n){e.onError&&e.onError({type:n.type||n,message:n.message,error:n.type,loaded:!S})};x=function(t,r){var a;"string"==typeof t&&(a=n.connect(t));var i=function(){N=!1,"string"==typeof t?a.then(r,J):"function"==typeof t.then?t.then(r,J):r(t)};if(b&&!N)return b.getChannelCache(f,function(n,t){D=t?t.k:void 0,(o=t?t.c:[]).length?(O=!0,e.onCacheStart&&e.onCacheStart(),h&&(I.realtime=_=P()),o.length?(e.onMessage&&o.forEach(function(n){var t={time:n.time};e.onMessage(n.patch,"cache",D,n.isCheckpoint,n.hash,n.author,t)}),e.onCacheReady&&e.onCacheReady({id:f,realtime:_,networkPromise:a}),i()):i()):i()}),void(I.resetCache=function(){b&&b.clearChannel(f),o=[]});i()};var q=!0;return F=function(n,t){v||n.join(f||null,E).then(function(e){if(v)try{e.leave()}catch(e){}else V(e,n,t)},function(r){r&&"ERESTRICTED"===r.type&&Array.isArray(r.message)&&e.onRejected?e.onRejected(r.message,function(e){e?J(r):F(n,t)}):J(r)})},I.stop=function(){v=!0},x(s||c,function(n){if(s=n,q){if(q=!1,v)return;var t=function(n){Y||"network.disconnect() called"!==n&&(e.onConnectionChange?e.onConnectionChange({state:!1}):e.onAbort&&e.onAbort({reason:n}))},r=function(n){if(e.onConnectionChange){e.onConnectionChange({state:!0,myId:n});var t=function(){S=!0,N=!0,k.users=[],x(s,F)};if(e.beforeReconnecting)return void e.beforeReconnecting(function(n,r){f=n,e.initialState=r,t()});t()}},o=function(e,n){var t=G(s.webChannels,f);t&&B(n,e,t,s,!0)};s.on("disconnect",t),s.on("reconnect",r),s.on("message",o),I.network=s,I.stop=function(){R&&R.stop&&R.stop();var e=G(s.webChannels,f);if(e)try{e.leave("")}catch(e){}s.off("disconnect",t),s.off("reconnect",r),s.off("message",o),v=!0},s.onHistoryKeeperChange=function(e){C.push(e)}}F(s,!0)}),I},o))}(s)),s.exports}function _(){return E?g:(E=1,g=function(){if(m)return y;m=1;const e=n=>{if(Array.isArray(n))return n.map(e);if(n instanceof Object){let t=[],r=[];return Object.keys(n).forEach(e=>{/^(0|[1-9][0-9]*)$/.test(e)?t.push(+e):r.push(e)}),t.sort(function(e,n){return e-n}).concat(r.sort()).reduce((t,r)=>(t[r]=e(n[r]),t),{})}return n},n=JSON.stringify.bind(JSON);return y=(t,r,o)=>{let a=n(t,r,0);if(!a||"{"!==a[0]&&"["!==a[0])return a;let i=JSON.parse(a);return n(e(i),null,o)}}())}function T(){return b||(b=1,function(e){e.exports&&(e.exports=function(e,n){const t=globalThis;var r,o={},a=void 0===t.Proxy,i=o.DeepProxy=function(){var e={},r=e.isArray=Array.isArray||function(e){return"[object Array]"===Object.toString(e)},o=e.type=function(e){return null===e?"null":r(e)?"array":typeof e},i=e.isProxyable=function(e,n){return(void 0!==n||!a)&&-1!==["object","array"].indexOf(o(e))},s=e.set=function(n){return function(t,r,o){if("on"===r)throw new Error("'on' is a reserved attribute name for realtime lists and maps");return i(o)?t[r]=e.create(o,n):t[r]=o,n(),t[r]||!0}},c=e.pathMatches=function(e,n){return!n.some(function(n,t){return n!==e[t]})},u=function(e,n){return n.pattern.length-e.pattern.length},f=function(e){return function(n,t,r){switch(n){case"change":t="array"===o(t)?t:[t],e.change.push({cb:function(e,n,o,a){if(c(o,t))return r(e,n,o,a)},pattern:t}),e.change.sort(u);break;case"remove":t="array"===o(t)?t:[t],e.remove.push({cb:function(e,n,o){if(c(n,t))return r(e,n,o)},pattern:t}),e.remove.sort(u);break;case"ready":e.ready.push({cb:function(e){t(e)}});break;case"cacheready":e.cacheready.push({cb:function(e){t(e)}});break;case"disconnect":e.disconnect.push({cb:function(e){t(e)}});break;case"reconnect":e.reconnect.push({cb:function(e){t(e)}});break;case"create":e.create.push({cb:function(e){t(e)}});break;case"error":e.error.push({cb:function(e){t(e)}})}return this}},l=e.get=function(){var e={cacheready:[],disconnect:[],reconnect:[],change:[],ready:[],remove:[],create:[],error:[]};return function(n,t){return"on"===t?f(e):"_isProxy"===t||("_events"===t?e:n[t])}},d=e.delete=function(e){return function(n,t){return void 0===n[t]||(delete n[t],e()),!0}},h=e.handlers=function(e,n){return n?{set:s(e),get:l(e),deleteProperty:d(e)}:{set:s(e),get:function(e,n){return"_isProxy"===n||e[n]},deleteProperty:d(e)}},p=e.remoteChangeFlag=!1,v=e.stringifyFakeProxy=function(e){var t=JSON.parse(n(e));return delete t._events,delete t._isProxy,n(t)};e.checkLocalChange=function(n,r){if(a&&!e.interval){var o=v(n);e.interval=t.setInterval(function(){var e=v(n);e!==o&&(o=e,p?p=!1:r())},300)}};var y=e.create=function(e,n,r){var s="function"===o(n)?h(n,r):n;switch(o(e)){case"object":Object.keys(e).forEach(function(t){i(e[t])&&!e[t]._isProxy&&(e[t]=y(e[t],n))});break;case"array":e.forEach(function(t,r){i(t)&&!t._isProxy&&(e[r]=y(e[r],n))});break;default:throw new Error("attempted to make a proxy of an unproxyable object")}if(!a)return e._isProxy?e:new t.Proxy(e,s);var c=JSON.parse(JSON.stringify(e));if(r){var u={cacheready:[],disconnect:[],reconnect:[],change:[],ready:[],remove:[],create:[],error:[]};c.on=f(u),c._events=u}return c},m=function(e,n,t,r,o){var a=e.slice(0);a.push(n),t._events.change.some(function(e){return!1===e.cb(r,o,a,t)})},g=e.find=function(e,n){for(var t=n.length,r=0;r<t;r++){if(void 0===e[n[r]])return;e=e[n[r]]}return e},E=function(e,n,t,r,a){var i=e.concat(n),s=g(t,i);switch(o(s)){case"array":a?m(e,n,t,r,void 0):t._events.remove.forEach(function(e){return e.cb(s,i,t)}),s.forEach(function(e,n){E(i,n,t)});break;case"object":a?m(e,n,t,r,void 0):t._events.remove.forEach(function(e){return e.cb(s,i,t,r,!1)}),Object.keys(s).forEach(function(e){E(i,e,t,s[e],!1)});break;default:t._events.remove.forEach(function(e){return e.cb(s,i,t)})}},b=e.objects=function(n,t,r,a,i){var s=Object.keys(n),c=Object.keys(t);c.forEach(function(c){var u=o(t[c]),f=n[c];if(-1!==s.indexOf(c)){var l=o(n[c]);if(l===u)if(-1!==["array","object"].indexOf(l)){var d=a.slice(0).concat(c);"object"===l?b.call(i,n[c],t[c],r,d,i):e.arrays.call(i,n[c],t[c],r,d,i)}else n[c]!==t[c]&&(n[c]=t[c],m(a,c,i,f,t[c]));else{switch(console.log("type changed from [%s] to [%s]",l,u),u){case"undefined":throw new Error("first pass should never reveal undefined keys");case"array":case"object":n[c]=r(t[c]);break;default:n[c]=t[c]}m(a,c,i,f,t[c])}}else{switch(u){case"undefined":throw new Error("undefined type has key. this shouldn't happen?");case"array":case"object":n[c]=r(t[c]);break;default:n[c]=t[c]}m(a,c,i,f,t[c])}}),s.forEach(function(e){var r=n[e];"on"!==e&&"_events"!==e&&(-1!==c.indexOf(e)&&"undefined"!==o(t[e])||(E(a,e,i,r,!0),delete n[e]))})},O=e.arrays=function(e,n,t,r,a){var i=e.length,s=n.length;if(i===s)e.forEach(function(i,s){var c=o(i),u=o(n[s]),f=i;if(c===u){var l=r.slice(0).concat(s);switch(u){case"undefined":throw new Error("existing key had type `undefined`. this should never happen");case"object":b.call(a,e[s],n[s],t,l,a)&&m(r,s,a,f,n[s]);break;case"array":O.call(a,e[s],n[s],t,l,a)&&m(r,s,a,f,n[s]);break;default:e[s]!==n[s]&&(e[s]=n[s],m(r,s,a,f,n[s]))}}else{switch(u){case"undefined":E(r,s,a,f,!0);break;case"object":case"array":e[s]=t(n[s]);break;default:e[s]=n[s]}m(r,s,a,f,n[s])}});else{if(n.forEach(function(n,i){var s=o(e[i]),c=o(n),u=e[i];if(s!==c){switch(c){case"undefined":throw new Error("this should never happen");case"object":case"array":e[i]=t(n);break;default:e[i]=n}m(r,i,a,u,n)}else{var f=r.slice(0).concat(i);switch(c){case"object":b.call(a,e[i],n,t,f,a);break;case"array":O.call(a,e[i],n,t,f,a)&&m(r,i,a,u,n);break;default:n!==e[i]&&(e[i]=n,m(r,i,a,u,n))}}}),i>s)for(var c,u=s;u<=s;u++)c=e[u],E(r,u,a,c,!0);e.length=s}};return e.update=function(e,n,t){var r=o(e),a=o(n);if(r!==a)throw new Error("Proxy updates can't result in type changes");switch(a){case"array":O.call(e,e,n,function(e){return y(e,t)},[],e);break;case"object":b.call(e,e,n,function(e){return y(e,t)},[],e);break;default:throw new Error("unsupported realtime datatype:"+a)}},e}();return o.create=function(o){if(!i.isProxyable(o.data,!0))throw new Error("unsupported datatype: "+i.type(o.data));if("function"!=typeof(r=o.ChainPad||t.ChainPad).SmartJSONTransformer)throw new Error("Please update ChainPad");o.classic&&!o.crypto&&(console.error("[chainpad-listmap] no crypto module provided. messages will not be encrypted"),o.crypto={encrypt:function(e){return e},decrypt:function(e){return e}});var s=o.readOnly,c={initialState:n(o.data),patchTransformer:r.SmartJSONTransformer,validateContent:o.validateContent||function(e){try{return JSON.parse(e),!0}catch(n){return console.log(e),console.error("Failed to parse, rejecting patch"),!1}},readOnly:o.readOnly,userName:o.userName||"listmap",Cache:o.Cache,logLevel:void 0===o.logLevel?0:o.logLevel};o.classic&&(c.channel=o.channel,c.crypto=o.crypto,c.network=o.network,c.websocketURL=o.websocketURL,c.metadata=o.metadata||{validateKey:o.validateKey,owners:o.owners,expire:o.expire},c.onRejected=o.onRejected);var u,f,l,d={metadata:{}},h=!0,p=!1,v=a?i.stringifyFakeProxy:n,y=function(){var e=v(f);try{u.contentUpdate(e)}catch(e){f._events.error.forEach(function(n){n.cb({type:"CHAINPAD",error:e.message})})}o.onLocal&&o.onLocal()},m=c.onLocal=function(e){h||s||(clearTimeout(l),e?y():l=setTimeout(y))},g=function(){i.remoteChangeFlag||m()};f=i.create(o.data,g,!0),c.onInit=function(e){f._events.create.forEach(function(n){n.cb(e)})},c.onCacheReady=function(e){u&&u===e.realtime||(u=d.realtime=e.realtime);var n=u.getUserDoc(),t=JSON.parse(n);i.update(f,t,g),i.checkLocalChange(f,m),p||f._events.cacheready.forEach(function(n){n.cb(e)})};var E=0;c.onReady=function(e){if(E=-1,p)return h=!1,c.onRemote(),void f._events.reconnect.forEach(function(n){n.cb(e)});u&&u===e.realtime||(u=d.realtime=e.realtime),d.metadata=e.metadata;var n=u.getUserDoc(),t=JSON.parse(n);i.update(f,t,g),i.checkLocalChange(f,m),h=!1,p=!0,f._events.ready.forEach(function(n){n.cb(e)})},c.onRemote=function(){if(!h){var e=u.getUserDoc(),n=JSON.parse(e);i.remoteChangeFlag=!0,i.update(f,n,g),i.remoteChangeFlag=!1}},c.onMessage=function(){-1!==E&&o.updateProgress&&o.updateProgress({progress:E++})},c.onAbort=function(e){f._events.disconnect.forEach(function(n){n.cb(e)})},c.onConnectionChange=function(e){e.state?h=!0:f._events.disconnect.forEach(function(n){n.cb(e)})},c.onMetadataUpdate=function(e){d.metadata=e,"function"==typeof o.onMetadataUpdate&&o.onMetadataUpdate(e)},c.onError=function(e){f._events.error.forEach(function(n){n.cb(e)})},c.onChannelError=function(e){f._events.error.forEach(function(n){n.cb(e)})},o.common&&"function"==typeof o.common.startRealtime?u=d.cpCnInner=o.common.startRealtime(c):d=e.start(c),d.proxy=f,d.realtime=u;var b=d.setReadOnly;return d.setReadOnly=function(e,n){s=e,b&&b(e,n)},d},o}(D(),_()))}(i)),i.exports}var S,N=T(),I={exports:{}};function x(){return S||(S=1,function(e){var n,r,o,a;a=function(){var e=f,n=function(t,r,o){r||(r=0);var a=n.resolve(t,r),i=n.m[r][a];if(!i&&e){if(i=e(a))return i}else if(i&&i.c&&(r=i.c,a=i.m,!(i=n.m[r][i.m])))throw new Error('failed to require "'+a+'" from '+r);if(!i)throw new Error('failed to require "'+t+'" from '+o);return i.exports||(i.exports={},i.call(i.exports,i,i.exports,n.relative(a,r))),i.exports};return n.resolve=function(e,t){var r=e,o=e+".js",a=e+"/index.js";return n.m[t][o]&&o?o:n.m[t][a]&&a?a:r},n.relative=function(e,t){return function(r){if("."!=r.charAt(0))return n(r,t,e);var o=e.split("/"),a=r.split("/");o.pop();for(var i=0;i<a.length;i++){var s=a[i];".."==s?o.pop():"."!=s&&o.push(s)}return n(o.join("/"),t,e)}},n}(),a.m=[],a.m[0]={"json.sortify":{c:1,m:"dist/JSON.sortify.js"},"fast-diff":{c:2,m:"diff.js"},"Diff.js":function(e,n,t){var r=t("fast-diff");e.exports.diff=function(e,n){return t=r(e,n),o=[],a=0,i=!0,s={offset:0,toInsert:"",toRemove:0,type:"Operation"},t.forEach(function(e,n){0===e[0]?(i||(o.push(s),a=s.offset+s.toRemove,s={offset:a,toInsert:"",toRemove:0,type:"Operation"}),a+=e[1].length,s.offset=a):1===e[0]?s.toInsert=e[1]:s.toRemove=e[1].length,n===t.length-1&&0!==e[0]&&o.push(s),i&&(i=!1)}),o;var t,o,a,i,s}},"Patch.js":function(e,n,t){var r=t("./Common"),o=t("./Operation"),a=t("./sha256"),i=e.exports,s=i.create=function(e,n){var t=Object.freeze({type:"Patch",operations:[],parentHash:e,isCheckpoint:!!n,mut:{inverseOf:void 0}});return n&&(t.mut.inverseOf=t),t},c=i.check=function(e,n){r.assert("Patch"===e.type),r.assert(Array.isArray(e.operations)),r.assert(/^[0-9a-f]{64}$/.test(e.parentHash));for(var t=e.operations.length-1;t>=0;t--)o.check(e.operations[t],n),t>0&&r.assert(!o.shouldMerge(e.operations[t],e.operations[t-1])),"number"==typeof n&&(n+=o.lengthChange(e.operations[t]));return e.isCheckpoint&&(r.assert(1===e.operations.length),r.assert(0===e.operations[0].offset),"number"==typeof n&&r.assert(!n||e.operations[0].toRemove===n)),e};i.toObj=function(e){r.PARANOIA&&c(e);var n,t=new Array(e.operations.length+1);for(n=0;n<e.operations.length;n++)t[n]=o.toObj(e.operations[n]);return t[n]=e.parentHash,t},i.fromObj=function(e,n){r.assert(Array.isArray(e)&&e.length>0);var t,i=s(a.check(e[e.length-1]),n);for(t=0;t<e.length-1;t++)i.operations[t]=o.fromObj(e[t]);return r.PARANOIA&&c(i),i};var u=function(e){return a.hex_sha256(e)},f=i.addOperation=function(e,n){r.PARANOIA&&(c(e),o.check(n));for(var t=0;t<e.operations.length;t++)if(o.shouldMerge(e.operations[t],n)){var a=o.merge(e.operations[t],n);if(e.operations.splice(t,1),null===a)return;n=a,t--}else{var i=o.rebase(e.operations[t],n);if(i===n)return void e.operations.splice(t,0,n);n=i}e.operations.push(n),r.PARANOIA&&c(e)};i.createCheckpoint=function(e,n,t){var a=o.create(0,e.length,n);r.PARANOIA&&t&&r.assert(t===u(e)),t=t||u(e);var i=s(t,!0);return i.operations[0]=a,i};var l=i.clone=function(e){r.PARANOIA&&c(e);for(var n=s(e.parentHash,e.isCheckpoint),t=0;t<e.operations.length;t++)n.operations[t]=e.operations[t];return n};i.merge=function(e,n){if(r.PARANOIA&&(c(e),c(n)),e.isCheckpoint)return r.assert(n.parentHash===e.parentHash),n.isCheckpoint?s(e.parentHash):l(n);if(n.isCheckpoint)return l(e);e=l(e);for(var t=n.operations.length-1;t>=0;t--)f(e,n.operations[t]);return e},i.apply=function(e,n){r.PARANOIA&&(c(e),r.assert("string"==typeof n),r.assert(a.hex_sha256(n)===e.parentHash));for(var t=n,i=e.operations.length-1;i>=0;i--)t=o.apply(e.operations[i],t);return t},i.lengthChange=function(e){r.PARANOIA&&c(e);for(var n=0,t=0;t<e.operations.length;t++)n+=o.lengthChange(e.operations[t]);return n},i.invert=function(e,n){r.PARANOIA&&(c(e),r.assert("string"==typeof n),r.assert(a.hex_sha256(n)===e.parentHash));for(var t=n,i=new Array(e.operations.length),u=e.operations.length-1;u>=0;u--)i[u]=o.invert(e.operations[u],t),t=o.apply(e.operations[u],t);var f=new Array(e.operations.length);!function(){for(var e=i.length-1;e>=0;e--){f[e]=i[e].offset;for(var n=e-1;n>=0;n--)f[e]+=i[n].toRemove-i[n].toInsert.length}}();var l=s(a.hex_sha256(t),e.isCheckpoint);l.operations.splice(0,l.operations.length);for(var d=0;d<i.length;d++)l.operations[d]=o.create(f[d],i[d].toRemove,i[d].toInsert);return r.PARANOIA&&c(l),l},i.simplify=function(e,n,t){r.PARANOIA&&(c(e),r.assert("string"==typeof n),r.assert(a.hex_sha256(n)===e.parentHash));for(var i=s(e.parentHash),u=n,f=[],l=0,d=e.operations.length-1;d>=0;d--){var h=t(e.operations[d],u,o.simplify);h&&(u=o.apply(h,u),f[l++]=h)}return Array.prototype.push.apply(i.operations,f.reverse()),i.operations[0]||i.operations.shift(),r.PARANOIA&&c(i),i},i.equals=function(e,n){if(e.operations.length!==n.operations.length)return!1;for(var t=0;t<e.operations.length;t++)if(!o.equals(e.operations[t],n.operations[t]))return!1;return!0};var d=function(e,n){return 0===e.offset&&e.toRemove===n.length&&e.toInsert===n};i.transform=function(e,n,t,o){if(r.PARANOIA&&(c(e,t.length),c(n,t.length),a.hex_sha256(t)!==e.parentHash))throw new Error("wrong hash");if(e.parentHash!==n.parentHash)throw new Error;var u=i.apply(n,t),f=s(n.mut.inverseOf?n.mut.inverseOf.parentHash:a.hex_sha256(u),e.isCheckpoint);if(0===n.operations.length)return l(e);if(0===e.operations.length){if(e.isCheckpoint)throw new Error;return f}if(e.isCheckpoint||1===e.operations.length&&d(e.operations[0],t))throw new Error("Attempting to transform a checkpoint, this should not happen");if(1===n.operations.length&&d(n.operations[0],t)){if(!n.isCheckpoint)throw new Error;return e}if(n.isCheckpoint)throw new Error;var h=o(e.operations,n.operations,t);return Array.prototype.push.apply(f.operations,h),r.PARANOIA&&c(f,u.length),f},i.random=function(e,n){r.assert("string"==typeof e),n=n||Math.floor(30*Math.random())+1;for(var t=s(a.hex_sha256(e)),i=e.length;n-- >0;){var u=o.random(i);i+=o.lengthChange(u),f(t,u)}return c(t),t},Object.freeze(e.exports)},"SHA256.js":function(e,n,t){!function(){function n(e,n){var t=(65535&e)+(65535&n);return(e>>16)+(n>>16)+(t>>16)<<16|65535&t}function t(e,n){return e>>>n|e<<32-n}function r(e,n){return e>>>n}function o(e,n,t){return e&n^~e&t}function a(e,n,t){return e&n^e&t^n&t}function i(e){return t(e,2)^t(e,13)^t(e,22)}function s(e){return t(e,6)^t(e,11)^t(e,25)}function c(e){return t(e,7)^t(e,18)^r(e,3)}function u(e){return t(e,17)^t(e,19)^r(e,10)}e.exports.hex_sha256=function(e){return function(e){for(var n="0123456789abcdef",t="",r=0;r<4*e.length;r++)t+=n.charAt(e[r>>2]>>8*(3-r%4)+4&15)+n.charAt(e[r>>2]>>8*(3-r%4)&15);return t}(function(e,t){var r,f,l,d,h,p,v,y,m,g,E=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],b=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],O=function(e){for(var n=[];e>0;e--)n.push(void 0);return n}(64);e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var A=0;A<e.length;A+=16){r=b[0],f=b[1],l=b[2],d=b[3],h=b[4],p=b[5],v=b[6],y=b[7];for(var w=0;w<64;w++)O[w]=w<16?e[w+A]:n(n(n(u(O[w-2]),O[w-7]),c(O[w-15])),O[w-16]),m=n(n(n(n(y,s(h)),o(h,p,v)),E[w]),O[w]),g=n(i(r),a(r,f,l)),y=v,v=p,p=h,h=n(d,m),d=l,l=f,f=r,r=n(m,g);b[0]=n(r,b[0]),b[1]=n(f,b[1]),b[2]=n(l,b[2]),b[3]=n(d,b[3]),b[4]=n(h,b[4]),b[5]=n(p,b[5]),b[6]=n(v,b[6]),b[7]=n(y,b[7])}return b}(function(e){for(var n=Array(),t=0;t<8*e.length;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<24-t%32;return n}(e),8*e.length))}}()},"Common.js":function(e,n,r){e.exports.global=function(){if("undefined"!=typeof self)return self;if(void 0!==t)return t;if("undefined"!=typeof window)return window;throw new Error("no self, nor global, nor window")}();var o=function(n){return"undefined"!=typeof localStorage&&localStorage[n]?localStorage[n]:e.exports.global[n]},a=e.exports.PARANOIA=o("ChainPad_PARANOIA");e.exports.VALIDATE_ENTIRE_CHAIN_EACH_MSG=o("ChainPad_VALIDATE_ENTIRE_CHAIN_EACH_MSG"),e.exports.TESTING=o("ChainPad_TESTING"),e.exports.assert=function(e){if(!e)throw new Error("Failed assertion")},e.exports.isUint=function(e){return"number"==typeof e&&Math.floor(e)===e&&e>=0},e.exports.randomASCII=function(e){for(var n=[],t=0;t<e;t++)n[t]=String.fromCharCode(Math.floor(256*Math.random())%57+65);return n.join("")},e.exports.strcmp=function(e,n){if(a&&"string"!=typeof e)throw new Error;if(a&&"string"!=typeof n)throw new Error;return e===n?0:e>n?1:-1},Object.freeze(e.exports)},"sha256.js":function(e,n,t){var r=t("./sha256/exports.js"),o=t("./SHA256.js"),a=t("./Common");e.exports.check=function(e){if("string"!=typeof e)throw new Error;if(!/[a-f0-9]{64}/.test(e))throw new Error;return e},e.exports.hex_sha256=function(e){e+="";var n=r.hex(function(e){for(var n=new Uint8Array(e.length),t=0;t<e.length;t++)n[t]=255&e.charCodeAt(t);return n}(e));if(a.PARANOIA){var t=o.hex_sha256(e);if(t!==n){try{throw new Error}catch(n){console.log({hashErr:n,badHash:e,asmHasher:r.hex,oldHasher:o.hex_sha256})}return t}}return n},Object.freeze(e.exports)},"Message.js":function(e,n,t){var r=t("./Common"),o=t("./Patch"),a=t("./sha256"),i=e.exports,s=i.PATCH=2,c=i.CHECKPOINT=4,u=i.check=function(e){return r.assert("Message"===e.type),r.assert(e.messageType===s||e.messageType===c),o.check(e.content),r.assert("string"==typeof e.lastMsgHash),e},f=i.create=function(e,n,t){var o={type:"Message",messageType:e,content:n,lastMsgHash:t,hashOf:"",mut:{parentCount:void 0,isInitialMessage:!1,isFromMe:!1,parent:void 0,time:void 0,author:void 0,serverHash:void 0}};return o.hashOf=d(o),r.PARANOIA&&u(o),Object.freeze(o)},l=i.toStr=i.toString=function(e){if(r.PARANOIA&&u(e),e.messageType===s||e.messageType===c){if(!e.content)throw new Error;return JSON.stringify([e.messageType,o.toObj(e.content),e.lastMsgHash])}throw new Error};i.fromString=function(e){var n={};"object"==typeof e&&(n=e,e=e.msg);var t=JSON.parse(e);if(t[0]!==c&&t[0]!==s)throw new Error("invalid message type "+t[0]);var r=f(t[0],o.fromObj(t[1],t[0]===c),t[2]);return r.mut.author=n.author,r.mut.time=n.time&&new Date(n.time),r.mut.serverHash=n.serverHash,Object.freeze(r)};var d=i.hashOf=function(e){return r.PARANOIA&&u(e),a.hex_sha256(l(e))};Object.freeze(e.exports)},"ChainPad.js":function(e,n,t){var r=e.exports.Common=t("./Common"),o=e.exports.Operation=t("./Operation"),a=e.exports.Patch=t("./Patch"),i=e.exports.Message=t("./Message"),s=e.exports.Sha=t("./sha256"),c=e.exports.Diff=t("./Diff"),u=e.exports.TextTransformer=t("./transform/TextTransformer");e.exports.NaiveJSONTransformer=t("./transform/NaiveJSONTransformer"),e.exports.SmartJSONTransformer=t("./transform/SmartJSONTransformer");var f=e.exports.EMPTY_STR_HASH="e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",l=function(e,n){e.logLevel>1&&console.log("["+e.userName+"]  "+n)},d=function(e,n){e.logLevel>0&&console.error("["+e.userName+"]  "+n)},h=function(e,n,t){if(!e.aborted){t||(t=Math.floor(2*Math.random()*e.config.avgSyncMilliseconds));var r=setTimeout(function(){e.schedules.splice(e.schedules.indexOf(r),1),n()},t);return e.schedules.push(r),r}},p=function(e,n){var t=e.schedules.indexOf(n);t>-1&&e.schedules.splice(t,1),clearTimeout(n)},v=function(e,n,t,o){var a=i.toStr(n);if(function(e,n,t){e.messageHandlers.length||t("no onMessage() handler registered");try{e.messageHandlers.forEach(function(e){e(n,function(){t.apply(null,arguments),t=function(){}})})}catch(e){t(e.stack)}}(e,a,function(t){if(t)l(e,"Posting to server failed ["+t+"]"),e.pending=null,e.syncSchedule=h(e,function(){g(e)});else{var o=e.pending;if(e.pending=null,!o)throw new Error;r.assert(o.hash===n.hashOf),R(e,a,!0)?(e.timeOfLastSuccess=+new Date,e.lag=+new Date-o.timeSent):l(e,"Our message ["+n.hashOf+"] failed validation"),o.callback()}}),e.pending)throw new Error("there is already a pending message");-1===e.timeOfLastSuccess&&(e.timeOfLastSuccess=+new Date),e.pending={hash:n.hashOf,timeSent:+new Date,callback:function(){e.syncSchedule=h(e,function(){g(e)},0),t()}},r.PARANOIA&&A(e)},y=function(e){var n=e.onSettle;e.onSettle=[],n.forEach(function(n){try{n()}catch(n){d(e,"Error in onSettle handler ["+n.stack+"]")}})},m=function(e){if(!e.mut.inverseOf)throw new Error;return e.mut.inverseOf},g=function(e,n){if(r.PARANOIA&&A(e),e.syncSchedule&&!e.pending){if(p(e,e.syncSchedule),e.syncSchedule=null,e.uncommitted=a.simplify(e.uncommitted,e.authDoc,e.config.operationSimplify),0===e.uncommitted.operations.length)return y(e),e.timeOfLastSuccess=+new Date,void(e.syncSchedule=h(e,function(){g(e)}));var t=_(e,e.best)+1;if(t%e.config.checkpointInterval!==0){var o;o=e.setContentPatch?e.setContentPatch:i.create(i.PATCH,e.uncommitted,e.best.hashOf),v(e,o,function(){e.setContentPatch&&(l(e,"initial Ack received ["+o.hashOf+"]"),e.setContentPatch=null)})}else{var s=e.best;if(l(e,"Sending checkpoint (interval ["+e.config.checkpointInterval+"]) patch no ["+t+"]"),l(e,_(e,e.best)),!s||!s.content||!m(s.content))throw new Error;var c=a.createCheckpoint(e.authDoc,e.authDoc,m(s.content).parentHash),u=i.create(i.CHECKPOINT,c,s.hashOf);v(e,u,function(){l(e,"Checkpoint sent and accepted")})}}},E=function(e,n){r.assert(n.lastMsgHash),r.assert(n.hashOf),e.messages[n.hashOf]=n,(e.messagesByParent[n.lastMsgHash]=e.messagesByParent[n.lastMsgHash]||[]).push(n)},b=function(e,n){r.assert(n.lastMsgHash),r.assert(n.hashOf),delete e.messages[n.hashOf];var t=e.messagesByParent[n.lastMsgHash];r.assert(t.indexOf(n)>-1),t.splice(t.indexOf(n),1),0===t.length&&delete e.messagesByParent[n.lastMsgHash];var o=e.messagesByParent[n.hashOf];if(o)for(var a=0;a<o.length;a++)delete o[a].mut.parent},O=function(e,n){return n.mut.parent=n.mut.parent||e.messages[n.lastMsgHash]},A=function(e){r.assert("ChainPad"===e.type),r.assert("string"==typeof e.authDoc),a.check(e.uncommitted,e.authDoc.length);var n=a.apply(e.uncommitted,e.authDoc);if(r.assert(n.length===w(e)),""!==e.userInterfaceContent&&r.assert(n===e.userInterfaceContent),r.VALIDATE_ENTIRE_CHAIN_EACH_MSG){var t=e.authDoc,o=e.best;r.assert(m(o.content).parentHash===e.uncommitted.parentHash);var i=[];do{i.push(o),t=a.apply(m(o.content),t)}while(o=O(e,o));if(e.rootMessage.content.isCheckpoint){if(t!==e.rootMessage.content.operations[0].toInsert)throw new Error}else if(""!==t)throw new Error;for(;o=i.pop();)t=a.apply(o.content,t);r.assert(t===e.authDoc)}},w=function(e){return e.authDoc.length+a.lengthChange(e.uncommitted)},D=function(e,n,t){if(!n)return!1;for(;;){if(!t)return!1;if(n===t)return!0;t=O(e,t)}},_=function(e,n){if("number"==typeof n.mut.parentCount)return n.mut.parentCount;for(var t=[];"number"!=typeof n.mut.parentCount;n=O(e,n)){if(!n){if(n===e.rootMessage)throw new Error("root message does not have parent count");throw new Error("parentCount called on unlinked message")}t.unshift(n)}for(var r=n.mut.parentCount,o=0;o<t.length;o++)t[o].mut.parentCount=++r;return r},T=function(e,n,t){var o;if(r.assert(t),n)r.assert(t.parentHash===e.uncommitted.parentHash),e.uncommitted=a.merge(m(t),e.uncommitted);else if(e.uncommitted=a.transform(e.uncommitted,t,e.authDoc,e.config.patchTransformer),e.config.validateContent){o=a.apply(t,e.authDoc);var i=a.apply(e.uncommitted,o);e.config.validateContent(i)||(d(e,"Transformed patch is not valid"),e.uncommitted=a.create(s.hex_sha256(e.authDoc)))}r.assert(e.uncommitted.parentHash===m(t).parentHash),e.authDoc=o||a.apply(t,e.authDoc),r.PARANOIA&&(r.assert(e.uncommitted.parentHash===m(t).parentHash),r.assert(s.hex_sha256(e.authDoc)===e.uncommitted.parentHash),e.userInterfaceContent=a.apply(e.uncommitted,e.authDoc))},S=function(e,n){var t=n;return(e.messagesByParent[n.hashOf]||[]).forEach(function(o){r.assert(o.lastMsgHash===n.hashOf),o=S(e,o),_(e,o)>_(e,t)&&(t=o)}),t},N=function(e,n){n.operations.length&&(e.patchHandlers.forEach(function(e){e(n)}),e.changeHandlers.forEach(function(e){n.operations.forEach(function(n){e(n.offset,n.toRemove,n.toInsert)})}))},I=function(e,n){try{return e.config.validateContent(n())}catch(n){d(e,"Error in content validator ["+n.stack+"]")}return!1},x=function(e,n,t){for(var r=O(e,n);r;r=O(e,r))if(!1===t(r))return},C=function(e,n){e.mut.inverseOf||((e.mut.inverseOf=a.invert(e,n)).mut.inverseOf=e)},R=function(e,n,t){r.PARANOIA&&A(e);var c=i.fromString(n);if(l(e,JSON.stringify([c.hashOf,c.content.operations])),e.messages[c.hashOf]){if(e.setContentPatch&&e.setContentPatch.hashOf===c.hashOf)e.setContentPatch=null;else{if(c.content.isCheckpoint)return l(e,"["+(t?"our":"their")+"] Checkpoint ["+c.hashOf+"] is already known"),!0;l(e,"Patch ["+c.hashOf+"] is already known")}r.PARANOIA&&A(e)}else if(!c.content.isCheckpoint||I(e,function(){return c.content.operations[0].toInsert})){if(E(e,c),!D(e,e.rootMessage,c)){if(c.content.isCheckpoint&&e.best.mut.isInitialMessage){l(e,"applying checkpoint ["+c.hashOf+"]");var u=a.apply(e.uncommitted,e.authDoc);r.assert(!r.PARANOIA||e.userInterfaceContent===u);var f=a.invert(e.uncommitted,e.authDoc);return a.addOperation(f,o.create(0,e.authDoc.length,c.content.operations[0].toInsert)),f=a.simplify(f,u,e.config.operationSimplify),c.mut.parentCount=0,e.rootMessage=e.best=c,e.authDoc=c.content.operations[0].toInsert,e.uncommitted=a.create(s.hex_sha256(e.authDoc)),N(e,f),r.PARANOIA&&(e.userInterfaceContent=e.authDoc),!0}return l(e,"Patch ["+c.hashOf+"] not connected to root (parent: ["+c.lastMsgHash+"])"),void(r.PARANOIA&&A(e))}(c=S(e,c)).mut.isFromMe=t;var d=c.content,h=[],p=e.best;if(!D(e,e.best,c)){var v=_(e,e.best),g=_(e,c);if(!(v<g||v===g&&r.strcmp(e.best.hashOf,c.hashOf)>0))return l(e,"Patch ["+c.hashOf+"] chain is ["+g+"] best chain is ["+v+"]"),r.PARANOIA&&A(e),!0;for(;p&&!D(e,p,c);)h.push(p),p=O(e,p);r.assert(p),l(e,"Patch ["+c.hashOf+"] better than best chain, switching")}var R=[],P=c;do{R.unshift(P),P=O(e,P),r.assert(P)}while(P!==p);var k=e.authDoc;h.forEach(function(e){k=a.apply(m(e.content),k)}),R.forEach(function(e,n){n!==R.length-1&&(C(e.content,k),k=a.apply(e.content,k))});var M=e.best;if(R.length>1?(M=R[R.length-2],r.assert(M)):h.length&&(M=O(e,h[h.length-1]),r.assert(M)),r.assert(m(M.content).parentHash),r.assert(!r.PARANOIA||m(M.content).parentHash===s.hex_sha256(k)),m(M.content).parentHash===d.parentHash){if(d.isCheckpoint&&e.config.noPrune);else if(d.isCheckpoint){var F;if(x(e,c,function(e){if(e.content.isCheckpoint){if(F)return F=e,!1;F=e}}),F&&F!==e.rootMessage){var L=_(e,F);if(e.config.strictCheckpointValidation&&L%e.config.checkpointInterval!==0){if(l(e,"checkpoint ["+c.hashOf+"] at invalid point ["+L+"]"),r.PARANOIA&&A(e),r.TESTING)throw new Error;return void b(e,c)}l(e,"checkpoint ["+c.hashOf+"]"),x(e,F,function(n){l(e,"pruning ["+n.hashOf+"]"),b(e,n)}),e.rootMessage=F}}else{var H=a.simplify(d,k,e.config.operationSimplify);if(!a.equals(H,d)){if(l(e,"patch ["+c.hashOf+"] can be simplified"),r.PARANOIA&&A(e),r.TESTING)throw new Error;return void b(e,c)}if(!I(e,function(){return a.apply(d,k)}))return void l(e,"Patch ["+c.hashOf+"] failed content validation")}C(d,k),e.uncommitted=a.simplify(e.uncommitted,e.authDoc,e.config.operationSimplify);var j=a.apply(e.uncommitted,e.authDoc);r.PARANOIA&&r.assert(j===e.userInterfaceContent);var K=a.invert(e.uncommitted,e.authDoc);if(h.forEach(function(n){l(e,"reverting ["+n.hashOf+"]"),n.mut.isFromMe&&l(e,"reverting patch 'from me' ["+JSON.stringify(n.content.operations)+"]"),K=a.merge(K,m(n.content)),function(e,n,t){T(e,n,m(t))}(e,n.mut.isFromMe,n.content)}),R.forEach(function(n){l(e,"applying ["+n.hashOf+"]"),K=a.merge(K,n.content),T(e,n.mut.isFromMe,n.content)}),K=a.merge(K,e.uncommitted),K=a.simplify(K,j,e.config.operationSimplify),e.best=c,r.PARANOIA){var U=a.apply(K,j);r.assert(e.userInterfaceContent.length===w(e)),r.assert(U===e.userInterfaceContent)}return N(e,K),e.uncommitted.operations.length||y(e),r.PARANOIA&&A(e),!0}if(l(e,"patch ["+c.hashOf+"] parentHash is not valid"),r.PARANOIA&&A(e),r.TESTING)throw new Error;b(e,c)}else l(e,"Checkpoint ["+c.hashOf+"] failed content validation")},P=function(e,n){return Object.freeze({type:"Block",hashOf:n.hashOf,lastMsgHash:n.lastMsgHash,isCheckpoint:!!n.content.isCheckpoint,isFromMe:n.mut&&n.mut.isFromMe,author:n.mut&&n.mut.author,serverHash:n.mut&&n.mut.serverHash,time:n.mut&&n.mut.time,getParent:function(){var t=O(e,n);if(t)return P(e,t)},getContent:function(){return function(e,n){for(var t=[n];t[0]!==e.rootMessage;){var o=O(e,t[0]);if(!o)return{error:"not connected to root",doc:void 0};t.unshift(o)}var i="";e.rootMessage.content.operations.length&&(r.assert(1===e.rootMessage.content.operations.length),i=e.rootMessage.content.operations[0].toInsert);for(var s=1;s<t.length;s++)i=a.apply(t[s].content,i);return{error:void 0,doc:i}}(e,n)},getPatch:function(){return a.clone(n.content)},getInversePatch:function(){return a.clone(m(n.content))},equals:function(e,t){return t?n===t:!(!e||"object"!=typeof e||"Block"!==e.type)&&e.equals(e,n)}})};e.exports.create=function(e){var n=function(e){var n=a.create(f);C(n,"");var t=i.create(i.PATCH,n,"0000000000000000000000000000000000000000000000000000000000000000");t.mut.parentCount=0,t.mut.isInitialMessage=!0;var r,s=t;if(""!==e.initialState){var c=a.create(f);a.addOperation(c,o.create(0,0,e.initialState)),C(c,""),(r=i.create(i.PATCH,c,t.hashOf)).mut.isInitialMessage=!0,s=r}var u={type:"ChainPad",authDoc:e.initialState,config:e,logLevel:e.logLevel,uncommitted:a.create(m(s.content).parentHash),patchHandlers:[],changeHandlers:[],messageHandlers:[],schedules:[],aborted:!1,syncSchedule:-2,userInterfaceContent:e.initialState,setContentPatch:r,pending:void 0,messages:{},messagesByParent:{},rootMessage:t,onSettle:[],userName:e.userName,best:s,lag:0,timeOfLastSuccess:-1};return E(u,t),r&&E(u,r),u}(function(e){if((e=e||{}).transformFunction)throw new Error("chainpad config transformFunction is nolonger used");return Object.freeze({initialState:e.initialState||"",checkpointInterval:e.checkpointInterval||50,avgSyncMilliseconds:e.avgSyncMilliseconds||300,strictCheckpointValidation:e.strictCheckpointValidation||!1,operationSimplify:e.operationSimplify||o.simplify,logLevel:"number"==typeof e.logLevel?e.logLevel:2,noPrune:e.noPrune,patchTransformer:e.patchTransformer||u,userName:e.userName||"anonymous",validateContent:e.validateContent||function(e){return!0},diffFunction:e.diffFunction||function(e,n){return c.diff(e,n)}})}(e)),t={onPatch:function(e){r.assert("function"==typeof e),n.patchHandlers.push(e)},patch:function(e,o,i){if("number"!=typeof e)!function(e,n){r.PARANOIA&&(A(e),r.assert(a.invert(e.uncommitted,e.authDoc).parentHash===n.parentHash),e.userInterfaceContent=a.apply(n,e.userInterfaceContent)),a.check(n,w(e)),e.uncommitted=a.merge(e.uncommitted,n)}(n,e);else{if("number"!=typeof o||"string"!=typeof i)throw new Error;t.change(e,o,i)}},onChange:function(e){r.assert("function"==typeof e),n.changeHandlers.push(e)},change:function(e,t,i){0===t&&""===i||function(e,n){r.PARANOIA&&(A(e),e.userInterfaceContent=o.apply(n,e.userInterfaceContent)),o.check(n,w(e)),a.addOperation(e.uncommitted,n)}(n,o.create(e,t,i))},contentUpdate:function(e){var t=n.config.diffFunction(n.authDoc,e),r=a.create(n.uncommitted.parentHash);Array.prototype.push.apply(r.operations,t),n.uncommitted=r},onMessage:function(e){r.assert("function"==typeof e),n.messageHandlers.push(e)},message:function(e){R(n,e,!1)},start:function(){n.aborted=!1,n.syncSchedule&&p(n,n.syncSchedule),n.pending=null,n.syncSchedule=h(n,function(){g(n)})},abort:function(){n.aborted=!0,n.schedules.forEach(function(e){clearTimeout(e)})},sync:function(){g(n)},getAuthDoc:function(){return n.authDoc},getUserDoc:function(){return a.apply(n.uncommitted,n.authDoc)},getDepthOfState:function(e,t){return function(e,n,t){if(r.assert("string"==typeof e),0===(n=n||0)&&t.authDoc===e)return 0;var o=s.hex_sha256(e),a=t.best,i=0;do{if(i<n);else if(a.content.parentHash===o)return i+1;i++}while(a=O(t,a));return-1}(e,t,n)},onSettle:function(e){r.assert("function"==typeof e),n.onSettle.push(e)},getAuthBlock:function(){return P(n,n.best)},getBlockForHash:function(e){r.assert("string"==typeof e);var t=n.messages[e];if(t)return P(n,t)},getLag:function(){var e=!!n.pending,t=n.lag;return n.pending&&(t=+new Date-n.timeOfLastSuccess),{pending:e,lag:t,active:!n.aborted&&-2!==n.syncSchedule}},_:void 0};return t._=n,Object.freeze(t)},Object.freeze(e.exports)},"Operation.js":function(e,n,t){var r=t("./Common"),o=e.exports,a=o.check=function(e,n){if(r.assert("Operation"===e.type),!r.isUint(e.offset))throw new Error;if(!r.isUint(e.toRemove))throw new Error;if("string"!=typeof e.toInsert)throw new Error;if(e.toRemove<1&&e.toInsert.length<1)throw new Error;return r.assert("number"!=typeof n||e.offset+e.toRemove<=n),e},i=o.create=function(e,n,t){var o={type:"Operation",offset:e||0,toRemove:n||0,toInsert:t||""};return r.PARANOIA&&a(o),Object.freeze(o)};o.toObj=function(e){return r.PARANOIA&&a(e),[e.offset,e.toRemove,e.toInsert]},o.fromObj=function(e){return r.assert(Array.isArray(e)&&3===e.length),i(e[0],e[1],e[2])};var s=o.apply=function(e,n){return r.PARANOIA&&(r.assert("string"==typeof n),a(e,n.length)),n.substring(0,e.offset)+e.toInsert+n.substring(e.offset+e.toRemove)};o.applyMulti=function(e,n){for(var t=e.length-1;t>=0;t--)n=s(e[t],n);return n};var c=o.invert=function(e,n){return r.PARANOIA&&(a(e),r.assert("string"==typeof n),r.assert(e.offset+e.toRemove<=n.length)),i(e.offset,e.toInsert.length,(" "+n.substring(e.offset,e.offset+e.toRemove)).slice(1))},u=/[\uD800-\uDBFF]|[\uDC00-\uDFFF]/,f=o.hasSurrogate=function(e){return u.test(e)};o.simplify=function(e,n){r.PARANOIA&&(a(e),r.assert("string"==typeof n),r.assert(e.offset+e.toRemove<=n.length));for(var t=c(e,n),o=Math.min(e.toInsert.length,t.toInsert.length),s=0;s<o&&t.toInsert[s]===e.toInsert[s];){if(f(t.toInsert[s])||f(e.toInsert[s])){if(e.toInsert[s+1]!==t.toInsert[s+1])break;s++}s++}var u=e.offset+s,l=e.toRemove-s,d=e.toInsert.substring(s),h=t.toInsert.substring(s);if(h.length===d.length){for(s=h.length-1;s>=0&&h[s]===d[s];s--);d=d.substring(0,s+1),l=s+1}return 0===l&&0===d.length?null:i(u,l,d)},o.equals=function(e,n){return e.toRemove===n.toRemove&&e.toInsert===n.toInsert&&e.offset===n.offset},o.lengthChange=function(e){return r.PARANOIA&&a(e),e.toInsert.length-e.toRemove},o.merge=function(e,n){r.PARANOIA&&(a(n),a(e));var t=e.offset,o=e.toRemove,s=e.toInsert,c=n.offset,u=n.toRemove,f=n.toInsert,l=c-t;if(u>0){var d=s;s=s.substring(0,l)+s.substring(l+u),(u-=d.length-s.length)<0&&(u=0),o+=u,u=0}if(l<0)t+=l,s=f+s;else if(s.length===l)s+=f;else{if(!(s.length>l))throw new Error("should never happen\n"+JSON.stringify([e,n],null,"  "));s=s.substring(0,l)+f+s.substring(l)}return""===s&&0===o?null:i(t,o,s)},o.shouldMerge=function(e,n){return r.PARANOIA&&(a(e),a(n)),n.offset<e.offset?e.offset<=n.offset+n.toRemove:n.offset<=e.offset+e.toInsert.length},o.rebase=function(e,n){return r.PARANOIA&&(a(e),a(n)),n.offset<e.offset?n:i(n.offset+e.toRemove-e.toInsert.length,n.toRemove,n.toInsert)},o.random=function(e){r.assert(r.isUint(e));var n=Math.floor(1e8*Math.random()%e)||0,t=Math.floor(1e8*Math.random()%(e-n))||0,o="";do{o=r.randomASCII(Math.floor(20*Math.random()))}while(0===t&&""===o);return i(n,t,o)},Object.freeze(e.exports)},"sha256/hash.js":function(e,n,t){var r=t("./utils.js");e.exports.hash_reset=function(){return this.result=null,this.pos=0,this.len=0,this.asm.reset(),this},e.exports.hash_process=function(e){if(null!==this.result)throw new IllegalStateError("state must be reset before processing new data");if(r.is_string(e)&&(e=r.string_to_bytes(e)),r.is_buffer(e)&&(e=new Uint8Array(e)),!r.is_bytes(e))throw new TypeError("data isn't of expected type");for(var n=this.asm,t=this.heap,o=this.pos,a=this.len,i=0,s=e.length,c=0;s>0;)a+=c=r._heap_write(t,o+a,e,i,s),i+=c,s-=c,o+=c=n.process(o,a),(a-=c)||(o=0);return this.pos=o,this.len=a,this},e.exports.hash_finish=function(){if(null!==this.result)throw new IllegalStateError("state must be reset before processing new data");return this.asm.finish(this.pos,this.len,0),this.result=new Uint8Array(this.HASH_SIZE),this.result.set(this.heap.subarray(0,this.HASH_SIZE)),this.pos=0,this.len=0,this}},"sha256/utils.js":function(e,n,t){var r=e.exports.string_to_bytes=function(e,n){n=!!n;for(var t=e.length,r=new Uint8Array(n?4*t:t),o=0,a=0;o<t;o++){var i=e.charCodeAt(o);if(n&&55296<=i&&i<=56319){if(++o>=t)throw new Error("Malformed string, low surrogate expected at position "+o);i=(55296^i)<<10|65536|56320^e.charCodeAt(o)}else if(!n&&i>>>8)throw new Error("Wide characters are not allowed.");!n||i<=127?r[a++]=i:i<=2047?(r[a++]=192|i>>6,r[a++]=128|63&i):i<=65535?(r[a++]=224|i>>12,r[a++]=128|i>>6&63,r[a++]=128|63&i):(r[a++]=240|i>>18,r[a++]=128|i>>12&63,r[a++]=128|i>>6&63,r[a++]=128|63&i)}return r.subarray(0,a)};e.exports.hex_to_bytes=function(e){var n=e.length;1&n&&(e="0"+e,n++);for(var t=new Uint8Array(n>>1),r=0;r<n;r+=2)t[r>>1]=parseInt(e.substr(r,2),16);return t},e.exports.base64_to_bytes=function(e){return r(atob(e))};var o=e.exports.bytes_to_string=function(e,n){n=!!n;for(var t=e.length,r=new Array(t),o=0,a=0;o<t;o++){var i=e[o];if(!n||i<128)r[a++]=i;else if(i>=192&&i<224&&o+1<t)r[a++]=(31&i)<<6|63&e[++o];else if(i>=224&&i<240&&o+2<t)r[a++]=(15&i)<<12|(63&e[++o])<<6|63&e[++o];else{if(!(i>=240&&i<248&&o+3<t))throw new Error("Malformed UTF8 character at byte offset "+o);var s=(7&i)<<18|(63&e[++o])<<12|(63&e[++o])<<6|63&e[++o];s<=65535?r[a++]=s:(s^=65536,r[a++]=55296|s>>10,r[a++]=56320|1023&s)}}for(var c="",u=16384,f=0;f<a;f+=u)c+=String.fromCharCode.apply(String,r.slice(f,f+u<=a?f+u:a));return c};e.exports.bytes_to_hex=function(e){for(var n="",t=0;t<e.length;t++){var r=(255&e[t]).toString(16);r.length<2&&(n+="0"),n+=r}return n},e.exports.bytes_to_base64=function(e){return btoa(o(e))},e.exports.pow2_ceil=function(e){return e-=1,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e+=1},e.exports.is_number=function(e){return"number"==typeof e},e.exports.is_string=function(e){return"string"==typeof e},e.exports.is_buffer=function(e){return e instanceof ArrayBuffer},e.exports.is_bytes=function(e){return e instanceof Uint8Array},e.exports.is_typed_array=function(e){return e instanceof Int8Array||e instanceof Uint8Array||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array},e.exports._heap_init=function(e,n){var t=n.heap,r=t?t.byteLength:n.heapSize||65536;if(4095&r||r<=0)throw new Error("heap size must be a positive integer and a multiple of 4096");return t=t||new e(new ArrayBuffer(r))},e.exports._heap_write=function(e,n,t,r,o){var a=e.length-n,i=a<o?a:o;return e.set(t.subarray(r,r+i),n),i}},"sha256/sha256.js":function(e,n,t){var r=t("./utils.js"),o=t("./hash.js"),a=t("./sha256.asm.js");function i(e){e=e||{},this.heap=r._heap_init(Uint8Array,e),this.asm=e.asm||a.sha256_asm({Uint8Array},null,this.heap.buffer),this.BLOCK_SIZE=64,this.HASH_SIZE=32,this.reset()}i.BLOCK_SIZE=64,i.HASH_SIZE=32;var s=i.prototype;s.reset=o.hash_reset,s.process=o.hash_process,s.finish=o.hash_finish;var c=null;e.exports.get_sha256_instance=function(){return null===c&&(c=new i({heapSize:1048576})),c},e.exports.sha256_constructor=i},"sha256/exports.js":function(e,n,t){var r=t("./sha256.js"),o=t("./utils.js");function a(e){if(void 0===e)throw new SyntaxError("data required");return r.get_sha256_instance().reset().process(e).finish().result}r.sha256_constructor.bytes=a,r.sha256_constructor.hex=function(e){var n=a(e);return o.bytes_to_hex(n)},r.sha256_constructor.base64=function(e){var n=a(e);return o.bytes_to_base64(n)},e.exports=r.sha256_constructor},"sha256/sha256.asm.js":function(e,n,t){e.exports.sha256_asm=function(e,n,t){"use asm";var r=0,o=0,a=0,i=0,s=0,c=0,u=0,f=0,l=0,d=0;var h=0,p=0,v=0,y=0,m=0,g=0,E=0,b=0,O=0,A=0,w=0,D=0,_=0,T=0,S=0,N=0;var I=new e.Uint8Array(t);function x(e,n,t,l,d,h,p,v,y,m,g,E,b,O,A,w){e=e|0;n=n|0;t=t|0;l=l|0;d=d|0;h=h|0;p=p|0;v=v|0;y=y|0;m=m|0;g=g|0;E=E|0;b=b|0;O=O|0;A=A|0;w=w|0;var D=0,_=0,T=0,S=0,N=0,I=0,x=0,C=0,R=0;D=r;_=o;T=a;S=i;N=s;I=c;x=u;C=f;R=e+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x428a2f98|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=n+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x71374491|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=t+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xb5c0fbcf|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=l+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xe9b5dba5|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=d+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x3956c25b|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=h+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x59f111f1|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=p+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x923f82a4|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=v+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xab1c5ed5|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=y+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xd807aa98|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=m+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x12835b01|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=g+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x243185be|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=E+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x550c7dc3|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=b+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x72be5d74|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=O+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x80deb1fe|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=A+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x9bdc06a7|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;R=w+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xc19bf174|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;e=R=(n>>>7^n>>>18^n>>>3^n<<25^n<<14)+(A>>>17^A>>>19^A>>>10^A<<15^A<<13)+e+m|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xe49b69c1|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;n=R=(t>>>7^t>>>18^t>>>3^t<<25^t<<14)+(w>>>17^w>>>19^w>>>10^w<<15^w<<13)+n+g|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xefbe4786|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;t=R=(l>>>7^l>>>18^l>>>3^l<<25^l<<14)+(e>>>17^e>>>19^e>>>10^e<<15^e<<13)+t+E|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x0fc19dc6|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;l=R=(d>>>7^d>>>18^d>>>3^d<<25^d<<14)+(n>>>17^n>>>19^n>>>10^n<<15^n<<13)+l+b|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x240ca1cc|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;d=R=(h>>>7^h>>>18^h>>>3^h<<25^h<<14)+(t>>>17^t>>>19^t>>>10^t<<15^t<<13)+d+O|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x2de92c6f|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;h=R=(p>>>7^p>>>18^p>>>3^p<<25^p<<14)+(l>>>17^l>>>19^l>>>10^l<<15^l<<13)+h+A|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x4a7484aa|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;p=R=(v>>>7^v>>>18^v>>>3^v<<25^v<<14)+(d>>>17^d>>>19^d>>>10^d<<15^d<<13)+p+w|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x5cb0a9dc|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;v=R=(y>>>7^y>>>18^y>>>3^y<<25^y<<14)+(h>>>17^h>>>19^h>>>10^h<<15^h<<13)+v+e|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x76f988da|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;y=R=(m>>>7^m>>>18^m>>>3^m<<25^m<<14)+(p>>>17^p>>>19^p>>>10^p<<15^p<<13)+y+n|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x983e5152|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;m=R=(g>>>7^g>>>18^g>>>3^g<<25^g<<14)+(v>>>17^v>>>19^v>>>10^v<<15^v<<13)+m+t|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xa831c66d|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;g=R=(E>>>7^E>>>18^E>>>3^E<<25^E<<14)+(y>>>17^y>>>19^y>>>10^y<<15^y<<13)+g+l|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xb00327c8|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;E=R=(b>>>7^b>>>18^b>>>3^b<<25^b<<14)+(m>>>17^m>>>19^m>>>10^m<<15^m<<13)+E+d|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xbf597fc7|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;b=R=(O>>>7^O>>>18^O>>>3^O<<25^O<<14)+(g>>>17^g>>>19^g>>>10^g<<15^g<<13)+b+h|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xc6e00bf3|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;O=R=(A>>>7^A>>>18^A>>>3^A<<25^A<<14)+(E>>>17^E>>>19^E>>>10^E<<15^E<<13)+O+p|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xd5a79147|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;A=R=(w>>>7^w>>>18^w>>>3^w<<25^w<<14)+(b>>>17^b>>>19^b>>>10^b<<15^b<<13)+A+v|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x06ca6351|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;w=R=(e>>>7^e>>>18^e>>>3^e<<25^e<<14)+(O>>>17^O>>>19^O>>>10^O<<15^O<<13)+w+y|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x14292967|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;e=R=(n>>>7^n>>>18^n>>>3^n<<25^n<<14)+(A>>>17^A>>>19^A>>>10^A<<15^A<<13)+e+m|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x27b70a85|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;n=R=(t>>>7^t>>>18^t>>>3^t<<25^t<<14)+(w>>>17^w>>>19^w>>>10^w<<15^w<<13)+n+g|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x2e1b2138|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;t=R=(l>>>7^l>>>18^l>>>3^l<<25^l<<14)+(e>>>17^e>>>19^e>>>10^e<<15^e<<13)+t+E|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x4d2c6dfc|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;l=R=(d>>>7^d>>>18^d>>>3^d<<25^d<<14)+(n>>>17^n>>>19^n>>>10^n<<15^n<<13)+l+b|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x53380d13|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;d=R=(h>>>7^h>>>18^h>>>3^h<<25^h<<14)+(t>>>17^t>>>19^t>>>10^t<<15^t<<13)+d+O|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x650a7354|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;h=R=(p>>>7^p>>>18^p>>>3^p<<25^p<<14)+(l>>>17^l>>>19^l>>>10^l<<15^l<<13)+h+A|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x766a0abb|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;p=R=(v>>>7^v>>>18^v>>>3^v<<25^v<<14)+(d>>>17^d>>>19^d>>>10^d<<15^d<<13)+p+w|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x81c2c92e|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;v=R=(y>>>7^y>>>18^y>>>3^y<<25^y<<14)+(h>>>17^h>>>19^h>>>10^h<<15^h<<13)+v+e|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x92722c85|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;y=R=(m>>>7^m>>>18^m>>>3^m<<25^m<<14)+(p>>>17^p>>>19^p>>>10^p<<15^p<<13)+y+n|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xa2bfe8a1|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;m=R=(g>>>7^g>>>18^g>>>3^g<<25^g<<14)+(v>>>17^v>>>19^v>>>10^v<<15^v<<13)+m+t|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xa81a664b|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;g=R=(E>>>7^E>>>18^E>>>3^E<<25^E<<14)+(y>>>17^y>>>19^y>>>10^y<<15^y<<13)+g+l|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xc24b8b70|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;E=R=(b>>>7^b>>>18^b>>>3^b<<25^b<<14)+(m>>>17^m>>>19^m>>>10^m<<15^m<<13)+E+d|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xc76c51a3|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;b=R=(O>>>7^O>>>18^O>>>3^O<<25^O<<14)+(g>>>17^g>>>19^g>>>10^g<<15^g<<13)+b+h|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xd192e819|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;O=R=(A>>>7^A>>>18^A>>>3^A<<25^A<<14)+(E>>>17^E>>>19^E>>>10^E<<15^E<<13)+O+p|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xd6990624|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;A=R=(w>>>7^w>>>18^w>>>3^w<<25^w<<14)+(b>>>17^b>>>19^b>>>10^b<<15^b<<13)+A+v|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xf40e3585|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;w=R=(e>>>7^e>>>18^e>>>3^e<<25^e<<14)+(O>>>17^O>>>19^O>>>10^O<<15^O<<13)+w+y|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x106aa070|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;e=R=(n>>>7^n>>>18^n>>>3^n<<25^n<<14)+(A>>>17^A>>>19^A>>>10^A<<15^A<<13)+e+m|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x19a4c116|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;n=R=(t>>>7^t>>>18^t>>>3^t<<25^t<<14)+(w>>>17^w>>>19^w>>>10^w<<15^w<<13)+n+g|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x1e376c08|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;t=R=(l>>>7^l>>>18^l>>>3^l<<25^l<<14)+(e>>>17^e>>>19^e>>>10^e<<15^e<<13)+t+E|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x2748774c|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;l=R=(d>>>7^d>>>18^d>>>3^d<<25^d<<14)+(n>>>17^n>>>19^n>>>10^n<<15^n<<13)+l+b|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x34b0bcb5|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;d=R=(h>>>7^h>>>18^h>>>3^h<<25^h<<14)+(t>>>17^t>>>19^t>>>10^t<<15^t<<13)+d+O|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x391c0cb3|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;h=R=(p>>>7^p>>>18^p>>>3^p<<25^p<<14)+(l>>>17^l>>>19^l>>>10^l<<15^l<<13)+h+A|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x4ed8aa4a|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;p=R=(v>>>7^v>>>18^v>>>3^v<<25^v<<14)+(d>>>17^d>>>19^d>>>10^d<<15^d<<13)+p+w|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x5b9cca4f|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;v=R=(y>>>7^y>>>18^y>>>3^y<<25^y<<14)+(h>>>17^h>>>19^h>>>10^h<<15^h<<13)+v+e|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x682e6ff3|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;y=R=(m>>>7^m>>>18^m>>>3^m<<25^m<<14)+(p>>>17^p>>>19^p>>>10^p<<15^p<<13)+y+n|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x748f82ee|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;m=R=(g>>>7^g>>>18^g>>>3^g<<25^g<<14)+(v>>>17^v>>>19^v>>>10^v<<15^v<<13)+m+t|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x78a5636f|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;g=R=(E>>>7^E>>>18^E>>>3^E<<25^E<<14)+(y>>>17^y>>>19^y>>>10^y<<15^y<<13)+g+l|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x84c87814|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;E=R=(b>>>7^b>>>18^b>>>3^b<<25^b<<14)+(m>>>17^m>>>19^m>>>10^m<<15^m<<13)+E+d|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x8cc70208|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;b=R=(O>>>7^O>>>18^O>>>3^O<<25^O<<14)+(g>>>17^g>>>19^g>>>10^g<<15^g<<13)+b+h|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0x90befffa|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;O=R=(A>>>7^A>>>18^A>>>3^A<<25^A<<14)+(E>>>17^E>>>19^E>>>10^E<<15^E<<13)+O+p|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xa4506ceb|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;A=R=(w>>>7^w>>>18^w>>>3^w<<25^w<<14)+(b>>>17^b>>>19^b>>>10^b<<15^b<<13)+A+v|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xbef9a3f7|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;w=R=(e>>>7^e>>>18^e>>>3^e<<25^e<<14)+(O>>>17^O>>>19^O>>>10^O<<15^O<<13)+w+y|0;R=R+C+(N>>>6^N>>>11^N>>>25^N<<26^N<<21^N<<7)+(x^N&(I^x))+0xc67178f2|0;C=x;x=I;I=N;N=S+R|0;S=T;T=_;_=D;D=R+(_&T^S&(_^T))+(_>>>2^_>>>13^_>>>22^_<<30^_<<19^_<<10)|0;r=r+D|0;o=o+_|0;a=a+T|0;i=i+S|0;s=s+N|0;c=c+I|0;u=u+x|0;f=f+C|0}function C(e){e=e|0;x(I[e|0]<<24|I[e|1]<<16|I[e|2]<<8|I[e|3],I[e|4]<<24|I[e|5]<<16|I[e|6]<<8|I[e|7],I[e|8]<<24|I[e|9]<<16|I[e|10]<<8|I[e|11],I[e|12]<<24|I[e|13]<<16|I[e|14]<<8|I[e|15],I[e|16]<<24|I[e|17]<<16|I[e|18]<<8|I[e|19],I[e|20]<<24|I[e|21]<<16|I[e|22]<<8|I[e|23],I[e|24]<<24|I[e|25]<<16|I[e|26]<<8|I[e|27],I[e|28]<<24|I[e|29]<<16|I[e|30]<<8|I[e|31],I[e|32]<<24|I[e|33]<<16|I[e|34]<<8|I[e|35],I[e|36]<<24|I[e|37]<<16|I[e|38]<<8|I[e|39],I[e|40]<<24|I[e|41]<<16|I[e|42]<<8|I[e|43],I[e|44]<<24|I[e|45]<<16|I[e|46]<<8|I[e|47],I[e|48]<<24|I[e|49]<<16|I[e|50]<<8|I[e|51],I[e|52]<<24|I[e|53]<<16|I[e|54]<<8|I[e|55],I[e|56]<<24|I[e|57]<<16|I[e|58]<<8|I[e|59],I[e|60]<<24|I[e|61]<<16|I[e|62]<<8|I[e|63])}function R(e){e=e|0;I[e|0]=r>>>24;I[e|1]=r>>>16&255;I[e|2]=r>>>8&255;I[e|3]=r&255;I[e|4]=o>>>24;I[e|5]=o>>>16&255;I[e|6]=o>>>8&255;I[e|7]=o&255;I[e|8]=a>>>24;I[e|9]=a>>>16&255;I[e|10]=a>>>8&255;I[e|11]=a&255;I[e|12]=i>>>24;I[e|13]=i>>>16&255;I[e|14]=i>>>8&255;I[e|15]=i&255;I[e|16]=s>>>24;I[e|17]=s>>>16&255;I[e|18]=s>>>8&255;I[e|19]=s&255;I[e|20]=c>>>24;I[e|21]=c>>>16&255;I[e|22]=c>>>8&255;I[e|23]=c&255;I[e|24]=u>>>24;I[e|25]=u>>>16&255;I[e|26]=u>>>8&255;I[e|27]=u&255;I[e|28]=f>>>24;I[e|29]=f>>>16&255;I[e|30]=f>>>8&255;I[e|31]=f&255}function P(){r=0x6a09e667;o=0xbb67ae85;a=0x3c6ef372;i=0xa54ff53a;s=0x510e527f;c=0x9b05688c;u=0x1f83d9ab;f=0x5be0cd19;l=d=0}function k(e,n,t,h,p,v,y,m,g,E){e=e|0;n=n|0;t=t|0;h=h|0;p=p|0;v=v|0;y=y|0;m=m|0;g=g|0;E=E|0;r=e;o=n;a=t;i=h;s=p;c=v;u=y;f=m;l=g;d=E}function M(e,n){e=e|0;n=n|0;var t=0;if(e&63)return-1;while((n|0)>=64){C(e);e=e+64|0;n=n-64|0;t=t+64|0}l=l+t|0;if(l>>>0<t>>>0)d=d+1|0;return t|0}function F(e,n,t){e=e|0;n=n|0;t=t|0;var r=0,o=0;if(e&63)return-1;if(~t)if(t&31)return-1;if((n|0)>=64){r=M(e,n)|0;if((r|0)==-1)return-1;e=e+r|0;n=n-r|0}r=r+n|0;l=l+n|0;if(l>>>0<n>>>0)d=d+1|0;I[e|n]=0x80;if((n|0)>=56){for(o=n+1|0;(o|0)<64;o=o+1|0)I[e|o]=0x00;C(e);n=0;I[e|0]=0}for(o=n+1|0;(o|0)<59;o=o+1|0)I[e|o]=0;I[e|56]=d>>>21&255;I[e|57]=d>>>13&255;I[e|58]=d>>>5&255;I[e|59]=d<<3&255|l>>>29;I[e|60]=l>>>21&255;I[e|61]=l>>>13&255;I[e|62]=l>>>5&255;I[e|63]=l<<3&255;C(e);if(~t)R(t);return r|0}function L(){r=h;o=p;a=v;i=y;s=m;c=g;u=E;f=b;l=64;d=0}function H(){r=O;o=A;a=w;i=D;s=_;c=T;u=S;f=N;l=64;d=0}function j(e,n,t,I,C,R,k,M,F,L,H,j,K,U,B,V){e=e|0;n=n|0;t=t|0;I=I|0;C=C|0;R=R|0;k=k|0;M=M|0;F=F|0;L=L|0;H=H|0;j=j|0;K=K|0;U=U|0;B=B|0;V=V|0;P();x(e^0x5c5c5c5c,n^0x5c5c5c5c,t^0x5c5c5c5c,I^0x5c5c5c5c,C^0x5c5c5c5c,R^0x5c5c5c5c,k^0x5c5c5c5c,M^0x5c5c5c5c,F^0x5c5c5c5c,L^0x5c5c5c5c,H^0x5c5c5c5c,j^0x5c5c5c5c,K^0x5c5c5c5c,U^0x5c5c5c5c,B^0x5c5c5c5c,V^0x5c5c5c5c);O=r;A=o;w=a;D=i;_=s;T=c;S=u;N=f;P();x(e^0x36363636,n^0x36363636,t^0x36363636,I^0x36363636,C^0x36363636,R^0x36363636,k^0x36363636,M^0x36363636,F^0x36363636,L^0x36363636,H^0x36363636,j^0x36363636,K^0x36363636,U^0x36363636,B^0x36363636,V^0x36363636);h=r;p=o;v=a;y=i;m=s;g=c;E=u;b=f;l=64;d=0}function K(e,n,t){e=e|0;n=n|0;t=t|0;var l=0,d=0,h=0,p=0,v=0,y=0,m=0,g=0,E=0;if(e&63)return-1;if(~t)if(t&31)return-1;E=F(e,n,-1)|0;l=r,d=o,h=a,p=i,v=s,y=c,m=u,g=f;H();x(l,d,h,p,v,y,m,g,0x80000000,0,0,0,0,0,0,768);if(~t)R(t);return E|0}function U(e,n,t,l,d){e=e|0;n=n|0;t=t|0;l=l|0;d=d|0;var h=0,p=0,v=0,y=0,m=0,g=0,E=0,b=0,O=0,A=0,w=0,D=0,_=0,T=0,S=0,N=0;if(e&63)return-1;if(~d)if(d&31)return-1;I[e+n|0]=t>>>24;I[e+n+1|0]=t>>>16&255;I[e+n+2|0]=t>>>8&255;I[e+n+3|0]=t&255;K(e,n+4|0,-1)|0;h=O=r,p=A=o,v=w=a,y=D=i,m=_=s,g=T=c,E=S=u,b=N=f;l=l-1|0;while((l|0)>0){L();x(O,A,w,D,_,T,S,N,0x80000000,0,0,0,0,0,0,768);O=r,A=o,w=a,D=i,_=s,T=c,S=u,N=f;H();x(O,A,w,D,_,T,S,N,0x80000000,0,0,0,0,0,0,768);O=r,A=o,w=a,D=i,_=s,T=c,S=u,N=f;h=h^r;p=p^o;v=v^a;y=y^i;m=m^s;g=g^c;E=E^u;b=b^f;l=l-1|0}r=h;o=p;a=v;i=y;s=m;c=g;u=E;f=b;if(~d)R(d);return 0}return{reset:P,init:k,process:M,finish:F,hmac_reset:L,hmac_init:j,hmac_finish:K,pbkdf2_generate_block:U}}},"transform/TextTransformer.js":function(e,n,t){var r=t("../Operation"),o=t("../Common"),a=function(e,n){o.PARANOIA&&(r.check(e),r.check(n));var t=function(e,n){if(e.offset>n.offset){if(e.offset>n.offset+n.toRemove)return r.create(e.offset-n.toRemove+n.toInsert.length,e.toRemove,e.toInsert);var t=e.toRemove-(n.offset+n.toRemove-e.offset);return t<0&&(t=0),0===t&&0===e.toInsert.length?null:r.create(n.offset+n.toInsert.length,t,e.toInsert)}if(e.offset+e.toRemove<n.offset)return e;var o=n.offset-e.offset;return 0===o&&0===e.toInsert.length?null:r.create(e.offset,o,e.toInsert)}(e,n);return o.PARANOIA&&t&&r.check(t),t};e.exports=function(e,n,t){var i,s=t;for(i=n.length-1;i>=0;i--)s=r.apply(n[i],s);var c=[];for(i=e.length-1;i>=0;i--){for(var u=e[i],f=n.length-1;f>=0;f--){try{u=a(u,n[f])}catch(e){return console.error("The pluggable transform function threw an error, failing operational transformation"),console.error(e.stack),[]}if(!u)break}u&&(o.PARANOIA&&r.check(u,s.length),c.unshift(u))}return c}},"transform/NaiveJSONTransformer.js":function(e,n,t){var r=t("./TextTransformer"),o=t("../Operation"),a=t("../Common");e.exports=function(e,n,t){var i,s,c,u=a.global.REALTIME_DEBUG=a.global.REALTIME_DEBUG||{};try{i=r(e,n,t),s=o.applyMulti(n,t),c=o.applyMulti(i,s);try{return JSON.parse(c),i}catch(r){console.error(r),u.ot_parseError={type:"resultParseError",resultOps:i,toTransform:e,transformBy:n,text1:t,text2:s,text3:c,error:r},console.log("Debugging info available at `window.REALTIME_DEBUG.ot_parseError`")}}catch(r){console.error(r),u.ot_applyError={type:"resultParseError",resultOps:i,toTransform:e,transformBy:n,text1:t,text2:s,text3:c,error:r},console.log("Debugging info available at `window.REALTIME_DEBUG.ot_applyError`")}return[]}},"transform/SmartJSONTransformer.js":function(e,n,t){var r,o,a,i=t("json.sortify"),s=t("../Diff"),c=t("../Operation"),u=t("./TextTransformer"),f=function(e){return null===e?"null":(n=e,"[object Array]"===Object.prototype.toString.call(n)?"array":typeof e);var n},l=function(e,n){for(var t=n.length,r=0;r<t;r++){if(void 0===e[n[r]])return;e=e[n[r]]}return e},d=function(e,n){var t=f(e);if(t!==f(n))return!1;if("object"===t){var r=Object.keys(e),o=Object.keys(n);return r.length===o.length&&!r.some(function(t){return!d(e[t],n[t])})&&!o.some(function(n){return!(n in e)})}return"array"===t?e.length===n.length&&!e.some(function(e,t){return!d(e,n[t])}):e===n},h=function(e,n,t,r,o){if("replace"===e)return{type:"replace",path:n,value:t,prev:r};if("splice"===e){if("number"!=typeof r)throw new Error;if("number"!=typeof o)throw new Error;return{type:"splice",path:n,value:t,offset:r,removals:o}}if("remove"!==e)throw new Error("expected a removal");return{type:"remove",path:n,value:t}},p=function(e,n,t,r){e.push(h("replace",n,t,r))},v=function(e,n,t,r,o){e.push(h("splice",n,t,r,o))},y=function(e,n){return!e.some(function(e,t){return e!==n[t]})},m=(o={},a=1,(r=["replace","remove","splice"]).forEach(function(e){return o[e]={},r.forEach(function(n){o[e][n]=a++})}),o),g=function(e,n,t){if("array"!==f(e)||"array"!==f(n))throw new Error("[resolve] expected two arrays");return n=n.filter(function(n){return!e.some(function(e){if("remove"===e.type&&y(e.path,n.path)&&n.path.length-e.path.length>1)return!0})&&("splice"!==n.type||!e.some(function(e){if("splice"===e.type&&y(e.path,n.path)&&e.path.length-n.path.length<0){if(!e.removals)return;for(var t=e.offset,r=e.offset+e.removals;t<r;t++)if(t===n.path[e.path.length])return!0}}))&&(!e.some(function(e){return"remove"===n.type&&d(e.path,n.path)})||void 0)}).filter(function(n){return!e.some(function(e){if("replace"===n.type&&"replace"===e.type&&d(e.path,n.path))return"string"!=typeof e.value||"string"!=typeof n.value||!t||e.prev!==n.prev||e.value===n.value||t(e,n,m.replace.replace)})}).map(function(n){return e.forEach(function(e){if("splice"===e.type){if(d(e.path,n.path)){if("splice"===n.type){if(n.offset>e.offset+n.removals)return void(n.offset+=e.value.length-e.removals);if(n.offset<e.offset)return void(n.removals=Math.max(e.offset-n.offset,0));n.removals=Math.max(n.removals-(n.offset+e.removals-n.offset),0),n.offset+=e.value.length-e.removals}return}if(y(e.path,n.path)){var t=e.path.length;"number"==typeof n.path[t]&&e.offset<=n.path[t]&&(n.path[t]+=e.value.length-e.removals)}}}),n}),n},E=function(e,n,t,r){var o=Object.keys(e),a=Object.keys(n);a.forEach(function(a){var i=f(n[a]),s=e[a],c=t.concat(a);if(-1!==o.indexOf(a)){var u=f(s);if(u===i)"object"===u?E(e[a],n[a],c,r):"array"===u?b(e[a],n[a],c,r):e[a]!==n[a]&&p(r,c,n[a],s);else{if(console.log("type changed from [%s] to [%s]",u,i),"undefined"===i)throw new Error("first pass should never reveal undefined keys");p(r,c,n[a],s)}}else{if("undefined"===i)throw new Error("undefined type has key. this shouldn't happen?");if(s)throw new Error("no such key existed in b, so 'old' should be falsey");p(r,c,n[a],s)}}),o.forEach(function(o){-1!==a.indexOf(o)&&"undefined"!==f(n[o])||function(e,n,t){e.push(h("remove",n,t))}(r,t.concat(o),e[o])})},b=function(e,n,t,r){var o=e.slice(0);if(0===o.length)v(r,t,n,0,0);else if(function(e,n){if(e.length!==n.length)return!1;for(var t=0;t<e.length;t++)if(f(e[t])!==f(n[t]))return!1;return!0}(o,n))o.forEach(function(e,o){var a=n[o];if(a!==e){var i=e,s=t.concat(o);switch(f(e)){case"undefined":throw new Error("existing key had type `undefined`. this should never happen");case"object":E(e,a,s,r);break;case"array":b(e,a,s,r);break;default:p(r,s,a,i)}}});else{for(var a=0,i=0;a<o.length&&d(o[a],n[a]);)a++;for(;d(o[o.length-1-i],n[n.length-1-i])&&i+a<o.length&&i+a<n.length;)i++;var s=o.length-a-i,c=[];n.length!==a+i&&(c=n.slice(a,n.length-i)),v(r,t,c,a,s)}},O=function(e,n){var t=[],r=f(e),o=f(n);if(r!==o)throw new Error("Can't merge two objects of differing types");if("array"===o)b(e,n,[],t);else{if("object"!==o)throw new Error("unsupported datatype"+o);E(e,n,[],t)}return t},A=function(e,n){return n.forEach(function(n){!function(e,n){var t,r,o;switch(n.type){case"replace":r=n.path[n.path.length-1],t=n.path.slice(0,n.path.length-1);var a=l(e,t);if(!a)throw new Error("cannot apply change to non-existent element");a[r]=n.value;break;case"splice":var i=l(e,n.path);if(!i)throw console.error("[applyOp] expected path [%s] to exist in object",n.path.join(",")),new Error("Path did not exist");if("array"!==f(i))throw new Error("Can't splice non-array");Array.prototype.splice.apply(i,[n.offset,n.removals].concat(n.value));break;case"remove":r=n.path[n.path.length-1],t=n.path.slice(0,n.path.length-1),void 0!==(o=l(e,t))&&delete o[r];break;default:throw new Error("unsupported operation type")}}(e,n)}),e},w=function(e,n,t){if(e.prev!==n.prev)throw new Error("Parent values don't match!");if(t===m.splice.splice)return console.log(e),console.log(n),console.log("\n\n\n\n\n\n\n\n\n"),!0;var r=e.prev,o=s.diff(r,e.value),a=s.diff(r,n.value),i=u(a,o,r),f=c.applyMulti(o,r),l=c.applyMulti(i,f);n.value=l};e.exports=function(e,n,t){var r=JSON.parse(t),o=c.applyMulti(n,t),a=JSON.parse(o),u=c.applyMulti(e,t),f=JSON.parse(u);try{var l=O(r,f),d=O(r,a),h=g(d,l,w);A(r,d),A(r,h);var p=i(r);return s.diff(o,p)}catch(e){console.error(e)}return[]},e.exports._={clone:function(e){return JSON.parse(JSON.stringify(e))},pathOverlaps:y,deepEqual:d,diff:O,resolve:g,patch:A,arbiter:w}}},a.m[1]={"dist/JSON.sortify.js":function(e,n,t){var r;r=function(){var e=function e(n){if(Array.isArray(n))return n.map(e);if(n instanceof Object){var t=(r=[],o=[],Object.keys(n).forEach(function(e){/^(0|[1-9][0-9]*)$/.test(e)?r.push(+e):o.push(e)}),{v:r.sort(function(e,n){return e-n}).concat(o.sort()).reduce(function(t,r){return t[r]=e(n[r]),t},{})});if("object"==typeof t)return t.v}var r,o;return n},n=JSON.stringify.bind(JSON);return function(t,r,o){var a=n(t,r,0);if(!a||"{"!==a[0]&&"["!==a[0])return a;var i=JSON.parse(a);return n(e(i),null,o)}},void 0!==e&&e.exports?e.exports=r():JSON.sortify=r()}},a.m[2]={"diff.js":function(e,n,t){var r=-1;function o(e,n,t,u){if(e===n)return e?[[0,e]]:[];if(null!=t){var f=function(e,n,t){var r="number"==typeof t?{index:t,length:0}:t.oldRange,o="number"==typeof t?null:t.newRange,a=e.length,i=n.length;if(0===r.length&&(null===o||0===o.length)){var s=r.index,c=e.slice(0,s),u=e.slice(s),f=o?o.index:null,l=s+i-a;if((null===f||f===l)&&!(l<0||l>i)){var d=n.slice(0,l);if((y=n.slice(l))===u){var p=Math.min(s,l);if((g=c.slice(0,p))===(b=d.slice(0,p)))return h(g,c.slice(p),d.slice(p),u)}}if(null===f||f===s){var v=s,y=(d=n.slice(0,v),n.slice(v));if(d===c){var m=Math.min(a-v,i-v);if((E=u.slice(u.length-m))===(O=y.slice(y.length-m)))return h(c,u.slice(0,u.length-m),y.slice(0,y.length-m),E)}}}if(r.length>0&&o&&0===o.length){var g=e.slice(0,r.index),E=e.slice(r.index+r.length);if(!(i<(p=g.length)+(m=E.length))){var b=n.slice(0,p),O=n.slice(i-m);if(g===b&&E===O)return h(g,e.slice(p,a-m),n.slice(p,i-m),E)}}return null}(e,n,t);if(f)return f}var l=i(e,n),d=e.substring(0,l);l=s(e=e.substring(l),n=n.substring(l));var p=e.substring(e.length-l),v=function(e,n){var t;if(!e)return[[1,n]];if(!n)return[[r,e]];var c=e.length>n.length?e:n,u=e.length>n.length?n:e,f=c.indexOf(u);if(-1!==f)return t=[[1,c.substring(0,f)],[0,u],[1,c.substring(f+u.length)]],e.length>n.length&&(t[0][0]=t[2][0]=r),t;if(1===u.length)return[[r,e],[1,n]];var l=function(e,n){var t=e.length>n.length?e:n,r=e.length>n.length?n:e;if(t.length<4||2*r.length<t.length)return null;function o(e,n,t){for(var r,o,a,c,u=e.substring(t,t+Math.floor(e.length/4)),f=-1,l="";-1!==(f=n.indexOf(u,f+1));){var d=i(e.substring(t),n.substring(f)),h=s(e.substring(0,t),n.substring(0,f));l.length<h+d&&(l=n.substring(f-h,f)+n.substring(f,f+d),r=e.substring(0,t-h),o=e.substring(t+d),a=n.substring(0,f-h),c=n.substring(f+d))}return 2*l.length>=e.length?[r,o,a,c,l]:null}var a,c,u,f,l,d=o(t,r,Math.ceil(t.length/4)),h=o(t,r,Math.ceil(t.length/2));if(!d&&!h)return null;a=h?d&&d[4].length>h[4].length?d:h:d,e.length>n.length?(c=a[0],u=a[1],f=a[2],l=a[3]):(f=a[0],l=a[1],c=a[2],u=a[3]);var p=a[4];return[c,u,f,l,p]}(e,n);if(l){var d=l[0],h=l[1],p=l[2],v=l[3],y=l[4],m=o(d,p),g=o(h,v);return m.concat([[0,y]],g)}return function(e,n){for(var t=e.length,o=n.length,i=Math.ceil((t+o)/2),s=i,c=2*i,u=new Array(c),f=new Array(c),l=0;l<c;l++)u[l]=-1,f[l]=-1;u[s+1]=0,f[s+1]=0;for(var d=t-o,h=d%2!=0,p=0,v=0,y=0,m=0,g=0;g<i;g++){for(var E=-g+p;E<=g-v;E+=2){for(var b=s+E,O=(T=E===-g||E!==g&&u[b-1]<u[b+1]?u[b+1]:u[b-1]+1)-E;T<t&&O<o&&e.charAt(T)===n.charAt(O);)T++,O++;if(u[b]=T,T>t)v+=2;else if(O>o)p+=2;else if(h&&(D=s+d-E)>=0&&D<c&&-1!==f[D]&&T>=(w=t-f[D]))return a(e,n,T,O)}for(var A=-g+y;A<=g-m;A+=2){for(var w,D=s+A,_=(w=A===-g||A!==g&&f[D-1]<f[D+1]?f[D+1]:f[D-1]+1)-A;w<t&&_<o&&e.charAt(t-w-1)===n.charAt(o-_-1);)w++,_++;if(f[D]=w,w>t)m+=2;else if(_>o)y+=2;else if(!h){var T;if((b=s+d-A)>=0&&b<c&&-1!==u[b])if(O=s+(T=u[b])-b,T>=(w=t-w))return a(e,n,T,O)}}}return[[r,e],[1,n]]}(e,n)}(e=e.substring(0,e.length-l),n=n.substring(0,n.length-l));return d&&v.unshift([0,d]),p&&v.push([0,p]),c(v,u),v}function a(e,n,t,r){var a=e.substring(0,t),i=n.substring(0,r),s=e.substring(t),c=n.substring(r),u=o(a,i),f=o(s,c);return u.concat(f)}function i(e,n){if(!e||!n||e.charAt(0)!==n.charAt(0))return 0;for(var t=0,r=Math.min(e.length,n.length),o=r,a=0;t<o;)e.substring(a,o)==n.substring(a,o)?a=t=o:r=o,o=Math.floor((r-t)/2+t);return u(e.charCodeAt(o-1))&&o--,o}function s(e,n){if(!e||!n||e.slice(-1)!==n.slice(-1))return 0;for(var t=0,r=Math.min(e.length,n.length),o=r,a=0;t<o;)e.substring(e.length-o,e.length-a)==n.substring(n.length-o,n.length-a)?a=t=o:r=o,o=Math.floor((r-t)/2+t);return f(e.charCodeAt(e.length-o))&&o--,o}function c(e,n){e.push([0,""]);for(var t,o=0,a=0,u=0,f="",h="";o<e.length;)if(o<e.length-1&&!e[o][1])e.splice(o,1);else switch(e[o][0]){case 1:u++,h+=e[o][1],o++;break;case r:a++,f+=e[o][1],o++;break;case 0:var p=o-u-a-1;if(n){if(p>=0&&d(e[p][1])){var v=e[p][1].slice(-1);if(e[p][1]=e[p][1].slice(0,-1),f=v+f,h=v+h,!e[p][1]){e.splice(p,1),o--;var y=p-1;e[y]&&1===e[y][0]&&(u++,h=e[y][1]+h,y--),e[y]&&e[y][0]===r&&(a++,f=e[y][1]+f,y--),p=y}}l(e[o][1])&&(v=e[o][1].charAt(0),e[o][1]=e[o][1].slice(1),f+=v,h+=v)}if(o<e.length-1&&!e[o][1]){e.splice(o,1);break}if(f.length>0||h.length>0){f.length>0&&h.length>0&&(0!==(t=i(h,f))&&(p>=0?e[p][1]+=h.substring(0,t):(e.splice(0,0,[0,h.substring(0,t)]),o++),h=h.substring(t),f=f.substring(t)),0!==(t=s(h,f))&&(e[o][1]=h.substring(h.length-t)+e[o][1],h=h.substring(0,h.length-t),f=f.substring(0,f.length-t)));var m=u+a;0===f.length&&0===h.length?(e.splice(o-m,m),o-=m):0===f.length?(e.splice(o-m,m,[1,h]),o=o-m+1):0===h.length?(e.splice(o-m,m,[r,f]),o=o-m+1):(e.splice(o-m,m,[r,f],[1,h]),o=o-m+2)}0!==o&&0===e[o-1][0]?(e[o-1][1]+=e[o][1],e.splice(o,1)):o++,u=0,a=0,f="",h=""}""===e[e.length-1][1]&&e.pop();var g=!1;for(o=1;o<e.length-1;)0===e[o-1][0]&&0===e[o+1][0]&&(e[o][1].substring(e[o][1].length-e[o-1][1].length)===e[o-1][1]?(e[o][1]=e[o-1][1]+e[o][1].substring(0,e[o][1].length-e[o-1][1].length),e[o+1][1]=e[o-1][1]+e[o+1][1],e.splice(o-1,1),g=!0):e[o][1].substring(0,e[o+1][1].length)==e[o+1][1]&&(e[o-1][1]+=e[o+1][1],e[o][1]=e[o][1].substring(e[o+1][1].length)+e[o+1][1],e.splice(o+1,1),g=!0)),o++;g&&c(e,n)}function u(e){return e>=55296&&e<=56319}function f(e){return e>=56320&&e<=57343}function l(e){return f(e.charCodeAt(0))}function d(e){return u(e.charCodeAt(e.length-1))}function h(e,n,t,o){return d(e)||l(o)?null:function(e){for(var n=[],t=0;t<e.length;t++)e[t][1].length>0&&n.push(e[t]);return n}([[0,e],[r,n],[1,t],[0,o]])}function p(e,n,t){return o(e,n,t,!0)}p.INSERT=1,p.DELETE=r,p.EQUAL=0,e.exports=p}},n=a("ChainPad.js"),r="ChainPad",e.exports=n,"undefined"!=typeof window?o=window:void 0!==t?o=t:"undefined"!=typeof self&&(o=self),o[r]=n}(I)),I.exports}var C,R=x(),P=n({__proto__:null,default:r(R)},[R]),k={exports:{}};function M(){return C||(C=1,function(e){var n;n=function(e,n){var t={Nacl:e},r=n.encodeBase64,o=e=>{let t;return(t=e.length%4)&&(e+="=".repeat(4-t)),n.decodeBase64(e)},a=n.decodeUTF8,i=n.encodeUTF8,s=function(e){for(var n="",t=0;t<e.length;t++)e[t]<16&&(n+="0"),n+=e[t].toString(16);return n},c=t.encrypt=function(n,t){return function(n,t){var o=a(n),i=e.randomBytes(24),s=e.secretbox(o,i,t);if(!s)throw new Error;return r(i)+"|"+r(s)}(n,t)},u=t.decrypt=function(n,t){return function(n,t){var r=n.split("|");if(2!==r.length)throw new Error;var a=o(r[0]),s=o(r[1]),c=e.secretbox.open(s,a,t);if(!c)throw new Error;return i(c)}(n,t)},f=t.parseKey=function(n){try{var t=o(n),a=e.hash(t),i=a.subarray(32);return{lookupKey:i,cryptKey:a.subarray(0,32),channel:r(i).substring(0,10)}}catch(e){throw console.error("[chainpad-crypto.parseKey] invalid string supplied"),e}},l=t.rand64=function(n){return r(e.randomBytes(n))};t.genKey=function(){return l(18)};var d=function(e){return r(e).replace(/\//g,"-").replace(/=+$/g,"")},h=function(e){return o(e.replace(/\-/g,"/"))};t.b64RemoveSlashes=function(e){return e.replace(/\//g,"-")},t.b64AddSlashes=function(e){return e.replace(/\-/g,"/")},t.createEncryptor=function(n){var t;if("object"==typeof n){var s={};if(!(t=n.cryptKey))throw new Error("NO_DECRYPTION_KEY_PROVIDED");if(n.signKey){var l=o(n.signKey);s.encrypt=function(n){return r(e.sign(a(c(n,t)),l))}}return s.decrypt=function(n,r,a){if(!r&&!a)throw new Error("UNSUPPORTED_DECRYPTION_CONFIGURATION");!0!==r||a||console.error("UNEXPECTED_CONFIGURATION");var s=a||"string"!=typeof r?o(n).subarray(64):e.sign.open(o(n),o(r));if(s)return u(i(s),t)},s}return t=f(n).cryptKey,{encrypt:function(e){return c(e,t)},decrypt:function(e){return u(e,t)}}},t.createEditCryptor=function(n,t){try{if(!n){if(t&&18!==t.length)throw new Error("expected supplied seed to have length of 18");t||(t=e.randomBytes(18)),n=r(t)}var a=e.hash(o(n)),i=e.sign.keyPair.fromSeed(a.subarray(0,32)),s=a.subarray(32,64);return{editKeyStr:n,signKey:r(i.secretKey),validateKey:r(i.publicKey),cryptKey:s,viewKeyStr:d(s)}}catch(e){throw console.error("[chainpad-crypto.createEditCryptor] invalid string supplied"),e}},t.createViewCryptor=function(e){try{if(!e)throw new Error("Cannot open a new pad in read-only mode!");return{cryptKey:o(e),viewKeyStr:e}}catch(e){throw console.error("[chainpad-crypto.createViewCryptor] invalid string supplied"),e}};var p=t.createViewCryptor2=function(n,t){try{if(!n)throw new Error("Cannot open a new pad in read-only mode!");var o=h(n),i=o;if(t){var s=a(t);(i=new Uint8Array(o.length+s.length)).set(s),i.set(o,s.length)}var c=e.hash(i),u=c.subarray(0,16),f=c.subarray(16,48),l=e.sign.keyPair.fromSeed(c.subarray(32,64));return{viewKeyStr:n,cryptKey:f,chanId:d(u),secondarySignKey:r(l.secretKey),secondaryValidateKey:r(l.publicKey)}}catch(e){throw console.error("[chainpad-crypto.createViewCryptor2] invalid string supplied"),e}};t.createEditCryptor2=function(n,t,o){try{if(!n){if(t&&18!==t.length)throw new Error("expected supplied seed to have length of 18");t||(t=e.randomBytes(18)),n=d(t)}t||(t=h(n));var i=t;if(o){var s=a(o);(i=new Uint8Array(t.length+s.length)).set(s),i.set(t,s.length)}var c=e.hash(i),u=e.sign.keyPair.fromSeed(c.subarray(0,32)),f=e.hash(u.secretKey).subarray(0,e.secretbox.keyLength),l=c.subarray(32,64),v=d(l),y=p(v,o);return{editKeyStr:n,viewKeyStr:v,signKey:r(u.secretKey),validateKey:r(u.publicKey),cryptKey:y.cryptKey,secondaryKey:r(f),chanId:y.chanId,secondarySignKey:y.secondarySignKey,secondaryValidateKey:y.secondaryValidateKey}}catch(e){throw console.error("[chainpad-crypto.createEditCryptor2] invalid string supplied"),e}},t.createFileCryptor2=function(n,t){try{var r;n||(r=e.randomBytes(18),n=d(r)),r||(r=h(n));var o=r;if(t){var i=a(t);(o=new Uint8Array(r.length+i.length)).set(i),o.set(r,i.length)}var s=e.hash(o),c=s.subarray(0,24);return{fileKeyStr:n,cryptKey:s.subarray(24,56),chanId:d(c)}}catch(e){throw console.error("[chainpad-crypto.createFileCryptor2] invalid string supplied"),e}};var v=t.Curve={},y=function(e){var n=0;e.forEach(function(e){n+=e.length});var t=new Uint8Array(n),r=0;return e.forEach(function(e){t.set(e,r),r+=e.length}),t};v.encrypt=function(n,t){var o=a(n),i=e.randomBytes(24),s=e.box.after(o,i,t);return r(i)+"|"+r(s)},v.decrypt=function(n,t){var r=n.split("|"),a=o(r[0]),s=o(r[1]),c=e.box.open.after(s,a,t);return c?i(c):null},v.signAndEncrypt=function(n,t,o){var i=v.encrypt(n,t);return r(e.sign(a(i),o))},v.openSigned=function(e,n){var t=o(e).subarray(64);return v.decrypt(i(t),n)},v.deriveKeys=function(n,t){try{var i=o(n),s=o(t),c=e.box.before(i,s),u=a("CryptPad.signingKeyGenerationSalt"),f=e.hash(y([u,c])),l=e.sign.keyPair.fromSeed(f.subarray(0,32)),d=f.subarray(32,64);return{cryptKey:r(d),signKey:r(l.secretKey),validateKey:r(l.publicKey)}}catch(e){return console.error("invalid keys or other problem deriving keys"),console.error(e),null}},v.createEncryptor=function(e){if(e&&"object"==typeof e){var n=o(e.cryptKey),t=o(e.signKey),r=o(e.validateKey);return{encrypt:function(e){return v.signAndEncrypt(e,n,t)},decrypt:function(e){return v.openSigned(e,n,r)}}}console.error("invalid input for createEncryptor")};var m=function(e,n,t){return new Uint8Array(Array.prototype.slice.call(e,n,t))},g=t.Mailbox={},E=function(n,t){var r=e.randomBytes(e.box.nonceLength),o=e.box(n,r,t.their_public,t.my_private);return y([r,t.my_public,o])},b=function(n,t){var r=m(n,0,e.box.nonceLength),o=m(n,e.box.nonceLength,e.box.nonceLength+e.box.publicKeyLength),a=m(n,e.box.nonceLength+e.box.publicKeyLength),i=e.box.open(a,r,t.their_public||o,t.my_private);if(!i)throw new Error("E_DECRYPTION_FAILURE");return{content:i,author:o}},O=g.sealSecretLetter=function(n,t){var o=a(n),i=E(o,{their_public:t.their_public,my_private:t.my_private,my_public:t.my_public}),s=t.ephemeral_keypair||e.box.keyPair(),c=E(i,{their_public:t.their_public,my_private:s.secretKey,my_public:s.publicKey});return t.signingKey&&(c=e.sign(c,t.signingKey)),r(c)};g.openOwnSecretLetter=function(e,n){var t=o(e);n.validateKey&&(t=t.subarray(64));var a=b(t,{my_private:n.ephemeral_private,their_public:n.their_public}),s=b(a.content,{my_private:n.my_private,their_public:n.their_public});return{content:i(s.content),author:r(s.author)}};var A=g.openSecretLetter=function(e,n){var t=o(e);n.validateKey&&(t=t.subarray(64));var a=b(t,{my_private:n.my_private}),s=b(a.content,{my_private:n.my_private});return{content:i(s.content),author:r(s.author)}};g.createEncryptor=function(e){if(e&&"object"==typeof e){["curvePublic","curvePrivate"].forEach(function(n){if("string"!=typeof e[n])throw console.log(n),new Error("Expected key was not present")});var n=o(e.curvePrivate),t=o(e.curvePublic),r=e.signingKey?o(e.signingKey):void 0,a=e.validateKey?o(e.validateKey):void 0;return{encrypt:function(a,i){var s=o(i);try{return O(a,{signingKey:r,ephemeral_keypair:e.ephemeral_keypair,their_public:s,my_private:n,my_public:t})}catch(e){return console.error(e),null}},decrypt:function(e){try{return A(e,{validateKey:a,my_private:n})}catch(e){return console.error(e),null}}}}console.error("invalid Mailbox.createEncryptor keys")};var w=t.Team={},D={teamCurvePublic:"team_curve_public",teamCurvePrivate:"team_curve_private",myCurvePublic:"my_curve_public",myCurvePrivate:"my_curve_private",teamEdPublic:"team_ed_public",teamEdPrivate:"team_ed_private"},_=function(n){var t=e.hash(n);return[m(t,0,32),m(t,32)]},T=function(n){var o=_(n),a=e.box.keyPair.fromSecretKey(o[0]),i=m(o[1],0,16);return{channel:s(i),teamCurvePublic:r(a.publicKey),teamCurvePrivate:r(a.secretKey),viewKeyStr:t.b64RemoveSlashes(r(n))}};return w.deriveGuestKeys=function(e){return T(o(t.b64AddSlashes(e)))},w.createSeed=function(){return t.b64AddSlashes(r(e.randomBytes(18)))},w.deriveMemberKeys=function(n,a){var i,s;try{if((i=o(t.b64AddSlashes(n))).length<18)throw new Error("INVALID_SEED")}catch(e){throw e}if(s=a,!Boolean(s.curvePublic&&o(s.curvePublic).length===e.box.publicKeyLength&&s.curvePrivate&&o(s.curvePrivate).length===e.box.secretKeyLength))throw new Error("INVALID_OWN_KEYS");var c,u,f,l=_(i),d=e.sign.keyPair.fromSeed(l[0]),h=T(l[1]);return c={myCurvePublic:a.curvePublic,myCurvePrivate:a.curvePrivate,teamEdPrivate:r(d.secretKey),teamEdPublic:r(d.publicKey)},u=h,f=JSON.parse(JSON.stringify(c)),Object.keys(u).forEach(function(e){f[e]=u[e]}),f},w.createEncryptor=function(n){var t={};Object.keys(D).forEach(function(e){if(n[e])try{t[D[e]]=o(n[e])}catch(n){throw console.log(e),new Error("INVALID_KEY_SUPPLIED")}});var s,c={};if(s=t,Boolean(s.my_curve_private&&s.my_curve_private.length===e.box.secretKeyLength&&s.my_curve_public&&s.my_curve_public.length===e.box.publicKeyLength&&s.team_curve_public&&s.team_curve_public.length===e.box.publicKeyLength&&s.team_ed_private&&s.team_ed_private.length===e.sign.secretKeyLength)&&(c.encrypt=function(n){try{return function(n,t){var o=a(n),i=E(o,{their_public:t.team_curve_public,my_private:t.my_curve_private,my_public:t.my_curve_public}),s=e.box.keyPair(),c=E(i,{their_public:t.team_curve_public,my_private:s.secretKey,my_public:s.publicKey});return r(e.sign(c,t.team_ed_private))}(n,t)}catch(e){return console.error(e),null}}),function(n){return Boolean(n.team_curve_private&&n.team_curve_private.length===e.box.secretKeyLength&&n.team_ed_public&&n.team_ed_public.length===e.sign.publicKeyLength)}(t)&&(c.decrypt=function(n,a){try{return function(n,t,a){var s,c=o(n);if(null===(s=!0===a?m(c,64):e.sign.open(c,t.team_ed_public)))throw new Error("E_VALIDATION_FAILURE");var u=b(s,{my_private:t.team_curve_private}),f=b(u.content,{my_private:t.team_curve_private});return{content:i(f.content),author:r(f.author)}}(n,t,a)}catch(e){return console.error(e),null}}),0===Object.keys(c).length)throw new Error("INVALID_TEAM_CONFIGURATION");return c},t},e.exports?e.exports=n(h(),w()):window.chainpad_crypto=n(window.nacl)}(k)),k.exports}var F,L=M(),H={exports:{}};function j(){return F||(F=1,function(e){e.exports&&(e.exports=((e={})=>{var n={setCustomize:n=>{e=n.ApiConfig},getWebsocketURL:function(n){var t=e.websocketPath||"/cryptpad_websocket";if(/^ws{1,2}:\/\//.test(t))return t;var r=new URL(n||globalThis?.location?.href||e.httpUnsafeOrigin);return n&&(r.href=n),r.protocol.replace(/http/,"ws")+"//"+r.host+t}};return n})())}(H)),H.exports}var K,U=j(),B=n({__proto__:null,default:r(U)},[U]),V={exports:{}};function Y(){return K||(K=1,function(e){e.exports&&(e.exports=function(e={}){return{setCustomize:n=>{e=n.AppConfig},userHashKey:"User_hash",userNameKey:"User_name",blockHashKey:"Block_hash",fileHashKey:"FS_hash",sessionJWT:"Session_JWT",ssoSeed:"SSO_seed",displayNameKey:"cryptpad.username",oldStorageKey:"CryptPad_RECENTPADS",storageKey:"filesData",tokenKey:"loginToken",prefersDriveRedirectKey:"prefersDriveRedirect",isPremiumKey:"isPremiumUser",displayPadCreationScreen:"displayPadCreationScreen",deprecatedKey:"deprecated",MAX_TEAMS_SLOTS:e.maxTeamsSlots||5,MAX_TEAMS_OWNED:e.maxOwnedTeams||5,MAX_PREMIUM_TEAMS_SLOTS:Math.max(e.maxTeamsSlots||0,e.maxPremiumTeamsSlots||0)||5,MAX_PREMIUM_TEAMS_OWNED:Math.max(e.maxOwnedTeams||0,e.maxPremiumTeamsOwned||0)||5,criticalApps:["profile","settings","debug","admin","support","notifications","calendar","moderation","oldadmin"],earlyAccessApps:[]}}(void 0))}(V)),V.exports}var G,J=Y(),q=n({__proto__:null,default:r(J)},[J]),W={exports:{}},z={exports:{}},Q=z.exports;function Z(){return G||(G=1,function(e){!function(n){const t=e=>{var t=n.CryptPad_Util={};n.atob=n.atob||function(e){return Buffer.from(e,"base64").toString("binary")},n.btoa=n.btoa||function(e){return Buffer.from(e,"binary").toString("base64")},t.encodeBase64=e.encodeBase64,t.decodeBase64=n=>{let t=n.length%4;return t&&(n+="=".repeat(4-t)),e.decodeBase64(n)},t.encodeUTF8=e.encodeUTF8,t.decodeUTF8=e.decodeUTF8,t.slice=function(e,n,t){return Array.prototype.slice.call(e,n,t)},t.u8ToBase64=(e,n)=>{const t=new FileReader;t.onload=()=>{let e=t.result,r=e.slice(e.indexOf(",")+1);n(r)},t.readAsDataURL(new Blob([e]))},t.shuffleArray=function(e){for(var n=e.length-1;n>0;n--){var t=Math.floor(Math.random()*(n+1)),r=e[n];e[n]=e[t],e[t]=r}},t.bake=function(e,n){return void 0===n&&(n=[]),Array.isArray(n)||(n=[n]),function(){return e.apply(null,n)}},t.both=function(e,n){if("function"!=typeof e)throw new Error("INVALID_USAGE");return"function"!=typeof n&&(n=function(e){return e}),function(){return e.apply(null,arguments),n.apply(null,arguments)}},t.clone=function(e){return null==e?e:JSON.parse(JSON.stringify(e))},t.serializeError=function(e){if(!(e instanceof Error))return e;var n={};return Object.getOwnPropertyNames(e).forEach(function(t){n[t]=e[t]}),n},t.tryParse=function(e){try{return JSON.parse(e)}catch(e){return}},t.mkAsync=function(e,n){if("function"!=typeof e)throw new Error("EXPECTED_FUNCTION");return function(){var t=Array.prototype.slice.call(arguments);setTimeout(function(){e.apply(null,t)},n)}},t.mkEvent=function(e){var n=[],t=!1;let r;return{reg:function(r){e&&t?setTimeout(r):n.push(r)},unreg:function(e){-1!==n.indexOf(e)?n.splice(n.indexOf(e),1):console.log("event handler was already unregistered")},fire:function(){if(!e||!t){var o=Array.prototype.slice.call(arguments);t||r.apply(null,o),t=!0,n.forEach(function(e){e.apply(null,o)})}},promise:new Promise(e=>{r=e})}},t.mkTimeout=function(e,n){n=n||0;var r=t.once(e),o=setTimeout(function(){r("TIMEOUT")},n);return t.both(r,function(){clearTimeout(o)})},t.onClickEnter=function(e,n,t){e.on("click keydown",function(e){var r="click"===e.type,o="keydown"===e.type&&13===e.which,a="keydown"===e.type&&32===e.which&&t&&t.space;(r||o||a)&&("keydown"===e.type&&e.preventDefault(),n(e))})},t.response=function(e){var n={},t={};"function"!=typeof e&&(e=function(e){throw new Error(e)});var r=function(e){clearTimeout(t[e]),delete t[e],delete n[e]};return{clear:r,expected:function(e){return Boolean(n[e])},expectation:function(e){return n[e]},expect:function(o,a,i){"string"!=typeof o&&e("EXPECTED_STRING"),"function"!=typeof a&&e("EXPECTED_CALLBACK"),n[o]=a,"number"==typeof i&&i&&(t[o]=setTimeout(function(){"function"==typeof n[o]&&n[o]("TIMEOUT"),r(o)},i))},handle:function(t,o){var a=n[t];if("function"==typeof a){try{a.apply(null,Array.isArray(o)?o:[o])}catch(n){e("HANDLER_ERROR",{error:n,id:t,args:o})}r(t)}else e("MISSING_CALLBACK",{id:t,args:o})},_pending:n}},t.inc=function(e,n,t){e[n]=(e[n]||0)+("number"==typeof t?t:1)},t.values=function(e){return Object.keys(e).map(function(n){return e[n]})},t.find=function(e,n){for(var t=n.length,r=0;r<t;r++){if(void 0===e[n[r]])return;e=e[n[r]]}return e},t.uid=function(){return Number(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)).toString(32).replace(/\./g,"")},t.guid=function(e){var n=t.uid();return void 0===e[n]?n:t.guid(e)},t.fixHTML=function(e){return e?e.replace(/[<>&"']/g,function(e){return{"<":"&lt;",">":"&gt","&":"&amp;",'"':"&#34;","'":"&#39;"}[e]}):""},t.hexToBase64=function(e){var t=e.replace(/\r|\n/g,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" "),r=String.fromCharCode.apply(null,t);return n.btoa(r).replace(/\//g,"-").replace(/=+$/,"")},t.base64ToHex=function(e){var t=[];return n.atob(e.replace(/-/g,"/")).split("").forEach(function(e){var n=e.charCodeAt(0).toString(16);1===n.length&&(n="0"+n),t.push(n)}),t.join("")},t.uint8ArrayToHex=function(e){for(var n="",t=0;t<e.length;t++)e[t]<16&&(n+="0"),n+=e[t].toString(16);return n},t.hexToUint8Array=function(e){for(var n=new Uint8Array(Math.ceil(e.length/2)),t=0;t<n.length;t++)n[t]=parseInt(e.substr(2*t,2),16);return n},t.uint8ArrayJoin=function(e){for(var n=0,t=0;t<e.length;t++)n+=e[t].length;var r=new Uint8Array(n);t=0;for(var o=0;t<e.length;t++)r.set(e[t],o),o+=e[t].length;return r},t.escapeKeyCharacters=function(e){return e&&e.replace&&e.replace(/\//g,"-")},t.unescapeKeyCharacters=function(e){return e.replace(/\-/g,"/")},t.deduplicateString=function(e){for(var n=e.slice(),t=0;t<n.length;t++)for(var r=t+1;r<n.length;r++)n[t]===n[r]&&n.splice(r--,1);return n},t.fixFileName=function(e){return e.replace(/ /g,"-").replace(/[\/\?]/g,"_").replace(/_+/g,"_")};var r=1048576,o=1073741824;t.bytesToGigabytes=function(e){return Math.ceil(e/o*100)/100},t.bytesToMegabytes=function(e){return Math.ceil(e/r*100)/100},t.bytesToKilobytes=function(e){return Math.ceil(e/1024*100)/100},t.magnitudeOfBytes=function(e){return e>=o?"GB":e>=r?"MB":"KB"};t.getBlock=function(e,n,r){var o=t.once(t.mkAsync(r)),a={};"string"==typeof n.bearer&&n.bearer&&(a.authorization=`Bearer ${n.bearer}`),fetch(e,{method:"GET",credentials:"include",headers:a}).then(e=>{e.ok?o(void 0,e):401!==e.status&&404!==e.status?o(e.status,e):e.json().then(n=>{o(e.status,n)}).catch(()=>{o(e.status)})}).catch(e=>{o(e)})},t.fetchApi=function(e,n,t,r){const o=new URL(e);o.pathname=`api/${n}`;let a=o.href+(t?"?"+ +new Date:"");if("undefined"!=typeof self&&self.crypto)fetch(a).then(e=>{if(!e.ok)throw new Error(`Fetch error: ${e.status}`);return e.text()}).then(e=>{r(JSON.parse(e.slice(27,-5)))}).catch(e=>{console.error(e.message),r({})});else if(void 0!==f){("http:"===o.protocol?require("node:http"):require("node:https")).get(o.href,e=>{let n="";e.on("data",e=>{n+=e}),e.on("end",()=>{try{r(JSON.parse(n.slice(27,-5)))}catch(e){console.error(e),r({})}})})}},t.fetch=function(e,n,r,o){var a,i=t.once(t.mkAsync(n)),s=function(e){var n=e.replace(/(\/)*$/,""),t=n.lastIndexOf("/"),r=n.slice(t+1);return/^[a-f0-9]{48}$/.test(r)||(r=void 0),r}(e),c=function(){(a=new XMLHttpRequest).open("GET",e,!0),r&&a.addEventListener("progress",function(e){if(e.lengthComputable){var n=e.loaded/e.total;r(n)}},!1),a.responseType="arraybuffer",a.onerror=function(e){i(e)},a.onload=function(){if(/^4/.test(""+this.status))return i("XHR_ERROR");var e=a.response;if(e){var n=new Uint8Array(e);return s?void function(e,n,t){o&&"function"==typeof o.setBlobCache?o.setBlobCache(e,n,t):t("EINVAL")}(s,n,function(){i(null,n)}):void i(void 0,n)}i("ENOENT")},a.send(null)};if(s)return function(e,n){o&&"function"==typeof o.getBlobCache?o.getBlobCache(e,n):n("EINVAL")}(s,function(e,n){!e&&n?i(void 0,n):c()}),{cancel:function(){a&&a.abort&&a.abort()}};c()},t.dataURIToBlob=function(e){for(var n=atob(e.split(",")[1]),t=e.split(",")[0].split(":")[1].split(";")[0],r=new ArrayBuffer(n.length),o=new Uint8Array(r),a=0;a<n.length;a++)o[a]=n.charCodeAt(a);return new Blob([r],{type:t})},t.throttle=function(e,n){var r,o,a=0,i=function(t){r=setTimeout(function(){r=void 0;var t=+new Date-a;t<n?i(n-t):e.apply(null,o)},t)},s=function(){a=+new Date,o=t.slice(arguments),r||i(n)};return s.clear=function(){clearTimeout(r),r=void 0},s},t.notAgainForAnother=function(e,n){if("function"!=typeof e||"number"!=typeof n)throw new Error("invalid inputs");var r=null;return function(){var o=+new Date;return r&&o<=r+n?n-(o-r):(r=o,e.apply(null,t.slice(arguments)),null)}},t.createRandomInteger=function(){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)},t.noop=function(){},t.once=function(e,n){return function(){e&&(e.apply(this,Array.prototype.slice.call(arguments)),e=n)}},t.blobToImage=function(e,n){var t=new FileReader;t.onloadend=function(){n(t.result)},t.readAsDataURL(e)},t.blobURLToImage=function(e,n){var t=new XMLHttpRequest;t.onload=function(){var e=new FileReader;e.onloadend=function(){n(e.result)},e.readAsDataURL(t.response)},t.open("GET",e),t.responseType="blob",t.send()},t.isObject=function(e){return"object"==typeof e&&"[object Object]"===Object.prototype.toString.call(e)},t.isCircular=function(e){try{return JSON.stringify(e),!1}catch(e){return!0}},t.extend=function(e,n){if(t.isObject(e)&&t.isObject(n))if(t.isCircular(n))console.log("Extend doesn't accept circular objects");else for(var r in n)t.isObject(n[r])?(e[r]=t.isObject(e[r])?e[r]:{},t.extend(e[r],n[r])):Array.isArray(n[r])?e[r]=n[r].slice():e[r]=n[r];else console.log("Extend only works with 2 objects")},t.isChecked=function(e){return!!e&&(void 0!==e.tagName?Boolean(e.checked):"function"==typeof e.prop&&Boolean(e.prop("checked")))},t.hexToRGB=function(e){var n=e.replace(/^#/,"");return[parseInt(n.slice(0,2),16),parseInt(n.slice(2,4),16),parseInt(n.slice(4,6),16)]},t.rgbToHex=function(e){return`#${e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/).slice(1).map(e=>parseInt(e,10).toString(16).padStart(2,"0")).join("")}`},t.isSmallScreen=function(){return n.innerHeight<800||n.innerWidth<800},t.stripTags=function(e){var n=document.createElement("div");return n.innerHTML=e,n.innerText},t.parseFilename=function(e){if(!e||!e.trim())return{};var n=/^(\.?.+?)(\.[^.]+)?$/.exec(e)||[];return{name:n[1],ext:n[2]}},t.isPlainTextFile=function(e,n){if(e&&0===e.indexOf("text/"))return!0;var r=t.parseFilename(n);return!(e||!n||r.ext)||("application/x-javascript"===e||"application/xml"===e)},t.isSpreadsheet=function(e,n){return e&&("application/vnd.oasis.opendocument.spreadsheet"===e||"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===e)||n&&(n.endsWith(".xlsx")||n.endsWith(".ods"))},t.isOfficeDoc=function(e,n){return e&&("application/vnd.oasis.opendocument.text"===e||"application/vnd.openxmlformats-officedocument.wordprocessingml.document"===e)||n&&(n.endsWith(".docx")||n.endsWith(".odt"))},t.isPresentation=function(e,n){return e&&("application/vnd.oasis.opendocument.presentation"===e||"application/vnd.openxmlformats-officedocument.presentationml.presentation"===e)||n&&(n.endsWith(".pptx")||n.endsWith(".odp"))},t.isValidURL=function(e){return!!new RegExp("^(https?:\\/\\/)((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?").test(e)};var a=/([\uD800-\uDBFF][\uDC00-\uDFFF])/;t.getFirstCharacter=function(e){if(!e||!e.trim())return"?";var n=function(e){for(var n=e.split(a),t=[],r=0;r<n.length;r++){var o=n[r];""!==o&&t.push(o)}return t}(e);return function(e){return a.test(e)}(n[0])?n[0]:e[0]},t.getRandomColor=function(e){var n=function(){return e?Math.floor(156*Math.random())+70:Math.floor(200*Math.random())+25};return"#"+n().toString(16)+n().toString(16)+n().toString(16)},t.checkRestrictedApp=function(e,n,t,r,o){if(Array.isArray(t)&&t.includes(e)&&!n.enableEarlyAccess)return-2;var a=n.premiumTypes;return Array.isArray(a)&&a.includes(e)?o?r?1:0:-1:2};return t.supportsWasm=function(){return!("undefined"==typeof Atomics||!function(){try{return"[object SharedArrayBuffer]"===Object.prototype.toString.call(new n.WebAssembly.Memory({shared:!0,initial:0,maximum:0}).buffer)}catch(e){console.error(e)}return!1}()||"undefined"==typeof WebAssembly)},t.getKeysArray=function(e){return[...Array(e).keys()]},t.getVersionFromUrlArgs=e=>{let n=/ver=([0-9.]+)(-[0-9]*)?/.exec(e);return Array.isArray(n)&&n[1]||void 0},t.Saferphore={create:e=>{var n,t=[];return n=function(){if(e<0)throw new Error("(resourceCount < 0) should never happen");var r;0!==e&&0!==t.length&&(e--,t.shift()((r=0,function(t){if(r++)throw new Error("returnAfter() called multiple times");var o=0;return function(){if(o++)throw new Error("returnAfter wrapped callback called multiple times");t&&t.apply(null,arguments),e++,n()}})))},{take:function(e){t.push(e),n()}}}},t};e.exports&&(e.exports=t(w()))}("undefined"!=typeof self?self:Q)}(z)),z.exports}var X,$,ee={exports:{}};function ne(){return X||(X=1,function(e){e.exports&&(e.exports=function(){var e={},n=function(e){return e.replace(/-/g,"/")};return e.parseUser=function(e){var t,r,o,a=function(e){if(/^\[.*?@.*\]$/.test(e)){var t,r=e.slice(1,-1);if(r=r.replace(/\/([a-zA-Z0-9+-]{43}=)$/,function(e,r){return t=n(r),""}),t){var o=r.lastIndexOf("@");if(!(o<1))return{domain:r.slice(o+1),user:r.slice(0,o),pubkey:t}}}}(e);if(function(e){if(e&&e.domain&&e.user&&e.pubkey)return!0}(a))return a;if(e.replace(/^https*:\/\/([^\/]+)\/user\/#\/1\/([^\/]+)\/([a-zA-Z0-9+-]{43}=)$/,function(e,a,i,s){return t=a,r=i,o=n(s),""}),!t)throw new Error("Could not parse user id ["+e+"]");return{domain:t,user:r,pubkey:o}},e.serialize=function(e,n,t){return"["+n+"@"+e.replace(/https*:\/\//,"")+"/"+t.replace(/\//g,"-")+"]"},e.canonicalize=function(t){if("string"==typeof t){if(44===t.length)return n(t);try{return e.parseUser(t).pubkey}catch(e){return}}},e}())}(ee)),ee.exports}function te(){return $||($=1,function(e){!function(n){e.exports&&(e.exports=function(e,t,r,o){var a=n.CryptPad_Hash={},i=e.uint8ArrayToHex,s=e.hexToBase64,c=e.base64ToHex;a.encodeBase64=e.encodeBase64,a.decodeBase64=e.decodeBase64,a.hashChannelList=function(n){return e.encodeBase64(o.hash(e.decodeUTF8(JSON.stringify(n))))},a.generateSignPair=function(){var e=o.sign.keyPair(),n=function(e){return t.b64RemoveSlashes(e).replace(/=+$/g,"")};return{validateKey:a.encodeBase64(e.publicKey),signKey:a.encodeBase64(e.secretKey),safeValidateKey:n(a.encodeBase64(e.publicKey)),safeSignKey:n(a.encodeBase64(e.secretKey))}},a.getSignPublicFromPrivate=function(n){var r=t.b64AddSlashes(n),a=e.decodeBase64(r),i=o.sign.keyPair.fromSecretKey(a);return e.encodeBase64(i.publicKey)},a.getCurvePublicFromPrivate=function(n){var r=t.b64AddSlashes(n),a=e.decodeBase64(r),i=o.box.keyPair.fromSecretKey(a);return e.encodeBase64(i.publicKey)};var u=a.getEditHashFromKeys=function(e){var n=e.version,r=e.keys;if(0===n)return e.channel+e.key;if(1===n){if(!r.editKeyStr)return;return"/1/edit/"+s(e.channel)+"/"+t.b64RemoveSlashes(r.editKeyStr)+"/"}if(2===n){if(!r.editKeyStr)return;var o=e.password?"p/":"";return"/2/"+e.type+"/edit/"+t.b64RemoveSlashes(r.editKeyStr)+"/"+o}},f=a.getViewHashFromKeys=function(e){var n=e.version,r=e.keys;if(0!==n){if(1===n){if(!r.viewKeyStr)return;return"/1/view/"+s(e.channel)+"/"+t.b64RemoveSlashes(r.viewKeyStr)+"/"}if(2===n){if(!r.viewKeyStr)return;var o=e.password?"p/":"";return"/2/"+e.type+"/view/"+t.b64RemoveSlashes(r.viewKeyStr)+"/"+o}}};a.getHiddenHashFromKeys=function(e,n,t){t=t||{};var r=n.keys&&n.keys.editKeyStr||n.key,o=!t.view&&r?"edit/":"view/",i=n.password?"p/":"";n.keys&&n.keys.fileKeyStr&&(o="");var s="/3/"+e+"/"+o+n.channel+"/"+i,c=a.parseTypeHash(e,s);return c&&c.getHash?c.getHash(t||{}):s};var l=a.getFileHashFromKeys=function(e){var n=e.version,r=e.keys;if(0!==n){if(1===n)return"/1/"+s(e.channel)+"/"+t.b64RemoveSlashes(r.fileKeyStr)+"/";if(2===n){if(!r.fileKeyStr)return;var o=e.password?"p/":"";return"/2/"+e.type+"/"+t.b64RemoveSlashes(r.fileKeyStr)+"/"+o}}};a.getPublicSigningKeyString=r.serialize,a.ephemeralChannelLength=34,a.createChannelId=function(e){var n=i(t.Nacl.randomBytes(e?17:16));if(-1===[32,34].indexOf(n.length)||/[^a-f0-9]/.test(n))throw new Error("channel ids must consist of 32 hex characters");return n},a.getChannelIdFromKey=function(e){if(e)return i(a.decodeBase64(e).subarray(0,16))},a.getBoxPublicFromSecret=function(e){if(e){var n=a.decodeBase64(e),t=o.box.keyPair.fromSecretKey(n);return a.encodeBase64(t.publicKey)}},a.checkBoxKeyPair=function(e,n){if(!n||!e)return!1;var t=a.decodeBase64(e),r=o.box.keyPair.fromSecretKey(t);return n===a.encodeBase64(r.publicKey)},a.createRandomHash=function(e,n){var r;return"file"===e?(r=t.createFileCryptor2(void 0,n),l({password:Boolean(n),version:2,type:e,keys:r})):(r=t.createEditCryptor2(void 0,void 0,n),u({password:Boolean(n),version:2,type:e,keys:r}))};var d=a.parseTypeHash=function(e,n){if(n){var r,o=[],a={},i=(r=n,r.replace(/\/+/g,"/")).split("/"),s=function(){a.password=-1!==o.indexOf("p"),a.present=-1!==o.indexOf("present"),a.embed=-1!==o.indexOf("embed"),a.versionHash=function(e){var n;return e.some(function(e){if(/^hash=/.test(e))return n=e.slice(5),!0}),n?t.b64AddSlashes(n):""}(o),a.auditorKey=function(e){var n;return e.some(function(e){if(/^auditor=/.test(e))return n=e.slice(8),!0}),n?t.b64AddSlashes(n):""}(o),a.newPadOpts=function(e){var n;return e.some(function(e){if(/^newpad=/.test(e))return n=e.slice(7),!0}),n||""}(o),a.loginOpts=function(e){var n;return e.some(function(e){if(/^login=/.test(e))return n=e.slice(6),!0}),n||""}(o),a.ownerKey=function(e){var n;return e.some(function(e){if(86===e.length)return n=e,!0}),n}(o)};return i[1]&&"4"===i[1]?(a.getHash=function(n){if(!n||!Object.keys(n).length)return"";var t="/4/"+e+"/";return n.newPadOpts&&(t+="newpad="+n.newPadOpts+"/"),n.loginOpts&&(t+="login="+n.loginOpts+"/"),t},a.getOptions=function(){var e={};return a.newPadOpts&&(e.newPadOpts=a.newPadOpts),a.loginOpts&&(e.loginOpts=a.loginOpts),e},a.version=4,a.app=i[2],o=i.slice(3),s(),a):-1===["media","file","user","invite"].indexOf(e)?(a.type="pad",a.getHash=function(){return n},a.getOptions=function(){return{embed:a.embed,present:a.present,ownerKey:a.ownerKey,versionHash:a.versionHash,auditorKey:a.auditorKey,newPadOpts:a.newPadOpts,loginOpts:a.loginOpts,password:a.password}},"/"!==n.slice(0,1)&&n.length>=56?(a.channel=n.slice(0,32),a.key=n.slice(32,56),a.version=0,a):(a.getHash=function(e){var n=i.slice(0,5).join("/")+"/",r=void 0!==e.ownerKey?e.ownerKey:a.ownerKey;r&&(n+=r+"/"),(a.password||e.password)&&(n+="p/"),e.embed&&(n+="embed/"),e.present&&(n+="present/");var o=void 0!==e.versionHash?e.versionHash:a.versionHash;o&&(n+="hash="+t.b64RemoveSlashes(o)+"/");var s=void 0!==e.auditorKey?e.auditorKey:a.auditorKey;return s&&(n+="auditor="+t.b64RemoveSlashes(s)+"/"),e.newPadOpts&&(n+="newpad="+e.newPadOpts+"/"),e.loginOpts&&(n+="login="+e.loginOpts+"/"),n},i[1]&&"1"===i[1]?(a.version=1,a.mode=i[2],a.channel=i[3],a.key=t.b64AddSlashes(i[4]),o=i.slice(5),s(),a):i[1]&&"2"===i[1]?(a.version=2,a.app=i[2],a.mode=i[3],a.key=i[4],o=i.slice(5),s(),a):i[1]&&"3"===i[1]?(a.version=3,a.app=i[2],a.mode=i[3],a.channel=i[4],o=i.slice(5),s(),a):a)):(a.getHash=function(){return i.join("/")},-1!==["media","file"].indexOf(e)?(a.type="file",a.getOptions=function(){return{embed:a.embed,present:a.present,ownerKey:a.ownerKey,newPadOpts:a.newPadOpts,loginOpts:a.loginOpts,password:a.password}},a.getHash=function(e){var n=i.slice(0,4).join("/")+"/",t=void 0!==e.ownerKey?e.ownerKey:a.ownerKey;return t&&(n+=t+"/"),(a.password||e.password)&&(n+="p/"),e.embed&&(n+="embed/"),e.present&&(n+="present/"),e.newPadOpts&&(n+="newpad="+e.newPadOpts+"/"),e.loginOpts&&(n+="login="+e.loginOpts+"/"),n},i[1]&&"1"===i[1]?(a.version=1,a.channel=i[2].replace(/-/g,"/"),a.key=i[3].replace(/-/g,"/"),o=i.slice(4),s(),a):i[1]&&"2"===i[1]?(a.version=2,a.app=i[2],a.key=i[3],o=i.slice(4),s(),a):i[1]&&"3"===i[1]?(a.version=3,a.app=i[2],a.channel=i[3],o=i.slice(4),s(),a):a):-1!==["user"].indexOf(e)?(a.type="user",i[1]&&"1"===i[1]?(a.version=1,a.user=i[2],a.pubkey=i[3].replace(/-/g,"/"),a):a):-1!==["invite"].indexOf(e)?(a.type="invite",i[1]&&"2"===i[1]?(a.version=2,a.app=i[2],a.mode=i[3],a.key=i[4],o=i.slice(5),a.password=-1!==o.indexOf("p"),a):a):void 0)}},h=a.parsePadUrl=function(e){var n,t={};return e?("/"!==e.slice(-1)&&"#"!==e.slice(-1)&&(e+="/"),e=e.replace(/\/\?[^#]+#/,"/#"),t.getUrl=function(e){e=e||{};var n="/";return t.type?(n+=t.type+"/",!t.hashData&&e&&Object.keys(e).length?n+"#"+function(e){if(!e||!Object.keys(e).length)return"";var n="/4/"+t.type+"/";return e.newPadOpts&&(n+="newpad="+e.newPadOpts+"/"),e.loginOpts&&(n+="login="+e.loginOpts+"/"),n}(e):t.hashData?n+="#"+t.hashData.getHash(e):n):n},t.getOptions=function(){return t.hashData&&t.hashData.getOptions?t.hashData.getOptions():{}},/^https*:\/\//.test(e)?(e.replace(/^https*:\/\/([^\/]*)\/(.*?)\//i,function(e,n,r){return t.domain=n,t.type=r,""}),-1===(n=e.indexOf("/#"))||(t.hash=e.slice(n+2),t.hashData=d(t.type,t.hash)),t):/^\/($|[^\/])/.test(e)?(n=e.indexOf("/#"),t.type=e.slice(1,n),-1===n||(t.hash=e.slice(n+2),t.hashData=d(t.type,t.hash)),t):t):t};return a.hashToHref=function(e,n){return"/"+n+"/#"+e},a.hrefToHash=function(e){return a.parsePadUrl(e).hash},a.getRelativeHref=function(e){if(e&&-1!==e.indexOf("#")){var n=h(e);return"/"+n.type+"/#"+n.hash}},a.getSecrets=function(n,r,o){var a,i,s={},u=function(){s.keys=t.createEditCryptor2(void 0,void 0,o),s.channel=c(s.keys.chanId),s.version=2,s.type=n};if(!r)return u(),s;if(r){if(!n)throw new Error("getSecrets with a hash requires a type parameter");a=d(n,r),i=r}if(0===i.length)return u(),s;if(0===a.version)s.channel=a.channel,s.key=a.key,s.version=0;else if(1===a.version){if(s.version=1,"pad"===a.type){if(s.channel=c(a.channel),"edit"===a.mode){if(s.keys=t.createEditCryptor(a.key),s.key=s.keys.editKeyStr,32!==s.channel.length||24!==s.key.length)throw new Error("The channel key and/or the encryption key is invalid")}else if("view"===a.mode&&(s.keys=t.createViewCryptor(a.key),32!==s.channel.length))throw new Error("The channel key is invalid")}else if("file"===a.type)s.channel=c(a.channel),s.keys={fileKeyStr:a.key,cryptKey:e.decodeBase64(a.key)};else if("user"===a.type)throw new Error("User hashes can't be opened (yet)")}else if(2===a.version)if(s.version=2,s.type=n,s.password=o,"pad"===a.type){if("edit"===a.mode){if(s.keys=t.createEditCryptor2(a.key,void 0,o),s.channel=c(s.keys.chanId),s.key=s.keys.editKeyStr,32!==s.channel.length||24!==s.key.length)throw new Error("The channel key and/or the encryption key is invalid")}else if("view"===a.mode&&(s.keys=t.createViewCryptor2(a.key,o),s.channel=c(s.keys.chanId),32!==s.channel.length))throw new Error("The channel key is invalid")}else if("file"===a.type){if(s.keys=t.createFileCryptor2(a.key,o),s.channel=c(s.keys.chanId),s.key=s.keys.fileKeyStr,48!==s.channel.length||24!==s.key.length)throw new Error("The channel key and/or the encryption key is invalid")}else if("user"===a.type)throw new Error("User hashes can't be opened (yet)");return s},a.getHashes=function(e){var n={};return(e=JSON.parse(JSON.stringify(e))).keys||e.key?(e.keys||(e.keys={}),(e.keys.editKeyStr||0===e.version&&e.key)&&(n.editHash=u(e)),e.keys.viewKeyStr&&(n.viewHash=f(e)),e.keys.fileKeyStr&&(n.fileHash=l(e)),n):n},a.getFormData=function(n,t,r){var i=(n=n||a.getSecrets("form",t,r))&&n.keys,s=i&&i.secondaryKey;if(s){var c=o.box.keyPair.fromSecretKey(e.decodeUTF8(s).slice(0,32)),u={};u.form_public=e.encodeBase64(c.publicKey);var f=u.form_private=e.encodeBase64(c.secretKey),l=a.getViewHashFromKeys({version:1,channel:n.channel,keys:{viewKeyStr:e.encodeBase64(i.cryptKey)}}),d=a.parseTypeHash("pad",l);return u.form_auditorHash=d.getHash({auditorKey:f}),u}},a.hrefToHexChannelId=function(e,n){var t=a.parsePadUrl(e);if(t&&t.hash)return a.getSecrets(t.type,t.hash,n).channel},a.getBlobPathFromHex=function(e){return"/blob/"+e.slice(0,2)+"/"+e},a.serializeHash=function(e){return e&&"/"!==e.slice(-1)&&(e+="/"),e},a.createInviteUrl=function(e,t){return t=t||a.createChannelId(),n.location.origin+"/invite/#/1/"+t+"/"+e.replace(/\//g,"-")+"/"},a.isValidChannel=function(e){return/^[a-zA-Z0-9]{32,48}$/.test(e)},a.isValidHref=function(e){if(e){var n=a.parsePadUrl(e);if(n&&n.type){if(n.hash){if(!n.hashData)return;if(void 0===n.hashData.version)return;if("pad"===n.hashData.type||"file"===n.hashData.type){if(!n.hashData.key&&!n.hashData.channel)return;if(n.hashData.key&&!/^[a-zA-Z0-9+-/=]+$/.test(n.hashData.key))return}}return n}}},a.decodeDataOptions=function(n){var t=decodeURIComponent(n),r=e.encodeUTF8(e.decodeBase64(t));return e.tryParse(r)||{}},a.encodeDataOptions=function(n){var t=JSON.stringify(n),r=e.encodeBase64(e.decodeUTF8(t));return encodeURIComponent(r)},a.getNewPadURL=function(e,n){var t=a.parsePadUrl(e),r=t.getOptions();return r.newPadOpts=a.encodeDataOptions(n),t.getUrl(r)},a.getLoginURL=function(e,n){var t=a.parsePadUrl(e),r=t.getOptions();return r.loginOpts=a.encodeDataOptions(n),t.getUrl(r)},a}(Z(),M(),ne(),h()))}("undefined"!=typeof window?window:{})}(W)),W.exports}var re,oe,ae=te(),ie=Z(),se={exports:{}},ce={exports:{}};function ue(){return re||(re=1,function(e){e.exports=function e(n,t,r){function o(i,s){if(!t[i]){if(!n[i]){if(!s&&f)return f(i);if(a)return a(i,!0);var c=new Error("Cannot find module '"+i+"'");throw c.code="MODULE_NOT_FOUND",c}var u=t[i]={exports:{}};n[i][0].call(u.exports,function(e){var t=n[i][1][e];return o(t||e)},u,u.exports,e,n,t,r)}return t[i].exports}for(var a=f,i=0;i<r.length;i++)o(r[i]);return o}({1:[function(e,n,r){(function(e){var t,r,o=e.MutationObserver||e.WebKitMutationObserver;if(o){var a=0,i=new o(f),s=e.document.createTextNode("");i.observe(s,{characterData:!0}),t=function(){s.data=a=++a%2}}else if(e.setImmediate||void 0===e.MessageChannel)t="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var n=e.document.createElement("script");n.onreadystatechange=function(){f(),n.onreadystatechange=null,n.parentNode.removeChild(n),n=null},e.document.documentElement.appendChild(n)}:function(){setTimeout(f,0)};else{var c=new e.MessageChannel;c.port1.onmessage=f,t=function(){c.port2.postMessage(0)}}var u=[];function f(){var e,n;r=!0;for(var t=u.length;t;){for(n=u,u=[],e=-1;++e<t;)n[e]();t=u.length}r=!1}function l(e){1!==u.push(e)||r||t()}n.exports=l}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,n,t){var r=e(1);function o(){}var a={},i=["REJECTED"],s=["FULFILLED"],c=["PENDING"];function u(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=c,this.queue=[],this.outcome=void 0,e!==o&&h(this,e)}function f(e,n,t){this.promise=e,"function"==typeof n&&(this.onFulfilled=n,this.callFulfilled=this.otherCallFulfilled),"function"==typeof t&&(this.onRejected=t,this.callRejected=this.otherCallRejected)}function l(e,n,t){r(function(){var r;try{r=n(t)}catch(n){return a.reject(e,n)}r===e?a.reject(e,new TypeError("Cannot resolve promise with itself")):a.resolve(e,r)})}function d(e){var n=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof n)return function(){n.apply(e,arguments)}}function h(e,n){var t=!1;function r(n){t||(t=!0,a.reject(e,n))}function o(n){t||(t=!0,a.resolve(e,n))}function i(){n(o,r)}var s=p(i);"error"===s.status&&r(s.value)}function p(e,n){var t={};try{t.value=e(n),t.status="success"}catch(e){t.status="error",t.value=e}return t}function v(e){return e instanceof this?e:a.resolve(new this(o),e)}function y(e){var n=new this(o);return a.reject(n,e)}function m(e){var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var t=e.length,r=!1;if(!t)return this.resolve([]);for(var i=new Array(t),s=0,c=-1,u=new this(o);++c<t;)f(e[c],c);return u;function f(e,o){function c(e){i[o]=e,++s!==t||r||(r=!0,a.resolve(u,i))}n.resolve(e).then(c,function(e){r||(r=!0,a.reject(u,e))})}}function g(e){var n=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var t=e.length,r=!1;if(!t)return this.resolve([]);for(var i=-1,s=new this(o);++i<t;)c(e[i]);return s;function c(e){n.resolve(e).then(function(e){r||(r=!0,a.resolve(s,e))},function(e){r||(r=!0,a.reject(s,e))})}}n.exports=u,u.prototype.catch=function(e){return this.then(null,e)},u.prototype.then=function(e,n){if("function"!=typeof e&&this.state===s||"function"!=typeof n&&this.state===i)return this;var t=new this.constructor(o);return this.state!==c?l(t,this.state===s?e:n,this.outcome):this.queue.push(new f(t,e,n)),t},f.prototype.callFulfilled=function(e){a.resolve(this.promise,e)},f.prototype.otherCallFulfilled=function(e){l(this.promise,this.onFulfilled,e)},f.prototype.callRejected=function(e){a.reject(this.promise,e)},f.prototype.otherCallRejected=function(e){l(this.promise,this.onRejected,e)},a.resolve=function(e,n){var t=p(d,n);if("error"===t.status)return a.reject(e,t.value);var r=t.value;if(r)h(e,r);else{e.state=s,e.outcome=n;for(var o=-1,i=e.queue.length;++o<i;)e.queue[o].callFulfilled(n)}return e},a.reject=function(e,n){e.state=i,e.outcome=n;for(var t=-1,r=e.queue.length;++t<r;)e.queue[t].callRejected(n);return e},u.resolve=v,u.reject=y,u.all=m,u.race=g},{1:1}],3:[function(e,n,r){(function(n){"function"!=typeof n.Promise&&(n.Promise=e(2))}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,n,t){var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function a(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}var i=a();function s(){try{if(!i||!i.open)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),n="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||n)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}function c(e,n){e=e||[],n=n||{};try{return new Blob(e,n)}catch(o){if("TypeError"!==o.name)throw o;for(var t=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),r=0;r<e.length;r+=1)t.append(e[r]);return t.getBlob(n.type)}}"undefined"==typeof Promise&&e(3);var u=Promise;function f(e,n){n&&e.then(function(e){n(null,e)},function(e){n(e)})}function l(e,n,t){"function"==typeof n&&e.then(n),"function"==typeof t&&e.catch(t)}function d(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function h(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var p="local-forage-detect-blob-support",v=void 0,y={},m=Object.prototype.toString,g="readonly",E="readwrite";function b(e){for(var n=e.length,t=new ArrayBuffer(n),r=new Uint8Array(t),o=0;o<n;o++)r[o]=e.charCodeAt(o);return t}function O(e){return new u(function(n){var t=e.transaction(p,E),r=c([""]);t.objectStore(p).put(r,"key"),t.onabort=function(e){e.preventDefault(),e.stopPropagation(),n(!1)},t.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),t=navigator.userAgent.match(/Edge\//);n(t||!e||parseInt(e[1],10)>=43)}}).catch(function(){return!1})}function A(e){return"boolean"==typeof v?u.resolve(v):O(e).then(function(e){return v=e})}function w(e){var n=y[e.name],t={};t.promise=new u(function(e,n){t.resolve=e,t.reject=n}),n.deferredOperations.push(t),n.dbReady?n.dbReady=n.dbReady.then(function(){return t.promise}):n.dbReady=t.promise}function D(e){var n=y[e.name].deferredOperations.pop();if(n)return n.resolve(),n.promise}function _(e,n){var t=y[e.name].deferredOperations.pop();if(t)return t.reject(n),t.promise}function T(e,n){return new u(function(t,r){if(y[e.name]=y[e.name]||F(),e.db){if(!n)return t(e.db);w(e),e.db.close()}var o=[e.name];n&&o.push(e.version);var a=i.open.apply(i,o);n&&(a.onupgradeneeded=function(n){var t=a.result;try{t.createObjectStore(e.storeName),n.oldVersion<=1&&t.createObjectStore(p)}catch(t){if("ConstraintError"!==t.name)throw t;console.warn('The database "'+e.name+'" has been upgraded from version '+n.oldVersion+" to version "+n.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),a.onerror=function(e){e.preventDefault(),r(a.error)},a.onsuccess=function(){var n=a.result;n.onversionchange=function(e){e.target.close()},t(n),D(e)}})}function S(e){return T(e,!1)}function N(e){return T(e,!0)}function I(e,n){if(!e.db)return!0;var t=!e.db.objectStoreNames.contains(e.storeName),r=e.version<e.db.version,o=e.version>e.db.version;if(r&&(e.version!==n&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),o||t){if(t){var a=e.db.version+1;a>e.version&&(e.version=a)}return!0}return!1}function x(e){return new u(function(n,t){var r=new FileReader;r.onerror=t,r.onloadend=function(t){var r=btoa(t.target.result||"");n({__local_forage_encoded_blob:!0,data:r,type:e.type})},r.readAsBinaryString(e)})}function C(e){return c([b(atob(e.data))],{type:e.type})}function R(e){return e&&e.__local_forage_encoded_blob}function P(e){var n=this,t=n._initReady().then(function(){var e=y[n._dbInfo.name];if(e&&e.dbReady)return e.dbReady});return l(t,e,e),t}function k(e){w(e);for(var n=y[e.name],t=n.forages,r=0;r<t.length;r++){var o=t[r];o._dbInfo.db&&(o._dbInfo.db.close(),o._dbInfo.db=null)}return e.db=null,S(e).then(function(n){return e.db=n,I(e)?N(e):n}).then(function(r){e.db=n.db=r;for(var o=0;o<t.length;o++)t[o]._dbInfo.db=r}).catch(function(n){throw _(e,n),n})}function M(e,n,t,r){void 0===r&&(r=1);try{var o=e.db.transaction(e.storeName,n);t(null,o)}catch(o){if(r>0&&(!e.db||"InvalidStateError"===o.name||"NotFoundError"===o.name))return u.resolve().then(function(){if(!e.db||"NotFoundError"===o.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),N(e)}).then(function(){return k(e).then(function(){M(e,n,t,r-1)})}).catch(t);t(o)}}function F(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function L(e){var n=this,t={db:null};if(e)for(var r in e)t[r]=e[r];var o=y[t.name];o||(o=F(),y[t.name]=o),o.forages.push(n),n._initReady||(n._initReady=n.ready,n.ready=P);var a=[];function i(){return u.resolve()}for(var s=0;s<o.forages.length;s++){var c=o.forages[s];c!==n&&a.push(c._initReady().catch(i))}var f=o.forages.slice(0);return u.all(a).then(function(){return t.db=o.db,S(t)}).then(function(e){return t.db=e,I(t,n._defaultConfig.version)?N(t):e}).then(function(e){t.db=o.db=e,n._dbInfo=t;for(var r=0;r<f.length;r++){var a=f[r];a!==n&&(a._dbInfo.db=t.db,a._dbInfo.version=t.version)}})}function H(e,n){var t=this;e=d(e);var r=new u(function(n,r){t.ready().then(function(){M(t._dbInfo,g,function(o,a){if(o)return r(o);try{var i=a.objectStore(t._dbInfo.storeName).get(e);i.onsuccess=function(){var e=i.result;void 0===e&&(e=null),R(e)&&(e=C(e)),n(e)},i.onerror=function(){r(i.error)}}catch(e){r(e)}})}).catch(r)});return f(r,n),r}function j(e,n){var t=this,r=new u(function(n,r){t.ready().then(function(){M(t._dbInfo,g,function(o,a){if(o)return r(o);try{var i=a.objectStore(t._dbInfo.storeName).openCursor(),s=1;i.onsuccess=function(){var t=i.result;if(t){var r=t.value;R(r)&&(r=C(r));var o=e(r,t.key,s++);void 0!==o?n(o):t.continue()}else n()},i.onerror=function(){r(i.error)}}catch(e){r(e)}})}).catch(r)});return f(r,n),r}function K(e,n,t){var r=this;e=d(e);var o=new u(function(t,o){var a;r.ready().then(function(){return a=r._dbInfo,"[object Blob]"===m.call(n)?A(a.db).then(function(e){return e?n:x(n)}):n}).then(function(n){M(r._dbInfo,E,function(a,i){if(a)return o(a);try{var s=i.objectStore(r._dbInfo.storeName);null===n&&(n=void 0);var c=s.put(n,e);i.oncomplete=function(){void 0===n&&(n=null),t(n)},i.onabort=i.onerror=function(){var e=c.error?c.error:c.transaction.error;o(e)}}catch(e){o(e)}})}).catch(o)});return f(o,t),o}function U(e,n){var t=this;e=d(e);var r=new u(function(n,r){t.ready().then(function(){M(t._dbInfo,E,function(o,a){if(o)return r(o);try{var i=a.objectStore(t._dbInfo.storeName).delete(e);a.oncomplete=function(){n()},a.onerror=function(){r(i.error)},a.onabort=function(){var e=i.error?i.error:i.transaction.error;r(e)}}catch(e){r(e)}})}).catch(r)});return f(r,n),r}function B(e){var n=this,t=new u(function(e,t){n.ready().then(function(){M(n._dbInfo,E,function(r,o){if(r)return t(r);try{var a=o.objectStore(n._dbInfo.storeName).clear();o.oncomplete=function(){e()},o.onabort=o.onerror=function(){var e=a.error?a.error:a.transaction.error;t(e)}}catch(e){t(e)}})}).catch(t)});return f(t,e),t}function V(e){var n=this,t=new u(function(e,t){n.ready().then(function(){M(n._dbInfo,g,function(r,o){if(r)return t(r);try{var a=o.objectStore(n._dbInfo.storeName).count();a.onsuccess=function(){e(a.result)},a.onerror=function(){t(a.error)}}catch(e){t(e)}})}).catch(t)});return f(t,e),t}function Y(e,n){var t=this,r=new u(function(n,r){e<0?n(null):t.ready().then(function(){M(t._dbInfo,g,function(o,a){if(o)return r(o);try{var i=a.objectStore(t._dbInfo.storeName),s=!1,c=i.openKeyCursor();c.onsuccess=function(){var t=c.result;t?0===e||s?n(t.key):(s=!0,t.advance(e)):n(null)},c.onerror=function(){r(c.error)}}catch(e){r(e)}})}).catch(r)});return f(r,n),r}function G(e){var n=this,t=new u(function(e,t){n.ready().then(function(){M(n._dbInfo,g,function(r,o){if(r)return t(r);try{var a=o.objectStore(n._dbInfo.storeName).openKeyCursor(),i=[];a.onsuccess=function(){var n=a.result;n?(i.push(n.key),n.continue()):e(i)},a.onerror=function(){t(a.error)}}catch(e){t(e)}})}).catch(t)});return f(t,e),t}function J(e,n){n=h.apply(this,arguments);var t=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||t.name,e.storeName=e.storeName||t.storeName);var r,o=this;if(e.name){var a=e.name===t.name&&o._dbInfo.db?u.resolve(o._dbInfo.db):S(e).then(function(n){var t=y[e.name],r=t.forages;t.db=n;for(var o=0;o<r.length;o++)r[o]._dbInfo.db=n;return n});r=e.storeName?a.then(function(n){if(n.objectStoreNames.contains(e.storeName)){var t=n.version+1;w(e);var r=y[e.name],o=r.forages;n.close();for(var a=0;a<o.length;a++){var s=o[a];s._dbInfo.db=null,s._dbInfo.version=t}var c=new u(function(n,r){var o=i.open(e.name,t);o.onerror=function(e){o.result.close(),r(e)},o.onupgradeneeded=function(){o.result.deleteObjectStore(e.storeName)},o.onsuccess=function(){var e=o.result;e.close(),n(e)}});return c.then(function(e){r.db=e;for(var n=0;n<o.length;n++){var t=o[n];t._dbInfo.db=e,D(t._dbInfo)}}).catch(function(n){throw(_(e,n)||u.resolve()).catch(function(){}),n})}}):a.then(function(n){w(e);var t=y[e.name],r=t.forages;n.close();for(var o=0;o<r.length;o++)r[o]._dbInfo.db=null;var a=new u(function(n,t){var r=i.deleteDatabase(e.name);r.onerror=function(){var e=r.result;e&&e.close(),t(r.error)},r.onblocked=function(){console.warn('dropInstance blocked for database "'+e.name+'" until all open connections are closed')},r.onsuccess=function(){var e=r.result;e&&e.close(),n(e)}});return a.then(function(e){t.db=e;for(var n=0;n<r.length;n++)D(r[n]._dbInfo)}).catch(function(n){throw(_(e,n)||u.resolve()).catch(function(){}),n})})}else r=u.reject("Invalid arguments");return f(r,n),r}var q={_driver:"asyncStorage",_initStorage:L,_support:s(),iterate:j,getItem:H,setItem:K,removeItem:U,clear:B,length:V,key:Y,keys:G,dropInstance:J};function W(){return"function"==typeof openDatabase}var z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Q="~~local_forage_type~",Z=/^~~local_forage_type~([^~]+)~/,X="__lfsc__:",$=X.length,ee="arbf",ne="blob",te="si08",re="ui08",oe="uic8",ae="si16",ie="si32",se="ur16",ce="ui32",ue="fl32",fe="fl64",le=$+ee.length,de=Object.prototype.toString;function he(e){var n,t,r,o,a,i=.75*e.length,s=e.length,c=0;"="===e[e.length-1]&&(i--,"="===e[e.length-2]&&i--);var u=new ArrayBuffer(i),f=new Uint8Array(u);for(n=0;n<s;n+=4)t=z.indexOf(e[n]),r=z.indexOf(e[n+1]),o=z.indexOf(e[n+2]),a=z.indexOf(e[n+3]),f[c++]=t<<2|r>>4,f[c++]=(15&r)<<4|o>>2,f[c++]=(3&o)<<6|63&a;return u}function pe(e){var n,t=new Uint8Array(e),r="";for(n=0;n<t.length;n+=3)r+=z[t[n]>>2],r+=z[(3&t[n])<<4|t[n+1]>>4],r+=z[(15&t[n+1])<<2|t[n+2]>>6],r+=z[63&t[n+2]];return t.length%3==2?r=r.substring(0,r.length-1)+"=":t.length%3==1&&(r=r.substring(0,r.length-2)+"=="),r}function ve(e,n){var t="";if(e&&(t=de.call(e)),e&&("[object ArrayBuffer]"===t||e.buffer&&"[object ArrayBuffer]"===de.call(e.buffer))){var r,o=X;e instanceof ArrayBuffer?(r=e,o+=ee):(r=e.buffer,"[object Int8Array]"===t?o+=te:"[object Uint8Array]"===t?o+=re:"[object Uint8ClampedArray]"===t?o+=oe:"[object Int16Array]"===t?o+=ae:"[object Uint16Array]"===t?o+=se:"[object Int32Array]"===t?o+=ie:"[object Uint32Array]"===t?o+=ce:"[object Float32Array]"===t?o+=ue:"[object Float64Array]"===t?o+=fe:n(new Error("Failed to get type for BinaryArray"))),n(o+pe(r))}else if("[object Blob]"===t){var a=new FileReader;a.onload=function(){var t=Q+e.type+"~"+pe(this.result);n(X+ne+t)},a.readAsArrayBuffer(e)}else try{n(JSON.stringify(e))}catch(t){console.error("Couldn't convert value into a JSON string: ",e),n(null,t)}}function ye(e){if(e.substring(0,$)!==X)return JSON.parse(e);var n,t=e.substring(le),r=e.substring($,le);if(r===ne&&Z.test(t)){var o=t.match(Z);n=o[1],t=t.substring(o[0].length)}var a=he(t);switch(r){case ee:return a;case ne:return c([a],{type:n});case te:return new Int8Array(a);case re:return new Uint8Array(a);case oe:return new Uint8ClampedArray(a);case ae:return new Int16Array(a);case se:return new Uint16Array(a);case ie:return new Int32Array(a);case ce:return new Uint32Array(a);case ue:return new Float32Array(a);case fe:return new Float64Array(a);default:throw new Error("Unkown type: "+r)}}var me={serialize:ve,deserialize:ye,stringToBuffer:he,bufferToString:pe};function ge(e,n,t,r){e.executeSql("CREATE TABLE IF NOT EXISTS "+n.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],t,r)}function Ee(e){var n=this,t={db:null};if(e)for(var r in e)t[r]="string"!=typeof e[r]?e[r].toString():e[r];var o=new u(function(e,r){try{t.db=openDatabase(t.name,String(t.version),t.description,t.size)}catch(e){return r(e)}t.db.transaction(function(o){ge(o,t,function(){n._dbInfo=t,e()},function(e,n){r(n)})},r)});return t.serializer=me,o}function be(e,n,t,r,o,a){e.executeSql(t,r,o,function(e,i){i.code===i.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[n.storeName],function(e,s){s.rows.length?a(e,i):ge(e,n,function(){e.executeSql(t,r,o,a)},a)},a):a(e,i)},a)}function Oe(e,n){var t=this;e=d(e);var r=new u(function(n,r){t.ready().then(function(){var o=t._dbInfo;o.db.transaction(function(t){be(t,o,"SELECT * FROM "+o.storeName+" WHERE key = ? LIMIT 1",[e],function(e,t){var r=t.rows.length?t.rows.item(0).value:null;r&&(r=o.serializer.deserialize(r)),n(r)},function(e,n){r(n)})})}).catch(r)});return f(r,n),r}function Ae(e,n){var t=this,r=new u(function(n,r){t.ready().then(function(){var o=t._dbInfo;o.db.transaction(function(t){be(t,o,"SELECT * FROM "+o.storeName,[],function(t,r){for(var a=r.rows,i=a.length,s=0;s<i;s++){var c=a.item(s),u=c.value;if(u&&(u=o.serializer.deserialize(u)),void 0!==(u=e(u,c.key,s+1)))return void n(u)}n()},function(e,n){r(n)})})}).catch(r)});return f(r,n),r}function we(e,n,t,r){var o=this;e=d(e);var a=new u(function(a,i){o.ready().then(function(){void 0===n&&(n=null);var s=n,c=o._dbInfo;c.serializer.serialize(n,function(n,u){u?i(u):c.db.transaction(function(t){be(t,c,"INSERT OR REPLACE INTO "+c.storeName+" (key, value) VALUES (?, ?)",[e,n],function(){a(s)},function(e,n){i(n)})},function(n){if(n.code===n.QUOTA_ERR){if(r>0)return void a(we.apply(o,[e,s,t,r-1]));i(n)}})})}).catch(i)});return f(a,t),a}function De(e,n,t){return we.apply(this,[e,n,t,1])}function _e(e,n){var t=this;e=d(e);var r=new u(function(n,r){t.ready().then(function(){var o=t._dbInfo;o.db.transaction(function(t){be(t,o,"DELETE FROM "+o.storeName+" WHERE key = ?",[e],function(){n()},function(e,n){r(n)})})}).catch(r)});return f(r,n),r}function Te(e){var n=this,t=new u(function(e,t){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){be(n,r,"DELETE FROM "+r.storeName,[],function(){e()},function(e,n){t(n)})})}).catch(t)});return f(t,e),t}function Se(e){var n=this,t=new u(function(e,t){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){be(n,r,"SELECT COUNT(key) as c FROM "+r.storeName,[],function(n,t){var r=t.rows.item(0).c;e(r)},function(e,n){t(n)})})}).catch(t)});return f(t,e),t}function Ne(e,n){var t=this,r=new u(function(n,r){t.ready().then(function(){var o=t._dbInfo;o.db.transaction(function(t){be(t,o,"SELECT key FROM "+o.storeName+" WHERE id = ? LIMIT 1",[e+1],function(e,t){var r=t.rows.length?t.rows.item(0).key:null;n(r)},function(e,n){r(n)})})}).catch(r)});return f(r,n),r}function Ie(e){var n=this,t=new u(function(e,t){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){be(n,r,"SELECT key FROM "+r.storeName,[],function(n,t){for(var r=[],o=0;o<t.rows.length;o++)r.push(t.rows.item(o).key);e(r)},function(e,n){t(n)})})}).catch(t)});return f(t,e),t}function xe(e){return new u(function(n,t){e.transaction(function(r){r.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(t,r){for(var o=[],a=0;a<r.rows.length;a++)o.push(r.rows.item(a).name);n({db:e,storeNames:o})},function(e,n){t(n)})},function(e){t(e)})})}function Ce(e,n){n=h.apply(this,arguments);var t=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||t.name,e.storeName=e.storeName||t.storeName);var r,o=this;return f(r=e.name?new u(function(n){var r;r=e.name===t.name?o._dbInfo.db:openDatabase(e.name,"","",0),e.storeName?n({db:r,storeNames:[e.storeName]}):n(xe(r))}).then(function(e){return new u(function(n,t){e.db.transaction(function(r){function o(e){return new u(function(n,t){r.executeSql("DROP TABLE IF EXISTS "+e,[],function(){n()},function(e,n){t(n)})})}for(var a=[],i=0,s=e.storeNames.length;i<s;i++)a.push(o(e.storeNames[i]));u.all(a).then(function(){n()}).catch(function(e){t(e)})},function(e){t(e)})})}):u.reject("Invalid arguments"),n),r}var Re={_driver:"webSQLStorage",_initStorage:Ee,_support:W(),iterate:Ae,getItem:Oe,setItem:De,removeItem:_e,clear:Te,length:Se,key:Ne,keys:Ie,dropInstance:Ce};function Pe(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}function ke(e,n){var t=e.name+"/";return e.storeName!==n.storeName&&(t+=e.storeName+"/"),t}function Me(){var e="_localforage_support_test";try{return localStorage.setItem(e,!0),localStorage.removeItem(e),!1}catch(e){return!0}}function Fe(){return!Me()||localStorage.length>0}function Le(e){var n=this,t={};if(e)for(var r in e)t[r]=e[r];return t.keyPrefix=ke(e,n._defaultConfig),Fe()?(n._dbInfo=t,t.serializer=me,u.resolve()):u.reject()}function He(e){var n=this,t=n.ready().then(function(){for(var e=n._dbInfo.keyPrefix,t=localStorage.length-1;t>=0;t--){var r=localStorage.key(t);0===r.indexOf(e)&&localStorage.removeItem(r)}});return f(t,e),t}function je(e,n){var t=this;e=d(e);var r=t.ready().then(function(){var n=t._dbInfo,r=localStorage.getItem(n.keyPrefix+e);return r&&(r=n.serializer.deserialize(r)),r});return f(r,n),r}function Ke(e,n){var t=this,r=t.ready().then(function(){for(var n=t._dbInfo,r=n.keyPrefix,o=r.length,a=localStorage.length,i=1,s=0;s<a;s++){var c=localStorage.key(s);if(0===c.indexOf(r)){var u=localStorage.getItem(c);if(u&&(u=n.serializer.deserialize(u)),void 0!==(u=e(u,c.substring(o),i++)))return u}}});return f(r,n),r}function Ue(e,n){var t=this,r=t.ready().then(function(){var n,r=t._dbInfo;try{n=localStorage.key(e)}catch(e){n=null}return n&&(n=n.substring(r.keyPrefix.length)),n});return f(r,n),r}function Be(e){var n=this,t=n.ready().then(function(){for(var e=n._dbInfo,t=localStorage.length,r=[],o=0;o<t;o++){var a=localStorage.key(o);0===a.indexOf(e.keyPrefix)&&r.push(a.substring(e.keyPrefix.length))}return r});return f(t,e),t}function Ve(e){var n=this.keys().then(function(e){return e.length});return f(n,e),n}function Ye(e,n){var t=this;e=d(e);var r=t.ready().then(function(){var n=t._dbInfo;localStorage.removeItem(n.keyPrefix+e)});return f(r,n),r}function Ge(e,n,t){var r=this;e=d(e);var o=r.ready().then(function(){void 0===n&&(n=null);var t=n;return new u(function(o,a){var i=r._dbInfo;i.serializer.serialize(n,function(n,r){if(r)a(r);else try{localStorage.setItem(i.keyPrefix+e,n),o(t)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||a(e),a(e)}})})});return f(o,t),o}function Je(e,n){if(n=h.apply(this,arguments),!(e="function"!=typeof e&&e||{}).name){var t=this.config();e.name=e.name||t.name,e.storeName=e.storeName||t.storeName}var r,o=this;return r=e.name?new u(function(n){e.storeName?n(ke(e,o._defaultConfig)):n(e.name+"/")}).then(function(e){for(var n=localStorage.length-1;n>=0;n--){var t=localStorage.key(n);0===t.indexOf(e)&&localStorage.removeItem(t)}}):u.reject("Invalid arguments"),f(r,n),r}var qe={_driver:"localStorageWrapper",_initStorage:Le,_support:Pe(),iterate:Ke,getItem:je,setItem:Ge,removeItem:Ye,clear:He,length:Ve,key:Ue,keys:Be,dropInstance:Je},We=function(e,n){return e===n||"number"==typeof e&&"number"==typeof n&&isNaN(e)&&isNaN(n)},ze=function(e,n){for(var t=e.length,r=0;r<t;){if(We(e[r],n))return!0;r++}return!1},Qe=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},Ze={},Xe={},$e={INDEXEDDB:q,WEBSQL:Re,LOCALSTORAGE:qe},en=[$e.INDEXEDDB._driver,$e.WEBSQL._driver,$e.LOCALSTORAGE._driver],nn=["dropInstance"],tn=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(nn),rn={description:"",driver:en.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function on(e,n){e[n]=function(){var t=arguments;return e.ready().then(function(){return e[n].apply(e,t)})}}function an(){for(var e=1;e<arguments.length;e++){var n=arguments[e];if(n)for(var t in n)n.hasOwnProperty(t)&&(Qe(n[t])?arguments[0][t]=n[t].slice():arguments[0][t]=n[t])}return arguments[0]}var sn=function(){function e(n){for(var t in o(this,e),$e)if($e.hasOwnProperty(t)){var r=$e[t],a=r._driver;this[t]=a,Ze[a]||this.defineDriver(r)}this._defaultConfig=an({},rn),this._config=an({},this._defaultConfig,n),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":r(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var n in e){if("storeName"===n&&(e[n]=e[n].replace(/\W/g,"_")),"version"===n&&"number"!=typeof e[n])return new Error("Database version must be a number.");this._config[n]=e[n]}return!("driver"in e)||!e.driver||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,n,t){var r=new u(function(n,t){try{var r=e._driver,o=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void t(o);for(var a=tn.concat("_initStorage"),i=0,s=a.length;i<s;i++){var c=a[i];if((!ze(nn,c)||e[c])&&"function"!=typeof e[c])return void t(o)}var l=function(){for(var n=function(e){return function(){var n=new Error("Method "+e+" is not implemented by the current driver"),t=u.reject(n);return f(t,arguments[arguments.length-1]),t}},t=0,r=nn.length;t<r;t++){var o=nn[t];e[o]||(e[o]=n(o))}};l();var d=function(t){Ze[r]&&console.info("Redefining LocalForage driver: "+r),Ze[r]=e,Xe[r]=t,n()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(d,t):d(!!e._support):d(!0)}catch(e){t(e)}});return l(r,n,t),r},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,n,t){var r=Ze[e]?u.resolve(Ze[e]):u.reject(new Error("Driver not found."));return l(r,n,t),r},e.prototype.getSerializer=function(e){var n=u.resolve(me);return l(n,e),n},e.prototype.ready=function(e){var n=this,t=n._driverSet.then(function(){return null===n._ready&&(n._ready=n._initDriver()),n._ready});return l(t,e,e),t},e.prototype.setDriver=function(e,n,t){var r=this;Qe(e)||(e=[e]);var o=this._getSupportedDrivers(e);function a(){r._config.driver=r.driver()}function i(e){return r._extend(e),a(),r._ready=r._initStorage(r._config),r._ready}function s(e){return function(){var n=0;function t(){for(;n<e.length;){var o=e[n];return n++,r._dbInfo=null,r._ready=null,r.getDriver(o).then(i).catch(t)}a();var s=new Error("No available storage method found.");return r._driverSet=u.reject(s),r._driverSet}return t()}}var c=null!==this._driverSet?this._driverSet.catch(function(){return u.resolve()}):u.resolve();return this._driverSet=c.then(function(){var e=o[0];return r._dbInfo=null,r._ready=null,r.getDriver(e).then(function(e){r._driver=e._driver,a(),r._wrapLibraryMethodsWithReady(),r._initDriver=s(o)})}).catch(function(){a();var e=new Error("No available storage method found.");return r._driverSet=u.reject(e),r._driverSet}),l(this._driverSet,n,t),this._driverSet},e.prototype.supports=function(e){return!!Xe[e]},e.prototype._extend=function(e){an(this,e)},e.prototype._getSupportedDrivers=function(e){for(var n=[],t=0,r=e.length;t<r;t++){var o=e[t];this.supports(o)&&n.push(o)}return n},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,n=tn.length;e<n;e++)on(this,tn[e])},e.prototype.createInstance=function(n){return new e(n)},e}(),cn=new sn;n.exports=cn},{3:3}]},{},[4])(4)}(ce)),ce.exports}function fe(){return oe||(oe=1,function(e){(()=>{const n=(e,n)=>{let t=globalThis,r=globalThis;var o=t.CryptPad_Cache={},a=e.mkEvent(!0),i=!1,s=!1,c=!1;try{var u=t.indexedDB.open("test_db",1);u.onsuccess=function(){i=(c=!0)&&!s,a.fire()},u.onerror=function(){a.fire()}}catch(e){a.fire()}o.enable=function(){s=!1,i=c&&!s},o.disable=function(){s=!0,i=c&&!s},o.isEnabled=()=>i;var f=n.createInstance({driver:n.INDEXEDDB,name:"cp_cache"});o.getBlobCache=function(n,t){t=e.once(e.mkAsync(t||function(){})),a.reg(function(){i?f.getItem(n,function(r,o){!r&&o&&o.c?(t(null,o.c),o.t=+new Date,f.setItem(n,o,function(e){e&&console.error(e)})):t(e.serializeError(r||"EINVAL"))}):t("NOCACHE")})},o.setBlobCache=function(n,t,r){r=e.once(e.mkAsync(r||function(){})),a.reg(function(){i?t?f.setItem(n,{c:t,t:+new Date},function(n){r(e.serializeError(n))}):r("EINVAL"):r("NOCACHE")})},o.getChannelCache=function(n,t){t=e.once(e.mkAsync(t||function(){})),a.reg(function(){i?f.getItem(n,function(r,o){!r&&o&&Array.isArray(o.c)?(t(null,o),o.t=+new Date,f.setItem(n,o,function(e){e&&console.error(e)})):t(e.serializeError(r||"EINVAL"))}):t("NOCACHE")})};var l={};return o.storeCache=function(n,t,r,o){o=e.once(e.mkAsync(o||function(){})),a.reg(function(){l[n]=l[n]||e.throttle(function(t,r,o){var a,s;i?Array.isArray(r)&&t?(a=r,Array.isArray(a)&&(a.length>100&&a.splice(0,a.length-100),a.some(function(e,n){if(e.isCheckpoint)return s=n,!0}),a.splice(0,s)),f.setItem(n,{k:t,c:r,t:+new Date},function(n){n&&o(e.serializeError(n))})):o("EINVAL"):o("NOCACHE")},50),l[n](t,r,o)})},o.leaveChannel=function(e){delete l[e]},o.clearChannel=function(n,t){t=e.once(e.mkAsync(t||function(){})),a.reg(function(){i?f.removeItem(n,function(){t()}):t("NOCACHE")})},o.clear=function(n){n=e.once(e.mkAsync(n||function(){})),a.reg(function(){i?f.clear(n):n("NOCACHE")})},o.getKeys=function(n){n=e.once(e.mkAsync(n||function(){})),a.reg(function(){i?f.keys().then(function(e){n(null,e)}).catch(function(e){n(e)}):n("NOCACHE")})},o.getTime=function(n,t){t=e.once(e.mkAsync(t||function(){})),a.reg(function(){i?f.getItem(n,function(n,r){!n&&r&&r.c?t(null,r.t):t(e.serializeError(n||"EINVAL"))}):t("NOCACHE")})},r.CryptPad_clearIndexedDB=o.clear,o};e.exports&&(e.exports=n(Z(),ue()))})()}(se)),se.exports}var le=fe(),de=n({__proto__:null,default:r(le)},[le]);const he=ie.mkEvent(!0),pe=ie.mkEvent(!0),ve=ie.mkEvent(),ye=ie.mkEvent();let me={};const ge={setCustomize:e=>{me=e.ApiConfig},init:e=>{var n,t,r;const{broadcast:o,userHash:a,anonHash:i}=e,s=a||i||ae.createRandomHash("drive"),c=e.store,u=ae.getSecrets("drive",s),f=(null===(n=e.store)||void 0===n?void 0:n.network)||(null===(t=e.store)||void 0===t?void 0:t.networkPromise),l={data:{},websocketURL:U.getWebsocketURL(),network:f,channel:u.channel,readOnly:!1,validateKey:(null===(r=u.keys)||void 0===r?void 0:r.validateKey)||void 0,crypto:L.createEncryptor(u.keys),Cache:de,userName:"fs",logLevel:1,ChainPad:P,updateProgress:function(e){e.type="drive",o([],"LOADING_DRIVE",e)},classic:!0},d=globalThis.CP_account_rt=N.create(l);c.driveSecret=u,c.proxy=d.proxy,c.onRpcReadyEvt=ie.mkEvent(!0),c.loggedIn=void 0!==e.userHash;const h={loggedIn:c.loggedIn};return d.proxy.on("create",function(e){c.realtime=e.realtime,c.network=e.network,c.loggedIn||(h.anonHash=ae.getEditHashFromKeys(u))}).on("cacheready",function(n){c.realtime=n.realtime,c.offline=!0;const t=!!c.networkPromise;if(c.networkPromise||(c.networkPromise=n.networkPromise),c.cacheReturned=h,c.networkPromise&&c.networkPromise.then&&!t){const e=setTimeout(function(){c.networkTimeout=!0,o([],"LOADING_DRIVE",{type:"offline"})},5e3);c.networkPromise.then(function(n){c.network||(c.network=n),clearTimeout(e)},function(n){console.error(n),clearTimeout(e)})}e.cache&&(h.edPublic=d.proxy.edPublic,he.fire(h))}).on("ready",function(n){delete c.networkTimeout,c.ready||(c.driveMetadata=n.metadata,d.proxy.drive||(d.proxy.drive={}),!d.proxy[J.displayNameKey]&&c.noDriveName&&(d.proxy[J.displayNameKey]=c.noDriveName),!d.proxy.uid&&c.noDriveUid&&(d.proxy.uid=c.noDriveUid),!d.proxy.form_seed&&e.form_seed&&(d.proxy.form_seed=e.form_seed),d.proxy.edPublic&&Array.isArray(me.adminKeys)&&-1!==me.adminKeys.indexOf(d.proxy.edPublic)&&(c.isAdmin=!0),h.edPublic=d.proxy.edPublic,pe.fire(h))}).on("error",function(e){"EDELETED"===e.error&&(c.ownDeletion||(c.isDeleted=!0,o([],"DRIVE_DELETED",e.message)))}).on("disconnect",function(){c.offline=!0,ve.fire(),o([],"UPDATE_METADATA")}).on("reconnect",function(){c.offline=!1,ye.fire(),o([],"UPDATE_METADATA")}),{channel:u.channel,onAccountCacheReady:he.reg,onAccountReady:pe.reg,onDisconnect:ve.reg,onReconnect:ye.reg}}};var Ee,be=Object.freeze({__proto__:null,Account:ge}),Oe={exports:{}};function Ae(){return Ee||(Ee=1,function(e){(()=>{const n=(e={},n={})=>{var t={setCustomize:t=>{n=t.Messages,e=t.AppConfig},init:function(e){t.state=e}};return t.send=function(n,r,o){("function"!=typeof o&&(o=function(){}),e.disableFeedback)?o():n&&(!0===r||t.state)?function(e,n){var t=new XMLHttpRequest;t.open("HEAD",e),t.onreadystatechange=function(){this.readyState===this.DONE&&n&&n()},t.send()}("/common/feedback.html?"+n+"="+Math.random().toString(16).replace(/0./,""),o):o()},t.reportAppUsage=function(){var e=window.location.pathname.split("/").filter(function(e){return e}).join(".");/^#\/1\/view\//.test(window.location.hash)?t.send(e+"_VIEW"):t.send(e)},t.reportScreenDimensions=function(){var e=window.innerHeight,n=window.innerWidth;t.send("DIMENSIONS:"+e+"x"+n)},t.reportLanguage=function(){n&&t.send("LANG_"+n._languageUsed)},t};e.exports&&(e.exports=n(void 0,void 0))})()}(Oe)),Oe.exports}var we,De,_e=Ae(),Te=n({__proto__:null,default:r(_e)},[_e]),Se={exports:{}},Ne={exports:{}};function Ie(){return De||(De=1,function(e){e.exports&&(e.exports=function(e={},n){var t={setCustomize:n=>{e=n.AppConfig}};t.MINIMUM_PASSWORD_LENGTH="number"==typeof e.minimumPasswordLength?e.minimumPasswordLength:8,t.MINIMUM_NAME_LENGTH=1,t.MAXIMUM_NAME_LENGTH=64,t.isEmail=function(e){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(e).toLowerCase())},t.isLongEnoughPassword=function(e){return e.length>=t.MINIMUM_PASSWORD_LENGTH};var r=t.isString=function(e){return"string"==typeof e};return t.isValidUsername=function(e){return!!(r(e)&&e.length>=t.MINIMUM_NAME_LENGTH)},t.isValidPassword=function(e){return!(!e||!r(e))},t.passwordsMatch=function(e,n){return r(e)&&r(n)&&e===n},t.customSalt=function(){return"string"==typeof e.loginSalt?e.loginSalt:""},t.deriveFromPassphrase=function(e,r,o,a){n(r,e+t.customSalt(),8,1024,o||128,200,a,void 0)},t.dispenser=function(e){var n={used:0};return function(t){if(n.used+t>e.length)throw new Error("exceeded available entropy");if("number"!=typeof t)throw new Error("expected a number");if(t<=0)throw new Error("expected to consume a positive number of bytes");var r;return r=e.slice?e.slice(n.used,n.used+t):e.subarray(n.used,n.used+t),n.used+=t,r}},t}(void 0,(we||(we=1,function(e){e.exports=function(e,n,t,r,o,a,i,s){function c(e){var n=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],t=1779033703,r=3144134277,o=1013904242,a=2773480762,i=1359893119,s=2600822924,c=528734635,u=1541459225,f=new Array(64);function l(e){for(var l=0,d=e.length;d>=64;){var h,p,v,y,m,g=t,E=r,b=o,O=a,A=i,w=s,D=c,_=u;for(p=0;p<16;p++)v=l+4*p,f[p]=(255&e[v])<<24|(255&e[v+1])<<16|(255&e[v+2])<<8|255&e[v+3];for(p=16;p<64;p++)y=((h=f[p-2])>>>17|h<<15)^(h>>>19|h<<13)^h>>>10,m=((h=f[p-15])>>>7|h<<25)^(h>>>18|h<<14)^h>>>3,f[p]=(y+f[p-7]|0)+(m+f[p-16]|0)|0;for(p=0;p<64;p++)y=(((A>>>6|A<<26)^(A>>>11|A<<21)^(A>>>25|A<<7))+(A&w^~A&D)|0)+(_+(n[p]+f[p]|0)|0)|0,m=((g>>>2|g<<30)^(g>>>13|g<<19)^(g>>>22|g<<10))+(g&E^g&b^E&b)|0,_=D,D=w,w=A,A=O+y|0,O=b,b=E,E=g,g=y+m|0;t=t+g|0,r=r+E|0,o=o+b|0,a=a+O|0,i=i+A|0,s=s+w|0,c=c+D|0,u=u+_|0,l+=64,d-=64}}l(e);var d,h=e.length%64,p=e.length/536870912|0,v=e.length<<3,y=h<56?56:120,m=e.slice(e.length-h,e.length);for(m.push(128),d=h+1;d<y;d++)m.push(0);return m.push(p>>>24&255),m.push(p>>>16&255),m.push(p>>>8&255),m.push(p>>>0&255),m.push(v>>>24&255),m.push(v>>>16&255),m.push(v>>>8&255),m.push(v>>>0&255),l(m),[t>>>24&255,t>>>16&255,t>>>8&255,t>>>0&255,r>>>24&255,r>>>16&255,r>>>8&255,r>>>0&255,o>>>24&255,o>>>16&255,o>>>8&255,o>>>0&255,a>>>24&255,a>>>16&255,a>>>8&255,a>>>0&255,i>>>24&255,i>>>16&255,i>>>8&255,i>>>0&255,s>>>24&255,s>>>16&255,s>>>8&255,s>>>0&255,c>>>24&255,c>>>16&255,c>>>8&255,c>>>0&255,u>>>24&255,u>>>16&255,u>>>8&255,u>>>0&255]}function u(e,n,t){e=e.length<=64?e:c(e);var r,o=64+n.length+4,a=new Array(o),i=new Array(64),s=[];for(r=0;r<64;r++)a[r]=54;for(r=0;r<e.length;r++)a[r]^=e[r];for(r=0;r<n.length;r++)a[64+r]=n[r];for(r=o-4;r<o;r++)a[r]=0;for(r=0;r<64;r++)i[r]=92;for(r=0;r<e.length;r++)i[r]^=e[r];function u(){for(var e=o-1;e>=o-4;e--){if(a[e]++,a[e]<=255)return;a[e]=0}}for(;t>=32;)u(),s=s.concat(c(i.concat(c(a)))),t-=32;return t>0&&(u(),s=s.concat(c(i.concat(c(a))).slice(0,t))),s}function f(e,n,t,r){var o,a,i=e[0]^n[t++],s=e[1]^n[t++],c=e[2]^n[t++],u=e[3]^n[t++],f=e[4]^n[t++],l=e[5]^n[t++],d=e[6]^n[t++],h=e[7]^n[t++],p=e[8]^n[t++],v=e[9]^n[t++],y=e[10]^n[t++],m=e[11]^n[t++],g=e[12]^n[t++],E=e[13]^n[t++],b=e[14]^n[t++],O=e[15]^n[t++],A=i,w=s,D=c,_=u,T=f,S=l,N=d,I=h,x=p,C=v,R=y,P=m,k=g,M=E,F=b,L=O;for(a=0;a<8;a+=2)A^=(o=(k^=(o=(x^=(o=(T^=(o=A+k)<<7|o>>>25)+A)<<9|o>>>23)+T)<<13|o>>>19)+x)<<18|o>>>14,S^=(o=(w^=(o=(M^=(o=(C^=(o=S+w)<<7|o>>>25)+S)<<9|o>>>23)+C)<<13|o>>>19)+M)<<18|o>>>14,R^=(o=(N^=(o=(D^=(o=(F^=(o=R+N)<<7|o>>>25)+R)<<9|o>>>23)+F)<<13|o>>>19)+D)<<18|o>>>14,L^=(o=(P^=(o=(I^=(o=(_^=(o=L+P)<<7|o>>>25)+L)<<9|o>>>23)+_)<<13|o>>>19)+I)<<18|o>>>14,A^=(o=(_^=(o=(D^=(o=(w^=(o=A+_)<<7|o>>>25)+A)<<9|o>>>23)+w)<<13|o>>>19)+D)<<18|o>>>14,S^=(o=(T^=(o=(I^=(o=(N^=(o=S+T)<<7|o>>>25)+S)<<9|o>>>23)+N)<<13|o>>>19)+I)<<18|o>>>14,R^=(o=(C^=(o=(x^=(o=(P^=(o=R+C)<<7|o>>>25)+R)<<9|o>>>23)+P)<<13|o>>>19)+x)<<18|o>>>14,L^=(o=(F^=(o=(M^=(o=(k^=(o=L+F)<<7|o>>>25)+L)<<9|o>>>23)+k)<<13|o>>>19)+M)<<18|o>>>14;n[r++]=e[0]=A+i|0,n[r++]=e[1]=w+s|0,n[r++]=e[2]=D+c|0,n[r++]=e[3]=_+u|0,n[r++]=e[4]=T+f|0,n[r++]=e[5]=S+l|0,n[r++]=e[6]=N+d|0,n[r++]=e[7]=I+h|0,n[r++]=e[8]=x+p|0,n[r++]=e[9]=C+v|0,n[r++]=e[10]=R+y|0,n[r++]=e[11]=P+m|0,n[r++]=e[12]=k+g|0,n[r++]=e[13]=M+E|0,n[r++]=e[14]=F+b|0,n[r++]=e[15]=L+O|0}function l(e,n,t,r,o){for(;o--;)e[n++]=t[r++]}function d(e,n,t,r,o){for(;o--;)e[n++]^=t[r++]}function h(e,n,t,r,o){l(e,0,n,t+16*(2*o-1),16);for(var a=0;a<2*o;a+=2)f(e,n,t+16*a,r+8*a),f(e,n,t+16*a+16,r+8*a+16*o)}function p(e,n,t){return e[n+16*(2*t-1)]}function v(e){for(var n=[],t=0;t<e.length;t++){var r=e.charCodeAt(t);r<128?n.push(r):r>127&&r<2048?(n.push(r>>6|192),n.push(63&r|128)):(n.push(r>>12|224),n.push(r>>6&63|128),n.push(63&r|128))}return n}if(t<1||t>31)throw new Error("scrypt: logN not be between 1 and 31");var y,m,g,E,b=1<<t>>>0;if(1*r>=1<<30||r>16777216||r>8388608||b>16777216/r)throw new Error("scrypt: parameters are too large");"string"==typeof e&&(e=v(e)),"string"==typeof n&&(n=v(n)),"undefined"!=typeof Int32Array?(y=new Int32Array(64*r),m=new Int32Array(32*b*r),E=new Int32Array(16)):(y=[],m=[],E=new Array(16)),g=u(e,n,128*r);var O=32*r;function A(){for(var e=0;e<32*r;e++){var n=4*e;y[0+e]=(255&g[n+3])<<24|(255&g[n+2])<<16|(255&g[n+1])<<8|255&g[n+0]}}function w(e,n){for(var t=e;t<n;t+=2)l(m,t*(32*r),y,0,32*r),h(E,y,0,O,r),l(m,(t+1)*(32*r),y,O,32*r),h(E,y,O,0,r)}function D(e,n){for(var t=e;t<n;t+=2){var o=p(y,0,r)&b-1;d(y,0,m,o*(32*r),32*r),h(E,y,0,O,r),o=p(y,O,r)&b-1,d(y,O,m,o*(32*r),32*r),h(E,y,O,0,r)}}function _(){for(var e=0;e<32*r;e++){var n=y[0+e];g[4*e+0]=n>>>0&255,g[4*e+1]=n>>>8&255,g[4*e+2]=n>>>16&255,g[4*e+3]=n>>>24&255}}var T="undefined"!=typeof setImmediate?setImmediate:setTimeout;function S(e,n,t,r,o){!function a(){T(function(){r(e,e+t<n?e+t:n),(e+=t)<n?a():o()})}()}function N(n){var t=u(e,g,o);return"base64"===n?function(e){for(var n,t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),r=e.length,o=[],a=0;a<r;)n=((a<r?e[a++]:0)<<16)+((a<r?e[a++]:0)<<8)+(a<r?e[a++]:0),o.push(t[n>>>18&63]),o.push(t[n>>>12&63]),o.push(t[n>>>6&63]),o.push(t[n>>>0&63]);return r%3>0&&(o[o.length-1]="=",r%3==1&&(o[o.length-2]="=")),o.join("")}(t):"hex"===n?function(e){for(var n="0123456789abcdef".split(""),t=e.length,r=[],o=0;o<t;o++)r.push(n[e[o]>>>4&15]),r.push(n[e[o]>>>0&15]);return r.join("")}(t):t}"function"==typeof a&&(s=i,i=a,a=1e3),a<=0?(A(),w(0,b),D(0,b),_(),i(N(s))):(A(),S(0,b,2*a,w,function(){S(0,b,2*a,D,function(){_(),i(N(s))})}))}}(Ne)),Ne.exports)))}(Se)),Se.exports}var xe,Ce,Re,Pe=Ie(),ke=n({__proto__:null,default:r(Pe)},[Pe]),Me={exports:{}},Fe={exports:{}},Le={exports:{}},He={exports:{}};function je(){return xe||(xe=1,function(e){e.exports&&(e.exports={whenRealtimeSyncs:function(e,n){"function"==typeof e.getAuthDoc?setTimeout(function(){e.getAuthDoc()!==e.getUserDoc()?e.onSettle(n):n()},0):console.error("improper use of this function")}})}(He)),He.exports}function Ke(){return Ce||(Ce=1,function(e){(()=>{const n=(e,n,t)=>{let r=globalThis;var o={setCustomize:()=>{}},a=function(e){try{return JSON.parse(JSON.stringify(e))}catch(e){return}};return o.init=function(o,i,s){var c=o.loggedIn,u=o.sharedFolder,f=o.readOnly,l=o.Messages||{},d=i.ROOT,h=i.FILES_DATA,p=i.STATIC_DATA,v=i.OLD_FILES_DATA,y=i.UNSORTED,m=i.TRASH,g=i.TEMPLATE,E=i.SHARED_FOLDERS,b=i.SHARED_FOLDERS_TEMP,O=i.debug;i._setReadOnly=function(e){(f=e)||i.fixFiles()},i.setHref=function(e,t,r){(t||e)&&(f||(t?[t]:i.findChannels([e])).forEach(function(e){var t=i.getFileData(e,!0);if(i.getHref(t)===r)return;t.href=i.cryptor.encrypt(r);const o=n.parsePadUrl(r);if("form"!==o.type)return;const a=n.getSecrets(o.type,o.hash,t.password);t.roHref="/"+o.type+"/#"+n.getViewHashFromKeys(a)}))},i.setPadAttribute=function(e,n,t,r){if(r=r||function(){},f)r("EFORBIDDEN");else{var o=i.getIdFromHref(e);if(o)if(n&&n.trim()){var s=i.getFileData(o,!0);"href"===n?i.setHref(null,o,t):s[n]=a(t),r(null)}else r("E_INVAL_ATTR");else r("E_INVAL_HREF")}},i.getPadAttribute=function(e,n,t){t=t||function(){};var r=i.getIdFromHref(e);if(r){var o=i.getFileData(r);t(null,a(o[n]))}else t(null,void 0)},i.pushData=function(n,t){if("function"!=typeof t&&(t=function(){}),f)t("EFORBIDDEN");else{var r=e.createRandomInteger(),o=a(n);o.href&&-1!==o.href.indexOf("#")&&(o.href=i.cryptor.encrypt(o.href)),s[h][r]=o,t(null,r)}},i.pushLink=function(n,t){if("function"!=typeof t&&(t=function(){}),f)t("EFORBIDDEN");else{var r=e.createRandomInteger(),o=a(n);s[p][r]=o,t(null,r)}},i.pushSharedFolder=function(n,t){if("function"!=typeof t&&(t=function(){}),f)t("EFORBIDDEN");else{var r,u=a(n);if(Object.keys(s[E]).some(function(e){if(s[E][e].channel===u.channel)return u.href&&!s[E][e].href&&(s[E][e].href=u.href),r=e,!0}))t("EEXISTS",r);else if(c&&!o.testMode){var l=e.createRandomInteger();u.href&&-1!==u.href.indexOf("#")&&(u.href=i.cryptor.encrypt(u.href)),s[E][l]=u,t(null,l)}else t("EAUTH")}},i.deprecateSharedFolder=function(e,n){if(!f){var t=s[E][e];if(t){if(!(!t.href||-1===i.cryptor.decrypt(t.href).indexOf("#")))(s[b][e]=JSON.parse(JSON.stringify(t))).legacy="PASSWORD_CHANGE"!==n;var r=i.findFile(Number(e));i.delete(r,null,!0),delete s[E][e]}}};var A=function(e){f||delete s[h][e]};i.checkDeletedFiles=function(e){if(c||o.testMode)if(f)e("EFORBIDDEN");else{var t=i.getFiles([d,"hrefArray",m]),r=[];i.getFiles([h,E,p]).forEach(function(e){if(-1===t.indexOf(e)){var a=i.isSharedFolder(e)?s[E][e]:i.getFileData(e),c=a.channel;a.lastVersion&&r.push(n.hrefToHexChannelId(a.lastVersion)),a.rtChannel&&r.push(a.rtChannel),c&&r.push(c),i.isSharedFolder(e)?(delete s[E][e],o.removeProxy&&o.removeProxy(e)):s[p][e]?delete s[p][e]:A(e)}}),r.length?e(null,r):e()}else e()};i.deleteMultiplePermanently=function(e,n,t){if(f)t("EFORBIDDEN");else{var r=e.filter(function(e){return i.isPathIn(e,[h])});if(!c&&!o.testMode)return r.forEach(function(e){var n=e[1];n&&A(n)}),void t();var a=e.filter(function(e){return i.isPathIn(e,["hrefArray"])}),u=e.filter(function(e){return i.isPathIn(e,[d])}),l=e.filter(function(e){return i.isPathIn(e,[m])}),p=[];a.forEach(function(e){var n=i.find(e);p.push({root:e[0],id:n})}),function(e){f||e.forEach(function(e){var n=s[e.root].indexOf(e.id);s[e.root].splice(n,1)})}(p),u.forEach(function(e){var n=e.slice(),t=n.pop();delete i.find(n)[t]});var v,y=[];l.forEach(function(e){var n=e.slice(),t=n.pop(),r=i.find(n);4!==e.length?delete r[t]:y.push({name:e[1],el:r})}),v=y,f||v.forEach(function(e){var n=s[m][e.name].indexOf(e.el);s[m][e.name].splice(n,1)}),n?t():i.checkDeletedFiles(t)}},i.copyFromOtherDrive=function(e,t,r,o){if(!f){var a=[];if(Object.keys(r).forEach(function(e){e=Number(e);var n=r[e];if(n.static)return delete n.static,void(s[p][e]=n);n.href&&(n.href=i.cryptor.encrypt(n.href));var t=!1;for(var o in s[h])if(s[h][o].channel===n.channel){s[h][o].href||(s[h][o].href=n.href),t=!0;break}t?a.push(e):s[h][e]=n}),i.isFile(t)&&-1!==a.indexOf(t))i.log(l.sharedFolders_duplicate);else{if(i.isFolder(t)){var c=function(e){for(var n in e)i.isFile(e[n])?-1!==a.indexOf(e[n])&&(i.log(l.sharedFolders_duplicate),delete e[n]):i.isFolder(e[n])&&c(e[n])};c(t)}var u=i.find(e),d=i.isFile(t)?n.createChannelId():o,v=i.getAvailableName(u,d);Array.isArray(u)?u.push(t):u[v]=t}}};i.copyElement=function(e,t){if(!f&&!i.comparePath(e,t)){var r=i.find(e),o=i.find(t);if(i.isPathIn(t,[m])){if(!e||e.length<2||e[0]===m)return void O("Can't move an element from the trash to the trash: ",e);var a=e[e.length-1],c=i.isPathIn(e,["hrefArray"])?i.getTitle(r):a,u=e.slice();return u.pop(),function(e,n,t){if(!f){var r=s[m];void 0===r[e]&&(r[e]=[]);var o={element:n,path:t};r[e].push(o)}}(c,r,u),!0}if(i.isPathIn(t,["hrefArray"])){if(i.isFolder(r))return void i.log(l.fo_moveUnsortedError);if(e[0]===t[0])return;var d=t[0];return-1===s[d].indexOf(r)&&s[d].push(r),!0}var h=i.isFile(r)?i.getAvailableName(o,n.createChannelId()):i.isInTrashRoot(e)?e[1]:e.pop();if(void 0===o[h])return o[h]=r,!0;i.log(l.fo_unavailableName)}},i.forget=function(e){if(!f){var n=i.getIdFromHref(e);if(n){if(!c&&!o.testMode)return A(n),!0;var t=i.findFile(n);return i.move(t,[m]),!0}}},i.restoreHref=function(e){if(!f){var n=i.getIdFromHref(e);if(n&&i.isFile(n)){var t=i.findFile(n),r=!0;t.forEach(function(e){e[0]!==m?r=!1:i.delete(e,null,!0)}),r&&i.add(n)}}},i.add=function(e,t){if(!f&&(c||o.testMode)){e=Number(e);var r=s[h][e]||s[p][e]||s[E][e];if(r&&"object"==typeof r){var a,u=t;if(t&&!Array.isArray(t)&&(u=decodeURIComponent(t).split(",")),t&&i.isPathIn(u,["hrefArray"]))(a=i.find(u)).push(e);else if(-1!==i.getFiles([d,m,"hrefArray"]).indexOf(e)||u||(u=[d]),t&&i.isPathIn(u,[d])){if(a=i.find(u)){var l=i.getAvailableName(a,n.createChannelId());return void(a[l]=e)}a=i.find([d]),u.slice(1).forEach(function(e){a=a[e]=a[e]||{}}),a[n.createChannelId()]=e}}}},i.setFolderData=function(e,t,r,o){if(!f){var a=i.find(e);if(i.isFolder(a)&&!i.isSharedFolder(a)){if(!i.hasFolderData(a))a["000"+n.createChannelId().slice(0,-3)]={metadata:!0};i.getFolderData(a)[t]=r,o()}}};var w=function(e){i.rt?(i.rt.sync(),t.whenRealtimeSyncs(i.rt,e)):r.setTimeout(e,1e3)};return i.migrateReadOnly=function(e){if(!f&&o.editKey)if(s.version>=2)e();else{s.migrateRo=1;w(function(){var n=JSON.parse(JSON.stringify(s));i.reencrypt(o.editKey,o.editKey,n),setTimeout(function(){s.version>=2?e():(Object.keys(n).forEach(function(e){s[e]=n[e]}),s.version=2,delete s.migrateRo,w(e))},1e3)})}else e({error:"EFORBIDDEN"})},i.migrate=function(t){if(f)t();else{!function(){if(s[y]&&s[v]){O("UNSORTED still exists in the object, removing it...");var e=s[y];0!==e.length?(e.forEach(function(e){"string"==typeof e&&(0===s[v].filter(function(n){return n.href===e}).length&&s[v].push({href:e}))}),delete s[y]):delete s[y]}}(),function(t){if(s[v])try{O("Migrating file system..."),s.migrate=1;w(function(){var r=s[v].slice();s[h]||(s[h]={});var o=s[h];r.forEach(function(t){if(t&&t.href){var r=t.href,a=e.createRandomInteger(),s=i.findFile(r),c=t,u=n.createChannelId();o[a]=c||{href:r},s.forEach(function(e){var n=e.slice(),t=n.pop(),r=i.find(n);if(i.isInTrashRoot(e))return r.element=a,void(o[a].filename=e[1]);i.isPathIn(e,["hrefArray"])?r[t]=a:(r[u]=a,o[a].filename=t,delete r[t])})}}),delete s[v],delete s.migrate,t()})}catch(e){console.error(e),t()}else t()}(t)}},i.fixFiles=function(t){if(!f){t&&(O=function(){});var r=+new Date;O("Cleaning file system...");var a=JSON.stringify(s),l=function(t){"object"!=typeof s[d]&&(O("ROOT was not an object"),s[d]={});var r=t||s[d];if(!r)return console.error("Invalid element in root");var o,a=0,c=s[p],u=s[h];for(var f in r)if(null!==(o=r[f]))if(i.isFolderData(o))0!==a&&(O("Multiple metadata files in folder"),delete r[f]),a++;else if(i.isFile(o,!0)||i.isFolder(o))if(i.isFolder(o))l(o);else{if("string"==typeof o){var v=e.createRandomInteger(),y=n.createChannelId();u[v]={href:i.cryptor.encrypt(o),filename:f},r[y]=v,delete r[f]}if("number"==typeof o)u[o]||c[o]||(O("An element in ROOT doesn't have associated data",o,f),delete r[f])}else O("An element in ROOT was not a folder nor a file. ",o),delete r[f];else console.error("element[%s] is null",f),delete r[f]};e.isObject(s[p])||(O("STATIC_DATA was not an object"),s[p]={}),l(),function(){if(!u){"object"!=typeof s[m]&&(O("TRASH was not an object"),s[m]={});var n,t=s[m],r=function(t,r,o){if("object"==typeof t){if(!i.isSharedFolder(t.element))if(i.isFile(t.element,!0)||i.isFolder(t.element))if(Array.isArray(t.path)){if("string"==typeof t.element){var a=e.createRandomInteger();s[h][a]={href:i.cryptor.encrypt(t.element),filename:o},t.element=a}if(i.isFolder(t.element)&&l(t.element),"number"==typeof t.element)s[h][t.element]||s[p][t.element]||(O("An element in TRASH doesn't have associated data",t.element,o),n.push(r))}else n.push(r);else n.push(r)}else n.push(r)};for(var o in t)if(Array.isArray(t[o]))if(0===t[o].length)O("Empty array in TRASH root. ",t[o]),delete t[o];else{n=[];for(var a=0;a<t[o].length;a++)r(t[o][a],a,o);for(var c=n.length-1;c>=0;c--)t[o].splice(n[c],1)}else O("An element in TRASH root is not an array. ",t[o]),delete t[o]}}(),function(){if(!u){Array.isArray(s[g])||(O("TEMPLATE was not an array"),s[g]=[]);var n=e.deduplicateString(s[g]);n.length!==s[g].length&&(s[g]=n);var t=s[g],r=i.getFiles([d]),o=[];t.forEach(function(n,a){if(i.isFile(n,!0)&&-1===r.indexOf(n)){if("string"==typeof n){var c=e.createRandomInteger();return s[h][c]={href:i.cryptor.encrypt(n)},void(t[a]=c)}if("number"==typeof n)s[h][n]||(O("An element in TEMPLATE doesn't have associated data",n),o.push(n))}else o.push(n)}),o.forEach(function(e){var n=t.indexOf(e);-1!==n&&t.splice(n,1)})}}(),function(){"object"!=typeof s[h]&&(O("FILES_DATA was not an object"),s[h]={});var e=s[h],t=i.getFiles([d,m,"hrefArray"]),r=i.find([d]),a=[];for(var u in e)if(String(u)===String(Number(u))){var l=e[u=Number(u)];if(l&&"object"==typeof l)if(l.href||l.roHref){var v;try{v=l.href&&(-1!==l.href.indexOf("#")?l.href:i.cryptor.decrypt(l.href))}catch(e){}if(!v||-1!==v.indexOf("#")){var y,g=n.parsePadUrl(v||l.roHref);if(g.hash)if(g.type){if(v&&"pad"===g.hashData.type&&g.hashData.version)if("view"===g.hashData.mode)l.roHref=v,delete l.href;else if(l.roHref){var E=n.parsePadUrl(l.roHref);E.hash&&E.type||(y=n.getSecrets(g.type,g.hash,l.password),l.roHref="/"+g.type+"/#"+n.getViewHashFromKeys(y))}else y=n.getSecrets(g.type,g.hash,l.password),l.roHref="/"+g.type+"/#"+n.getViewHashFromKeys(y);if(0===g.hashData.version&&delete l.roHref,v&&"/"!==v.slice(0,1)&&(l.href=i.cryptor.encrypt(n.getRelativeHref(v))),l.ctime||(l.ctime=l.atime),l.title||(l.title=i.getDefaultName(g)),!l.channel)try{y||(y=n.getSecrets(g.type,g.hash,l.password)),l.channel=y.channel,console.log(l),O("Adding missing channel in filesData ",l.channel)}catch(e){console.error(e)}if(n.isValidChannel(l.channel)||console.error("Remove invalid channel",l.channel,l),!c&&!o.testMode||-1!==t.indexOf(u));else O("An element in filesData was not in ROOT, TEMPLATE or TRASH.",u,l),r[n.createChannelId()]=u}else O("Removing an element in filesData with a invalid type.",l),a.push(u);else O("Removing an element in filesData with a invalid href.",l),a.push(u)}}else O("Removing an element in filesData with a missing href.",l),a.push(u);else O("An element in filesData was not an object.",l),a.push(u)}else O("Invalid file ID in filesData.",u),a.push(u);a.forEach(function(e){A(e)});var b=s[p],w=[];for(var D in b){var _=b[D=Number(D)];_&&"object"==typeof _&&_.href?!c&&!o.testMode||-1!==t.indexOf(D)||w.push(D):w.push(D)}w.forEach(function(e){f||delete s[p][e]})}(),Object.keys(s).forEach(function(e){"/"===e.slice(0,1)&&delete s[e]}),function(){if(!u){"object"!=typeof s[E]&&(O("SHARED_FOLDER was not an object"),s[E]={});var e,t,r=s[E],o=i.getFiles([d,m]),a=i.find([d]);for(var c in r){var f;t=r[c],c=Number(c);try{f=t.href&&(-1!==t.href.indexOf("#")?t.href:i.cryptor.decrypt(t.href))}catch(e){}if((e=n.parsePadUrl(f||t.roHref))&&e.hash&&"undefined"!==e.hash){if(-1===o.indexOf(c))console.log("missing"+c),a[n.createChannelId()]=c}else delete r[c]}}}(),function(){if(!u){"object"!=typeof s[b]&&(O("SHARED_FOLDER_TEMP was not an object"),s[b]={});var e=s[b],n=s[E];for(var t in e)n[t]&&delete e[t]}}();var v=+new Date-r+"ms";JSON.stringify(s)===a?O("File system was clean.",v):O("Your file system was corrupted. It has been cleaned so that the pads you visit can be stored safely.",v)}},i},o};e.exports&&(e.exports=n(Z(),te(),je()))})()}(Le)),Le.exports}function Ue(){return Re||(Re=1,function(e){(()=>{const n=(e,n,t,r,o,a={})=>{let i=globalThis;var s={setCustomize:e=>{a=e.Messages,r.setCustomize(e)}},c=s.ROOT="root",u=s.UNSORTED="unsorted",f=s.TRASH="trash",l=s.TEMPLATE="template",d=s.SHARED_FOLDERS="sharedFolders",h=s.SHARED_FOLDERS_TEMP="sharedFoldersTemp",p=s.FILES_DATA=t.storageKey,v=s.OLD_FILES_DATA=t.oldStorageKey,y=s.STATIC_DATA="static";s.getDefaultName=function(e){var n=e.type;return a.type[n]+" - "+function(){if(i.Intl&&i.Intl.DateTimeFormat)return new i.Intl.DateTimeFormat(void 0,{weekday:"short",year:"numeric",month:"long",day:"numeric"}).format(new Date);return(new Date).toString().split(" ").slice(0,4).join(" ")}()};var m=s.createCryptor=function(e){var n={};if(!e)return n.encrypt=function(e){return e},n.decrypt=function(e){return e},n;try{var t=o.createEncryptor(e);n.encrypt=function(e){try{return"/file/#"===e.slice(0,7)?e:t.encrypt(e)}catch(e){return}},n.decrypt=function(e){try{return t.decrypt(e)}catch(e){return}}}catch(e){console.error(e)}return n};return s.getHref=function(e,n){if(e.href&&-1!==e.href.indexOf("#"))return e.href;if(e.href&&n){var t=n.decrypt(e.href);if(t&&-1!==t.indexOf("#"))return t}return e.roHref},s.reencrypt=function(e,n,t){if(t){var r=m(e),o=m(n);Object.keys(t[p]).forEach(function(e){var n=t[p][e]||{};if(n.href&&n.roHref&&!n.fileType){var a=n.href&&-1===n.href.indexOf("#")?r.decrypt(n.href):n.href;if(!a)return;n.href=o.encrypt(a)}}),Object.keys(t[d]||{}).forEach(function(e){var n=t[d][e]||{};if(n.href){var a=n.href&&-1===n.href.indexOf("#")?r.decrypt(n.href):n.href;if(!a)return;n.href=o.encrypt(a)}}),Object.keys(t[h]||{}).forEach(function(e){var n=t[h][e]||{};if(n.href){var a=n.href&&-1===n.href.indexOf("#")?r.decrypt(n.href):n.href;if(!a)return;n.href=o.encrypt(a)}})}else console.error("Nothing to reencrypt")},s.init=function(t,o){var i={};i.cryptor=m(o.editKey),i.setReadOnly=function(e,n){o.editKey=n,i.cryptor=m(n),i.cryptor.k=Math.random(),i.readOnly=e,i._setReadOnly&&i._setReadOnly(e)},i.readOnly=o.readOnly,i.reencrypt=s.reencrypt,i.getDefaultName=s.getDefaultName;var g=o.sframeChan,E=a.fm_newFolder||"New folder",b=a.fm_newFile||"New file";i.ROOT=c,i.STATIC_DATA=y,i.UNSORTED=u,i.TRASH=f,i.TEMPLATE=l,i.SHARED_FOLDERS=d,i.SHARED_FOLDERS_TEMP=h,i.FILES_DATA=p,i.OLD_FILES_DATA=v;var O=i.sharedFolder=o.sharedFolder;i.id=o.id;var A=function(){console.debug.apply(console,arguments)},w=i.log=o.log||A,D=o.logError||A,_=i.debug=o.debug||A;i.fixFiles=function(){};var T=i.error=function(){g?g.query("Q_DRIVE_USEROBJECT",{cmd:"fixFiles",data:{}},function(){}):("function"==typeof i.fixFiles&&i.fixFiles(),console.error.apply(console,arguments),i.fixFiles())};o.outer&&r.init(o,i,t),i.getStructure=function(){var e={};return e[c]={},e[f]={},e[p]={},e[l]=[],e[d]={},e};var S=i.getHref=function(e){return s.getHref(e,i.cryptor)},N=function(e){return null===e?"null":Array.isArray(e)?"array":typeof e};i.isValidDrive=function(e){var n=i.getStructure();return"object"==typeof e&&Object.keys(n).every(function(t){return e[t]&&N(n[t])===N(e[t])})};var I=function(){return[l]},x=function(e,n){return e===n},C=i.isSharedFolder=function(e){return!O&&Boolean(t[d]&&t[d][e])},R=i.isFile=function(e,n){return!C(e)&&("number"==typeof e||(void 0!==t[v]||n)&&"string"==typeof e)},P=i.isFolderData=function(e){return"object"==typeof e&&!0===e.metadata};i.isReadOnlyFile=function(e){if(!R(e))return!1;var n=i.getFileData(e);return n.roHref?Boolean(n.roHref&&!n.href):void 0},i.isStaticFile=function(e){return Boolean(t[y]&&t[y][e])};var k=i.isFolder=function(e){return!P(e)&&("object"==typeof e&&!e.channel||C(e))};i.isFolderEmpty=function(e){return!!k(e)&&(0===Object.keys(e).length||!(1!==Object.keys(e).length||!P(e[Object.keys(e)[0]])))},i.hasSubfolder=function(e,n){if(!k(e))return!1;var t=0,r=function(e){t+=k(e.element)?1:0};for(var o in e)n?Array.isArray(e[o])&&e[o].forEach(r):t+=k(e[o])?1:0;return t},i.hasFile=function(e,n){if(!k(e))return!1;var t=0,r=function(e){t+=R(e.element)?1:0};for(var o in e)n?Array.isArray(e[o])&&e[o].forEach(r):t+=R(e[o])?1:0;return t},i.hasFolderData=function(e){for(var n in e)if(P(e[n]))return!0};var M=i.hasSubSharedFolder=function(e){for(var n in e){if(C(e[n]))return!0;if(k(e[n])&&M(e[n]))return!0}return!1},F=i.getFileData=function(n,r){if(n){var a,s;try{a=(t[y]||{})[n]}catch(e){console.error(e)}if(a){var c=r?a:e.clone(a);return r||(c.static=!0),c}try{s=t[p][n]||{}}catch(e){console.error(e),s={}}if(!r&&(s=JSON.parse(JSON.stringify(s))).href&&-1===s.href.indexOf("#"))if(o.editKey)try{s.href=i.cryptor.decrypt(s.href)}catch(e){delete s.href}else delete s.href;return s}};i.getFolderData=function(e){for(var n in e)if(P(e[n]))return e[n];return{}};var L=i.getTitle=function(e,n){if(C(e))return"??";var t=F(e);if(t){if(t.static)return t.name;if(e&&(t.href||t.roHref))return"title"===n?t.title:"name"===n?t.filename:t.filename||t.title||b;T("getTitle called with a non-existing file id: ",e,t)}else T("unable to retrieve data about the requested file: ",e,t)},H=i.comparePath=function(e,n){if(!(e&&n&&Array.isArray(e)&&Array.isArray(n)))return!1;if(e.length!==n.length)return!1;for(var t=!0,r=e.length-1;t&&r>=0;)t=e[r]===n[r],r--;return t},j=i.isSubpath=function(e,n){var t=n.slice(),r=e.slice(0,t.length);return H(t,r)},K=i.isPathIn=function(e,n){if(n){var t=n.indexOf("hrefArray");return-1!==t&&(n.splice(t,1),n=n.concat(I())),n.some(function(n){return Array.isArray(e)&&e[0]===n})}},U=i.isInTrashRoot=function(e){return e[0]===f&&4===e.length},B=function(e,n){if(n){if(0===n.length)return e;var t=n.slice(),r=t.shift();if(void 0!==e[r])return B(e[r],t);_("Unable to find the key '"+r+"' in the root object provided:",e)}else T("Invalid path:\n",n,"\nin root\n",e)},V=i.find=function(e){return B(t,e)},Y=i.getFilesRecursively=function(e,n){for(var t in n=n||[],e)R(e[t])||C(e[t])?-1===n.indexOf(e[t])&&n.push(e[t]):P(e[t])||Y(e[t],n);return n},G={array:function(e){return t[e]||(t[e]=[]),t[e].slice()}};I().forEach(function(e){G[e]=function(){return G.array(e)}}),G.hrefArray=function(){var n=[];return O?n:(I().forEach(function(e){n=n.concat(G[e]())}),e.deduplicateString(n))},G[c]=function(){var e=[];return Y(t[c],e),e},G[f]=function(){var e=t[f],n=[],r=function(e){R(e.element)||C(e.element)?-1===n.indexOf(e.element)&&n.push(e.element):Y(e.element,n)};for(var o in e){if(!Array.isArray(e[o]))return void T("Trash contains a non-array element");e[o].forEach(r)}return n},G[v]=function(){var e=[];return t[v]?(t[v].forEach(function(n){n.href&&-1===e.indexOf(n.href)&&e.push(n.href)}),e):e},G[y]=function(){return t[y]?Object.keys(t[y]).map(Number).filter(Boolean):[]},G[p]=function(){return t[p]?Object.keys(t[p]).map(Number).filter(Boolean):[]},G[d]=function(){return t[d]?Object.keys(t[d]).map(Number).filter(Boolean):[]};var J=i.getFiles=function(n){var t=[];return n&&n.length||(n=[c,"hrefArray",f,v,p,d]),n.forEach(function(e){"function"==typeof G[e]&&(t=t.concat(G[e]()))}),e.deduplicateString(t)},q=i.getIdFromHref=function(e){var r,o=function(e){if(e)return n.parsePadUrl(e).getUrl().replace(/\/p\/?/,"/")},a=o(e);return J([p]).some(function(e){if(o(S(t[p][e]))===a||o(t[p][e].roHref)===a)return r=e,!0}),r};i.getSFIdFromHref=function(e){var r,o=function(e){if(e)return n.parsePadUrl(e).getUrl().replace(/\/p\/?/,"/")},a=o(e);return J([d]).some(function(e){if(o(S(t[d][e]))===a||o(t[d][e].roHref)===a)return r=e,!0}),r};var W=function(e,n){if(!K(e,[c,f]))return[];n=Array.isArray(n)?n:[n];var t={},r=V(e),o=function(e){Object.keys(e).forEach(n=>{t[n]||=[],Array.prototype.push.apply(t[n],e[n])})};if(R(r)||C(r))return n.some(n=>{x(n,r)&&(t[n]||=[],t[n].push(e))}),t;if(k(r))for(var a in r){let t=e.slice();t.push(a),o(W(t,n))}return t},z=function(e,n){if(O)return{};if(!t[e])return{};var r=t[e].slice(),o={},a=-1;return n.forEach(n=>{for(;-1!==(a=r.indexOf(n,a+1));)o[n]||=[],o[n].push([e,a])}),o},Q=function(e,n){if(O)return[];var t=V(e),r={},o=function(e){Object.keys(e).forEach(n=>{r[n]||=[],Array.prototype.push.apply(r[n],e[n])})};if(1===e.length&&"object"==typeof t&&Object.keys(t).forEach(function(r){var a=t[r];if(Array.isArray(a)){var i=e.slice();i.push(r),o(Q(i,n))}}),2===e.length){if(!Array.isArray(t))return[];t.forEach(function(t,a){var i=e.slice();i.push(a),i.push("element"),R(t.element)?n.some(e=>{x(e,t.element)&&(r[e]||=[],r[e].push(i))}):o(Q(i,n))})}return e.length>=4&&o(W(e,n)),r},Z=i.findFiles=function(e){var n=W([c],e),t=z(l,e),r=Q([f],e);let o={};return e.forEach(e=>{o[e]=[]}),[n,t,r].forEach(e=>{Object.keys(e).forEach(n=>{o[n]||=[],Array.prototype.push.apply(o[n],e[n])})}),o},X=i.findFile=function(e){return Z([e])[e]||[]};i.findChannels=function(e,n){var r=t[p],o=t[d],a=[p];return n&&a.push(d),J(a).filter(function(n){var t=r[n]||o[n]||{};return-1!==e.indexOf(t.channel)})},i.search=function(r){if("string"!=typeof r)return[];r=r.trim();var o,a=[],s=t[p],u=t[d],f=r.toLowerCase();/^#/.test(f)&&(o=[f.slice(1).trim()]);J([p,d]).forEach(function(e){var n=s[e]||u[e];if(n)if(Array.isArray(n.tags)&&(t=n.tags,o&&t.length&&(t=t.map(function(e){return e.toLowerCase()}),o.some(function(e){return t.some(function(n){return n===e})}))))a.push(e);else{var t,r=n.title||n.lastTitle;(r&&-1!==r.toLowerCase().indexOf(f)||n.filename&&-1!==n.filename.toLowerCase().indexOf(f))&&a.push(e)}});var l=n.getRelativeHref(r);if(l){var h=q(l);h&&a.push(h)}a=e.deduplicateString(a);var v=[];a.forEach(function(e){v.push({id:e,paths:X(e),data:i.getFileData(e)})});var y=[],m=function(e,n){for(var t in e)k(e[t])&&!C(e[t])&&(-1!==t.toLowerCase().indexOf(f)&&y.push({id:null,paths:[n.concat(t)],data:{title:t}}),m(e[t],n.concat(t)))};return m(t[c],[c]),y=y.sort(function(e,n){return e.data.title.toLowerCase()>n.data.title.toLowerCase()}),v=y.concat(v)},i.getRecentPads=function(){var e=t[p];return Object.keys(e).filter(function(n){return e[n]}).sort(function(n,t){return e[t].atime-e[n].atime}).map(function(e){return Number(e)})},i.getOwnedPads=function(e){var n=t[p];return Object.keys(n).filter(function(t){return n[t].owners&&-1!==n[t].owners.indexOf(e)}).map(function(e){return Number(e)})};var $=i.getAvailableName=function(e,n){if(void 0===e[n])return n;for(var t=n,r=1;void 0!==e[t];)t=n+"_"+r,r++;return t},ee=i.move=function(e,n,t){if(g)g.query("Q_DRIVE_USEROBJECT",{cmd:"move",data:{paths:e,newPath:n}},t);else{var r=[];e.forEach(function(e){var t=e.slice();t.pop(),H(t,n)||(j(n,e)?w(a.fo_moveFolderToChildError):i.copyElement(e.slice(),n)&&r.push(e))}),i.delete(r,t)}};return i.restore=function(e,n){if(g)g.query("Q_DRIVE_USEROBJECT",{cmd:"restore",data:{path:e}},n);else if(U(e)){var t=e.slice();t.pop();var r=V(t).path;ee([e],r,n)}},i.addFolder=function(e,n,t){if(g)g.query("Q_DRIVE_USEROBJECT",{cmd:"addFolder",data:{path:e,name:n}},t);else{var r=V(e),o=$(r,n||E);r[o]={};var a=e.slice();a.push(o),t({newPath:a})}},i.delete=function(e,n,t){g?g.query("Q_DRIVE_USEROBJECT",{cmd:"delete",data:{paths:e,nocheck:t}},n):(n=n||function(){},i.deleteMultiplePermanently(e,t,n))},i.emptyTrash=function(e){e=e||function(){},g?g.query("Q_DRIVE_USEROBJECT",{cmd:"emptyTrash"},e):(t[f]={},i.checkDeletedFiles(e))},i.ownedInTrash=function(e){return J([f]).map(function(n){var r=C(n)?t[d][n]:i.getFileData(n);if(r)return e(r.owners)?r.channel:void 0}).filter(Boolean)},i.rename=function(e,n,r){if(r=r||function(){},g)g.query("Q_DRIVE_USEROBJECT",{cmd:"rename",data:{path:e,newName:n}},r);else if(e.length<=1)D("Renaming `root` is forbidden");else{var o,i=V(e);if(k(i)&&!C(i)){var s=e.slice(),c=s.pop();if(!n||!n.trim()||c===n)return;var u=V(s);return void 0!==u[n]?void w(a.fo_existingNameError):(u[n]=i,delete u[c],void("function"==typeof r&&r()))}if(o=C(i)?t[d][i]:t[p][i]||t[y][i])return t[y][i]?n&&n.trim()?(o.name=n,void r()):void r():n&&""!==n.trim()?void(L(i,"name")!==n&&(o.filename=n,"function"==typeof r&&r())):(delete o.filename,void("function"==typeof r&&r()))}},i.getTagsList=function(){var e,n={},r=function(e){n[e]=n[e]?++n[e]:1};for(var o in t[p])(e=t[p][o]).tags&&Array.isArray(e.tags)&&e.tags.forEach(r);return n},i},s};e.exports&&(e.exports=n(Z(),te(),Y(),Ke(),M(),void 0))})()}(Fe)),Fe.exports}var Be,Ve,Ye,Ge,Je={exports:{}};function qe(){return Be||(Be=1,function(e){e.exports=function(e){var n,t=[],r=[],o=0,a=function(e){return o++,function(){for(e&&e.apply(null,arguments),o=(o||1)-1;!o&&t.length&&!n;)t.shift()(a)}};a.abort=function(){r.forEach(clearTimeout),n=1};var i={nThen:function(e){return n||(o?t.push(e):e(a)),i},orTimeout:function(e,s){if(n)return i;if(!s)throw Error("Must specify milliseconds to orTimeout()");var c,u=setTimeout(function(){for(;t.shift()!==c;);for(e(a),o=(o||1)-1;!o&&t.length;)t.shift()(a)},s);return t.push(c=function(){var e=r.indexOf(u);if(e>-1)return r.splice(e,1),void clearTimeout(u);throw new Error("timeout not listed in array")}),r.push(u),i}};return i.nThen(e)}}(Je)),Je.exports}function We(){if(Ye)return Ve;Ye=1;return Ve=((e,n,t,r,o,a,i,s)=>{var c={},u={};return c.checkMigration=function(e,t,r,o){var a=n.once(n.mkAsync(o));if(t)if(e)if(t.version>=2)a();else if(t.migrateRo){var i,s=!1,c=setInterval(function(){if(t.version>=2)return s=!0,clearTimeout(i),clearInterval(c),void a()},100);i=setTimeout(function(){clearInterval(c),r.migrateReadOnly(function(){s=!0,a()})},2e4);t.on("change",["version"],function(){s||t.version>=2&&(s=!0,clearTimeout(i),clearInterval(c),a())})}else r.migrateReadOnly(a);else a();else a()},c.migrate=function(e){var t=u[e];if(t){var r=t.teams;if(Array.isArray(r)&&r.length){var o=r[0];if(o.secondaryKey){var a=n.find(o,["store","manager","folders",o.id]);a&&a.proxy&&!a.proxy.version&&a.userObject.migrateReadOnly(function(){r.forEach(function(e){n.find(e,["store","manager","folders",e.id,"userObject"]).setReadOnly(!1,e.secondarykey)})})}}}},c.load=function(t,f,l,d){var h=n.once(n.mkAsync(d)),p=t.network,v=t.store,y=t.isNew,m=t.isNewChannel,g=v.id,E=v.handleSharedFolder,b=v.manager.user.userObject.getHref(l),O=e.parsePadUrl(b),A=e.getSecrets("drive",O.hash,l.password);if(!A.keys)return v.manager.deprecateProxy(f),void h(null);var w=A.keys.secondaryKey;o(function(e){t.cache&&r.getChannelCache(A.channel,e(function(n){if("EINVAL"===n)return e.abort(),v.manager.restrictedProxy(f,A.channel),void h(null)}))}).nThen(function(e){m(null,{channel:A.channel},e(function(n){if(n.isNew&&!y)return v.manager.deprecateProxy(f,A.channel,n.reason),e.abort(),void h(null)}))}).nThen(function(){var e=u[A.channel];if(e&&e.readOnly&&w&&c.upgrade(A.channel,A),e&&e.ready&&e.rt)return setTimeout(function(){v.manager.addProxy(f,e.rt,function(){c.leave(A.channel,g)},w),h(e.rt)}),e.teams.push({cb:h,store:v,id:f}),void(E&&E(f,e.rt));if(e&&!e.ready&&e.rt)return e.teams.push({cb:h,store:v,secondaryKey:w,id:f}),void(E&&E(f,e.rt));e=u[A.channel]={teams:[{cb:h,store:v,secondaryKey:w,id:f}],readOnly:!Boolean(w)};var n=l.owners,o={data:{},channel:A.channel,readOnly:!Boolean(w),crypto:a.createEncryptor(A.keys),userName:"sharedFolder",logLevel:1,ChainPad:s,classic:!0,network:p,Cache:r,metadata:{validateKey:A.keys.validateKey||void 0,owners:n},onRejected:t.Store&&t.Store.onRejected},d=e.rt=i.create(o);d.proxy.on("cacheready",function(){e.teams&&(e.teams.forEach(function(n){d.cache=!0,n.store.manager.addProxy(n.id,d,function(){c.leave(A.channel,n.store.id)},n.secondaryKey,t.updatePassword),t.updatePassword=!1,n.cb(e.rt)}),e.ready=!0)}),d.proxy.on("ready",function(){y&&!Object.keys(d.proxy).length&&(d.proxy.version=2),e.teams&&(e.teams.forEach(function(n){d.cache=!1,n.store.manager.addProxy(n.id,d,function(){c.leave(A.channel,n.store.id)},n.secondaryKey,t.updatePassword),n.cb(e.rt)}),e.ready=!0)}),d.proxy.on("error",function(n){if(n&&n.error){if("EDELETED"===n.error){try{e.teams.forEach(function(e){e.store.manager.deprecateProxy(e.id,A.channel,n.message),e.store.handleSharedFolder&&e.store.handleSharedFolder(e.id,null),e.cb()})}catch(e){}return delete u[A.channel],void h()}if("ERESTRICTED"===n.error)return e.teams.forEach(function(e){e.store.manager.restrictedProxy(e.id,A.channel),e.cb()}),delete u[A.channel],void h()}}),E&&E(f,d)})},c.upgrade=function(e,n){var t=u[e];if(t&&t.readOnly&&t.rt.setReadOnly&&n.keys&&n.keys.editKeyStr){var r=a.createEncryptor(n.keys);t.readOnly=!1,t.rt.setReadOnly(!1,r)}},c.leave=function(e,n){var t=u[e];if(t){var r,o=t.teams;if(Array.isArray(o))o.some(function(e,t){if(e.store.id===n)return e.store.handleSharedFolder&&e.store.handleSharedFolder(e.id,null),r=t,!0}),void 0!==r&&(o.splice(r,1),o.length||t.rt&&t.rt.stop&&t.rt.stop())}},c.updatePassword=function(r,a,i,s){var f=a.oldChannel,l=a.href,d=a.password,h=e.parsePadUrl(l),p=e.getSecrets(h.type,h.hash,d),v=u[f];if(v){if(v.rt&&v.rt.stop)try{v.rt.stop()}catch(e){}var y=o;v.teams.forEach(function(e){y=y(function(o){var a=e.store,s=e.id,u=n.find(a.proxy,["drive",t.SHARED_FOLDERS])||{};if(s&&u[s]){var l=JSON.parse(JSON.stringify(u[s]));l.password=d,c.load({network:i,store:a,updatePassword:!0,Store:r,isNewChannel:r.isNewChannel},s,l,o()),a.rpc&&(a.rpc.unpin([f],o()),a.rpc.pin([p.channel],o()))}}).nThen}),y(function(){s()})}else s({error:"ENOTFOUND"})},c.loadSharedFolders=function(e,n,r,a,i,s,u,f){var l=a[t.SHARED_FOLDERS]||{},d=Object.keys(l).length,h=1,p=s();u=u||function(){},o(function(t){Object.keys(l).forEach(function(o){var a=l[o];c.load({network:n,store:r,Store:e,cache:f,isNewChannel:e.isNewChannel},o,a,t(function(){u({progress:h,max:d}),h++}))})}).nThen(function(){setTimeout(p)})},c.isSharedFolderChannel=function(e){return Object.keys(u).includes(e)},c})(te(),Z(),Ue(),fe(),qe(),M(),T(),x()),Ve}function ze(){return Ge||(Ge=1,function(e){(()=>{const n=(e,n,t,r={},o,a,i={})=>{var s=function(n,t,r,o,a,i){if(!n.folders[t]||i||n.folders[t].restricted){var s=function(e){var n={};for(var t in e.cfg)n[t]=e.cfg[t];return n}(n);s.sharedFolder=!0,s.id=t,s.editKey=a,s.rt=r.realtime,s.readOnly=Boolean(!a);var c=e.init(r.proxy,s);c.fixFiles&&c.fixFiles();var u=r.proxy;if(u.metadata&&u.metadata.title){var f=n.user.proxy[e.SHARED_FOLDERS][t];f&&(f.lastTitle=u.metadata.title)}return n.folders[t]={proxy:r.proxy,userObject:c,leave:o,restricted:u.restricted,offline:Boolean(r.cache)},u.on&&(u.on("disconnect",function(){n.folders[t].offline=!0}),u.on("reconnect",function(){n.folders[t].offline=!1})),c}n.folders[t].offline&&!r.cache&&n.Store&&(n.folders[t].offline=!1,n.folders[t].userObject.fixFiles&&n.folders[t].userObject.fixFiles(),n.Store.refreshDriveUI())},c=function(e,n){var t=e.folders[n];t&&(t.leave(),delete e.folders[n])},u=function(t,r,o,a){if(!t.folders[r]||!t.folders[r].deleting){if(t.user.userObject.readOnly){return c(t,r),s(t,r,{proxy:{deprecated:!0}},function(){}),void t.Store.refreshDriveUI()}if(o&&t.unpinPads([o],function(){}),a&&"PASSWORD_CHANGE"!==a){let o=n.find(t,["user","proxy",e.SHARED_FOLDERS]),a=o[r]&&o[r].lastTitle;return a&&((e,n,t)=>{var r=e.store.mailbox;if(r){var o,a=e.cfg.teamId;o=a?e.store.modules.team.getTeamsData()[a]:e.Store.getMetadata(null,null,()=>{}).user,r.sendTo("SF_DELETED",{sfId:n,team:a,title:t},{curvePublic:o.curvePublic,channel:o.notifications},e=>{console.error(e)})}})(t,r,a),delete o[r],void(t.Store&&t.Store.refreshDriveUI&&t.Store.refreshDriveUI())}t.user.userObject.deprecateSharedFolder(r,a),c(t,r),t.Store&&t.Store.refreshDriveUI&&t.Store.refreshDriveUI()}},f=function(e,n){c(e,n),s(e,n,{proxy:{restricted:!0,root:{},filesData:{}}},function(){}),e.Store.refreshDriveUI()},l=function(e,n){return Array.isArray(n)&&-1!==n.indexOf(e.edPublic)},d=function(e){var n=[e.user.userObject],t=Object.keys(e.folders).map(function(n){return e.folders[n].userObject});return Array.prototype.push.apply(n,t),n},h=function(e,n){var t=d(e),r=e.user.userObject;return t.some(function(e){if(Object.keys(e.getFileData(n)).length)return r=e,!0}),r},p=function(e,n){var t=Number(n.id);if(t)return e.user.userObject.findFile(t)[0]},v=function(n,t,r){var o=[];return n.user.userObject.findChannels([t],!0).forEach(function(t){var a=n.user.proxy[e.SHARED_FOLDERS][t];a&&!r&&(a=JSON.parse(JSON.stringify(a))),a||(a=n.user.userObject.getFileData(t,r)),o.push({id:t,data:a,userObject:n.user.userObject})}),Object.keys(n.folders).forEach(function(e){n.folders[e].userObject.findChannels([t]).forEach(function(t){o.push({id:t,fId:e,data:n.folders[e].userObject.getFileData(t,r),userObject:n.folders[e].userObject})})}),o},y=function(e,n){var t=[],r=e.user.userObject.getIdFromHref(n);return r&&t.push({data:e.user.userObject.getFileData(r),userObject:e.user.userObject}),Object.keys(e.folders).forEach(function(r){var o=e.folders[r].userObject.getIdFromHref(n);o&&t.push({fId:r,data:e.folders[r].userObject.getFileData(o),userObject:e.folders[r].userObject})}),t},m=function(e,n){var t=[],r=d(e);let o={};return r.forEach(function(e){var a=Number(e.id);let i;if(a){i=e.findFile(n);let t=(o[a]||[])[0];if(!t)return;i.forEach(function(e){Array.prototype.unshift.apply(e,t)})}else{let t=[n],a=r.map(e=>+e.id).filter(Boolean);Array.prototype.push.apply(t,a),o=e.findFiles(t),i=o[n]}Array.prototype.push.apply(t,i)}),t},g=function(e,n){var t={},r=d(e);let o={};return r.forEach(function(e){var a=Number(e.id);if(!e.id){let e=r.map(e=>+e.id).filter(Boolean);Array.prototype.push.apply(n,e)}var i=e.findFiles(n);if(e.id||(o=i),a){let e=(o[a]||[])[0];if(!e)return;Object.keys(i).forEach(n=>{i[n].forEach(n=>{Array.prototype.unshift.apply(n,e)})})}Object.keys(i).forEach(e=>{t[e]||=[],Array.prototype.push.apply(t[e],i[e])})}),t},E=function(e,t,r){if(r)return e.user.userObject.findChannels(t);var o=[];return d(e).forEach(function(e){var n=e.findChannels(t);Array.prototype.push.apply(o,n)}),o=n.deduplicateString(o)},b=function(e,n,t){var r=d(e),o={};return r.some(function(e){if((o=e.getFileData(n,t))&&Object.keys(o).length)return!0}),o},O=function(t,r){var o;if(t.isHistoryMode&&!t.folders[r])o=!0;else if(!t.folders[r])return{};var a=o?{}:t.folders[r].proxy;Object.keys(a.metadata||{}).length>1&&(a.metadata={title:a.metadata.title});var i=n.clone(a.metadata||{});for(var s in t.user.proxy[e.SHARED_FOLDERS][r]||{})if(void 0!==t.user.proxy[e.SHARED_FOLDERS][r][s]){var c=n.clone(t.user.proxy[e.SHARED_FOLDERS][r][s]);if("href"===s&&-1===c.indexOf("#"))try{c=t.user.userObject.cryptor.decrypt(c)}catch(e){}"href"===s&&-1===c.indexOf("#")&&(c=void 0),i[s]=c}return i},A=function(e,n){var t,r={id:null,userObject:e.user.userObject,path:n};if(!Array.isArray(n)||n.length<=1)return r;for(var o=e.user.userObject,a=2;a<n.length;a++)if(t=o.find(n.slice(0,a)),o.isSharedFolder(t)){r={id:t,userObject:e.folders[t]?.userObject,path:n.slice(a)};break}return r},w=function(e,n){var t=[],r={};return n.forEach(function(n){var o=A(e,n);o.id?r[o.id]?r[o.id].push(o.path):r[o.id]=[o.path]:t.push(o.path)}),{main:t,folders:r}},D=function(e,n){var t=A(e,n);return"number"==typeof t.id&&t.id},_=function(e,n,t){if(!n||!D(e,n)){var r=b(e,t||e.user.userObject.find(n));if(r&&l(e,r.owners)){var o=r.channel;if(o)return Object.keys(e.folders).map(function(n){return e.folders[n].userObject}).some(function(e){return e.findChannels([o]).length})}}},T=function(e,t,o){var a=[],i=[];return t.forEach(function(t,s){var c=o.find(t),u=[],f=t[t.length-1];if(o.isFile(c))u.push(c);else if(o.isSharedFolder(c)){u.push(c);var l=e.folders[c].proxy.metadata||{};l&&(f=l.title)}else{try{c=JSON.parse(JSON.stringify(c))}catch(e){return}o.getFilesRecursively(c,u)}if(u.some(function(e){return o.isSharedFolder(e)}))return e.cfg&&e.cfg.log&&e.cfg.log(r._getKey("fm_moveNestedSF",[f])),void i.unshift(s);u=n.deduplicateString(u);var d={};u.forEach(function(e){d[e]=o.getFileData(e)}),a.push({el:c,data:d,key:f})}),i.forEach(function(e){t.splice(e,1)}),a},S=function(e,n){var r;return v(e,n).some(function(e){if(e&&e.data&&e.data.href){var n=t.parsePadUrl(e.data.href),o=n.hashData;if(o&&"view"!==o.mode)return r=n.hash,!0}}),r},N=function(e,n,t){var r=w(e,n.paths),o=A(e,n.newPath),i=n.copy;o.userObject.isFolder(o.path)?a(function(n){if(r.main.length)if(o.id){var t=T(e,r.main,e.user.userObject),a=o.userObject;if(t.forEach(function(e){a.copyFromOtherDrive(o.path,e.el,e.data,e.key)}),i)return;r.main.length&&e.user.userObject.delete(r.main,n())}else e.user.userObject.move(r.main,o.path,n());var s=Object.keys(r.folders);s.length&&s.forEach(function(t){var a=Number(t),s=r.folders[a];if(o.id===a)o.userObject.move(s,o.path,n());else{var c=e.folders[a].userObject,u=o.userObject;if(T(e,s,c).forEach(function(e){u.copyFromOtherDrive(o.path,e.el,e.data,e.key)}),i)return;c.delete(s,n())}})}).nThen(function(){t()}):t()},I=function(n,o,s){var c=A(n,(o=o||{}).path);if(c&&c.userObject)if(c.id)s({error:"EINVAL"});else if(n.pinPads){var u,f=o.folderData||{};a(function(){if(!o.folderData){var e=t.createRandomHash("drive",o.password),r=t.getSecrets("drive",e,o.password),a=t.getHashes(r);f={href:"/drive/#"+a.editHash,roHref:"/drive/#"+a.viewHash,channel:r.channel,lastTitle:o.name,ctime:+new Date},o.password&&(f.password=o.password),o.owned&&(f.owners=[n.edPublic])}}).nThen(function(e){n.Store.pad.getMetadata(null,{channel:f.channel},e(function(n){if(n&&(n.error||n.rejected))return e.abort(),void s({error:n.error||"ERESTRICTED"})}))}).nThen(function(e){n.pinPads([f.channel],e())}).nThen(function(e){n.user.userObject.pushSharedFolder(f,e(function(r,o){if("EEXISTS"===r&&f.href&&o){var a=t.parsePadUrl(f.href),c=t.getSecrets("drive",a.hash,f.password);return i.upgrade(c.channel,c),n.folders[o]&&n.folders[o].userObject.setReadOnly(!1,c.keys.secondaryKey),e.abort(),void s(o)}return"EEXISTS"===r&&o?(e.abort(),void s(o)):r?(e.abort(),void s(r)):void(u=o)}))}).nThen(function(t){n.user.userObject.add(u,c.path),n.loadSharedFolder(u,f,t(function(a){if(!a)return t.abort(),void s({error:"EDELETED"});a.proxy.metadata||(a.proxy.metadata={title:o.name||r.fm_newFolder}),o.folderData&&n.Store.pad.getMetadata(null,{channel:f.channel},function(t){var r=n.user.proxy[e.SHARED_FOLDERS][u];t.owners&&(r.owners=t.owners),t.expire&&(r.expire=+t.expire)})}),!Boolean(o.folderData))}).nThen(function(){n.onSync(function(){s(u)})})}else s({error:"EAUTH"});else s({error:"E_NOTFOUND"})},x=function(r,o,i){var s=(o=o||{}).resolved||w(r,o.paths);if(s.main.length||Object.keys(s.folders).length){if(o.paths&&1===o.paths.length&&o.paths[0][0]===e.SHARED_FOLDERS_TEMP)return delete n.find(r,["user","proxy",e.SHARED_FOLDERS_TEMP])[o.paths[0][1]],void r.onSync(i);var c=[];a(function(t){if(s.main.length){var o=r.user.userObject;n.find(r.settings,["drive","hideDuplicate"])&&s.main.forEach(function(n){var t=o.find(n);if(n[0]!==e.FILES_DATA&&!o.isFile(t)&&!o.isSharedFolder(t)){var a=[];o.getFilesRecursively(t,a),a.forEach(function(n){_(r,null,n)&&r.user.userObject.add(Number(n),[e.ROOT])})}}),o.delete(s.main,t(function(e,n){r.unpinPads&&n&&Array.prototype.push.apply(c,n)}))}}).nThen(function(e){Object.keys(s.folders).forEach(function(n){r.folders[n].userObject.delete(s.folders[n],e(function(e,n){r.unpinPads&&n&&Array.prototype.push.apply(c,n)}))})}).nThen(function(e){if(r.unpinPads){c=n.deduplicateString(c);var o=[];E(r,c).forEach(function(e){var n=b(r,e),a=[n.channel];n.answersChannel&&a.push(n.answersChannel),n.rtChannel&&a.push(n.rtChannel),n.lastVersion&&a.push(t.hrefToHexChannelId(n.lastVersion)),Array.prototype.push.apply(o,a)});var a=[];c.forEach(function(e){-1===o.indexOf(e)&&(a.push(e),r.Store.checkDeletedPad(e))}),r.unpinPads(a,e(function(e){if(e&&e.error)return console.error(e.error)}))}}).nThen(function(){i()})}else i({error:"E_NOTFOUND"})},C=function(t,r,i){var s=w(t,(r=r||{}).paths||[]);if(r.channel||s.main.length||Object.keys(s.folders).length){var c={main:[],folders:{}},u=function(r,a,i,s){var u,f=n.once(n.mkAsync(s)),l=r;if(!l&&a){var d=a.find(i);if(!a.isFile(d)&&!a.isSharedFolder(d))return;var h=a.isFile(d)?a.getFileData(d):O(t,d);l=h.channel}Object.keys(t.user.proxy[e.SHARED_FOLDERS]||{}).some(function(n){if((t.user.proxy[e.SHARED_FOLDERS][n]||{}).channel===l)return u=Number(n),t.folders[n].deleting=!0,!0}),t.removeOwnedChannel(l,function(e){if(e&&e.error&&"ENOENT"!==e.error)return u&&t.folders[u]&&t.folders[u].deleting&&delete t.folders[u].deleting,o.send("ERROR_DELETING_OWNED_PAD="+l+"|"+e.error,!0),void f();var n=E(t,[l]);if(u&&n.push(u),!n.length)return c=void 0,void f();n.forEach(function(e){var n=m(t,e),r=w(t,n);Array.prototype.push.apply(c.main,r.main),Object.keys(r.folders).forEach(function(e){c.folders[e]?Array.prototype.push.apply(c.folders[e],r.folders[e]):c.folders[e]=r.folders[e]})}),f()})};a(function(e){r.channel&&u(r.channel,null,null,e()),s.main.forEach(function(n){u(null,t.user.userObject,n,e())}),Object.keys(s.folders).forEach(function(n){var r=t.folders[n].userObject;s.folders[n].forEach(function(n){u(null,r,n,e())})})}).nThen(function(){c?x(t,{resolved:c},i):i(),r.channel&&t.Store.refreshDriveUI()})}else i({error:"E_NOTFOUND"})},R={move:N,restore:function(e,n,t){n=n||{},e.user.userObject.restore(n.path,t)},addFolder:function(e,n,t){var r=A(e,(n=n||{}).path);r&&r.userObject?r.userObject.addFolder(r.path,n.name,function(n){if(n.newPath&&r.id){var o=p(e,r.userObject);o&&Array.prototype.unshift.apply(n.newPath,o)}t(n)}):t({error:"E_NOTFOUND"})},addSharedFolder:I,addLink:function(e,n,t){var r=A(e,(n=n||{}).path);if(r&&r.userObject){var o=r.userObject,a=+new Date;o.pushLink({name:n.name,href:n.href,atime:a,ctime:a},function(n,a){n?t({error:n}):(o.add(a,r.path),e.onSync(t))})}else t({error:"E_NOTFOUND"})},restoreSharedFolder:function(r,o,i){var s=o.id,c=o.password,u=n.find(r,["user","proxy",e.SHARED_FOLDERS_TEMP]),f=u&&u[s];if(f)if(r.Store){var l=r.user.userObject.getHref?r.user.userObject.getHref(f):f.href,d=!1;a(function(e){r.Store.isNewChannel(null,{href:l,password:c},e(function(e){d=!(!e||e.error)&&e.isNew}))}).nThen(function(){if(d)i({error:"ENOTFOUND"});else{var e=n.clone(f),o=t.parsePadUrl(l),a=t.getSecrets(o.type,o.hash,c);e.password=c,e.channel=a.channel,a.keys.editKeyStr&&(e.href="/drive/#"+t.getEditHashFromKeys(a)),e.roHref="/drive/#"+t.getViewHashFromKeys(a),delete e.legacy,I(r,{path:["root"],folderData:e},function(){delete u[s],r.onSync(i)})}})}else i({error:"ESTORE"});else i({error:"EINVAL"})},convertFolderToSharedFolder:function(n,t,r){var o=t.path,i=n.user.userObject.find(o);if(o.length<=1||o[0]!==e.ROOT)r({error:"E_INVAL_PATH"});else if(D(n,o))r({error:"E_INVAL_NESTING"});else if(n.user.userObject.hasSubSharedFolder(i))r({error:"E_INVAL_NESTING"});else{var s,c=o.slice(0,-1),u=n.user.userObject.find(c),f=o[o.length-1];a(function(e){I(n,{path:c,name:f,owned:t.owned,password:t.password||""},e(function(n){if("object"==typeof n&&n&&n.error)return e.abort(),void r(n);s=n}))}).nThen(function(t){if(!s)return t.abort(),void r({error:"E_NO_ID"});var a,f=[];for(var l in i)(n.user.userObject.isFolder(i[l])||n.user.userObject.isFile(i[l]))&&f.push(o.concat(l));if(Object.keys(u).some(function(e){if(u[e]===s)return a=e,!0}),!a)return t.abort(),void r({error:"E_NO_KEY"});var d=c.concat(a).concat(e.ROOT);N(n,{paths:f,newPath:d,copy:!1},t())}).nThen(function(t){var r=[];Object.keys(i).forEach(function(e){if(n.user.userObject.isFile(i[e])){var t=n.user.userObject.getFileData(i[e]);t&&l(n,t.owners)&&r.push(o.concat(e))}}),N(n,{paths:r,newPath:[e.ROOT],copy:!1},t())}).nThen(function(){var t=n.user.proxy[e.SHARED_FOLDERS][s],a=n.user.userObject.getFolderData(i);for(var c in a)"metadata"!==c&&(t[c]=a[c]);n.user.userObject.delete([o],function(){r({fId:s})})})}},delete:x,deleteOwned:C,emptyTrash:function(e,t,r){a(function(r){if(t&&t.deleteOwned){var i=e.user.userObject.ownedInTrash(function(n){return l(e,n)}),s=a;i.forEach(function(n){s=s(function(t){e.removeOwnedChannel(n,t(function(e){setTimeout(t(),50),e&&e.error&&"ENOENT"!==e.error&&(console.error(e.error,n),o.send("ERROR_EMPTYTRASH_OWNED="+n+"|"+e.error,!0)),console.warn("DELETED",n)}))}).nThen}),s(r())}e.user.userObject.emptyTrash(r(function(t,o){var i=a;setTimeout(r(function(){if(Array.isArray(o)){var t=r(),a=n.deduplicateString(o),s=[];a.forEach(function(n){i=i(function(t){v(e,n,!0).length||s.push(n),e.Store.checkDeletedPad(n,t())}).nThen}),i(function(){e.unpinPads(s,function(){t()})})}}))}))}).nThen(r)},rename:function(n,t,o){var a=A(n,(t=t||{}).path);if(a&&a.userObject){if(!a.id){var i=n.user.userObject.find(a.path);if(n.user.userObject.isSharedFolder(i)&&n.folders[i])return n.folders[i].proxy.metadata.title=t.newName||r.fm_folder,n.user.proxy[e.SHARED_FOLDERS][i].lastTitle=t.newName||r.fm_folder,void o()}a.userObject.rename(a.path,t.newName,o)}else o({error:"E_NOTFOUND"})},setFolderData:function(n,t,r){var o=A(n,(t=t||{}).path);if(o&&o.userObject){if(!o.id){var a=n.user.userObject.find(o.path);if(n.user.userObject.isSharedFolder(a)&&n.folders[a])return n.user.proxy[e.SHARED_FOLDERS][a][t.key]=t.value,void n.onSync(r)}o.userObject.setFolderData(o.path,t.key,t.value,function(){n.onSync(r)})}else r({error:"E_NOTFOUND"})},updateStaticAccess:function(e,n,t){h(e,n).getFileData(n,!0).atime=+new Date,e.onSync(t)}},P=function(e,n,t){var r=n.cmd,o=n.data||{},a=R[r];"function"!=typeof a?t():a(e,o,t)},k=function(n,t,r){if(r=r||function(){},t.attr&&t.attr.trim()){var o=n.user.userObject.getSFIdFromHref(t.href);o&&("href"===t.attr&&(t.value=n.user.userObject.cryptor.encrypt(t.value)),n.user.proxy[e.SHARED_FOLDERS][o][t.attr]=t.value);var i=y(n,t.href),s=a;i.forEach(function(e){s=s(function(n){e.userObject.setPadAttribute(t.href,t.attr,t.value,n())}).nThen}),s(function(){r()})}else r("E_INVAL_ATTR")},M=function(e,n,t){t=t||function(){};var r=e.user.userObject.getSFIdFromHref(n.href);if(r){var o=O(e,r),a=n.attr?o[n.attr]:JSON.parse(JSON.stringify(o));setTimeout(function(){t(null,{value:a,atime:1})})}else{var i=y(e,n.href),s={};i.forEach(function(e){var t=e.data.atime,r=n.attr?e.data[n.attr]:JSON.parse(JSON.stringify(e.data));(!s.value||s.atime<t)&&(s.atime=t,s.value=r)}),setTimeout(function(){t(null,s)})}},F=function(e){var n={};return d(e).forEach(function(e){var t=e.getTagsList();Object.keys(t).forEach(function(e){n[e]=n[e]?n[e]+t[e]:t[e]})}),n},L=function(e,n){var t=d(e),r=[],o=[];return t.forEach(function(e){var t=e.getFiles(n).map(function(n){return{id:n,data:e.getFileData(n)}}).filter(function(e){if(-1===o.indexOf(e.data.channel||e.id))return o.push(e.data.channel||e.id),!0});Array.prototype.push.apply(r,t)}),r},H=function(e){return e.filter(function(e){if("string"==typeof e)return-1!==[32,48].indexOf(e.length)})},j=function(n,r){var o=[],a=function(e){return"expirable"===r?function(t){var r=e.getFileData(t);r&&-1===o.indexOf(r.channel)&&(function(e,n){return Array.isArray(n)&&n.length&&(!e.edPublic||-1===n.indexOf(e.edPublic))}(n,r.owners)||r.expire&&r.expire<+new Date)&&o.push(r.channel)}:"owned"===r?function(t){var r=e.getFileData(t);r&&-1===o.indexOf(r.channel)&&l(n,r.owners)&&o.push(r.channel)}:"pin"===r?function(n){var r=e.getFileData(n);if(r){if(r.lastVersion){var a=t.hrefToHexChannelId(r.lastVersion);-1===o.indexOf(a)&&o.push(a)}r.answersChannel&&-1===o.indexOf(r.answersChannel)&&o.push(r.answersChannel),r.rtChannel&&-1===o.indexOf(r.rtChannel)&&o.push(r.rtChannel),r.ooImages&&Array.isArray(r.ooImages)&&Array.prototype.push.apply(o,r.ooImages),-1===o.indexOf(r.channel)&&o.push(r.channel)}}:void 0};if("owned"===r&&!n.edPublic)return H(o);if("pin"===r&&!n.edPublic)return H(o);if(d(n).forEach(function(n){n.getFiles([e.FILES_DATA]).forEach(a(n))}),"owned"===r){var i=Object.keys(n.user.proxy[e.SHARED_FOLDERS]).filter(function(t){var r=n.user.proxy[e.SHARED_FOLDERS][t].owners;if(l(n,r))return!0}).map(function(t){return n.user.proxy[e.SHARED_FOLDERS][t].channel});Array.prototype.push.apply(o,i)}if("pin"===r){var s=Object.keys(n.folders).map(function(t){try{return n.user.proxy[e.SHARED_FOLDERS][t].channel}catch(e){console.error(e)}}).filter(Boolean);Array.prototype.push.apply(o,s)}return H(o)},K=function(e,n,t,r){var o=e.user.userObject,i=["root"];if(n){var s=A(e,n);o=s.userObject,i=s.path}var c=function(){var e;a(function(n){o.pushData(t,n(function(n,t){n?e=n:o.add(t,i)}))}).nThen(function(){r(e)})};e.pinPads?e.pinPads([t.channel],function(e){e&&e.error?r(e.error):c()}):c()},U=function(e,n,t,r){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"rename",data:{path:n,newName:t}},r)},B=function(e,n,t,r,o){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"move",data:{paths:n,newPath:t,copy:o}},r)},V=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"emptyTrash",data:{deleteOwned:n}},t)},Y=function(e,n,t,r){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"addFolder",data:{path:n,name:t}},r)},G=function(e,n,t,r){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"addSharedFolder",data:{path:n,name:t.name,owned:t.owned,password:t.password}},r)},J=function(e,n,t,r){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"addLink",data:{path:n,name:t.name,href:t.url}},r)},q=function(e,n,t,r){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"restoreSharedFolder",data:{id:n,password:t}},r)},W=function(e,n,t,r,o){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"convertFolderToSharedFolder",data:{path:n,owned:t,password:r}},o)},z=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"delete",data:{paths:n}},t)},Q=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"deleteOwned",data:{paths:n}},t)},Z=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"restore",data:{path:n}},t)},X=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"setFolderData",data:n},t)},$=function(e,n,t){e.sframeChan.query("Q_DRIVE_USEROBJECT",{cmd:"updateStaticAccess",data:n},t)},ee=E,ne=b,te=p,re=function(e,n,t){if(t)return e.folders[t].userObject.find(n);var r=A(e,n);return r.userObject.find(r.path)},oe=function(e,n,t){var r=h(e,n);return String(r.getTitle(n,t))},ae=function(e,n){return h(e,n).isStaticFile(n)},ie=function(e,n){return h(e,n).isReadOnlyFile(n)},se=function(e,t){var r=[];return d(e).forEach(function(e){Array.prototype.push.apply(r,e.getFiles(t))}),r=n.deduplicateString(r)},ce=function(e,n){var t=[];return d(e).forEach(function(r){var o=p(e,r),a=r.search(n);a.length&&(o&&a.forEach(function(e){e.inSharedFolder=!0,e.paths.forEach(function(e){Array.prototype.unshift.apply(e,o)})}),Array.prototype.push.apply(t,a))}),t},ue=function(n){var t=[];return d(n).forEach(function(n){var r=n.getFiles([e.FILES_DATA,e.STATIC_DATA]).map(function(e){return[Number(e),n.getFileData(e)]});Array.prototype.push.apply(t,r)}),t.filter(function(e){return e[1].atime}).sort(function(e,n){return n[1].atime-e[1].atime})},fe=function(e){return e.user.userObject.getOwnedPads(e.edPublic)},le=function(e,n){e.isHistoryMode=Boolean(n)},de=function(e,n){var t=A(e,n);if(!t||!t.userObject)return{};if(!t.id){var r=e.user.userObject.find(t.path);if(e.user.userObject.isSharedFolder(r))return O(e,r)}var o=t.userObject.find(t.path);return t.userObject.getFolderData(o)},he=D,pe=function(e,n){return e.user.userObject.isValidDrive(n)},ve=function(e,n,t){return e.user.userObject.isFile(n,t)},ye=function(e,n){return e.user.userObject.isFolder(n)},me=function(e,n){return e.user.userObject.isSharedFolder(n)},ge=function(e,n){if(e.folders[n]){var t=e.folders[n].userObject;return t.isFolderEmpty(t.find[t.ROOT])}return e.user.userObject.isFolderEmpty(n)},Ee=function(e,n,t){return e.user.userObject.isPathIn(n,t)},be=function(e,n,t){return e.user.userObject.isSubpath(n,t)},Oe=function(e,n){return e.user.userObject.isInTrashRoot(n)},Ae=function(e,n,t){return e.user.userObject.comparePath(n,t)},we=function(e,n,t){if(e.folders[n]){var r=e.folders[n].userObject;return r.hasSubfolder(r.find[r.ROOT])}return e.user.userObject.hasSubfolder(n,t)},De=function(e,n){return e.user.userObject.hasSubSharedFolder(n)},_e=function(e,n,t){if(e.folders[n]){var r=e.folders[n].userObject;return r.hasFile(r.find[r.ROOT])}return e.user.userObject.hasFile(n,t)},Te=function(e){return e.user.userObject.ownedInTrash(function(n){return l(e,n)})},Se=_;return{setCustomize:n=>{r=n.Messages,e.setCustomize(n)},create:function(n,t,r){var o={pinPads:t.pin,unpinPads:t.unpin,onSync:t.onSync,Store:t.Store,store:t.store,removeOwnedChannel:t.removeOwnedChannel,loadSharedFolder:t.loadSharedFolder,cfg:r,edPublic:t.edPublic,settings:t.settings,user:{proxy:n},folders:{}};r.removeProxy=function(e){c(o,e)},o.user.userObject=e.init(n,r);var a=function(e){return function(){return[].unshift.call(arguments,o),e.apply(null,arguments)}};return{addProxy:a(s),removeProxy:a(c),deprecateProxy:a(u),restrictedProxy:a(f),addSharedFolder:a(I),addPin:function(e,n){o.pinPads=e,o.unpinPads=n},removePin:function(){delete o.pinPads,delete o.unpinPads},command:a(P),getPadAttribute:a(M),setPadAttribute:a(k),getTagsList:a(F),getSecureFilesList:a(L),getSharedFolderData:a(O),getChannelsList:a(j),addPad:a(K),delete:a(x),deleteOwned:a(C),findChannel:a(v),findHref:a(y),findFile:a(m),getEditHash:a(S),user:o.user,folders:o.folders}},createInner:function(n,t,r,o){var a={cfg:o,sframeChan:t,edPublic:r,user:{proxy:n,userObject:e.init(n,o)},folders:{}},i=function(e){return function(){return[].unshift.call(arguments,a),e.apply(null,arguments)}};return{addProxy:i(s),removeProxy:i(c),setHistoryMode:i(le),rename:i(U),move:i(B),emptyTrash:i(V),addFolder:i(Y),addSharedFolder:i(G),addLink:i(J),restoreSharedFolder:i(q),convertFolderToSharedFolder:i(W),delete:i(z),deleteOwned:i(Q),restore:i(Z),setFolderData:i(X),updateStaticAccess:i($),getFileData:i(ne),find:i(re),getTitle:i(oe),isReadOnlyFile:i(ie),isStaticFile:i(ae),getFiles:i(se),search:i(ce),getRecentPads:i(ue),getOwnedPads:i(fe),getTagsList:i(F),findFile:i(m),findFiles:i(g),findChannels:i(ee),getSharedFolderData:i(O),getFolderData:i(de),isInSharedFolder:i(he),getUserObjectPath:i(te),isDuplicateOwned:i(Se),ownedInTrash:i(Te),isValidDrive:i(pe),isFile:i(ve),isFolder:i(ye),isSharedFolder:i(me),isFolderEmpty:i(ge),isPathIn:i(Ee),isSubpath:i(be),isInTrashRoot:i(Oe),comparePath:i(Ae),hasSubfolder:i(we),hasSubSharedFolder:i(De),hasFile:i(_e),user:a.user,folders:a.folders}}}};e.exports&&(e.exports=n(Ue(),Z(),te(),void 0,Ae(),qe(),We()))})()}(Me)),Me.exports}var Qe,Ze,Xe=ze(),$e=n({__proto__:null,default:r(Xe)},[Xe]),en=Ue(),nn=n({__proto__:null,default:r(en)},[en]),tn={exports:{}},rn={exports:{}};function on(){return Ze||(Ze=1,function(e){e.exports&&(e.exports=((e={},n={},t)=>{let r=[];const o=["sheet","doc","presentation"],a=a=>{e=a.AppConfig;const i=(n=a.ApiConfig).onlyOffice&&n.onlyOffice.availableVersions.includes(t.currentVersion);r=e.availablePadTypes.filter(e=>i||!o.includes(e))};Object.keys(e).length&&a({AppConfig:e,ApiConfig:n});const i={OO_APPS:o,setCustomize:a};return i.__defineGetter__("availableTypes",function(){return n.appsToDisable?r.filter(e=>!n.appsToDisable.includes(e)):r}),i.__defineGetter__("appsToSelect",function(){return r.filter(e=>!["drive","teams","file","contacts","convert"].includes(e))}),i.isAvailable=e=>Array.isArray(i.availableTypes)&&i.availableTypes.includes(e),i})(void 0,void 0,(Qe||(Qe=1,function(e){e.exports&&(e.exports={currentVersionNumber:8,currentVersion:"v8"})}(rn)),rn.exports)))}(tn)),tn.exports}var an,sn,cn=on(),un=n({__proto__:null,default:r(cn)},[cn]),fn={exports:{}},ln={exports:{}};function dn(){return an||(an=1,function(e){(()=>{const n=(e,n,t={},r)=>{const o=function(){if(Object.keys(t).length){var e,n=new URL(t.httpUnsafeOrigin);try{return(e=new URL(t.websocketPath,t.httpUnsafeOrigin)).protocol=n.protocol,e.origin}catch(e){return console.error(e),t.httpUnsafeOrigin}}};var a=o();var i=e=>JSON.parse(JSON.stringify(e)),s=function(e,t,r){var o=n.once(n.mkAsync(r));fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>{e.ok?e.text().then(e=>{o(void 0,n.tryParse(e))}):e.json().then().then(n=>{o(e.status,n)})}).catch(e=>{o(e)})},c=function(t,o,c){var u=i(o);u.publicKey=n.encodeBase64(t.publicKey),u.nonce=n.encodeBase64(r.randomBytes(24));var f,l,d=new URL("/api/auth/",a);e(function(e){s(d,u,e((n,t)=>n?(e.abort(),console.error(n),t&&console.error(t),void c(n)):t.date&&t.txid?(f=t.txid,void(l=t.date)):(e.abort(),void c("REQUEST_REJECTED"))))}).nThen(function(e){var o=i(u);o.txid=f,o.date=l;var a=n.decodeUTF8(JSON.stringify(o)),h=r.sign.detached(a,t.secretKey),p=n.encodeBase64(h);s(d,{sig:p,txid:f},e((n,t)=>{if(n)return e.abort(),console.error(n),t&&console.error(t),void c("RESPONSE_REJECTED",t);c(void 0,t)}))})};return c.setCustomize=e=>{t=e.ApiConfig,a=o()},c};e.exports&&(e.exports=n(qe(),Z(),void 0,h()))})()}(ln)),ln.exports}function hn(){return sn||(sn=1,function(e){e.exports&&(e.exports=((e,n={},t,r)=>{var o={setCustomize:e=>{n=e.ApiConfig,t.setCustomize(e)}};o.join=e.uint8ArrayJoin,o.seed=function(){return r.hash(e.decodeUTF8("pewpewpew"))},o.genkeys=function(e){if(!(e instanceof Uint8Array))throw new Error("INVALID_SEED_FORMAT");if(!e||"number"!=typeof e.length||e.length<64)throw new Error("INVALID_SEED_LENGTH");var n=e.subarray(0,r.sign.seedLength),t=e.subarray(r.sign.seedLength,r.sign.seedLength+r.secretbox.keyLength);return{sign:r.sign.keyPair.fromSeed(n),symmetric:t}},o.keysToRPCFormat=function(n){try{var t=n.sign;return{edPrivate:e.encodeBase64(t.secretKey),edPublic:e.encodeBase64(t.publicKey)}}catch(e){return void console.error(e)}},o.encrypt=function(n,t,a){var i=e.decodeUTF8(t),s=r.randomBytes(r.secretbox.nonceLength);return o.join([[0],s,r.secretbox(i,s,a.symmetric)])},o.decrypt=function(n,t){var o=n.subarray(1,1+r.secretbox.nonceLength),a=n.subarray(1+r.secretbox.nonceLength),i=r.secretbox.open(a,o,t.symmetric);try{return JSON.parse(e.encodeUTF8(i))}catch(e){return void console.error(e)}},o.sign=function(e,n){return r.sign.detached(r.hash(e),n.sign.secretKey)},o.serialize=function(n,t){var r=o.encrypt(0,n,t),a=o.sign(r,t);return{publicKey:e.encodeBase64(t.sign.publicKey),signature:e.encodeBase64(a),ciphertext:e.encodeBase64(r)}},o.proveAncestor=function(n){var t=e.find(n,["sign","publicKey"]),o=e.find(n,["sign","secretKey"]);try{var a=r.sign.detached(t,o);return JSON.stringify([t,a].map(e.encodeBase64))}catch(e){return void console.error(e)}};var a=function(n){return e.encodeBase64(n).replace(/\//g,"-")};o.getBlockUrl=function(e){var t=a(e.sign.publicKey);return(n.fileHost||n.httpUnsafeOrigin||window.location.origin)+"/block/"+t.slice(0,2)+"/"+t},o.getBlockHash=function(e){return o.getBlockUrl(e)+"#"+a(e.symmetric)};var i=function(n){try{return e.decodeBase64(n.replace(/\-/g,"/"))}catch(e){return void console.error(e)}};return o.parseBlockHash=function(e){if("string"==typeof e){var n=e.split("#");if(2===n.length)try{return{href:n[0],keys:{symmetric:i(n[1])}}}catch(e){return void console.error(e)}}},o.checkRights=function(n,r){const o=e.mkAsync(r),{blockKeys:a,auth:i}=n;var s="MFA_CHECK";i&&i.type&&(s=`${i.type.toUpperCase()}_`+s),t(a.sign,{command:s,auth:i&&i.data},o)},o.writeLoginBlock=function(e,n){const{content:r,blockKeys:a,oldBlockKeys:i,auth:s,pw:c,session:u,token:f,userData:l}=e;var d="WRITE_BLOCK";s&&s.type&&(d=`${s.type.toUpperCase()}_`+d);var h=o.serialize(JSON.stringify(r),a);h.auth=s&&s.data,h.hasPassword=c,h.registrationProof=i&&o.proveAncestor(i),f&&(h.inviteToken=f),l&&(h.userData=l),t(a.sign,{command:d,content:h,session:u},n)},o.removeLoginBlock=function(e,n){const{reason:r,blockKeys:o,auth:a,edPublic:i}=e;var s="REMOVE_BLOCK";a&&a.type&&(s=`${a.type.toUpperCase()}_`+s),t(o.sign,{command:s,auth:a&&a.data,edPublic:i,reason:r},n)},o.updateSSOBlock=function(e,n){const{blockKeys:r,oldBlockKeys:a}=e;var i=a&&o.proveAncestor(a);t(r.sign,{command:"SSO_UPDATE_BLOCK",ancestorProof:i},n)},o})(Z(),void 0,dn(),h()))}(fn)),fn.exports}var pn,vn,yn,mn=hn(),gn=n({__proto__:null,default:r(mn)},[mn]),En={exports:{}};function bn(){return pn||(pn=1,function(e){var n;n=function(){var e=function(n){if(Array.isArray(n))return n.map(e);if(n instanceof Object){var t=[],r=[];return Object.keys(n).forEach(function(e){/^(0|[1-9][0-9]*)$/.test(e)?t.push(+e):r.push(e)}),t.sort(function(e,n){return e-n}).concat(r.sort()).reduce(function(t,r){return t[r]=e(n[r]),t},{})}return n},n=JSON.stringify.bind(JSON);return function(t,r,o){var a=n(t,r,0);if(!a||"{"!==a[0]&&"["!==a[0])return a;var i=JSON.parse(a);return n(e(i),null,o)}},e.exports?e.exports=n():JSON.sortify=n()}(En)),En.exports}function On(){if(yn)return vn;yn=1;var e,n,t,r,o,a,i,s;return M(),e=te(),n=Z(),Y(),t=je(),o=(r={}).createData=function(t,r){var o={channel:r||e.createChannelId(),displayName:t["cryptpad.username"],profile:t.profile&&t.profile.view,edPublic:t.edPublic,curvePublic:t.curvePublic,notifications:n.find(t,["mailboxes","notifications","channel"]),avatar:t.profile&&t.profile.avatar,badge:t.profile&&t.profile.badge,uid:t.uid};return!1===r&&delete o.channel,o},a=r.getFriend=function(e,n){if(n){if(n===e.curvePublic){var t=o(e);return delete t.channel,t}return e.friends?e.friends[n]:void 0}},i=r.getFriendList=function(e){return e.friends||(e.friends={}),e.friends},s=function(e,n){Object.keys(e).forEach(function(t){"me"!==t&&n(e[t],t,e)})},r.getFriendChannelsList=function(e){var n=[];return s(e.friends,function(e){n.push(e.channel)}),n},r.declineFriendRequest=function(e,n,t){e.mailbox.sendTo("DECLINE_FRIEND_REQUEST",{},{channel:n.notifications,curvePublic:n.curvePublic},function(e){t(e)})},r.acceptFriendRequest=function(e,n,t){var r=a(e.proxy,n.curvePublic)||{},i=o(e.proxy,r.channel||n.channel);e.mailbox.sendTo("ACCEPT_FRIEND_REQUEST",{user:i},{channel:n.notifications,curvePublic:n.curvePublic},function(e){t(e)})},r.addToFriendList=function(e,n,r){var o=e.proxy,a=i(o),s=n.curvePublic;s!==o.curvePublic?(a[s]=n,t.whenRealtimeSyncs(e.realtime,function(){r(),e.pinPads([n.channel],function(e){e.error&&console.error(e.error)})})):r("E_MYKEY")},r.updateMyData=function(e,t){var r=o(e.proxy,!1);e.proxy.friends&&(e.proxy.friends.me=n.clone(r),delete e.proxy.friends.me.channel),e.modules.team&&e.modules.team.updateMyData(r);var i=function(n){n&&n.notifications&&(delete n.user,r.channel=n.channel,e.mailbox.sendTo("UPDATE_DATA",r,{channel:n.notifications,curvePublic:n.curvePublic},function(e){e&&e.error&&console.error(e)}))};t?i(a(e.proxy,t)):s(e.proxy.friends||{},i)},r.removeFriend=function(e,n,r){var o=e.proxy,a=o.friends[n];a?a.notifications?e.mailbox.sendTo("UNFRIEND",{curvePublic:o.curvePublic},{channel:a.notifications,curvePublic:a.curvePublic},function(i){i&&i.error?r(i):(e.messenger.onFriendRemoved(n,a.channel),delete o.friends[n],t.whenRealtimeSyncs(e.realtime,function(){r(i)}))}):r({error:"EINVAL"}):r({error:"ENOENT"})},vn=r}var An,wn,Dn,_n={exports:{}},Tn={exports:{}},Sn={exports:{}};function Nn(){return An||(An=1,function(e){var n,t,r,o,a,i,s,c,u,f,l,d;e.exports&&(e.exports=(n=Z(),t=h(),r=n.uid,o=n.tryParse,a=function(e,r){var o=n.decodeUTF8(JSON.stringify(e));return n.encodeBase64(t.sign.detached(o,r))},i=function(e,n,t){if("function"!=typeof t)throw new Error("expected callback");var o=e.network,a=o.historyKeeper;if("string"==typeof a){var i=r(),s=e.pending[i]=function(e,n){t(e,n)};return s.data=n,s.called=0,o.sendto(a,JSON.stringify([i,n]))}t("NO_HISTORY_KEEPER")},s=[],c=[],u=function(e){var n={network:e,connected:!0,anon:void 0,authenticated:[]};return s.push(e),c.push(n),e.on("message",function(t,r){r===e.historyKeeper&&function(e,n){"string"!=typeof n&&console.error("received non-string message [%s]",n);var t=o(n);if(t){if(Array.isArray(t)&&!/(FULL_HISTORY|HISTORY_RANGE)/.test(t[0])){var r=t[0];"string"==typeof r&&(function(e,n){return!!e.anon&&"function"==typeof e.anon.pending[n]}(e,r)?function(e,n,t){var r=e.pending[n];"ERROR"===t[0]?r(t[1]):r(void 0,t.slice(1)),delete e.pending[n]}(e.anon,r,t.slice(1)):e.authenticated.some(function(e){var n=e.pending[r];return"function"==typeof n&&("ERROR"!==t[1]?(/\|/.test(t[1])&&e.cookie!==t[1]&&(e.cookie=t[1]),n(void 0,t.slice(2)),delete e.pending[r],!0):"NO_COOKIE"===t[2]?(e.send("COOKIE","",function(t){if(t)return console.error(t),void n(t);e.resend(r)&&delete e.pending[r]}),!0):(n(t[2]),delete e.pending[r],!0))})||console.error("UNHANDLED RPC MESSAGE",n))}}else console.error(new Error("could not parse message: %s",n))}(n,t)}),e.on("disconnect",function(){n.connected=!1,n.anon&&(n.anon.connected=!1),n.authenticated.forEach(function(e){e.connected=!1})}),e.on("reconnect",function(){n.anon&&(n.anon.connected=!0),n.authenticated.forEach(function(e){e.connected=!0})}),n},f=function(e){var n;return s.some(function(t,r){return e===t&&(n=r,!0)}),c[n]?c[n]:u(e)},l=function(e,t){if(!e)throw new Error("expected network context");var o,s=t.publicKeyString;return e.authenticated.some(function(e,n){return e.publicKey===s&&(o=n,!0)}),e.authenticated[o]?e.authenticated[o]:function(e,t){var o={network:e.network,publicKey:t.publicKeyString,timeouts:{},pending:{},cookie:null,connected:!0},s=o.send=function(e,r,s){var c=n.mkAsync(s);if(o.connected||"COOKIE"===e){var u=[e,r];o.cookie&&o.cookie.join?u.unshift(o.cookie.join("|")):u.unshift(o.cookie);var f=a(u,t.signKey);return u.unshift(t.publicKeyString),u.unshift(f),i(o,u,c)}c("DISCONNECTED")};return o.resend=function(e){var n=o.pending[e];if(n.called)return console.error("[%s] called too many times",e),!0;n.called++,n.data[2]=o.cookie,n.data[0]=a(n.data.slice(2),t.signKey);var i=r();o.pending[i]=n,delete o.pending[e];try{return o.network.sendto(o.network.historyKeeper,JSON.stringify([i,n.data]))}catch(e){console.log("failed to resend"),console.error(e)}},s.unauthenticated=function(e,r,a){var s=n.mkAsync(a);if(o.connected){var c=[null,t.publicKeyString,null,e,r];return o.cookie&&o.cookie.join?c[2]=o.cookie.join("|"):c[2]=o.cookie,i(o,c,s)}s("DISCONNECTED")},o.destroy=function(){Object.keys(o.timeouts).forEach(function(e){clearTimeout(e)});var n=e.authenticated.indexOf(o);-1!==n&&e.authenticated.splice(n,1)},e.authenticated.push(o),o}(e,t)},d=function(e){return e.anon||function(e){var t={network:e.network,timeouts:{},pending:{},connected:!0};return e.anon=t,t.send=function(e,r,o){var a=n.mkAsync(o);if(t.connected)return i(t,[e,r],a);a("DISCONNECTED")},t.resend=function(e){var n=t.pending[e];if(n.called)return console.error("[%s] called too many times",e),!0;n.called++;try{return t.network.sendto(t.network.historyKeeper,JSON.stringify([e,n.data]))}catch(e){console.log("failed to resend"),console.error(e)}},t.destroy=function(){Object.keys(t.timeouts).forEach(function(e){clearTimeout(e)}),e.anon=void 0},t}(e)},{create:function(e,t,r,o){if("function"!=typeof o)throw new Error("expected callback");var a,i=n.mkAsync(o);try{if(64!==(a=n.decodeBase64(t)).length)throw new Error("private key did not match expected length of 64")}catch(e){return void i(e)}try{if(32!==n.decodeBase64(r).length)return void i("expected public key to be 32 uint")}catch(e){return void i(e)}if(e){var s=f(e),c=l(s,{publicKeyString:r,signKey:a});c.send("COOKIE","",function(e){e?i(e):i(void 0,{send:c.send,destroy:c.destroy})})}else i("NO_NETWORK")},createAnonymous:function(e,t){var r=n.mkAsync(t);if("function"!=typeof r)throw new Error("expected callback");if(e){var o=d(f(e));r(void 0,{send:o.send,destroy:o.destroy})}else r("NO_NETWORK")}}))}(Sn)),Sn.exports}function In(){return wn||(wn=1,function(e){var n,t;e.exports&&(e.exports=(n=Z(),t=Nn(),{create:function(e,r,o,a){if("function"!=typeof o)throw new Error("Expected callback");var i=n.once(n.mkAsync(o));if(e)if(r){var s=r.edPrivate,c=r.edPublic;s&&c?t.create(e,s,c,function(e,t){if(e)i(e);else{var r={};r.destroy=t.destroy,r.publicKey=c,r.send=t.send,r.pin=function(e,r){var o=n.once(n.mkAsync(r));Array.isArray(e)?t.send("PIN",e,o):o("[TypeError] pin expects an array")},r.unpin=function(e,r){var o=n.once(n.mkAsync(r));Array.isArray(e)?t.send("UNPIN",e,o):o("[TypeError] pin expects an array")},r.adminRpc=function(e,n){if(e.cmd){var r=[e.cmd,e.data];t.send("ADMIN",r,n)}else setTimeout(function(){n("[TypeError] admin rpc expects a command")})},r.getServerHash=function(e){t.send("GET_HASH",c,function(n,t){t&&t[0]?e(n,Array.isArray(t)&&t[0]||void 0):e("NO_HASH_RETURNED")})},r.reset=function(e,r){var o=n.once(n.mkAsync(r));Array.isArray(e)?t.send("RESET",e,o):o("[TypeError] pin expects an array")},r.getFileListSize=function(e){t.send("GET_TOTAL_SIZE",void 0,function(n,t){n?e(n):t&&t.length&&"number"==typeof t[0]?e(void 0,t[0]):e("INVALID_RESPONSE")})},r.updatePinLimits=function(e){t.send("UPDATE_LIMITS",void 0,function(n,t){n?e(n):t&&t.length&&"number"==typeof t[0]?e(void 0,t[0],t[1],t[2]):e("INVALID_RESPONSE")})},r.getLimit=function(e){t.send("GET_LIMIT",void 0,function(n,t){n?e(n):t&&t.length&&"number"==typeof t[0]?e(void 0,t[0],t[1],t[2]):e("INVALID_RESPONSE")})},r.trimHistory=function(e,r){var o=n.once(n.mkAsync(r));"object"==typeof e&&e.channel&&e.hash?t.send("TRIM_HISTORY",e,function(e){if(e)return o(e);o()}):o("INVALID_ARGUMENTS")},r.clearOwnedChannel=function(e,n){"string"==typeof e&&32===e.length?t.send("CLEAR_OWNED_CHANNEL",e,function(e){if(e)return n(e);n()}):n("INVALID_ARGUMENTS")},r.removeOwnedChannel=function(e,n,r){if("string"!=typeof e||-1===[32,48].indexOf(e.length))return console.error("invalid channel to remove",e),void n("INVALID_ARGUMENTS");t.send("REMOVE_OWNED_CHANNEL",{channel:e,reason:r},function(t,r){t?n(t):r&&r.length&&"OK"===r[0]?(n(),a&&a.clearChannel&&a.clearChannel(e)):n("INVALID_RESPONSE")})},r.removePins=function(e){t.send("REMOVE_PINS",void 0,function(n,t){n?e(n):t&&t.length&&"OK"===t[0]?e():e("INVALID_RESPONSE")})},r.uploadComplete=function(e,n){t.send("UPLOAD_COMPLETE",e,function(e,t){if(e)n(e);else{var r=t[0];"string"==typeof r?n(void 0,r):n("INVALID_ID")}})},r.ownedUploadComplete=function(e,n){t.send("OWNED_UPLOAD_COMPLETE",e,function(e,t){if(e)n(e);else{var r=t[0];"string"==typeof r?n(void 0,r):n("INVALID_ID")}})},r.uploadStatus=function(e,n){"number"==typeof e?t.send("UPLOAD_STATUS",e,function(e,t){if(e)n(e);else{var r=t[0];"boolean"==typeof r?n(void 0,r):n("INVALID_RESPONSE")}}):setTimeout(function(){n("INVALID_SIZE")})},r.uploadCancel=function(e,n){t.send("UPLOAD_CANCEL",e,function(e){e?n(e):n()})},r.setMetadata=function(e,n){t.send("SET_METADATA",{channel:e.channel,command:e.command,value:e.value},n)},i(e,r)}}):i("INVALID_KEYS")}else i("INVALID_PROXY");else i("INVALID_NETWORK")}}))}(Tn)),Tn.exports}function xn(){return Dn||(Dn=1,function(e){(()=>{const n=(e,n,t,r,o,a,i,s,c,u)=>{var f=function(e,n,t){if(!e.done){if(e.cb(n&&n.error,t,n),e.done=!0,!e.hasNetwork){var o=r.find(e,["network","disconnect"]);"function"==typeof o&&o()}if(e.realtime&&e.realtime.stop)try{e.realtime.stop()}catch(e){console.error(e)}var a=r.find(e,["session","realtime","abort"]);"function"==typeof a&&(e.session.realtime.sync(),a())}},l=function(e,r){u(function(n){var o,a;e.hasNetwork||(o=n(function(e,n){e||(r.network=n)}),a=i.getWebsocketURL(),t.connect(a).then(function(e){o(null,e)},function(e){o(e)}))}).nThen(function(){e.realtime=n.start(r)})},d=function(e,n,t,r){Array.isArray(t)&&t.length&&16===t[0].length&&Array.isArray(n.accessKeys)?(e.network.historyKeeper=t[0],u(function(t){n.accessKeys.forEach(function(n){c.create(e.network,n,t(function(e){console.log("done",n),e&&console.error(e)}))})}).nThen(function(){r()})):r(!0)},h=function(n,t){var r;return"string"==typeof n?r=o.getSecrets("pad",n,t.password):"object"==typeof n&&(r=n),r.keys||(r.keys=r.key),{websocketURL:i.getWebsocketURL(t.origin),channel:r.channel,validateKey:r.keys.validateKey||void 0,crypto:e.createEncryptor(r.keys),logLevel:0,initialState:t.initialState,Cache:s}},p=function(e){return"object"==typeof e},v=function(e,n){p(e)&&p(n)&&Object.keys(n).forEach(function(t){e[t]=n[t]})};return{get:function(e,n,t,r){if("function"!=typeof n)throw new Error("Cryptget expects a callback");r=r||function(){};var o=h(e,t=t||{}),a={cb:n,accessKeys:t.accessKeys,hasNetwork:Boolean(t.network)};o.onRejected=function(e,n){d(o,a,e,n)},o.onReady=function(e){var n=a.session=e.realtime;a.network=e.network,r(1),f(a,void 0,n.getUserDoc())},o.onError=function(e){console.warn(e),f(a,e)},o.onChannelError=function(e){console.error(e),f(a,e)},o.onCacheReady=t.onCacheReady;var i=0;o.onMessage=function(){i++,r(Math.min(.99,i/100))},v(o,t),l(a,o)},put:function(e,n,t,r){if("function"!=typeof t)throw new Error("Cryptput expects a callback");var o=h(e,r=r||{}),i={cb:t,accessKeys:r.accessKeys,hasNetwork:Boolean(r.network)};o.onRejected=function(e,n){d(o,i,e,n)},o.onReady=function(e){var r=i.session=e.realtime;i.network=e.network,r.contentUpdate(n);var o=setTimeout(function(){t(new Error("Timeout"))},15e3);a.whenRealtimeSyncs(r,function(){clearTimeout(o);var e=r.getAuthDoc();r.abort(),f(i,void 0,e)})},o.onChannelError=function(e){f(i,e)},v(o,r),l(i,o)}}};e.exports&&(e.exports=n(M(),D(),u(),Z(),te(),je(),j(),fe(),In(),qe(),x()))})()}(_n)),_n.exports}var Cn,Rn,Pn,kn,Mn,Fn,Ln,Hn={exports:{}};function jn(){if(Mn)return kn;Mn=1;return kn=((e,n,t,r,o,a,i,s)=>{const c={};let u={};c.setCustomize=e=>{u=e.Broadcast};var f=["notifications","supportteam","broadcast"],l=[],d="000000000000000000000000000000000",h=function(e,n,t,r,o){e.emit("MESSAGE",{type:n,content:t},r?[r]:e.clients,o)},p=function(e,n,t,r){e.emit("VIEWED",{type:n,hash:t},r||e.clients)},v=function(e){var n=e.store&&e.store.proxy;if(n.curvePrivate&&n.curvePublic)return{curvePrivate:n.curvePrivate,curvePublic:n.curvePublic}},y=c.sendTo=function(n,t,o,a,i){a=a||{};var c=i||function(e){e&&e.error&&console.error(e.error)};if(s.Mailbox){var u=e.find(n,["store","anon_rpc"]);if(u){var f={encrypt:function(e){return e}},l=d,h={uid:e.uid(),type:t,content:o};if(!/^BROADCAST/.test(t)){var p=v(n);if(!p)return void c({error:"missing asymmetric encryption keys"});if(!a||!a.channel||!a.curvePublic)return void c({error:"no notification channel"});if(l=a.channel,f=s.Mailbox.createEncryptor(p),"object"==typeof o&&!o.user){var y=r.createData(n.store.proxy,!1);o.user=y}h={type:t,content:o}}var m=JSON.stringify(h),g=f.encrypt(m,a.curvePublic);if(a.viewed){var E=e.find(n,["store","proxy","teams",a.viewed]);if(E){var b=g.slice(0,64),O=e.find(E,["keys","mailbox","viewed"]);Array.isArray(O)&&O.push(b)}}u.send("WRITE_PRIVATE_MESSAGE",[l,g],function(e){c(e?{error:e}:{hash:g.slice(0,64)})})}else c({error:"anonymous rpc session not ready"})}else c({error:"chainpad-crypto is outdated and doesn't support mailboxes."})};c.sendToAnon=function(n,t,r,o,a){var i=s.Nacl,c=i.randomBytes(32),u=i.box.keyPair.fromSecretKey(new Uint8Array(c)),f=e.encodeBase64(u.secretKey),l=e.encodeBase64(u.publicKey);y({store:{anon_rpc:n,proxy:{curvePrivate:f,curvePublic:l}}},t,r,o,a)};var m=function(n,r,o,i){var s=r.type,c=r.hash;if(/^REMINDER\|/.test(c)){i(),delete n.boxes.reminders.content[c],p(n,s,c,n.clients.filter(function(e){return e!==o}));var u=c.slice(9).split("-")[0],f=e.find(n,["store","proxy","hideReminders",u]);if(!f){var l=n.store.proxy.hideReminders=n.store.proxy.hideReminders||{};f=l[u]=l[u]||[]}var d=c.split("-")[1];d&&!f.includes(d)&&f.push(Number(d))}else{var h=n.boxes[s];if(h){var v,y,m=h.data||{},g=h.history.indexOf(c);-1!==g&&(0===g?(m.lastKnownHash=c,h.history.shift()):-1===m.viewed.indexOf(c)&&m.viewed.push(c));var E=[];h.history.some(function(e,n){if(-1===m.viewed.indexOf(e))return!0;v=n+1,E.push(e),y=e}),m.viewed=m.viewed.filter(function(e){return-1===E.indexOf(e)}),v&&(h.history=h.history.slice(v),m.lastKnownHash=y),Object.keys(h.content).forEach(function(e){-1!==h.history.indexOf(e)&&-1===m.viewed.indexOf(e)||(a.remove(n,h,h.content[e],e),delete h.content[e])}),t.whenRealtimeSyncs(n.store.realtime,function(){i(),p(n,s,c,n.clients.filter(function(e){return e!==o}))})}else i({error:"NOT_LOADED"})}},g=function(e,n,t,c,u){u=u||{};var f=e.boxes[n]={channel:t.channel,type:n,queue:[],history:[],content:{},sendMessage:function(n){if("object"==typeof n&&!n.user){var t=r.createData(e.store.proxy,!1);n.user=t}try{n=JSON.stringify(n)}catch(e){console.error(e)}f.queue.push(n)},data:t};if(s.Mailbox){var l=t.keys||v(e);if(l||t.decrypted){var d=t.decrypted?{encrypt:function(e){return e},decrypt:function(e){return e}}:s.Mailbox.createEncryptor(l);f.encryptor=d;var y,g={network:e.store.network,channel:t.channel,noChainPad:!0,crypto:d,owners:"broadcast"===n?[]:u.owners||[e.store.proxy.edPublic],lastKnownHash:t.lastKnownHash};g.onConnectionChange=function(){},g.onConnect=function(t,r){f.sendMessage=function(t,o){var a;o=o||function(){};try{a=JSON.stringify(t)}catch(e){console.error(e)}r(a,function(r,a){r?console.error(r):(f.history.push(a),t.ctime=+new Date,f.content[a]=t,h(e,n,{msg:t,hash:a}),o(a))},l.curvePublic)},f.queue.forEach(function(e){f.sendMessage(e)}),f.queue=[]},f.onMessage=g.onMessage=function(r,i,s,c,l,d,p){if(l!==t.lastKnownHash&&l!==y){var v=p&&p.time;y=l;try{r=JSON.parse(r)}catch(e){console.error(e)}if(d&&(r.author=d),f.history.push(l),function(e,n){return-1===(n.viewed||[]).indexOf(e)&&e!==n.lastKnownHash}(l,t)){var g={msg:r,hash:l,time:v},E=f.ready;a.add(e,f,g,function(t,a,i){a&&m(e,a,"",function(){console.log("Notification handled automatically")}),i||t?m(e,{type:n,hash:l},"",function(){console.log("Notification handled automatically")}):(r.ctime=v||0,f.content[l]=r,u.dump||h(e,n,g,null,function(e){e&&e.msg&&E&&o.system(void 0,e.msg)}))})}else if(0===Object.keys(f.content).length){t.lastKnownHash=l,f.history=[];var b=t.viewed.indexOf(l);-1!==b&&t.viewed.splice(b,1)}}},g.onReady=function(){var r=[];t.viewed.forEach(function(e,n){-1===f.history.indexOf(e)&&r.push(n)});for(var o=r.length-1;o>=0;o--)t.viewed.splice(r[o],1);var i=function(t){a.remove(e,f,f.content[t],t),delete f.content[t],p(e,n,t)};e.store.proxy.on("change",["mailboxes",n],function(e,n,t){var r;"lastKnownHash"===t[2]&&(f.history.some(function(e,t){if(r=t+1,i(e),e===n)return!0}),f.history=f.history.slice(r));"viewed"===t[2]&&i(n)}),f.ready=!0,c(f.content)},f.cpNf=i.start(g)}else console.error("missing asymmetric encryption keys")}else console.error("chainpad-crypto is outdated and doesn't support mailboxes.")};return c.init=function(t,r,i){var s={},c=t.store,v=c.proxy.mailboxes=c.proxy.mailboxes||{},E={Store:t.Store,store:c,pinPads:t.pinPads,updateMetadata:t.updateMetadata,updateDrive:t.updateDrive,mailboxes:v,emit:i,clients:[],boxes:{},req:{},loggedIn:c.loggedIn&&c.proxy.edPublic};return function(e,t){!t.notifications&&e.loggedIn&&(t.notifications={channel:n.createChannelId(),lastKnownHash:"",viewed:[]},e.pinPads([t.notifications.channel],function(e){e.error&&console.error(e)})),t.support&&delete t.support,t.broadcast||(t.broadcast={channel:d,lastKnownHash:u.lastBroadcastHash,decrypted:!0,viewed:[]})}(E,v),E.loggedIn&&function(n){var t=n.store.network;t.on("message",function(r,o){if(o===t.historyKeeper){var a=JSON.parse(r);if(/HISTORY_RANGE/.test(a[0])){var i=a[1],s=n.req[i];if(s){var c=a[0],u=a[2],f=s.box;if("HISTORY_RANGE"===c){if(!Array.isArray(u))return;var l;if("broadcast"===s.box.type)l=e.tryParse(u[4]);else try{var d=f.encryptor.decrypt(u[4]);(l=JSON.parse(d.content)).author=d.author}catch(e){console.log(e)}var h=u[4].slice(0,64);n.emit("HISTORY",{txid:i,time:u[5],message:l,hash:h},[s.cId])}else"HISTORY_RANGE_END"===c&&(n.emit("HISTORY",{txid:i,complete:!0},[s.cId]),delete n.req[i])}}}})}(E),E.boxes.reminders={content:{}},Object.keys(v).forEach(function(e){if(-1!==f.indexOf(e)){var n=v[e];-1===l.indexOf(e)?g(E,e,n,function(){}):g(E,e,n,r(function(){}))}}),E.loggedIn&&Object.keys(c.proxy.teams||{}).forEach(function(n){var t=c.proxy.teams[n];if(t){var r=t.keys.mailbox||{};if(r.channel){var o={owners:[e.find(t,["keys","drive","edPublic"])]};g(E,"team-"+n,r,function(){},o)}}}),s.post=function(e,n,t){var r=E.boxes[e];r&&r.sendMessage({type:n,content:t,sender:c.proxy.curvePublic})},s.hideMessage=function(e,n){p(E,e,n.hash,E.clients)},s.showMessage=function(e,n,t,r){"reminders"===e&&n&&(E.boxes.reminders.content[n.hash]=n.msg,E.clients.length||(E.boxes.reminders.content[n.hash].requiresNotif=!0),p(E,e,n.hash,E.clients)),h(E,e,n,t,function(e){o.system(void 0,e.msg),r&&r()})},s.open=function(e,n,t,r,o){(-1!==f.indexOf(e)||r)&&g(E,e,n,t,o)},s.close=function(e,n){!function(e,n,t){t=t||function(){};var r=e.boxes[n];r?r.cpNf&&"function"==typeof r.cpNf.stop?(r.cpNf.stop(),Object.keys(r.content).forEach(function(t){a.remove(e,r,r.content[t],t),p(e,n,t,e.clients)}),delete e.boxes[n]):t("EINVAL"):t()}(E,e,n)},s.dismiss=function(e,n){m(E,e,"",n)},s.sendTo=function(e,n,t,r){E.loggedIn?y(E,e,n,t,r):r({error:"NOT_LOGGED_IN"})},s.removeClient=function(e){!function(e,n){var t=e.clients.indexOf(n);e.clients.splice(t,1)}(E,e)},s.execCommand=function(e,n,t){var r=n.cmd,a=n.data;"SUBSCRIBE"!==r?"DISMISS"!==r?"SENDTO"!==r?"LOAD_HISTORY"!==r||function(e,n,t,r){var o=e.boxes[t.type];if(o){var a=["GET_HISTORY_RANGE",o.channel,{from:t.lastKnownHash,count:t.count,txid:t.txid}];"broadcast"===t.type&&(a=["GET_HISTORY_RANGE",o.channel,{to:t.lastKnownHash,txid:t.txid}]),e.req[t.txid]={cId:n,box:o};var i=e.store.network;i.sendto(i.historyKeeper,JSON.stringify(a)).then(function(){},function(e){console.error(e)})}else r({error:"ENOENT"})}(E,e,a,t):y(E,a.type,a.msg,a.user,t):m(E,a,e,t):function(e,n,t,r){Object.keys(e.boxes).forEach(function(n){Object.keys(e.boxes[n].content).forEach(function(r){var a={msg:e.boxes[n].content[r],hash:r};h(e,n,a,t,function(e){e.error||a.msg&&a.msg.requiresNotif&&(o.system(void 0,e.msg),delete a.msg.requiresNotif)})})}),-1===e.clients.indexOf(t)&&e.clients.push(t),r()}(E,0,e,t)},s},c})(Z(),te(),je(),On(),(Cn||(Cn=1,function(e){(()=>{const n=(e={})=>{let n=globalThis;var t={};e.requireConf=e.requireConf||{},t.setCustomize=n=>{e=n.ApiConfig};var r=n.location&&n.location.pathname.slice(1,-1),o=-1!==["code","slide","pad","kanban","whiteboard","diagram","sheet","poll","teams","form","doc","presentation"].indexOf(r)?"-"+r:"",a="/customize/favicon/main-favicon"+o+".png?"+e.requireConf.urlArgs,i="/customize/favicon/alt-favicon"+o+".png?"+e.requireConf.urlArgs,s="/customize/favicon/main-favicon"+o+".ico?"+e.requireConf.urlArgs,c="/customize/favicon/alt-favicon"+o+".ico?"+e.requireConf.urlArgs,u=n.document,f=t.isSupported=function(){return"function"==typeof n.Notification&&n.isSecureContext},l=t.hasPermission=function(){return"granted"===Notification.permission},d=t.getPermission=function(e){e=e||function(){},Notification&&"function"==typeof Notification.requestPermission?Notification.requestPermission(function(n){e("granted"===n)}):e(!1)},h=t.create=function(e,t,r){u&&!r?r=u.getElementById("favicon").getAttribute("data-main-favicon")||i:r||(r=i);var o=new Notification(t,{icon:r,body:e});return o.onclick=function(){if(u)try{parent.focus(),n.focus(),this.close()}catch(e){}},o};return t.system=function(e,n,t){if(f())return l()?h(e,n,t):void("denied"!==Notification.permission&&d(function(r){r&&h(e,n,t)}))},u&&!u.getElementById("favicon")&&function(){if(u){console.debug("creating favicon");var e={id:"favicon",type:"image/png",rel:"icon","data-main-favicon":a,"data-alt-favicon":i,href:a};if(!u.getElementById("favicon")){var n=u.createElement("link");Object.keys(e).forEach(function(t){n.setAttribute(t,e[t])}),u.head.appendChild(n)}if(!u.getElementById("favicon-ico")){var t=u.createElement("link");e.href=e.href.replace(/\.png/g,".ico"),e.id="favicon-ico",e.type="image/x-icon",Object.keys(e).forEach(function(n){t.setAttribute(n,e[n])}),u.head.appendChild(t)}}else console.error("document is not available in this context")}(),t.tab=function(e,r){if(u){var o="_pendingTabNotification",f=u.getElementById("favicon"),l=u.getElementById("favicon-ico"),d=a,h=i,p=s,v=c;f&&(d=f.getAttribute("data-main-favicon")||a,h=f.getAttribute("data-alt-favicon")||i,f.setAttribute("href",d)),l&&(p=l.getAttribute("data-main-favicon")||s,v=l.getAttribute("data-alt-favicon")||c,l.setAttribute("href",p));var y=function(e){return!!t[o]&&(n.clearInterval(t[o]),f&&f.setAttribute("href",e?h:d),l&&l.setAttribute("href",e?v:p),!0)};y();var m=function(){f&&f.setAttribute("href",f.getAttribute("href")===d?h:d),l&&l.setAttribute("href",l.getAttribute("href")===p?v:p),--r};return t[o]=n.setInterval(function(){if(r>0)return m();y(!0)},e),m(),{cancel:y}}console.error("document is not available in this context")},t};e.exports&&(e.exports=n(void 0))})()}(Hn)),Hn.exports),(Pn||(Pn=1,Rn=((e,n,t,r,o)=>{var a=function(e){var n=e.store.realtime.getLag().lag||0;return 20*(Math.max(0,n)+300)*(.5+Math.random())},i={},s={},c=function(e,n){var r=e.store.proxy.mutedUsers||{},o=t.find(n,["msg","author"]);return!!o&&Boolean(r[o])},u={};i.FRIEND_REQUEST=function(n,t,r,o){var a=r.msg.content.user||r.msg.content;if(c(n,r))o(!0);else if(u[r.msg.author])o(!0);else{if(u[r.msg.author]={type:t.type,hash:r.hash},e.getFriend(n.store.proxy,r.msg.author)||n.store.proxy.friends_pending[r.msg.author])return delete n.store.proxy.friends_pending[r.msg.author],void e.acceptFriendRequest(n.store,a,function(t){t&&t.error?o():e.addToFriendList({proxy:n.store.proxy,realtime:n.store.realtime,pinPads:n.pinPads},a,function(e){if(e)return console.error(e),void o(!0);n.store.messenger&&n.store.messenger.onFriendAdded(a),n.updateMetadata(),o(!0)})});o()}},s.FRIEND_REQUEST=function(e,n,t){var r=t.content.user||t.content;u[r.curvePublic]&&delete u[r.curvePublic]};var f={},l={};i.DECLINE_FRIEND_REQUEST=function(e,n,t,r){var o=t.msg.content.user||t.msg.content;o.curvePublic||(o.curvePublic=t.msg.author),setTimeout(function(){r(!0),e.store.proxy.friends_pending[t.msg.author]&&(delete e.store.proxy.friends_pending[t.msg.author],e.updateMetadata(),f[t.msg.author]||n.sendMessage({type:"FRIEND_REQUEST_DECLINED",content:{user:o}},function(e){f[t.msg.author]={type:n.type,hash:e}}))},a(e))},i.FRIEND_REQUEST_DECLINED=function(e,n,t,r){e.updateMetadata();var o=t.msg.content.user.curvePublic||t.msg.content.user,a=l[o];delete l[o],f[o]?r(!0,a):(f[o]={type:n.type,hash:t.hash},r(!1,a))},s.FRIEND_REQUEST_DECLINED=function(e,n,t){var r=t.content.user.curvePublic||t.content.user;f[r]&&delete f[r]},i.ACCEPT_FRIEND_REQUEST=function(n,t,r,o){var i=r.msg.content.user||r.msg.content;setTimeout(function(){o(!0),n.store.proxy.friends_pending[r.msg.author]&&(delete n.store.proxy.friends_pending[r.msg.author],e.addToFriendList({proxy:n.store.proxy,realtime:n.store.realtime,pinPads:n.pinPads},i,function(e){e?console.error(e):(n.store.messenger&&n.store.messenger.onFriendAdded(i),n.updateMetadata(),n.store.modules.profile&&n.store.modules.profile.update(),l[r.msg.author]||t.sendMessage({type:"FRIEND_REQUEST_ACCEPTED",content:{user:i}},function(e){l[r.msg.author]={type:t.type,hash:e}}))}))},a(n))},i.FRIEND_REQUEST_ACCEPTED=function(e,n,t,r){e.updateMetadata();var o=t.msg.content.user.curvePublic||t.msg.content.user,a=f[o];delete f[o],l[o]?r(!0,a):(l[o]={type:n.type,hash:t.hash},r(!1,a))},s.FRIEND_REQUEST_ACCEPTED=function(e,n,t){var r=t.content.user.curvePublic||t.content.user;l[r]&&delete l[r]},i.CANCEL_FRIEND_REQUEST=function(e,n,t,r){var o=u[t.msg.author];o?r(!0,o):r(!0)},i.UNFRIEND=function(n,t,r,o){var a=r.msg.author,i=e.getFriend(n.store.proxy,a);i?(delete n.store.proxy.friends[a],delete n.store.proxy.friends_pending[a],n.store.messenger&&n.store.messenger.onFriendRemoved(a,i.channel),n.updateMetadata(),o(!0)):o(!0)},i.UPDATE_DATA=function(e,n,t,r){var o=t.msg,a=o.author,i=e.store.proxy.friends&&e.store.proxy.friends[a];if(!i||"object"!=typeof o.content)return void r(!0);const s=o.content.edPublic,c=()=>{Object.keys(o.content).forEach(function(e){i[e]=o.content[e]}),e.store.messenger&&e.store.messenger.onFriendUpdate(a),e.updateMetadata(),r(!0)};if(o.content.badge&&e.store.modules.badge)return e.store.modules.badge.listBadges({edPublic:s},e=>{e.includes(o.content.badge)||delete o.content.badge,c()});c()};var d=function(e,n){let t=e.store.data.blockHash,a=o.parseBlockHash(t).keys.symmetric;return r.encrypt(n,a)},h={};i.SHARE_PAD=function(e,t,r,o){var a=r.msg,i=r.hash,s=a.content;if(c(e,r))o(!0);else{var u,f=s.isStatic?s.href:n.hrefToHexChannelId(s.href,s.password),l=n.parsePadUrl(s.href),p=l.hashData&&l.hashData.mode||"n/a",v=h[f];if(v){if("edit"===v.mode&&"view"===p)return void o(!0);u=v.data}s.password&&(s.password=d(e,s.password)),h[f]={mode:p,data:{type:t.type,hash:i}},o(!1,u)}},s.SHARE_PAD=function(e,t,r,o){var a=r.content,i=n.hrefToHexChannelId(a.href,a.password),s=h[i];s&&s.data&&s.data.hash===o&&delete h[i]};var p=!1;i.SUPPORT_MESSAGE=function(e,n,t,r){p?r(!0):(p=!0,r())},s.SUPPORT_MESSAGE=function(){p=!1},i.REQUEST_PAD_ACCESS=function(e,n,t,r){var o=t.msg.content;if(c(e,t))r(!0);else{var a=o.channel,i=e.store.manager.findChannel(a);if(i.length){var s,u,f=e.store.proxy.edPublic;i.some(function(e){if(e.data&&Array.isArray(e.data.owners)&&-1!==e.data.owners.indexOf(f)&&e.data.href)return u=e.data.href,s=e.data.filename||e.data.title,!0})?(o.title=s,o.href=u,r(!1)):r(!0)}else r(!0)}},i.GIVE_PAD_ACCESS=function(e,n,t,r){var o,a=t.msg.content,i=a.channel;e.store.manager.findChannel(i,!0).forEach(function(e){e.data&&!e.data.href&&(o||(o=e.data.filename||e.data.title),e.userObject.setHref(i,null,a.href))}),a.title=o||a.title,r(!1)},i.ADD_TO_ACCESS_LIST=function(e,n,t,r){var o=t.msg.content.channel;e.Store.getAllStores().forEach(function(n){var t=n.manager.findChannel(o);if(t.length){var r=t[0].data,a=t[0].id,i=n.id;e.Store.loadSharedFolder(i,a,r,function(){},!1)}}),r(!0)};var v={};i.ADD_OWNER=function(e,n,t,r){var o=t.msg.content;if(c(e,t))r(!0);else{if(!(o.teamChannel||o.href&&o.title&&o.channel))return console.log("Remove invalid notification"),void r(!0);var a=o.channel||o.teamChannel;o.password&&(o.pw=o.password,o.password=d(e,o.password)),v[a]?r(!0):(v[a]={type:n.type,hash:t.hash},r(!1))}},s.ADD_OWNER=function(e,n,t){var r=t.content.channel||t.content.teamChannel;v[r]&&delete v[r]},i.RM_OWNER=function(e,n,t,r){var o=t.msg.content;if(!o.channel&&!o.teamChannel)return console.log("Remove invalid notification"),void r(!0);var a=o.channel||o.teamChannel;if(o.teamChannel){var i=e.store.proxy.teams||{};Object.keys(i).some(function(e){if(i[e].channel===a)return i[e].owner=!1,!0})}v[a]&&o.pending?r(!1,v[a]):r(!1)};var y={};i.INVITE_TO_TEAM=function(e,n,r,o){var a=r.msg.content;if(c(e,r))o(!0);else{if(!a.team)return console.log("Remove invalid notification"),void o(!0);var i=y[a.team.channel];if(i)return console.log("removing old invitation"),o(!1,i),void(y[a.team.channel]={type:n.type,hash:r.hash});var s=t.find(e,["store","proxy","teams"])||{};Object.keys(s).some(function(e){return s[e].channel===a.team.channel})?o(!0):(y[a.team.channel]={type:n.type,hash:r.hash},o(!1))}},s.INVITE_TO_TEAM=function(e,n,r){var o=t.find(r,["content","team","channel"]);delete y[o]},i.KICKED_FROM_TEAM=function(e,n,t,r){var o=t.msg.content;if(!o.teamChannel)return console.log("Remove invalid notification"),void r(!0);y[o.teamChannel]&&o.pending?r(!0,y[o.teamChannel]):r(!1)},i.INVITE_TO_TEAM_ANSWER=function(e,n,r,o){var a=r.msg,i=a.content;if(!i.teamChannel)return console.log("Remove invalid notification"),void o(!0);var s,c,u=t.find(e,["store","proxy","teams"])||{};if(Object.keys(u).some(function(e){var n=u[e];if(n.channel===i.teamChannel)return s=e,c=n,!0}),s){if(i.team=c,!i.answer)try{e.store.modules.team.removeFromTeam(s,a.author,!0)}catch(e){console.error(e)}var f=i.user||i;n.sendMessage({type:"INVITE_TO_TEAM_ANSWERED",content:{user:f,team:c,answer:i.answer}},function(){}),o(!0)}else o(!0)},i.TEAM_EDIT_RIGHTS=function(e,n,r,o){var a=r.msg.content;if(!a.teamData)return console.log("Remove invalid notification"),void o(!0);var i,s=t.find(e,["store","proxy","teams"])||{};if(Object.keys(s).some(function(e){if(s[e].channel===a.teamData.channel)return i=e,!0}),i)try{e.store.modules.team.changeMyRights(i,a.state,a.teamData,function(e){e||console.error("Can't update team rights"),o(!0)})}catch(e){console.error(e)}else o(!0)},i.OWNED_PAD_REMOVED=function(e,n,t,r){var o=t.msg.content;if(!o.channel)return console.log("Remove invalid notification"),void r(!0);var a=o.channel;e.store.manager.findChannel(a).forEach(function(n){var t=e.store.manager.findFile(n.id);e.store.manager.delete({paths:t},function(){e.updateDrive()})}),r(!0)},i.MOVE_TODO=function(e,n,t,r){var o=e.store.proxy.curvePublic;t.msg.author===o?r():r(!0)},i.SAFE_LINKS_DEFAULT=function(e,n,t,r){var o=e.store.proxy.curvePublic;t.msg.author===o?r():r(!0)};var m={};i.FORM_RESPONSE=function(e,n,t,r){var o,a,i=t.msg,s=t.hash,c=i.content,u=c.channel;if(u)if(function(e,n){return(e.store.proxy.mutedChannels||[]).includes(n)}(e,u))r(!0);else if(e.Store.getAllStores().some(function(e){return e.manager.findChannel(u).some(function(e){if(e.data&&(!a||e.data.href))return a=e.data.href||e.data.roHref,o=e.data.filename||e.data.title,!!e.data.href||void 0})}),a){c.href=a,c.title=o;var f=m[u],l=f?f.data:void 0;m[u]={data:{type:n.type,hash:s}},r(!1,l)}else r(!0);else r(!0)},s.FORM_RESPONSE=function(e,n,t,r){var o=t.content.channel,a=m[o];a&&a.data&&a.data.hash===r&&delete m[o]};var g={};i.COMMENT_REPLY=function(e,n,r,o){var a=r.msg,i=r.hash,s=a.content;if(t.find(e.store.proxy,["settings","pad","disableNotif"]))o(!0);else{var c,u,f=s.channel;if(f)if(e.Store.getAllStores().some(function(e){return e.manager.findChannel(f).some(function(e){if(e.data&&(!u||e.data.href))return u=e.data.href||e.data.roHref,c=e.data.filename||e.data.title,!!e.data.href||void 0})}),u){s.href=u,s.title=c;var l=g[f],d=l?l.data:void 0;g[f]={data:{type:n.type,hash:i}},o(!1,d)}else o(!0);else o(!0)}},s.COMMENT_REPLY=function(e,n,t,r){var o=t.content.channel,a=g[o];a&&a.data&&a.data.hash===r&&delete g[o]};var E,b,O={};i.MENTION=function(e,n,t,r){var o=t.msg,a=t.hash,i=o.content;if(c(e,t))r(!0);else{var s=i.channel;if(s){var u,f;e.Store.getAllStores().some(function(e){return e.manager.findChannel(s).some(function(e){if(e.data&&(!f||e.data.href))return f=e.data.href||e.data.roHref,u=e.data.filename||e.data.title,!!e.data.href||void 0})}),i.href=f,i.title=u;var l=O[s],d=l?l.data:void 0;O[s]={data:{type:n.type,hash:a}},r(!1,d)}else r(!0)}},s.MENTION=function(e,n,t,r){var o=t.content.channel,a=O[o];a&&a.data&&a.data.hash===r&&delete O[o]},i.BROADCAST_MAINTENANCE=function(e,n,t,r){var o=t.msg.uid;e.Store.onMaintenanceUpdate(o),r(!0)},i.BROADCAST_SURVEY=function(e,n,t,r){var o=t.msg,a=o.content,i=o.uid,s=E;E={type:n.type,hash:t.hash},e.Store.onSurveyUpdate(i),r(!a.url,s)},i.BROADCAST_CUSTOM=function(e,n,t,r){var o=t.msg.uid,a=b;b={uid:o,type:n.type,hash:t.hash},r(!1,a)},i.BROADCAST_DELETE=function(e,n,t,r){var o=t.msg.content.uid;if(b&&b.uid===o)return r(!0,b),void(b=void 0);r(!0)};var A,w,D={};return i.SF_DELETED=function(e,n,t,r){var o=t.msg.content,a=o.team,i=o.sfId;if(D[i])r(!0);else if(D[i]=1,a){var s=e.store.proxy.teams[a];o.teamName=s.metadata&&s.metadata.name,r(!1)}else r(!1)},s.SF_DELETED=function(e,n,t){var r=t.content.sfId;delete D[r]},i.NEW_TICKET=function(e,n,r,o){var a=r.msg.content;a.time||(a.time=r.time);var i=t.find(e,["store","modules","support"]);a.isAdmin&&i.addUserTicket(a,o),i.addAdminTicket(a,o)},i.NOTIF_TICKET=function(e,n,r,o){var a=r.msg.content;a.time||(a.time=r.time);var i=t.find(e,["store","modules","support"]);if(a.isAdmin)return t.find(e,["store","proxy","support",a.channel])?(i.updateUserTicket(a),A?void o(!1,A):(A={channel:a.channel,type:n.type,hash:r.hash},void o(!1))):void o(!0);i.checkAdminTicket(a,s=>{s?(i.updateAdminTicket(a),t.find(e.store.proxy,["settings","general","disableSupportNotif"])?o(!0):w?o(!1,w):(w={channel:a.channel,type:n.type,hash:r.hash},o(!1))):o(!0)})},s.NOTIF_TICKET=function(e,n,t){var r=t.content.channel;A&&A.channel===r&&(A=void 0),w&&w.channel===r&&(w=void 0)},i.ADD_MODERATOR=function(e,n,r,o){var a=r.msg.content;t.find(e,["store","modules","support"]).updateAdminKey(a,o)},i.MODERATOR_NEW_KEY=function(e,n,r,o){var a=r.msg.content;t.find(e,["store","modules","support"]).updateAdminKey(a,function(){o(!0)})},{add:function(e,n,r,o){if(r.msg){var a=t.find(e,["store","proxy","curvePublic"]),s=t.find(r,["msg","content","user","curvePublic"])||t.find(r,["msg","content","curvePublic"]);if(s&&r.msg.author!==s&&r.msg.author!==a)return console.error("blocked"),void o(null,null,!0);var c=r.msg.type;if(i[c])try{i[c](e,n,r,o)}catch(e){console.error(e),o()}else o()}else o(null,null,!0)},remove:function(e,n,t,r){if(t){var o=t.type;if(s[o])try{s[o](e,n,t,r)}catch(e){console.error(e)}}}}})(On(),te(),Z(),M(),hn())),Rn),D(),M()),kn}function Kn(){if(Ln)return Fn;Ln=1;return Fn=((e,n,t,r,o,a,i,s,c)=>{let u={};let f=function(f,l,d,h){var p=f.version||0;s(function(){}).nThen(function(){var n,t,r,o,a;p<2&&(n="cryptpad.userlist-drawer",t="cryptpad.hide_poll_text",r="cryptpad.indentUnit",o="cryptpad.indentWithTabs",a=f.settings=f.settings||{},void 0!==f[r]&&(a.codemirror=a.codemirror||{},a.codemirror.indentUnit=f[r],delete f[r]),void 0!==f[o]&&(a.codemirror=a.codemirror||{},a.codemirror.indentWithTabs=f[o],delete f[o]),void 0!==f[n]&&(a.toolbar=a.toolbar||{},a.toolbar["userlist-drawer"]=f[n],delete f[n]),void 0!==f[t]&&(a.poll=a.poll||{},a.poll["hide-text"]=f[t],delete f[t]),e.send("Migrate-2",!0),f.version=p=2)}).nThen(function(){p<3&&(!function(){if(localStorage.CRYPTPAD_LANG){var e=localStorage.CRYPTPAD_LANG;f.settings.language=e}}(),e.send("Migrate-3",!0),f.version=p=3)}).nThen(function(){var n;p<4&&(n=f.settings=f.settings||{},void 0!==f.allowUserFeedback&&(n.general=n.general||{},n.general.allowUserFeedback=f.allowUserFeedback,delete f.allowUserFeedback),e.send("Migrate-4",!0),f.version=p=4)}).nThen(function(){p<5&&(!function(){var e=f.drive&&f.drive.filesData;if(e)for(var n in e)"number"!=typeof e[n].ctime&&(e[n].ctime=+new Date(e[n].ctime)),"number"!=typeof e[n].atime&&(e[n].atime=+new Date(e[n].atime))}(),e.send("Migrate-5",!0),f.version=p=5)}).nThen(function(t){var r,o,a,i,c;p<6&&(a=f.drive.filesData||{},i=s(function(){}),c=Object.keys(a).length,Object.keys(a).forEach(function(e,t){i=i.nThen(function(i){setTimeout(i(function(){if(r=a[e],o=n.parsePadUrl(r.href),r.href&&!r.channel){var i=n.getSecrets(o.type,o.hash,r.password);r.channel=i.channel,d(6,Math.round(100*t/c)),console.log("Adding missing channel in filesData ",r.channel)}}))})}),i.nThen(t(function(){e.send("Migrate-6",!0),f.version=p=6})))}).nThen(function(t){var r,o,a,i,c;p<7&&(a=f.drive.filesData,i=s(function(){}),c=Object.keys(a).length,Object.keys(a).forEach(function(e,t){i=i.nThen(function(i){setTimeout(i(function(){if((r=a[e]).href)if(-1!==r.href.indexOf("#"))if("pad"===(o=n.parsePadUrl(r.href)).hashData.type){if("view"===o.hashData.mode)r.roHref=r.href,delete r.href,console.log("Move href to roHref in filesData ",r.roHref);else{var i=n.getSecrets(o.type,o.hash,r.password),s=n.getViewHashFromKeys(i);s&&(r.roHref="/"+o.type+"/#"+s,console.log("Adding missing roHref in filesData ",r.href))}d(6,Math.round(100*t/c))}else d(7,Math.round(100*t/c));else d(7,Math.round(100*t/c));else d(7,Math.round(100*t/c))}))})}),i.nThen(t(function(){e.send("Migrate-7",!0),f.version=p=7})))}).nThen(function(){p<8&&(f.FS_hashes=t.deduplicateString(f.FS_hashes||[]),e.send("Migrate-8",!0),f.version=p=8)}).nThen(function(){p<9&&(!function(){var e=h.network,n={},t={store:h},o=r.createData(f),i=function(e){var t=n[e];if(t){try{t.wc.leave()}catch(e){}delete n[e]}};e.on("message",function(r,s){try{!function(r,s){if(s===e.historyKeeper){var c=JSON.parse(r);if(!c.validateKey&&!c.owners||!c.channel){if(c.channel&&n[c.channel]){if(c.error&&"EINVAL"===c.error){var u=["GET_HISTORY",c.channel,{}];return void e.sendto(e.historyKeeper,JSON.stringify(u)).then(function(){},function(){})}if(c.state&&1===c.state){o.channel=c.channel;var f=["UPDATE",o.curvePublic,+new Date,o],l=n[c.channel].encrypt(JSON.stringify(f));return n[c.channel].wc.bcast(l).then(function(){},function(e){console.error("Can't migrate this friend",n[c.channel].friend,e)}),void i(c.channel)}}else if(c.channel)return;var d=c[3];if(d&&n[d]){var h=n[d],p=h.decrypt(c[4]),v=JSON.parse(p);if("UPDATE"===v[0]){if(v[1]===o.curvePublic)return;var y=v[3];if(!y.notifications)return;h.friend.notifications=y.notifications,o.channel=d,a.sendTo(t,"UPDATE_DATA",o,{channel:y.notifications,curvePublic:y.curvePublic},function(e){e&&e.error?console.error(e):console.log("friend migrated",h.friend)}),i(d)}}}}}(r,s)}catch(e){console.error(e)}});var s=f.friends||{};Object.keys(s).forEach(function(t){if(44===t.length){var r=s[t];r.notifications||e.join(r.channel).then(function(t){var o=c.Curve.deriveKeys(r.curvePublic,f.curvePrivate),a=c.Curve.createEncryptor(o);n[r.channel]={wc:t,friend:r,decrypt:a.decrypt,encrypt:a.encrypt};var i={lastKnownHash:r.lastKnownHash},s=["GET_HISTORY",r.channel,i];e.sendto(e.historyKeeper,JSON.stringify(s)).then(function(){},function(e){console.error("Can't migrate this friend",r,e)})},function(e){console.error("Can't migrate this friend",r,e)})}})}(),e.send("Migrate-9",!0),f.version=p=9)}).nThen(function(t){p<10&&function(){var i=h.proxy.todo;if(i){var c,l=t(function(){e.send("Migrate-10",!0),f.version=p=10}),d={network:h.network,initialState:"{}",metadata:{owners:h.proxy.edPublic?[h.proxy.edPublic]:[]}};s(function(e){o.get(i,e(function(n,t){if(n||!t)return e.abort(),void l();try{c=JSON.parse(t)}catch(e){}}),d)}).nThen(function(e){if(!c||"object"!=typeof c)return e.abort(),void l();var t={content:{data:{1:{id:"1",color:"color6",item:[],title:u.kanban_todo},2:{id:"2",color:"color3",item:[],title:u.kanban_working},3:{id:"3",color:"color5",item:[],title:u.kanban_done}},items:{},list:[1,2,3]},metadata:{title:u.type.todo,defaultTitle:u.type.todo,type:"kanban"}},s=4,p=!1;if((c.order||[]).forEach(function(e){var n=c.data[e];if(n&&n.task){p=!0;var r=n.state?"3":"1";t.content.data[r].item.push(s),t.content.items[s]={id:s,title:n.task},s++}}),!p)return e.abort(),void l();var v=n.createRandomHash("kanban"),y=n.getSecrets("kanban",v),m=n.getSecrets("todo",i);o.put(v,JSON.stringify(t),e(function(t){if(t)return e.abort(),void l();h.rpc&&(h.rpc.pin([y.channel],function(){}),h.rpc.unpin([m.channel],function(){}));var o=n.hashToHref(v,"kanban");h.manager.addPad(["root"],{title:u.type.todo,owners:d.metadata.owners,channel:y.channel,href:o,roHref:n.hashToHref(n.getViewHashFromKeys(y),"kanban"),atime:+new Date,ctime:+new Date},e(function(e){if(e)console.error(e);else{delete h.proxy.todo;var n=r.createData(f),t={store:h};a.sendTo(t,"MOVE_TODO",{user:n,href:o},{channel:n.notifications,curvePublic:n.curvePublic},function(e){e&&e.error&&console.error(e)})}}))}),d)}).nThen(function(){l()})}}()}).nThen(function(n){if(!(p>=11)){var o=function(){e.send("Migrate-11",!0),f.version=p=11};if(void 0===t.find(f,["settings","security","unsafeLinks"])){var i={store:h},s=r.createData(f);s.curvePublic?a.sendTo(i,"SAFE_LINKS_DEFAULT",{user:s},{channel:s.notifications,curvePublic:s.curvePublic},n(function(e){e&&e.error?console.error(e):o()})):o()}else o()}}).nThen(function(){i.whenRealtimeSyncs(h.realtime,t.mkAsync(t.bake(l)))})};return f.setCustomize=e=>{u=e.Messages},f})(Ae(),te(),Z(),On(),xn(),jn(),je(),qe(),M()),Fn}var Un,Bn,Vn=o(be);var Yn,Gn,Jn,qn,Wn=Bn?Un:(Bn=1,Yn=xn(),Gn=Ue(),te(),Jn=je(),qn={anonDriveIntoUser:function(e,n,t){n&&e.loggedIn||"function"!=typeof t?Yn.get(n,function(r,o){var a;if(r)console.error("Cannot migrate recent pads",r);else if(o){try{a=JSON.parse(o)}catch(e){return"function"==typeof t&&t(),void console.error("Cannot parsed recent pads",e)}if(a){var i=e.proxy,s=Gn.init(a.drive,{readOnly:!1,loggedIn:!0,outer:!0}),c=function(){s.fixFiles(!0);var r=e.manager;s.getFiles([s.FILES_DATA]).forEach(function(e){var n=s.getFileData(e),t=n.channel,o=r.findChannel(t);if(0===o.length)n&&r.addPad(null,n,function(e){e&&console.error("Cannot import file:",n,e)});else{if(!n.href)return;o.forEach(function(e){e.data&&!e.data.href&&e.userObject.setHref(t,null,n.href)})}}),i.FS_hashes&&Array.isArray(i.FS_hashes)||(i.FS_hashes=[]),-1===i.FS_hashes.indexOf(n)&&i.FS_hashes.push(n),"function"==typeof t&&Jn.whenRealtimeSyncs(e.realtime,t)};s&&"function"==typeof s.migrate?s.migrate(c):(console.log("oldFo.migrate is not a function"),c())}else"function"==typeof t&&t()}else"function"==typeof t&&t()}):t()}},Un=qn);const zn=ie.mkEvent(!0),Qn=ie.mkEvent(!0),Zn=ie.mkEvent(),Xn=ie.mkEvent(),$n=(e,n)=>{var t,r;const o=e.store,a=e.Store;let i;if(n){const e=a.getStore(n);i=null===(r=null==e?void 0:e.proxy)||void 0===r?void 0:r.drive}else i=null===(t=o.drive)||void 0===t?void 0:t.proxy;return i},et={init:e=>{var n;const{broadcast:t,store:r,Store:o,account:a}=e,i=r.drive||(r.drive={});let s=null===(n=r.proxy)||void 0===n?void 0:n.drive;if((null==s?void 0:s.hash)||ae.createRandomHash("drive"),!s.hash)return i.proxy=s,a.onAccountCacheReady(()=>{zn.fire()}),a.onAccountReady(()=>{Qn.fire()}),{channel:"",onDriveCacheReady:zn.reg,onDriveReady:Qn.reg,onDisconnect:Zn.reg,onReconnect:Xn.reg};throw new Error("NOT IMPLEMENTED")},initAPI:e=>{const{broadcast:n,store:t,Store:r,account:o}=e,a={store:t,Store:r};return{exists:(e,n,r)=>{r({state:Boolean(t.proxy)})},get:(e,n,t)=>{let r=$n(a,n.teamId);t(r?{drive:r}:{error:"ENOTFOUND"})},set:(e,n,t)=>{let o=$n(a,n.teamId);var i,s;o?(i=o,s=n.value,Object.keys(i).forEach(e=>{delete i[e]}),Object.keys(s).forEach(e=>{i[e]=ie.clone(s[e])}),r.onSync(n.teamId,t)):t({error:"ENOTFOUND"})},migrateAnon:(e,n,r)=>{Wn.anonDriveIntoUser(t,n.anonHash,r)}}}};var nt=o(Object.freeze({__proto__:null,Drive:et})),tt=D(),rt=r(qe()),ot=r(bn()),at=We();const it=ie.mkEvent(!0),st=ie.mkEvent(!0),ct=(e,n,t,r)=>{const o=ie.once(ie.mkAsync(r)),{store:a,Store:i}=e;!a.offline&&a.anon_rpc?t.channel?32===t.channel.length&&ae.isValidChannel(t.channel)?a.anon_rpc.send("GET_METADATA",t.channel,(e,n)=>{if(e)return void o({error:e});const r=n&&n[0]||{};o(r),r.rejected||i.getAllStores().forEach(e=>{const n=e.manager.findChannel(t.channel,!0);let o=!1;(n.forEach(e=>{ot(e.data.owners)!==ot(r.owners)&&(o=!0),e.data.owners=r.owners,e.data.atime=+new Date,r.expire&&(e.data.expire=+r.expire)}),o)&&(e.sendEvent||a.sendDriveEvent)("DRIVE_CHANGE",{path:["drive",en.FILES_DATA]})})}):o({error:"EINVAL"}):o({error:"ENOTFOUND"}):o({error:"OFFLINE"})},ut=(e,n,t)=>{if(t.versionHash)return((e,n,t)=>{let r;const{Store:o,store:a,postMessage:i}=e,s=t.channel,c=t.versionHash,u=ae.createChannelId();rt(t=>{ct(e,0,{channel:s},t(e=>{if(e&&e.rejected)return i(n,"PAD_ERROR",{type:"ERESTRICTED"}),void t.abort();r=e.validateKey}))}).nThen(()=>{o.getHistoryRange(n,{cpCount:1,channel:s,lastKnownHash:c},e=>{var t,o;if(e&&e.error)return i(n,"PAD_ERROR",e.error);const f=e.messages||[];if((null===(t=f[f.length-1])||void 0===t?void 0:t.serverHash)!==c)return i(n,"PAD_ERROR",{type:"HASH_NOT_FOUND"});i(n,"PAD_CONNECT",{myID:u,id:s,members:[u]}),(e.messages||[]).forEach(e=>{i(n,"PAD_MESSAGE",{msg:e.msg,time:e.time,user:u.slice(0,16)})}),r&&(null===(o=null==a?void 0:a.messenger)||void 0===o||o.storeValidateKey(s,r)),i(n,"PAD_READY")})})})(e,n,t);const{channels:r,store:o,Store:a,myDeletions:i,postMessage:s}=e,c=t.channel;if(!ae.isValidChannel(c))return s(n,"PAD_ERROR","INVALID_CHAN");const u=void 0===r[c],f=r[c]||(r[c]={queue:[],data:{},clients:[],bcast:(e,n,t)=>{f.clients.forEach(function(r){r!==t&&s(r,e,n)})},history:[],pushHistory:(e,n)=>{if(n){let n;for(f.history.push("cp|"+e),n=f.history.length-101;n>0&&!/^cp\|/.test(f.history[n]);n--);return void(f.history=f.history.slice(n))}f.history.push(e)}});if(-1===f.clients.indexOf(n)&&f.clients.push(n),!u&&f.wc)return s(n,"PAD_CONNECT",{myID:f.wc.myID,id:f.wc.id,members:f.wc.members}),f.wc.members.forEach(e=>{s(n,"PAD_JOIN",e)}),f.history.forEach(e=>{s(n,"PAD_MESSAGE",{msg:tt.removeCp(e),user:f.wc.myID,validateKey:f.data.validateKey})}),void s(n,"PAD_READY");const l=n=>{const r=null==n?void 0:n.type;"EDELETED"===r&&i[c]&&(delete i[c],n.ownDeletion=!0),f.bcast("PAD_ERROR",n),"EDELETED"===r&&(null==de?void 0:le.clearChannel)&&le.clearChannel(c),["EDELETED","EEXPIRED","ERESTRICTED"].includes(r)&&e.leavePad(null,t,function(){})},d={Cache:o.neverCache?void 0:de,priority:1,onCacheStart:()=>{s(n,"PAD_CACHE")},onCacheReady:()=>{s(n,"PAD_CACHE_READY"),st.fire()},onReady:e=>{const t=e.metadata||{};f.data=t,(null==t?void 0:t.validateKey)&&o.messenger&&o.messenger.storeValidateKey(c,t.validateKey),s(n,"PAD_READY",e.noCache)},onMessage:function(e,n,t,r,o){f.lastHash=o,f.pushHistory(e,r),f.bcast("PAD_MESSAGE",{user:n,msg:e,validateKey:t})},onJoin:function(e){f.bcast("PAD_JOIN",e)},onLeave:function(e){f.bcast("PAD_LEAVE",e)},onError:l,onChannelError:l,onRejected:a.onRejected,onConnectionChange:e=>{e.state||f.bcast("PAD_DISCONNECT")},onMetadataUpdate:e=>{f.data=e||{},a.getAllStores().forEach(n=>{n.manager.findChannel(c,!0).forEach(n=>{n.data.owners=e.owners,n.data.atime=+new Date,e.expire&&(n.data.expire=+e.expire)});(n.sendEvent||o.sendDriveEvent)("DRIVE_CHANGE",{path:["drive",en.FILES_DATA]})}),f.bcast("PAD_METADATA",e)},crypto:{encrypt:function(e){return e},decrypt:function(e){return e}},noChainPad:!0,channel:c,metadata:t.metadata,network:o.network||o.networkPromise,websocketURL:U.getWebsocketURL(),onInit:function(){it.fire()},onConnect:(e,t)=>{f.sendMessage=(n,r,o)=>{t(n,t=>{t?o({error:t}):(f.lastHash=n.slice(0,64),f.pushHistory(tt.removeCp(n),/^cp\|/.test(n)),f.bcast("PAD_MESSAGE",{user:e.myID,msg:tt.removeCp(n),validateKey:f.data.validateKey},r),o())})},f.wc=e,f.queue.forEach(function(e){f.sendMessage(e.message,n)}),f.queue=[],f.bcast("PAD_CONNECT",{myID:e.myID,id:e.id,members:e.members})}};f.cpNf=tt.start(d)},ft=(e,n)=>{var t,r,o,a,i,s;const c=e.store;if(null===(r=null===(t=c.messenger)||void 0===t?void 0:t.leavePad)||void 0===r||r.call(t,n),null===(a=null===(o=c.onlyoffice)||void 0===o?void 0:o.leavePad)||void 0===a||a.call(o,n),Object.keys(c.modules).forEach(e=>{var t,r;null===(r=null===(t=c.modules[e])||void 0===t?void 0:t.leavePad)||void 0===r||r.call(t,n)}),!((e,n)=>{const{store:t}=e;if(!t)return!1;if(t.driveChannel===n)return!0;if(at.isSharedFolderChannel(n))return!0;if(ie.find(t,["proxy","teams"])){var r=ie.find(t,["proxy","teams"])||{};return Object.keys(r).some(e=>r[e].channel===n)}if(ie.find(t,["proxy","profile","href"])){let e=ie.find(t,["proxy","profile","href"]);return ae.hrefToHexChannelId(e)===n}})(e,n)){try{le.leaveChannel(n)}catch(e){console.error(e)}null===(s=null===(i=e.channels[n])||void 0===i?void 0:i.cpNf)||void 0===s||s.stop()}delete e.channels[n]},lt={init:e=>{const{broadcast:n,postMessage:t,store:r,Store:o}=e,a={channels:[],postMessage:t,store:r,Store:o,myDeletions:[],leavePad:(e,n,t)=>{}},i=(e,n,t)=>{const r=a.channels[n.channel];(null==r?void 0:r.cpNf)?(ft(a,n.channel),t()):t({error:"EINVAL"})};a.leavePad=i;return{join:(e,n,t)=>{ut(a,e,n)},destroy:(e,n,t)=>{((e,n,t,r)=>{const{store:o,Store:a,channels:i,myDeletions:s}=e;let c,u,f=t,l=!1;if(t&&"object"==typeof t&&({channel:f,force:l,teamId:c,reason:u}=t),f===o.driveChannel&&!l)return void r({error:"User drive removal blocked!"});const d=a.getStore(c);d?d.rpc?(i[f]&&(s[f]=!0),d.rpc.removeOwnedChannel(f,e=>{e&&delete s[f],r({error:e})},u)):r({error:"RPC_NOT_READY"}):r({error:"ENOTFOUND"})})(a,0,n,t)},clear:(e,n,t)=>{((e,n,t,r)=>{const{Store:o}=e,a=o.getStore(t&&t.teamId);a.rpc?a.rpc.clearOwnedChannel(t.channel,e=>{r({error:e})}):r({error:"RPC_NOT_READY"})})(a,0,n,t)},setMetadata:(e,n,t)=>{((e,n,t,r)=>{if(!t.channel)return void r({error:"ENOTFOUND"});if(!t.command)return void r({error:"EINVAL"});const{Store:o}=e,a=o.getStore(t.teamId);if(!a)return void r({error:"ENOTFOUND"});const i=t.channels;delete t.channels,a.rpc.setMetadata(t,(e,n)=>{e?r({error:e}):Array.isArray(n)&&n.length?r(n[0]):r({})}),Array.isArray(i)&&i.forEach(e=>{var r=ie.clone(t);r.channel=e,o.setPadMetadata(n,r,()=>{})})})(a,e,n,t)},getMetadata:(e,n,t)=>{ct(a,0,n,t)},sendMessage:(e,n,t)=>{((e,n,t,r)=>{var o=t.msg,a=e.channels[t.channel];if(a)a.wc?a.sendMessage(o,n,r):(a.queue.push(o),r())})(a,e,n,t)},onCorruptedCache:(e,n,t)=>{((e,n,t)=>{var r=e.channels[t];r&&r.cpNf&&(le.clearChannel(t),r.cpNf.resetCache&&r.cpNf.resetCache())})(a,0,n)},getLastHash:(e,n,t)=>{((e,n,t,r)=>{var o=e.channels[t.channel];o?o.lastHash?r({hash:o.lastHash}):r({error:"EINVAL"}):r({error:"ENOCHAN"})})(a,0,n,t)},leave:i,removeClient:e=>{Object.keys(a.channels).forEach(n=>{let t=a.channels[n].clients.indexOf(e);-1!==t&&a.channels[n].clients.splice(t,1),0===a.channels[n].clients.length&&ft(a,n)})},onJoined:it.reg,onCacheReady:st.reg,getChannels:()=>a.channels}}};var dt,ht,pt,vt,yt,mt,gt,Et,bt,Ot,At,wt,Dt,_t,Tt,St,Nt,It,xt,Ct,Rt=o(Object.freeze({__proto__:null,Pad:lt}));function Pt(){if(ht)return dt;ht=1;return dt=((e,n,t)=>{const r={};let o={},a={};r.setCustomize=e=>{o=e.Messages,a=e.AppConfig};var i=function(e,n){n.degraded||n.clients.forEach(function(t){var r=e.clients[t];if(r){var o={id:r.id,cursor:r.cursor};n.sendMsg(JSON.stringify(o))}})},s=function(e,n,t){var r=n.members,o=a.degradedLimit||8;t.degraded=r.length-1>=o,e.emit("DEGRADED",{degraded:t.degraded},t.clients)},c=function(e,n,r,o){var a=n.channel,c=n.secret;c.keys.cryptKey&&(c.keys.cryptKey=function(e){for(var n=Object.keys(e).length,t=new Uint8Array(n),r=0;r<n;r++)t[r]=e[r];return t}(c.keys.cryptKey));var u=c.channel,f=e.store.network,l=!0,d=e.clients[r];if(d)o();else{d=e.clients[r]={channel:a,cursor:{}};var h=e.channels[a];if(h)return d.id||(d.id=h.wc.myID+"-"+r),h.clients.forEach(function(n){var t=e.clients[n];h.degraded||t&&e.emit("MESSAGE",{id:t.id,cursor:t.cursor},[r])}),h.sendMsg(JSON.stringify({join:!0,id:d.id})),h.clients.push(r),s(e,h.wc,h),void o();var p=function(n){e.channels[a]=e.channels[a]||{};var f=e.channels[a];f.padChan=u,d.id||(d.id=n.myID+"-"+r),f.clients&&f.clients.forEach(function(t){e.clients[t]&&!e.clients[t].id&&(e.clients[t].id=n.myID+"-"+t)}),f.encryptor||(f.encryptor=t.createEncryptor(c.keys)),n.on("join",function(){i(e,f),s(e,n,f)}),n.on("leave",function(t){e.emit("MESSAGE",{leave:!0,id:t},f.clients),s(e,n,f)}),n.on("message",function(n){if(!f.degraded){var t,r=f.encryptor.decrypt(n,c.keys&&c.keys.validateKey);try{if((t=JSON.parse(r))&&t.join)return void i(e,f);e.emit("MESSAGE",t,f.clients)}catch(e){console.error(e)}}}),f.wc=n,f.sendMsg=function(e,t){t=t||function(){};var r=f.encryptor.encrypt(e);n.bcast(r).then(function(){t()},function(e){t({error:e})})},l&&(f.clients=[r],l=!1,o(),s(e,n,f))};f.join(a).then(p,function(e){o({error:e})});var v=function(){e.channels[a]?f.join(a).then(p,function(e){console.error(e)}):console.log("cant reconnect",a)};e.channels[a]=e.channels[a]||{},e.channels[a].onReconnect=v,f.on("reconnect",v)}},u=function(t,r,a,i){var s=t.clients[a];if(s){var c=t.store.proxy||{};r.color=e.find(c,["settings","general","cursor","color"]),r.name=c[n.displayNameKey]||t.store.noDriveName||o.anonymous,r.avatar=e.find(c,["profile","avatar"]),r.uid=e.find(c,["uid"])||t.store.noDriveUid,s.cursor=r,function(e,n){var t=e.clients[n];if(t&&t.cursor){var r=e.channels[t.channel];if(r&&!r.degraded&&r.sendMsg){var o={id:t.id,cursor:t.cursor};r.sendMsg(JSON.stringify(o)),e.emit("MESSAGE",o,r.clients.filter(function(e){return e!==n}))}}}(t,a),i()}else i({error:"NO_CLIENT"})};return r.init=function(e,n,t){var r={};if(e.store&&e.store.modules&&e.store.modules.cursor)return e.store.modules.cursor;var o={store:e.store,emit:t,channels:{},clients:{}};return r.removeClient=function(e){!function(e,n){var t,r=function(e){return e!==n};for(var o in e.channels)(t=e.channels[o]).clients=t.clients.filter(r),0===t.clients.length&&(t.wc&&t.wc.leave(),t.onReconnect&&e.store.network.off("reconnect",t.onReconnect),delete e.channels[o]);if(e.clients[n]){var a={leave:!0,id:e.clients[n].id};(t=e.channels[e.clients[n].channel])&&(t.sendMsg(JSON.stringify(a)),e.emit("MESSAGE",a,t.clients))}delete e.clients[n]}(o,e)},r.leavePad=function(e){!function(e,n){Object.keys(e.channels).some(function(t){var r=e.channels[t];if(r.padChan===n)return r.wc&&r.wc.leave(),r.onReconnect&&e.store.network.off("reconnect",r.onReconnect),delete e.channels[t],!0})}(o,e)},r.execCommand=function(e,n,t){var r=n.cmd,a=n.data;"INIT_CURSOR"!==r?"UPDATE"!==r||u(o,a,e,t):c(o,a,e,t)},r},r})(Z(),Y(),M()),dt}function kt(){if(vt)return pt;vt=1;return pt=((e,n,t,r,o,a,i,s,c,u)=>{const f={};let l={};f.setCustomize=e=>{l=e.ApiConfig};var d=i.Nacl,h=function(e,n,t,r){let o=Object.keys(e.clients).filter(t=>Boolean(e.clients[t].admin)===n);o.length&&e.emit(t,{channel:r},[o])},p=function(n,t,r,o){var a=e.mkAsync(o);if(t&&!n.adminRdyEvt)return void a("EFORBIDDEN");let i=l.httpUnsafeOrigin;e.fetchApi(i,"config",!0,o=>{n.moderatorKeys=o.moderatorKeys,n.adminKeys=o.adminKeys;var i=o.supportMailboxKey;if(i){if(!t||e.find(n.store.proxy,["mailboxes","supportteam","keys","curvePublic"])===i)return t?n.adminRdyEvt.reg(()=>{a(null,{supportKey:i,myCurve:r.adminCurvePrivate||e.find(n.store.proxy,["mailboxes","supportteam","keys","curvePrivate"]),theirPublic:r.curvePublic,notifKey:r.curvePublic})}):void a(null,{supportKey:i,myCurve:n.store.proxy.curvePrivate,theirPublic:r.curvePublic||i,notifKey:i});a("EFORBIDDEN")}else a("E_NOT_INIT")})},v=function(n,t,r,o){var s,c,f=e.once(e.mkAsync(o));a(e=>{p(n,r,t,e((n,t)=>{if(n)return e.abort(),void f({error:n});s=t.theirPublic,c=t.myCurve}))}).nThen(()=>{var r,o=i.Curve.deriveKeys(s,c),a=i.Curve.createEncryptor(o),l={network:n.store.network,channel:t.channel,noChainPad:!0,crypto:a,owners:[]},d=[];f=e.both(function(){r&&"function"==typeof r.stop&&r.stop()},f),l.onMessage=function(e,n,t,r,o,a,i){var s=i&&i.time;try{e=JSON.parse(e)}catch(e){return void console.error(e)}e.time=s,a&&(e.author=a),d.push(e)},l.onError=f,l.onChannelError=f,l.onReady=function(){f(null,d)},r=u.start(l)})},y=function(t,r,o,s){var c=e.find(t,["store","mailbox"]),u=e.find(t,["store","anon_rpc"]);if(c)if(u){var f,l,d,h=r.channel,v=r.title,y=r.ticket,m=+new Date;a(e=>{p(t,o,r,e((n,t)=>{if(n)return e.abort(),void s({error:n});f=t.supportKey,l=t.theirPublic,d=t.myCurve}))}).nThen(e=>{var n=i.Curve.deriveKeys(l,d),t=i.Curve.createEncryptor(n),r=JSON.stringify(y),o=t.encrypt(r);u.send("WRITE_PRIVATE_MESSAGE",[h,o],e((n,t)=>{if(n)return e.abort(),void s({error:n});m=t&&t[0]}))}).nThen(e=>{if(o){var n=t.adminDoc.proxy.tickets.active;if(n[h])return e.abort(),void s({error:"EEXISTS"});n[h]={title:y.title,restored:y.legacy,premium:!1,time:m,author:r.name,supportKey:f,lastAdmin:!0,authorKey:r.curvePublic,notifications:r.notifications}}}).nThen(e=>{o||(t.supportData[h]={time:+new Date,title:v,curvePublic:f},t.Store.onSync(null,e()))}).nThen(()=>{var a=o?r.notifications:n.getChannelIdFromKey(f);c.sendTo("NEW_TICKET",{title:v,channel:h,time:m,isAdmin:o,supportKey:f,premium:o?"":e.find(t,["store","account","plan"]),user:e.find(r.ticket,["sender","curvePublic"])?void 0:{supportTeam:!0}},{channel:a,curvePublic:l},e=>{console.error(e),e&&e.error&&delete t.supportData[h],s(e)}),c.sendTo("NOTIF_TICKET",{title:v,channel:h,time:m,isAdmin:o,isNewTicket:!0,user:e.find(r.ticket,["sender","curvePublic"])?void 0:{supportTeam:!0}},{channel:a,curvePublic:l},()=>{})})}else s({error:"anonymous rpc session not ready"});else s({error:"E_NOT_READY"})},m=function(t,r,o,s){var c,u,f,l,d=e.find(t,["store","mailbox"]),h=e.find(t,["store","anon_rpc"]);d?h?r?.ticket?a(e=>{p(t,o,r,e((n,t)=>{if(n)return e.abort(),void s(n);c=t.theirPublic,u=t.myCurve,f=t.notifKey}))}).nThen(e=>{var n=i.Curve.deriveKeys(c,u),t=i.Curve.createEncryptor(n),o=JSON.stringify(r.ticket),a=t.encrypt(o);h.send("WRITE_PRIVATE_MESSAGE",[r.channel,a],e((n,t)=>{if(n)return e.abort(),void s(n);l=t&&t[0],s(void 0,l)}))}).nThen(()=>{var t=o?r.notifChannel:n.getChannelIdFromKey(f);t&&d.sendTo("NOTIF_TICKET",{isAdmin:o,title:r.ticket.title,isClose:r.ticket.close,channel:r.channel,time:l,user:e.find(r.ticket,["sender","curvePublic"])?void 0:{supportTeam:!0}},{channel:t,curvePublic:f},()=>{})}):s("E_NO_DATA"):s("anonymous rpc session not ready"):s("E_NOT_READY")},g=function(t,r,o){var a=n.getSecrets("support",r),u={data:{},channel:a.channel,crypto:i.createEncryptor(a.keys),userName:"support",ChainPad:c,classic:!0,network:t.store.network,metadata:{validateKey:a.keys.validateKey||void 0}},f=t.adminDoc=s.create(u);f.proxy.on("ready",function(){var r=f.proxy;if(r.tickets=r.tickets||{},r.tickets.active=r.tickets.active||{},r.tickets.closed=r.tickets.closed||{},r.tickets.pending=r.tickets.pending||{},t.adminRdyEvt.fire(),o(),!t.supportRpc)return;let a=function(n){if(!n.adminDoc||!n.supportRpc)return;let t=n.adminDoc.metadata&&n.adminDoc.metadata.channel,r=n.adminDoc.proxy.tickets,o=[t,...Object.keys(r.active),...Object.keys(r.pending),...Object.keys(r.closed)];return e.deduplicateString(o).sort()}(t),i=n.hashChannelList(a);t.supportRpc.getServerHash(function(e,n){e?console.warn(e):n!==i&&t.supportRpc.reset(a,function(e){e&&console.warn(e)})})}),f.proxy.on("change",["recorded"],function(){h(t,!0,"RECORDED_CHANGE","")}),f.proxy.on("remove",["recorded"],function(){h(t,!0,"RECORDED_CHANGE","")})},E=function(t,o,i){let s=i(),c=t.store.proxy,u=e.find(c,["mailboxes","supportteam","keys","curvePublic"]),f=e.find(c,["mailboxes","supportteam","keys","curvePrivate"]);o||(t.adminRdyEvt=e.mkEvent(!0)),a(e=>{p(t,!1,{},e((n,r)=>{if(setTimeout(s),n)e.abort();else if(r.theirPublic!==u){try{delete c.mailboxes.supportteam,t.store.mailbox.close("supportteam")}catch(e){}return delete t.adminRdyEvt,void e.abort()}}))}).nThen(n=>{!function(n,t){let o,a,i=e.mkAsync(t),s=n.store.proxy,c=e.find(s,["mailboxes","supportteam","keys","curvePrivate"]);if(c){try{let n=d.sign.keyPair.fromSeed(e.decodeBase64(c));o=e.encodeBase64(n.secretKey),a=e.encodeBase64(n.publicKey)}catch(e){return void i(e)}r.create(n.store.network,{edPublic:a,edPrivate:o},(e,t)=>{e?i(e):(console.log("Support RPC ready, public key is ",a),n.supportRpc=t,i())})}else i("EFORBIDDEN")}(t,n(e=>{e&&console.error("Support RPC not ready",e)}))}).nThen(e=>{let r=f.slice(0,24),o=n.getEditHashFromKeys({version:2,type:"support",keys:{editKeyStr:r}});g(t,o,e())}).nThen(()=>{console.log("Support admin loaded")})};var b=function(n,t,r,o){let a=n.store.proxy,i=e.find(a,["mailboxes","supportadmin"]);i?n.store.mailbox.open("supportadmin",i,function(t){n.store.mailbox.close("supportadmin",function(){});let r=e.clone(t||{}),a=[];Object.keys(r).forEach(e=>{let t=r[e];if("CLOSE"===t.type)return void(a.includes(t.content.id)||a.push(t.content.id));let o=t.author,i=t.content&&t.content.title;((e,n,t)=>{let r=e.adminDoc.proxy;return["active","pending","closed"].some(e=>{let o=r.tickets[e];return Object.keys(o).some(e=>{let r=o[e];return r.authorKey===n&&r.title===t&&r.restored})})})(n,o,i)&&(a.includes(t.content.id)||a.push(t.content.id))}),Object.keys(r).forEach(e=>{let n=r[e];n.content&&a.includes(n.content.id)&&delete r[e]}),o(r)},!0,{dump:!0}):o({error:"ENOENT"})};let O=(n,t,r,o)=>{let a;try{let n=d.sign.keyPair.fromSeed(e.decodeBase64(r));a=e.encodeBase64(n.publicKey)}catch(e){return void o(e)}n.Store.adminRpc(null,{cmd:"ADMIN_DECREE",data:["SET_SUPPORT_KEYS",[t,a]]},o)},A=(e,n,t,r)=>{e.Store.adminRpc(null,{cmd:"GET_MODERATORS",data:{}},r)};return f.init=function(r,i,s){var c={};if(r.store&&r.store.modules&&r.store.modules.support)return r.store.modules.support;var u=r.store,f=u.proxy.support=u.proxy.support||{},g={moderatorKeys:l.moderatorKeys,adminKeys:l.adminKeys,supportData:f,store:r.store,Store:r.Store,emit:s,clients:{}};return e.find(u,["proxy","mailboxes","supportteam"])&&E(g,!1,i),c.ctx=g,c.removeClient=function(e){delete g.clients[e]},c.leavePad=function(){},c.addAdminTicket=function(e,n){!function(e,n,r){e.adminRdyEvt?e.adminRdyEvt.reg(()=>{let o;a(t=>{p(e,!0,n,t((e,n)=>{if(e)return t.abort(),void r(!0);o=n.supportKey}))}).nThen(()=>{var a=Math.floor(2e3*Math.random());setTimeout(()=>{var a=e.adminDoc.proxy;a.tickets.active[n.channel]||a.tickets.closed[n.channel]||a.tickets.pending[n.channel]?r(!0):(a.tickets.active[n.channel]={title:n.title,premium:n.premium,time:n.time,author:n.user&&n.user.displayName,supportKey:n.supportKey||o,authorKey:n.user&&n.user.curvePublic},t.whenRealtimeSyncs(e.adminDoc.realtime,function(){r(!0)}),h(e,!0,"NEW_TICKET",n.channel),e.supportRpc&&e.supportRpc.pin([n.channel],()=>{}))},a)})}):r(!0)}(g,e,n)},c.updateAdminTicket=function(e){!function(e,n){e.adminRdyEvt&&e.adminRdyEvt.reg(()=>{var t=Math.floor(2e3*Math.random());setTimeout(()=>{var t=e.adminDoc.proxy;let r=t.tickets.active[n.channel]||t.tickets.pending[n.channel];r&&(n.time<=r.time||(n.isClose&&(t.tickets.closed[n.channel]=r,delete t.tickets.active[n.channel],delete t.tickets.pending[n.channel]),r.time=n.time,r.lastAdmin=!1,h(e,!0,"UPDATE_TICKET",n.channel)))},t)})}(g,e)},c.updateAdminKey=function(t,r){((t,r,o)=>{let i=r.supportKey,s=n.getBoxPublicFromSecret(i),c=t.store.proxy;const u=e.find(c,["mailboxes","supportteam","keys","curvePrivate"]),f=e.find(c,["mailboxes","supportteam","keys","curvePublic"]);p(t,!1,{},(n,r)=>{if(n)return void o(!0);if(s!==r.theirPublic)return void o(!0);if(u===i||f===s)return void o(!0);let c=e.find(t,["store","mailbox"]);try{t.adminDoc&&t.adminDoc.stop(),c&&c.close("supportteam"),t.supportRpc&&t.supportRpc.destroy(),t.adminRdyEvt=e.mkEvent(!0)}catch(e){console.error(e)}t.Store.addAdminMailbox(null,{version:2,priv:i},e=>{e&&e.error?o(!0):a(e=>{E(t,!0,e),t.adminRdyEvt.reg(()=>{h(t,!0,"UPDATE_RIGHTS"),o(!1)})})})})})(g,t,r)},c.checkAdminTicket=function(e,n){!function(e,n,t){e.adminRdyEvt?e.adminRdyEvt.reg(()=>{let r=e.adminDoc.proxy,o=r.tickets.active[n.channel]||r.tickets.pending[n.channel];t(o)}):t(!0)}(g,e,n)},c.addUserTicket=function(e,n){!function(e,n,t){if(!e.supportData)return void t(!0);let r=n.channel;e.supportData[r]={time:n.time,title:n.title,curvePublic:n.supportKey},e.Store.onSync(null,function(){t(!0)})}(g,e,n)},c.updateUserTicket=function(e){!function(e,n){if(h(e,!1,"UPDATE_TICKET",n.channel),n.isClose){let t=e.supportData[n.channel];if(!t)return;t.closed=!0}}(g,e)},c.execCommand=function(r,i,s){var c=i.cmd,u=i.data;"MAKE_TICKET"!==c?"GET_MY_TICKETS"!==c?"REPLY_TICKET"!==c?"CLOSE_TICKET"!==c?"DELETE_TICKET"!==c?"MAKE_TICKET_ADMIN"!==c?"LIST_TICKETS_ADMIN"!==c?"LOAD_TICKET_ADMIN"!==c?"REPLY_TICKET_ADMIN"!==c?"CLOSE_TICKET_ADMIN"!==c?"MOVE_TICKET_ADMIN"!==c?"GET_RECORDED"!==c?"SET_RECORDED"!==c?"USE_RECORDED"!==c?"SEARCH_ADMIN"!==c?"FILTER_TAGS_ADMIN"!==c?"SET_TAGS_ADMIN"!==c?"GET_LEGACY"!==c?"DUMP_LEGACY"!==c?"CLEAR_LEGACY"!==c?"RESTORE_LEGACY"!==c?"GET_PRIVATE_KEY"!==c?"DISABLE_SUPPORT"!==c?"ROTATE_KEYS"!==c?"ADD_MODERATOR"!==c?s({error:"NOT_SUPPORTED"}):function(n,t,r,o){let a=n.store.proxy;var i=e.find(n,["store","mailbox"]);let s=e.find(a,["mailboxes","supportteam","keys","curvePublic"]),c=e.find(a,["mailboxes","supportteam","keys","curvePrivate"]),u=e.find(a,["mailboxes","supportteam","lastKnownHash"]),f=a.edPublic;p(n,!1,{},(e,r)=>{e?o({error:e}):r.theirPublic===s&&n.moderatorKeys.includes(f)?i.sendTo("ADD_MODERATOR",{supportKey:c,lastKnownHash:u},{channel:t.mailbox,curvePublic:t.curvePublic},()=>{o()}):o({error:"EFORBIDDEN"})})}(g,u,0,s):function(t,r,i,s){let c,u=e.once(e.mkAsync(s)),f=t.store.proxy,l=f.edPublic;const h=d.box.keyPair(),v=e.encodeBase64(h.publicKey),y=e.encodeBase64(h.secretKey),m=e.find(f,["mailboxes","supportteam","keys","curvePrivate"]),g=e.find(f,["mailboxes","supportteam","keys","curvePublic"]);if(!y||!v)return void u({error:"INVALID_KEY"});let b;a(e=>{p(t,!1,{},e((n,t)=>{if("E_NOT_INIT"!==n)return n?(u({error:n}),void e.abort()):void(c=t.theirPublic)}))}).nThen(e=>{if(!t.adminKeys.includes(l))return e.abort(),void u({error:"EFORBIDDEN"})}).nThen(e=>{if(c)return t.moderatorKeys.includes(l)?g!==c?(e.abort(),void u({error:"EFORBIDDEN"})):void 0:(e.abort(),void u({error:"EINVAL"}))}).nThen(e=>{c&&t.adminRdyEvt.reg(()=>{let r=t.adminDoc.proxy;b=t.adminDoc.metadata&&t.adminDoc.metadata.channel;let a=y.slice(0,24),i=n.getEditHashFromKeys({version:2,type:"support",keys:{editKeyStr:a}}),s={network:t.store.network,initialState:"{}"};(r.oldKeys=r.oldKeys||{})[g]={curvePrivate:m,rotatedOn:+new Date,rotatedBy:l},o.put(i,JSON.stringify(r),e(n=>{if(n)return e.abort(),void u({error:n})}),s)})}).nThen(e=>{O(t,v,y,e(n=>{if(n&&n.error)return e.abort(),void u(n)}))}).nThen(()=>{if(!c)return;t.adminDoc&&t.adminDoc.stop();let n=e.find(t,["store","mailbox"]);n&&n.close("supportteam"),t.supportRpc&&t.supportRpc.destroy(),t.adminRdyEvt=e.mkEvent(!0)}).nThen(e=>{t.Store.addAdminMailbox(null,{version:2,priv:y},e(n=>{if(n&&n.error)return e.abort(),c?O(t,g,m,()=>{u(n)}):void u(n)}))}).nThen(n=>{if(!c)return;let r=e.find(t,["store","mailbox"]);A(t,0,0,n(e=>{if(e&&e.error)return void u({success:!0,noNotify:!0});let n=e&&e[0];Object.keys(n||{}).forEach(e=>{let t=n[e];r.sendTo("MODERATOR_NEW_KEY",{supportKey:y},{channel:t.mailbox,curvePublic:t.curvePublic},()=>{})})}))}).nThen(e=>{E(t,!0,e)}).nThen(e=>{b&&t.Store.adminRpc(null,{cmd:"ARCHIVE_DOCUMENT",data:{id:b,reason:"Deprecated support pad"}},e())}).nThen(()=>{u({success:!0})})}(g,0,0,s):function(n,t,r,o){let i,s=e.once(e.mkAsync(o)),c=n.store.proxy.edPublic;a(e=>{p(n,!1,{},e(n=>{if(n)return s({error:n}),void e.abort()}))}).nThen(e=>{if(!n.adminKeys.includes(c))return e.abort(),void s({error:"EFORBIDDEN"})}).nThen(e=>{n.Store.adminRpc(null,{cmd:"ARCHIVE_SUPPORT",data:{}},e(n=>{if(n&&n.error)return e.abort(),void s(n)}))}).nThen(e=>{n.Store.adminRpc(null,{cmd:"ADMIN_DECREE",data:["SET_SUPPORT_KEYS",["",""]]},e(function(n){if(n&&n.error)return e.abort(),void s(n)}))}).nThen(e=>{A(n,0,0,e(n=>{if(!n||n.error)return e.abort(),void s();i=n[0]||{}}))}).nThen(()=>{let e=a;Object.keys(i).forEach(t=>{e=e(e=>{n.Store.adminRpc(null,{cmd:"REMOVE_MODERATOR",data:t},e(e=>{e&&e.error&&console.error("Error removing moderator data",t,e.error)}))}).nThen}),e(()=>{s()})})}(g,0,0,s):function(n,t,r,o){let a=n.store.proxy,i=e.find(a,["mailboxes","supportteam","keys","curvePublic"]),s=e.find(a,["mailboxes","supportteam","keys","curvePrivate"]);p(n,!1,{},(e,n)=>{e?o({error:e}):(i&&n.theirPublic!==i&&(s=void 0),o({curvePrivate:s,curvePublic:n.theirPublic}))})}(g,0,0,s):function(t,r,o,a){let i=t.store.proxy,s=e.find(i,["mailboxes","supportadmin"]);if(!s)return void a({error:"ENOENT"});if(!t.adminRdyEvt)return void a({error:"EFORBIDDEN"});let c=r.messages,u=r.hashes,f=c[0],l=c[c.length-1];f?t.adminRdyEvt.reg(()=>{let r={name:e.find(f,["sender","name"]),notifications:e.find(f,["sender","notifications"]),curvePublic:e.find(f,["sender","curvePublic"]),channel:n.createChannelId(),title:f.title,time:l.time,ticket:{legacy:!0,title:f.title,sender:f.sender,messages:c}};y(t,r,!0,e=>{e&&e.error?a(e):(u.forEach(e=>{s.viewed.push(e)}),t.Store.onSync(null,function(){a({done:!0})}))})}):a({error:"EINVAL"})}(g,u,0,s):function(e,n,t,r){let o=e.store.proxy;e.store.mailbox.close("supportadmin",function(){delete o.mailboxes.supportadmin,e.Store.onSync(null,function(){r({done:!0})})})}(g,0,0,s):function(n,t,r,o){let a=n.store.proxy,i=e.find(a,["mailboxes","supportadmin"]);if(!i)return void o({error:"ENOENT"});let s=e.clone(i);s.lastKnownHash=void 0,s.viewed=[],n.store.mailbox.open("supportadmin",s,function(e){n.store.mailbox.close("supportadmin",function(){}),o(e)},!0,{dump:!0})}(g,0,0,s):b(g,0,0,s):((e,n,r,o)=>{e.adminRdyEvt?e.adminRdyEvt.reg(()=>{let r=e.adminDoc.proxy.tickets,a=n.channel;(r.active[a]||r.pending[a]||r.closed[a]).tags=n.tags||[],t.whenRealtimeSyncs(e.adminDoc.realtime,function(){let e=[];["active","pending","closed"].forEach(n=>{let t=r[n];Object.keys(t).forEach(n=>{(t[n].tags||[]).forEach(n=>{e.includes(n)||e.push(n)})})}),o({done:!0,allTags:e})})}):o({error:"EFORBIDDEN"})})(g,u,0,s):((e,n,t,r)=>{if(!e.adminRdyEvt)return void r({error:"EFORBIDDEN"});let o=n.tags||[];e.adminRdyEvt.reg(()=>{let n=e.adminDoc.proxy.tickets;if(!o.length)return void r({all:!0});let t=[];["active","pending","closed"].forEach(e=>{let r=n[e];Object.keys(r).forEach(e=>{(r[e].tags||[]).some(e=>o.includes(e))||t.push(e)})}),r({tickets:t})})})(g,u,0,s):((n,t,r,o)=>{if(!n.adminRdyEvt)return void o({error:"EFORBIDDEN"});let a=t.tags||[],i=(t.text||"").toLowerCase();n.adminRdyEvt.reg(()=>{let t=n.adminDoc.proxy.tickets,r={},s=(n,t,o)=>{let a=e.clone(t);a.category=o,r[n]=a};["active","pending","closed"].some(n=>{let o=t[n];return Object.keys(o).some(t=>{let c=o[t];if(a.length&&!(c.tags||[]).some(e=>a.includes(e)))return;let u=e.hexToBase64(t).slice(0,10);if(i===u)return r={},s(t,c,n),!0;(!i||c.title.toLowerCase().includes(i))&&s(t,c,n)})}),o({tickets:r})})})(g,u,0,s):function(e,n,t,r){if(!e.adminRdyEvt)return void r({error:"EFORBIDDEN"});let o=n.id;e.adminRdyEvt.reg(()=>{let n=e.adminDoc.proxy,t=(n.recorded=n.recorded||{})[o];t&&(t.count=(t.count||0)+1),r()})}(g,u,0,s):function(e,n,r,o){if(!e.adminRdyEvt)return void o({error:"EFORBIDDEN"});let a=n.id,i=n.content,s=Boolean(n.remove);e.adminRdyEvt.reg(()=>{let n=e.adminDoc.proxy,r=n.recorded=n.recorded||{};s?delete r[a]:r[a]={content:i,count:0},t.whenRealtimeSyncs(e.adminDoc.realtime,function(){o({done:!0})})})}(g,u,0,s):function(n,t,r,o){n.adminRdyEvt?n.adminRdyEvt.reg(()=>{let t=n.adminDoc.proxy,r=t.recorded=t.recorded||{};o({messages:e.clone(r)})}):o({error:"EFORBIDDEN"})}(g,0,0,s):function(e,n,r,o){if(!e.adminRdyEvt)return void o({error:"EFORBIDDEN"});let a=n.channel,i=n.from,s=n.to;e.adminRdyEvt.reg(()=>{let n=e.adminDoc.proxy,r=n.tickets[i],c=n.tickets[s];if(!i||!s)return void o({error:"EINVAL"});let u=r[a];u&&!c[a]?(c[a]=u,delete r[a],t.whenRealtimeSyncs(e.adminDoc.realtime,function(){o({moved:!0})})):o({error:"CANT_MOVE"})})}(g,u,0,s):function(e,n,r,o){if(!e.adminRdyEvt)return void o({error:"EFORBIDDEN"});let a=n.supportKey;e.adminRdyEvt.reg(()=>{let r=e.adminDoc.proxy;r.oldKeys&&r.oldKeys[a]&&(n.adminCurvePrivate=r.oldKeys[a].curvePrivate),m(e,n,!0,r=>{if(r)o({error:r});else{var a=e.adminDoc.proxy,i=a.tickets.active[n.channel]||a.tickets.pending[n.channel];i.time=+new Date,i.lastAdmin=!0,a.tickets.closed[n.channel]=i,delete a.tickets.active[n.channel],delete a.tickets.pending[n.channel],t.whenRealtimeSyncs(e.adminDoc.realtime,function(){o({closed:!0})})}})})}(g,u,0,s):function(e,n,t,r){if(!e.adminRdyEvt)return void r({error:"EFORBIDDEN"});let o=n.supportKey;e.adminRdyEvt.reg(()=>{let t=e.adminDoc.proxy;t.oldKeys&&t.oldKeys[o]&&(n.adminCurvePrivate=t.oldKeys[o].curvePrivate),m(e,n,!0,(t,o)=>{if(t)r({error:t});else{var a=e.adminDoc.proxy,i=a.tickets.active[n.channel]||a.tickets.pending[n.channel];i.time=o,i.lastAdmin=!0,r({sent:!0})}})})}(g,u,0,s):function(n,t,r,o){let a=t.supportKey;n.adminRdyEvt.reg(()=>{let r=n.adminDoc.proxy;r.oldKeys&&r.oldKeys[a]&&(t.adminCurvePrivate=r.oldKeys[a].curvePrivate),v(n,t,!0,function(r,a){if(r)return void o({error:r});var i=n.adminDoc.proxy;if(!Array.isArray(a)||!a.length)return void o(a);a.sort((e,n)=>e.time-n.time);let s=a[a.length-1],c=a.some(n=>{let r=e.find(n,["sender","curvePublic"]);if(t.curvePublic===r)return e.find(n,["sender","quota","plan"])});var u=i.tickets.active[t.channel];u&&(s.legacy&&(s=Array.isArray(s.messages)&&s.messages[s.messages.length-1]),u.time=s.time,u.premium=c,s.sender&&(u.lastAdmin=!s.sender.blockLocation),s.close&&(i.tickets.closed[t.channel]=u,delete i.tickets.active[t.channel],h(n,!0,"UPDATE_TICKET",t.channel))),o(a)})})}(g,u,0,s):function(n,t,r,o){n.adminRdyEvt?(n.clients[r]||(n.clients[r]={admin:!0}),n.adminRdyEvt.reg(()=>{var r=n.adminDoc.proxy;return"pending"===t.type?o(e.clone(r.tickets.pending)):"closed"===t.type?o(e.clone(r.tickets.closed)):void o(e.clone(r.tickets.active))})):o({error:"EFORBIDDEN"})}(g,u,r,s):function(e,n,t,r){e.adminRdyEvt?e.adminRdyEvt.reg(()=>{y(e,n,!0,r)}):r({error:"EFORBIDDEN"})}(g,u,0,s):function(e,n,t,r){let o=e.supportData,a=n.channel;o[a]&&o[a].closed?(delete o[a],r({deleted:!0})):r({error:"ENOTCLOSED"})}(g,u,0,s):function(e,n,t,r){m(e,n,!1,e=>{r(e?{error:e}:{closed:!0})})}(g,u,0,s):function(e,n,t,r){m(e,n,!1,e=>{r(e?{error:e}:{sent:!0})})}(g,u,0,s):function(n,t,r,o){var i=[],s=a;n.clients[r]||(n.clients[r]={admin:!1}),Object.keys(n.supportData).forEach(function(t){s=s(r=>{var o=e.clone(n.supportData[t]);v(n,{channel:t,curvePublic:o.curvePublic},!1,r((e,r)=>{if(e){if("EDELETED"===e.type)return void delete n.supportData[t];o.error=e}else o.messages=r,r.length&&r[r.length-1].close&&(n.supportData[t].closed=!0,o.closed=!0);o.id=t,i.push(o)}))}).nThen}),s(()=>{i.sort((e,n)=>e.closed&&n.closed?e.time-n.time:e.closed?1:n.closed?-1:e.time-n.time),o({tickets:i})})}(g,0,r,s):function(e,n,t,r){y(e,n,!1,r)}(g,u,0,s)},c},f})(Z(),te(),je(),In(),xn(),qe(),M(),T(),x(),D()),pt}function Mt(){if(mt)return yt;mt=1;var e,n,t;return e=M(),t=function(n,t,r,o){var a=t.channel,i=t.secret;i.keys.cryptKey&&(i.keys.cryptKey=function(e){for(var n=Object.keys(e).length,t=new Uint8Array(n),r=0;r<n;r++)t[r]=e[r];return t}(i.keys.cryptKey));var s=i.channel,c=n.store.network,u=!0,f=n.clients[r];if(f)o();else{f=n.clients[r]={channel:a};var l=n.channels[a];if(l)return f.id||(f.id=l.wc.myID+"-"+r),l.clients.push(r),void o();var d=function(t){n.channels[a]=n.channels[a]||{};var c=n.channels[a];c.padChan=s,f.id||(f.id=t.myID+"-"+r),c.clients&&c.clients.forEach(function(e){n.clients[e]&&!n.clients[e].id&&(n.clients[e].id=t.myID+"-"+e)}),c.encryptor||(c.encryptor=e.createEncryptor(i.keys)),t.on("message",function(e){var t,r=c.encryptor.decrypt(e,i.keys&&i.keys.validateKey);try{t=JSON.parse(r),n.emit("MESSAGE",t,c.clients)}catch(e){console.error(e)}}),c.wc=t,c.sendMsg=function(e,n){n=n||function(){};var r=c.encryptor.encrypt(e);t.bcast(r).then(function(){n()},function(e){n({error:e})})},u&&(c.clients=[r],u=!1,o())};c.join(a).then(d,function(e){o({error:e})});var h=function(){n.channels[a]?c.join(a).then(d,function(e){console.error(e)}):console.log("cant reconnect",a)};n.channels[a]=n.channels[a]||{},n.channels[a].onReconnect=h,c.on("reconnect",h)}},(n={}).init=function(e,n,r){var o={};if(e.store&&e.store.modules&&e.store.modules.integration)return e.store.modules.integration;var a={store:e.store,emit:r,channels:{},clients:{}};return o.removeClient=function(e){!function(e,n){var t,r=function(e){return e!==n};for(var o in e.channels)(t=e.channels[o]).clients=t.clients.filter(r),0===t.clients.length&&(t.wc&&t.wc.leave(),t.onReconnect&&e.store.network.off("reconnect",t.onReconnect),delete e.channels[o]);delete e.clients[n]}(a,e)},o.leavePad=function(e){!function(e,n){Object.keys(e.channels).some(function(t){var r=e.channels[t];if(r.padChan===n)return r.wc&&r.wc.leave(),r.onReconnect&&e.store.network.off("reconnect",r.onReconnect),delete e.channels[t],!0})}(a,e)},o.execCommand=function(e,n,r){var o=n.cmd,i=n.data;"INIT"!==o?"SEND"!==o||function(e,n,t,r){var o=e.clients[t];if(o){var a=e.channels[o.channel];if(a){var i={id:t,msg:n.msg,uid:n.uid};a.sendMsg(JSON.stringify(i),r),e.emit("MESSAGE",i,a.clients.filter(function(e){return e!==t}))}else r({error:"NO_CHAN"})}else r({error:"NO_CLIENT"})}(a,i,e,r):t(a,i,e,r)},o},yt=n}function Ft(){if(Et)return gt;Et=1;var e,n;return n=function(e,n,t){var r=e.clients[n];if(r){var o=e.channels[r.channel];o?(t(),o.history.forEach(function(t){e.emit("MESSAGE",{msg:t,validateKey:o.validateKey},[n])}),e.emit("HISTORY_SYNCED",{},[n])):t({error:"ENOCHAN"})}else t({error:"ENOENT"})},(e={}).init=function(e,t){var r={},o={store:e,emit:t,channels:{},clients:{}};return r.removeClient=function(e){!function(e,n){var t,r=function(e){return e!==n};for(var o in e.channels)(t=e.channels[o]).clients=t.clients.filter(r),0===t.clients.length&&(t.wc&&t.wc.leave(),delete e.channels[o]);if(e.clients[n]){var a=e.clients[n].channel,i=e.channels[a];i&&e.emit("LEAVE",{id:n},[i.clients[0]]),delete e.clients[n]}}(o,e)},r.leavePad=function(e){!function(e,n){Object.keys(e.channels).some(function(t){var r=e.channels[t];if(r.padChan===n)return r.wc&&r.wc.leave(),delete e.channels[t],!0})}(o,e)},r.execCommand=function(e,t,r){var a=t.cmd,i=t.data;"SEND_MESSAGE"!==a?"UPDATE_HASH"!==a?"OPEN_CHANNEL"!==a?"GET_HISTORY"!==a?"REENCRYPT"!==a||function(e,n,t,r){var o=n.channel,a=e.store.network,i=function(e){var t=a.historyKeeper,o={metadata:n.metadata},i=["GET_HISTORY",e.id,o];a.sendto(t,JSON.stringify(i)),n.msgs.forEach(function(n){e.bcast(n)}),e.leave(),r()};e.store.anon_rpc.send("IS_NEW_CHANNEL",o,function(e,n){var t;e?r({error:e}):(n&&n.length&&"object"==typeof n[0]?t=n[0].isNew:r({error:"INVALID_RESPONSE"}),t?a.join(o).then(i,function(e){r({error:e})}):r({error:"EEXISTS"}))})}(o,i,0,r):n(o,e,r):function(e,t,r,o){var a=t.channel,i=t.padChan,s=e.store.network,c=!0,u=e.clients[r];if(u)o();else{u=e.clients[r]={channel:a};var f=e.channels[a];if(f)return u.id||(u.id=f.wc.myID+"-"+r),n(e,r,function(){e.emit("READY",f.clients,[r])}),f.clients.push(r),void o();var l=Math.floor(1e6*Math.random()),d=function(n){e.channels[a]=e.channels[a]||{history:[],validateKey:t.validateKey},(f=e.channels[a]).padChan=i,u.id||(u.id=n.myID+"-"+r),f.clients&&f.clients.forEach(function(t){e.clients[t]&&(e.clients[t].id=n.myID+"-"+t)}),n.on("join",function(){}),n.on("leave",function(){}),n.on("message",function(n){f.history.push(n),e.emit("MESSAGE",{msg:n,validateKey:f.validateKey},f.clients)}),f.wc=n,f.sendMsg=function(e,t){t=t||function(){};var r=e.slice(0,64);n.bcast(e).then(function(){f.history.push(e),f.lastKnownHash=r,t()},function(e){t({error:e})})},c&&(f.clients=[r],f.lastCpHash=t.lastCpHash,c=!1,o());var d=s.historyKeeper,h={txid:l,lastKnownHash:f.lastKnownHash||f.lastCpHash,metadata:{forcePlaceholder:!0,validateKey:t.validateKey,owners:t.owners,expire:t.expire}},p=["GET_HISTORY",n.id,h];d&&s.sendto(d,JSON.stringify(p)).then(function(){},function(e){console.error(e)})};s.on("message",function(n,t){if(e.channels[a]&&t===s.historyKeeper){var r;try{r=JSON.parse(n)}catch(e){}if(r&&!(r.txid&&r.txid!==l||r.channel&&r.channel!==a))if(r.validateKey&&r.channel)f.validateKey||(f.validateKey=r.validateKey);else if(r.state&&1===r.state&&r.channel)e.emit("READY",f.clients,f.clients);else if(r.error&&r.channel)e.emit("READY",f.clients,f.clients);else if(!(Array.isArray(r)&&r[0]&&r[0]!==l||(n=r[4],r[3]!==a))){var o=n.slice(0,64);o!==f.lastKnownHash&&o!==f.lastCpHash&&(f.lastKnownHash=o,e.emit("MESSAGE",{msg:n},f.clients),f.history.push(n))}}}),s.join(a).then(d,function(e){o({error:e})}),s.on("reconnect",function(){e.channels[a]&&s.join(a).then(d,function(e){console.error(e)})})}}(o,i,e,r):function(e,n,t,r){var o=e.clients[t];if(o){var a=e.channels[o.channel];if(a){var i=n,s=-1;a.history.some(function(e,n){if(e.slice(0,64)===i)return s=n+1,!0}),-1!==s&&(a.history=a.history.slice(s)),r()}else r({error:"INVALID_CHANNEL"})}else r({error:"NOT_IN_CHANNEL"})}(o,i,e,r):function(e,n,t,r){var o=e.clients[t];if(o){var a=e.channels[o.channel];if(a){var i=function(o){o&&o.error?r(o):(e.emit("MESSAGE",{msg:n.msg},a.clients.filter(function(e){return e!==t})),r())};n.isCp?a.sendMsg(n.isCp,i):a.sendMsg(n.msg,i)}else r({error:"INVALID_CHANNEL"})}else r({error:"NOT_IN_CHANNEL"})}(o,i,e,r)},r},gt=e}function Lt(){if(Ot)return bt;Ot=1;return bt=((e,n,t,r,o,a,i,s)=>{var c={};const u=e.mkEvent(!0);return c.init=function(c,f,l){var d={},h=c.store;if(h.loggedIn&&h.proxy.edPublic){var p={Store:c.Store,store:h,pinPads:c.pinPads,updateMetadata:c.updateMetadata,emit:l,onReadyHandlers:[],clients:[]};return p.profile=h.proxy.profile=h.proxy.profile||{},function(e,t){var r=e.profile;if(r.edit&&r.view)setTimeout(t);else{var o=n.createRandomHash("profile"),a=n.getSecrets("profile",o);e.pinPads([a.channel],function(e){e.error?t(e.error):(r.edit=n.getEditHashFromKeys(a),r.view=n.getViewHashFromKeys(a),setTimeout(t))})}}(p,f(function(r){r||function(r){var o=r.profile,c=n.getSecrets("profile",o.edit),f=i.createEncryptor(c.keys),l={data:{},network:r.store.network,channel:c.channel,crypto:f,owners:[r.store.proxy.edPublic],ChainPad:s,validateKey:c.keys.validateKey||void 0,userName:"profile",classic:!0},d=a.create(l);d.proxy.on("create",function(){}).on("ready",function(){if(d.proxy.name=r.store.proxy[t.displayNameKey]||"",r.listmap=d,d.proxy.curvePublic||(d.proxy.curvePublic=r.store.proxy.curvePublic),d.proxy.notifications||(d.proxy.notifications=e.find(r.store.proxy,["mailboxes","notifications","channel"])),d.proxy.edPublic||(d.proxy.edPublic=r.store.proxy.edPublic),!d.proxy.proof){let n=c.channel,t=e.decodeUTF8(n),o=e.decodeBase64(r.store.proxy.edPrivate),a=i.Nacl.sign(t,o),s=e.encodeBase64(a);d.proxy.proof=s}r.onReadyHandlers.length&&(r.onReadyHandlers.forEach(function(e){try{e(d.proxy)}catch(e){console.error(e)}}),r.onReadyHandlers=[]),u.fire()}).on("change",[],function(){r.emit("UPDATE",d.proxy,r.clients)})}(p)})),d.setName=function(e){!function(e,n){e.listmap.proxy.name=n,r.whenRealtimeSyncs(e.listmap.realtime,function(){e.listmap&&e.emit("UPDATE",e.listmap.proxy,e.clients)})}(p,e)},d.removeClient=function(e){!function(e,n){var t=e.clients.indexOf(n);-1!==t&&e.clients.splice(t,1)}(p,e)},d.update=function(){p.listmap&&p.emit("UPDATE",p.listmap.proxy,p.clients)},d.execCommand=function(e,n,t){console.log(n);var a=n.cmd,i=n.data;"SUBSCRIBE"!==a?"SET"!==a||function(e,n,t,a){u.reg(()=>{var i=n.key,s=n.value;i&&(e.listmap.proxy[i]=s,r.whenRealtimeSyncs(e.listmap.realtime,function(){e.emit("UPDATE",e.listmap.proxy,e.clients.filter(function(e){return e!==t})),"badge"===i&&e.Store.set(null,{key:["profile","badge"],value:s||void 0},()=>{o.updateMyData(e.store),e.updateMetadata()}),a(e.listmap.proxy)}))})}(p,i,e,t):function(e,n,t,r){-1===e.clients.indexOf(t)&&e.clients.push(t),e.listmap?r(e.listmap.proxy):e.onReadyHandlers.push(function(e){r(e)})}(p,0,e,t)},d}},c})(Z(),te(),Y(),je(),On(),T(),M(),x()),bt}function Ht(){if(wt)return At;wt=1;return At=function(e,n,t,r,o,a){var i={},s=function(e){return Boolean(e&&"object"==typeof e&&!Array.isArray(e))},c=function(e){return e.slice(0,64)},u=function(n,t){var r=e.find(t,[n,"role"]);return-1!==["OWNER","ADMIN"].indexOf(r)},f=function(n,t,r){var o=e.find(r,[n,"role"]);return!!o&&(!!function(e){return-1!==["OWNER","ADMIN","MEMBER","VIEWER"].indexOf(e)}(t)&&("OWNER"===o||"ADMIN"===o&&-1!==["ADMIN","MEMBER","VIEWER"].indexOf(t)))},l=function(e){return"string"==typeof e&&44===e.length},d=i.commands={};d.ADD=function(e,n,t){if(!s(e))throw new Error("INVALID ARGS");if(!t.internal.initialized)throw new Error("UNITIALIZED");if(void 0===t.state.members)throw new Error("CANNOT_ADD_TO_UNITIALIZED_ROSTER");var r=t.state.members;Object.keys(e).forEach(function(t){if(!l(t))throw console.log(t,t.length),new Error("INVALID_CURVE_KEY");if(!s(e[t]))throw new Error("INVALID_CONTENT");if(r[t])throw new Error("ALREADY_PRESENT");var o=e[t];if("string"!=typeof o.role&&(o.role="MEMBER"),!f(n,o.role,r))throw new Error("INSUFFICIENT_PERMISSIONS");if("string"!=typeof o.displayName)throw new Error("DISPLAYNAME_REQUIRED");if("string"!=typeof o.notifications)throw new Error("NOTIFICATIONS_REQUIRED")});var o=!1;return Object.keys(e).forEach(function(n){o=!0,r[n]=e[n]}),o},d.RM=function(n,t,r){if(!Array.isArray(n))throw new Error("INVALID_ARGS");if(void 0===r.state.members)throw new Error("CANNOT_RM_FROM_UNITIALIZED_ROSTER");var o=r.state.members;n.forEach(function(n){if(!l(n))throw new Error("INVALID_CURVE_KEY");if(n!==t){var r=o[n].role;if(!function(n,t,r){var o=e.find(r,[n,"role"]);return!!o&&("OWNER"===o||"ADMIN"===o&&-1!==["ADMIN","MEMBER","VIEWER"].indexOf(t))}(t,r,o))throw new Error("INSUFFICIENT_PERMISSIONS")}});var a=!1;return n.forEach(function(e){o[e]&&(a=!0,delete o[e])}),a},d.DESCRIBE=function(n,t,o){if(!n||"object"!=typeof n||Array.isArray(n))throw new Error("INVALID_ARGUMENTS");if(void 0===o.state.members)throw new Error("NOT_READY");var a=o.state.members;Object.keys(n).forEach(function(r){if(!l(r))throw new Error("INVALID_ID");if(!a[r])throw new Error("NOT_PRESENT");if(!function(n,t,r){if(!r[t])return!1;if(n===t&&r[t])return!0;var o=e.find(r,[n,"role"]),a=e.find(r,[t,"role"]);return!!o&&("OWNER"===o||"ADMIN"===o&&"OWNER"!==a)}(t,r,a))throw new Error("INSUFFICIENT_PERMISSIONS");var o=n[r];if(!s(o))throw new Error("INVALID_ARGUMENTS");var i=e.clone(a[r]);if("string"==typeof o.role&&!function(n,t,r,o){return!(n!==t||!o[t])&&("MEMBER"===e.find(o,[n,"role"])?"VIEWER"===r:void 0)}(t,r,o.role,a)&&!f(t,o.role,a))throw new Error("INSUFFICIENT_PERMISSIONS");if("string"!=typeof i.displayName&&"string"!=typeof o.displayName)throw new Error("DISPLAYNAME_REQUIRED");if(-1===["undefined","string"].indexOf(typeof o.displayName))throw new Error("INVALID_DISPLAYNAME");if("string"!=typeof i.notifications&&"string"!=typeof o.notifications)throw new Error("NOTIFICATIONS_REQUIRED");if(-1===["undefined","string"].indexOf(typeof o.notifications))throw new Error("INVALID_NOTIFICATIONS")});var i=!1;return Object.keys(n).forEach(function(t){var o=e.clone(a[t]),s=n[t];Object.keys(s).forEach(function(e){void 0===o[e]||null!==s[e]?o[e]=s[e]:delete o[e]}),r(o)!==r(a[t])&&(i=!0,a[t]=o)}),i},d.CHECKPOINT=function(e,n,t){if(!s(e))throw new Error("INVALID_CHECKPOINT_STATE");if(!t.internal.initialized){t.state=e;var o=t.state.metadata=t.state.metadata||{};return o.topic=o.topic||"",o.name=o.name||"",o.avatar=o.avatar||"",t.internal.initialized=!0,!0}if(r(e)!==r(t.state))throw new Error("CHECKPOINT_DOES_NOT_MATCH_PREVIOUS_STATE");if(!u(n,t.state.members))throw new Error("INSUFFICIENT_PERMISSIONS");return t.state=e,!0};var h=["avatar","name","topic"];d.METADATA=function(n,t,r){if(!s(n))throw new Error("INVALID_ARGS");if(!function(n,t){var r=e.find(t,[n,"role"]);return Boolean(r&&-1!==["OWNER","ADMIN"].indexOf(r))}(t,r.state.members))throw new Error("INSUFFICIENT_PERMISSIONS");Object.keys(n).forEach(function(e){if(null===n[e]){if(-1===h.indexOf(e))return;throw new Error("CANNOT_REMOVE_MANDATORY_METADATA")}if("string"!=typeof n[e])throw new Error("INVALID_ARGUMENTS")});var o=!1;return Object.keys(n).forEach(function(e){void 0!==r.state.metadata[e]&&null===n[e]&&(o=!0,delete r.state.metadata[e]),n[e]!==r.state.metadata[e]&&(o=!0,r.state.metadata[e]=n[e])}),o},d.INVITE=function(e,n,t){if(!s(e))throw new Error("INVALID_ARGS");if(!t.internal.initialized)throw new Error("UNINITIALIED");if(void 0===t.state.members)throw new Error("CANNOT+INVITE_TO_UNINITIALIED_ROSTER");var r=t.state.members;Object.keys(e).forEach(function(t){if(!l(t))throw console.log(t,t.length),new Error("INVALID_CURVE_KEY");if(!s(e[t]))throw new Error("INVALID_CONTENT");if(r[t])throw new Error("ARLEADY_PRESENT");var o=e[t];if("string"!=typeof o.role&&(o.role="VIEWER"),void 0===o.pending&&(o.pending=!0),!f(n,o.role,r))throw new Error("INSUFFICIENT_PERMISSIONS");if("string"!=typeof o.displayName||!o.displayName)throw new Error("DISPLAYNAME_REQUIRED")});var o=!1;return Object.keys(e).forEach(function(n){o=!0,r[n]=e[n]}),o},d.ACCEPT=function(n,t,r){if(!r.internal.initialized)throw new Error("UNINITIALIED");if(void 0===r.state.members)throw new Error("CANNOT_ADD_TO_UNINITIALIED_ROSTER");var o=r.state.members;if(!s(o[t]))throw new Error("INSUFFICIENT_PERMISSIONS");if(!o[t].pending)throw new Error("ALREADY_PRESENT");if("string"!=typeof n)throw new Error("INVALID_ARGS");if(!l(n))throw new Error("INVALID_CURVE_KEY");var a=n;if(void 0!==o[a])throw new Error("MEMBER_ALREADY_PRESENT");var i=e.clone(o[t]);delete i.remaining,delete i.totalUses,delete i.inviteChannel,delete i.previewChannel,o[a]=i;var c=o[t].remaining||1;return-1===c||(c>1?o[t].remaining=c-1:delete o[t]),!0};var p=function(e,n,t){if(!Array.isArray(e)||"string"!=typeof n)throw new Error("INVALID ARGUMENTS");var r=e[0];if("function"!=typeof d[r])throw new Error("INVALID_COMMAND");return d[r](e[1],n,t)},v=function(n,t,r){return p(n,t,e.clone(r))};return i.create=function(n,i){if("function"!=typeof i)throw new Error("EXPECTED_CALLBACK");var f=e.once(e.mkAsync(i));if(n.network)if(n.channel&&"string"==typeof n.channel&&32===n.channel.length)if(n.keys&&"object"==typeof n.keys)if(n.store){var d=e.response(function(e,n){console.error("ROSTER_RESPONSE__"+e,n)}),h=n.store,y=n.keys,m=y.myCurvePublic,g=n.channel,E=n.lastKnownHash||-1;n.newTeam&&(E=void 0);var b={state:{members:{},metadata:{}},internal:{initialized:!1,sinceLastCheckpoint:0,lastCheckpointHash:E}},O={},A={change:e.mkEvent(),checkpoint:e.mkEvent()};O.on=function(e,n){if("object"!=typeof A[e])throw new Error("unsupported event");return A[e].reg(n),O},O.off=function(e,n){if("object"!=typeof A[e])throw new Error("unsupported event");return A[e].unreg(n),O},O.once=function(e,n){if("object"!=typeof A[e])throw new Error("unsupported event");var t=function(){n.apply(null,Array.prototype.slice.call(arguments)),A[e].unreg(t)};return A[e].reg(t),O},O.getState=function(){return e.clone(b.state)},O.getLastCheckpointHash=function(){return b.internal.lastCheckpointHash||-1};var w=function(){b.internal.pendingCheckpointId&&(d.clear(b.internal.pendingCheckpointId),delete b.internal.pendingCheckpointId),clearTimeout(b.internal.checkpointTimeout),delete b.internal.checkpointTimeout};O.stop=function(){b.internal.cpNetflux&&"function"==typeof b.internal.cpNetflux.stop?(b.internal.cpNetflux.stop(),w()):console.log("FAILED TO LEAVE")};var D,_,T,S=!1,N=function(){if(n.onCacheReady){var e=b.state;if(Object.keys(e.members||{}).length)n.onCacheReady(O);else{try{b.internal.cpNetflux.resetCache()}catch(e){console.error(e)}n.onCacheReady({error:"CORRUPTED"})}}},I=function(){S=!0,f(void 0,O)},x=function(e){e&&"EUNKNOWN"===e.type||(S?console.error("CHANNEL_ERROR",e):f(e))},C=function(e){e.state||(S=!1)},R=function(){console.log("ROSTER CONNECTED")},P=function(){return Boolean(S&&m)},k=function(n,t,r,o,a,i){D!==a&&b.internal.sinceLastCheckpoint++,D=a;var s=e.tryParse(n);if(s){var f,l;try{f=p(s,i,b)}catch(e){l=e.message}var h=c(a);if(d.expected(h)){if(l)return void d.handle(h,[l]);try{f?d.handle(h,[void 0,O.getState()]):(d.handle(h,["NO_CHANGE"]),console.log(n))}catch(e){console.log("CAUGHT",e)}}if("CHECKPOINT"===s[0]&&f?(P()&&A.checkpoint.fire(a),b.internal.sinceLastCheckpoint=0,b.internal.lastCheckpointHash=a):f&&P()&&A.change.fire(),w(),P()&&function(e,n){if(!u(e,n.state.members))return!1;var t=n.internal.sinceLastCheckpoint;return!(!t||"number"!=typeof t||t<25)}(m,b)){var v=1e3*Math.floor(20*Math.random())+5e3;b.internal.checkpointTimeout=setTimeout(function(){b.internal.pendingCheckpointId=O.checkpoint(function(e){e&&console.error(e)})},v)}}else console.error("could not parse")},M=function(n,t){var r=e.tryParse(n);return"CHECKPOINT"===r[0]&&v(r,t,b)},F=function(e,n){if(P()){var t=h.anon_rpc;if(t){var o=!1;try{o=v(e,y.myCurvePublic,b)}catch(e){return void n(e.message)}if(o){var a=T.encrypt(r(e)),i=c(a);return d.expect(i,function(e,t){e?n(e):n(void 0,t,i)},3e4),t.send("WRITE_PRIVATE_MESSAGE",[g,a],function(e){if(e)return d.handle(i,[e.message||e])}),i}n("NO_CHANGE")}else n("ANON_RPC_NOT_READY")}else n("NOT_READY")};O.init=function(n,t){var r=e.once(e.mkAsync(t));if(b.internal.initialized)r("ALREADY_INITIALIZED");else if(s(n)){var o=e.clone(n);o.role="OWNER";var a={};a[m]=o,F(["CHECKPOINT",{members:a}],r)}else r("INVALID_ARGUMENTS")},O.checkpoint=function(n){var t=e.once(e.mkAsync(n));F(["CHECKPOINT",e.clone(b.state)],t)},O.add=function(n,t){var r=e.once(e.mkAsync(t));if(!b.internal.initialized)return r("UNINITIALIZED");if(s(n)){var o=e.clone(n);Object.keys(o).forEach(function(e){if(!l(e)||s(b.state.members[e]))return delete o[e]}),F(["ADD",o],r)}else r("INVALID_ARGUMENTS")},O.remove=function(n,t){var r=e.once(e.mkAsync(t)),o=b.state;if(!o)return r("UNINITIALIZED");if(Array.isArray(n)){var a=e.clone(n),i=[],s=Object.keys(o.members);a.forEach(function(e){-1!==s.indexOf(e)&&i.push(e)}),F(["RM",i],r)}else r("INVALID_ARGUMENTS")},O.describe=function(n,t){var r=e.once(e.mkAsync(t)),o=b.state;if(!o)return r("UNINITIALIZED");if(s(n)){var a=e.clone(n);Object.keys(a).some(function(e){var n=a[e];if(s(n)||delete a[e],!s(o.members[e]))return!0;Object.keys(n).forEach(function(t){n[t]===o.members[e][t]&&delete n[t]})})?r("INVALID_ARGUMENTS"):F(["DESCRIBE",a],r)}else r("INVALID_ARGUMENTS")},O.metadata=function(n,t){var r=e.once(e.mkAsync(t)),o=b.state.metadata;if(s(n)){var a=e.clone(n);Object.keys(a).forEach(function(e){a[e]===o[e]&&delete a[e]}),F(["METADATA",a],r)}else r("INVALID_ARGUMENTS")},O.invite=function(n,t){var r=e.once(e.mkAsync(t));if(!b.state)return r("UNINITIALIZED");if(!b.internal.initialized)return r("UNINITIALIZED");if(s(n)){var o=e.clone(n);Object.keys(o).forEach(function(e){if(!l(e)||s(b.state.members[e]))return delete o[e]}),F(["INVITE",o],r)}else r("INVALID_ARGUMENTS")},O.accept=function(n,t){var r=e.once(e.mkAsync(t));"string"==typeof n&&l(n)?F(["ACCEPT",n],r):r("INVALID_ARGUMENTS")},o(function(e){h.anon_rpc&&h.anon_rpc.send("GET_METADATA",g,function(n,t){if(n)return e.abort(),void console.error(n);_=b.internal.metadata=t&&t[0]||void 0})}).nThen(function(e){if(!n.keys.teamEdPublic&&_&&_.validateKey&&(n.keys.teamEdPublic=_.validateKey),!n.keys.teamEdPublic)return e.abort(),void f("NO_VALIDATE_KEY");try{T=a.Team.createEncryptor(n.keys)}catch(n){return e.abort(),void f(n)}}).nThen(function(){"string"==typeof E&&console.log("Synchronizing from checkpoint"),b.internal.cpNetflux=t.start({lastKnownHash:E,network:n.network,channel:n.channel,crypto:T,validateKey:n.keys.teamEdPublic,owners:n.owners,Cache:n.Cache,isCacheCheckpoint:M,onCacheReady:N,onChannelError:x,onReady:I,onConnect:R,onConnectionChange:C,onMessage:k,noChainPad:!0})})}else f("EXPECTED_STORE");else f("EXPECTED_CRYPTO_KEYS");else f("EXPECTED_CHANNEL");else f("EXPECTED_NETWORK")},i}(Z(),te(),D(),bn(),qe(),M()),At}function jt(){if(St)return Tt;St=1;return Tt=((e,n,t,r,o,a,i,s,c,u,f,l,d,h,p,v,y,m,g,E)=>{const b={};E=E||"undefined"!=typeof window&&window.nacl;var O=e.mkEvent(!0),A=function(){},w=function(e,t,r,o){t&&(o||(r.on("change",["drive",a.SHARED_FOLDERS],function(o,s,c){if(c.length>3&&"password"===c[3]){var u=c[2],f=r.drive[a.SHARED_FOLDERS][u],l=t.manager.user.userObject.getHref?t.manager.user.userObject.getHref(f):f.href,d=n.parsePadUrl(l),h=n.getSecrets(d.type,d.hash,o);return setTimeout(function(){i.updatePassword(e.Store,{oldChannel:h.channel,password:s,href:l},e.store.network,function(){console.log("Shared folder password changed")})}),!1}}),r.on("disconnect",function(){t.offline=!0,t.sendEvent("NETWORK_DISCONNECT",t.id)}),r.on("reconnect",function(){t.offline=!1,t.sendEvent("NETWORK_RECONNECT",t.id)})),r.on("change",[],function(n,r,i){if(o){if(i[0]===a.FILES_DATA&&"object"==typeof r&&r.channel&&!r.owners){var s=[r.channel];r.rtChannel&&s.push(r.rtChannel),r.lastVersion&&s.push(r.lastVersion),t.pin(s,function(e){e&&e.error&&console.error(e.error)})}if(i[0]===a.FILES_DATA&&"object"==typeof n&&n.channel&&!r){var c=[n.channel];t.manager.findChannel(n.channel).some(function(e){return e.fId!==o})||(n.rtChannel&&c.push(n.rtChannel),n.lastVersion&&c.push(n.lastVersion),t.unpin(c,function(e){e&&e.error&&console.error(e)}))}}n&&!r&&Array.isArray(i)&&(i[0]===a.FILES_DATA||"drive"===i[0]&&i[1]===a.FILES_DATA)&&setTimeout(function(){e.Store.checkDeletedPad(n&&n.channel)}),t.sendEvent("DRIVE_CHANGE",{id:o,old:n,new:r,path:i})}),r.on("remove",[],function(e,n){t.sendEvent("DRIVE_REMOVE",{id:o,old:e,path:n})}))},D=function(e,n){var t=e.teams[n];if(t){try{t.listmap.stop()}catch(e){}try{t.roster.stop()}catch(e){}t.proxy={},t.stopped=!0,delete e.teams[n],delete e.cache[n],delete e.store.proxy.teams[n],e.emit("LEAVE_TEAM",n,t.clients),e.updateMetadata(),e.store.calendar&&e.store.calendar.closeTeam(n),e.store.mailbox&&e.store.mailbox.close("team-"+n,function(){})}},_=function(e,n,t,r){n.rpc?r():t.edPrivate&&t.edPublic?h.create(e.store.network,t,function(e,t){e?r(e):(n.rpc=t,n&&n.onRpcReadyEvt&&n.onRpcReadyEvt.fire(),r())},d):r("EFORBIDDEN")},T=function(t,r,a,s,c,u,f){var l=e.once(e.mkAsync(f));if(t.cache[r])l();else{var d=a.proxy,h={id:r,proxy:d,listmap:a,clients:[],realtime:a.realtime,handleSharedFolder:function(e,n){!function(e,n,t,r){var o=e.teams[n];o&&(r?(o.sharedFolders[t]=r,w(e,o,r.proxy,t)):delete o.sharedFolders[t])}(t,r,e,n)},sharedFolders:{},roster:s,onRpcReadyEvt:e.mkEvent(!0),offline:!0};t.cache[r]=h,u&&h.clients.push(u),s.on("change",function(){var n=s.getState(),o=e.find(t,["store","proxy","curvePublic"]);if(n.members&&Object.keys(n.members).length)if(n.members[o]){var a=e.find(t,["store","proxy","teams",r]);a&&(a.metadata=n.metadata),t.updateMetadata(),t.emit("ROSTER_CHANGE",r,h.clients)}else D(t,r);else console.error(JSON.stringify(n))}),s.on("checkpoint",function(n){e.find(t,["store","proxy","teams",r,"keys","roster"]).lastKnownHash=n}),h.sendEvent=function(e,n,r){t.emit(e,n,h.clients.filter(function(e){return e!==r}))},h.getChatData=function(){var e=c.chat||{},t=e.edit||e.view;if(!t)return{};var o=n.getSecrets("chat",t);return{teamId:r,channel:o.channel,secret:o,validateKey:e.validateKey}},h.pin=function(e,n){c.drive.edPrivate?h.rpc?("function"!=typeof n&&console.error("expected a callback"),h.rpc.pin(e,function(e,t){n(e?{error:e}:{hash:t})})):n({error:"TEAM_RPC_NOT_READY"}):n({error:"EFORBIDDEN"})},h.unpin=function(e,n){c.drive.edPrivate?h.rpc?("function"!=typeof n&&console.error("expected a callback"),h.rpc.unpin(e,function(e,t){n(e?{error:e}:{hash:t})})):n({error:"TEAM_RPC_NOT_READY"}):n({error:"EFORBIDDEN"})};var p=t.store.proxy.teams[h.id],v=p.hash||p.roHash,y=n.getSecrets("team",v,p.password),m=h.manager=o.create(d.drive,{onSync:function(e){t.Store.onSync(r,e)},edPublic:c.drive.edPublic,pin:h.pin,unpin:h.unpin,loadSharedFolder:function(e,n,r,o){i.load({isNew:o,network:t.store.network||t.store.networkPromise,store:h,isNewChannel:t.Store.isNewChannel,Store:t.Store},e,n,r)},settings:{drive:e.find(t.store,["proxy","settings","drive"])},removeOwnedChannel:function(e,n){var o;"object"==typeof e?(e.teamId=r,o=e):o={channel:e,teamId:r},t.Store.pad.destroy("",o,n)},Store:t.Store,store:t.store},{teamId:h.id,outer:!0,edPublic:c.drive.edPublic,loggedIn:!0,log:function(e){h.sendEvent("DRIVE_LOG",e)},rt:h.realtime,editKey:y.keys.secondaryKey,readOnly:Boolean(!y.keys.secondaryKey)});h.secondaryKey=y&&y.keys.secondaryKey,h.userObject=m.user.userObject,g(function(e){t.teams[r]=h,w(t,h,d);var n=t.store.network||t.store.networkPromise;i.loadSharedFolders(t.Store,n,h,h.proxy.drive,h.userObject,e,function(e){t.progress+=70/(t.numberOfTeams*e.max),t.updateProgress({progress:t.progress})},!0)}).nThen(function(){t.store.modules.calendar&&t.store.modules.calendar.openTeam(r),l()})}},S=function(t,r,o,a,s,c,u){var f,l=a.getState(),d=e.find(t,["store","proxy","teams",r]);d&&(d.metadata=l.metadata),delete t.nocache[r],t.store.proxy.teams[r]&&g(function(e){T(t,r,o,a,s,c,e()),f=t.teams[r]||t.cache[r],s.drive.edPrivate&&_(t,f,s.drive,e(function(){}))}).nThen(function(e){f.userObject.fixFiles(),i.checkMigration(f.secondaryKey,f.proxy?.drive,f.userObject,e()),i.loadSharedFolders(t.Store,t.store.network,f,f.proxy?.drive,f.userObject,e,function(e){t.progress+=70/(t.numberOfTeams*e.max),t.updateProgress({progress:t.progress})})}).nThen(function(){if(f.rpc){var o=function(n,t){var r=n.teams[t];if(!r)return null;var o=r.manager.getChannelsList("pin"),a=n.store.proxy.teams[t];o.push(`${a.channel}#drive`);var i=e.find(a,["keys","chat","channel"]),s=e.find(a,["keys","roster","channel"]),c=e.find(a,["keys","mailbox","channel"]);if(i&&o.push(i),s&&o.push(s),c&&o.push(c),r.proxy.calendars){var u=Object.keys(r.proxy.calendars).map(function(e){return r.proxy.calendars[e].channel});o=o.concat(u)}var f=r.roster.getState();return f.members&&Object.keys(f.members).forEach(function(e){var n=f.members[e];n.inviteChannel&&n.pending&&o.push(n.inviteChannel),n.previewChannel&&n.pending&&o.push(n.previewChannel)}),o.sort(),o}(t,r),a=n.hashChannelList(o);f.rpc.getServerHash(function(e,n){e?console.warn(e):n!==a&&f.rpc.reset(o,function(e){e&&console.warn(e)})})}}).nThen(function(){f.offline=!1,t.onReadyHandlers[r]&&t.onReadyHandlers[r].forEach(function(e){("function"==typeof e.cb&&e.cb(),e.cId)&&(-1===f.clients.indexOf(e.cId)&&f.clients.push(e.cId))}),delete t.onReadyHandlers[r],t.store.modules.calendar&&t.store.modules.calendar.openTeam(r),u()})},N=function(e,n,t,r,o,a){var i=function(){(e.cache[n]||e.teams[n])&&D(e,n),delete e.store.proxy.teams[n],delete e.onReadyHandlers[n],o.abort(),a({error:"ENOENT"})};t&&e.store.anon_rpc.send("IS_NEW_CHANNEL",t,o(function(e,n){n&&n.length&&"object"==typeof n[0]&&n[0].isNew&&i()})),r&&e.store.anon_rpc.send("IS_NEW_CHANNEL",r,o(function(e,n){n&&n.length&&"object"==typeof n[0]&&n[0].isNew&&i()}))},I=function(t,r,o,a,i){var f=e.once(e.mkAsync(a)),l=r.hash||r.roHash,h=n.getSecrets("team",l,r.password),y=v.createEncryptor(h.keys);r.roHash||(r.roHash=n.getViewHashFromKeys(h));var E,b,A=r.keys;if(!A.chat.validateKey&&A.chat.edit){var w=n.getSecrets("chat",A.chat.edit);A.chat.validateKey=w.keys.validateKey}var _={curvePublic:t.store.proxy.curvePublic,curvePrivate:t.store.proxy.curvePrivate},I=A.roster||{},x=I.edit?v.Team.deriveMemberKeys(I.edit,_):v.Team.deriveGuestKeys(I.view||"");g(function(e){if(i)return d.getChannelCache(h.channel,e(function(n,t){t&&t.c||(e.abort(),f({error:"NOCACHE"}))})),void d.getChannelCache(x.channel,e(function(n,t){var r=t&&t.c,o=t&&t.k;o&&!x.teamEdPublic&&(x.teamEdPublic=o),r||(e.abort(),f({error:"NOCACHE"}))}));t.Store.onReadyEvt.reg(()=>{N(t,o,h.channel,x.channel,e,f)})}).nThen(function(n){var a={lm:!1,roster:!1,check:function(){this.lm&&this.roster&&i&&(t.progress+=30/t.numberOfTeams,t.updateProgress({progress:t.progress}),T(t,o,b,E,A,null,n(f)),this.check=function(){})}},u={data:{},readOnly:!Boolean(h.keys.signKey),network:t.store.network||t.store.networkPromise,channel:h.channel,crypto:y,ChainPad:m,Cache:d,metadata:{validateKey:h.keys.validateKey||void 0},userName:"team",classic:!0,onMetadataUpdate:function(){var e=t.teams[o];e&&t.emit("ROSTER_CHANGE",o,e.clients)}};(b=p.create(u)).proxy.on("cacheready",function(){a.lm=!0,a.check()}),b.proxy.on("ready",n()),b.proxy.on("error",function(e){e&&void 0!==e.loaded&&!e.loaded&&f({error:"ECONNECT"}),e&&e.error&&"EDELETED"===e.error&&D(t,o)}),s.create({network:t.store.network||t.store.networkPromise,channel:x.channel,keys:x,store:t.store,lastKnownHash:I.lastKnownHash,onCacheReady:function(e){if(i){if(e&&"CORRUPTED"===e.error)return console.error("Corrupted roster cache, cant load this team offline",r),b&&"function"==typeof b.stop&&b.stop(),n.abort(),void f({error:"CACHE_CORRUPTED_ROSTER"});E=e,a.roster=!0,a.check()}},Cache:d},n(function(r,o){if(r)return n.abort(),console.error(r),void f({error:"ROSTER_ERROR"});E=o,I.lastKnownHash=E.getLastCheckpointHash();var a=E.getState(),i=e.find(t,["store","proxy","curvePublic"]);a.members[i]&&O.reg(function(){if(I.edit){var e={},n=c.createData(t.store.proxy,!1);n.pending=!1,e[t.store.proxy.curvePublic]=n,E.describe(e,function(e){e&&"NO_CHANGE"!==e&&console.error(e)})}})}))}).nThen(function(n){var a=E.getState(),i=e.find(t,["store","proxy","curvePublic"]);if(!a.members||!Object.keys(a.members).length)return b.stop(),E.stop(),b.proxy={},f({error:"EINVAL"}),n.abort(),console.error(JSON.stringify(a)),void u.send("ROSTER_CORRUPTED");if(!a.members[i])return b.stop(),E.stop(),b.proxy={},delete t.store.proxy.teams[o],t.updateMetadata(),f({error:"EFORBIDDEN"}),void n.abort();var s=a.members[i],c=e.find(r,["keys","drive","edPrivate"]);if(r.hash&&c||-1===["ADMIN","MEMBER"].indexOf(s.role))r.hash&&c||"OWNER"!==s.role||u.send("TEAM_RIGHTS_OWNER");else{console.warn("Missing edit rights: demote to viewer");var l={};l[t.store.proxy.curvePublic]={role:"VIEWER"},E.describe(l,function(e){u.send("TEAM_RIGHTS_FIXED"),delete r.hash,delete r.keys.drive.edPrivate,delete r.keys.chat.edit,e&&"NO_CHANGE"!==e&&console.error(e)})}}).nThen(function(){i||(t.progress+=30/t.numberOfTeams,t.updateProgress({progress:t.progress})),S(t,o,b,E,A,null,f)})},x=function(n,t,r,o){var a=t.team;if(!((a.hash||a.roHash)&&a.channel&&a.password&&a.keys&&a.metadata))return void o({error:"EINVAL"});let i=n.store.proxy.teams;if(Object.values(i).some(e=>e.channel===a.channel))o({error:"EEXISTS"});else{var s=e.createRandomInteger();n.store.proxy.teams[s]=a,n.onReadyHandlers[s]=[],I(n,a,s,function(e){e&&e.error||console.debug("Team joined:"+s);var t=n.store.proxy.teams[s];n.store.mailbox.open("team-"+s,t.keys.mailbox,function(){},!0,{owners:t.keys.drive.edPublic}),n.updateMetadata(),o(e)})}},C=function(n,t,r){var o=e.find(n,["store","proxy","teams",t]);if(!o)return{};var a=e.clone(o);return r||(delete a.hash,delete a.keys.drive.edPrivate,delete a.keys.chat.edit),delete a.owner,a},R=function(t,r,o){if(!r)return!0;var a=e.find(t,["store","proxy","teams",r]);if(!a)return!0;var s=t.teams[r];if(!s)return!0;var c=n.getSecrets("team",o||a.roHash,a.password);if(i.upgrade(a.channel,c),s.userObject&&s.userObject.setReadOnly(!c.keys.secondaryKey,c.keys.secondaryKey),c.keys.secondaryKey)try{t.store.modules.calendar.upgradeTeam(r)}catch(e){console.error(e)}!c.keys.secondaryKey&&s.rpc&&s.rpc.destroy();var u=e.find(s,["proxy","drive","sharedFolders"]);Object.keys(u||{}).forEach(function(t){var r=s.manager.getSharedFolderData(t),o=n.parsePadUrl(r.href||r.roHref),a=n.getSecrets(o.type,o.hash,r.password);i.upgrade(a.channel,a);var c=e.find(s,["manager","folders",t,"userObject"]);c&&c.setReadOnly(!a.keys.secondaryKey,a.keys.secondaryKey)}),t.updateMetadata(),t.emit("ROSTER_CHANGE_RIGHTS",r,s.clients)},P=function(t,r,o,a,i){if(r){var s=e.find(t,["store","proxy","teams",r]);if(s){var c=t.onReadyHandlers[r],u=t.teams[r];if(s.channel===a.channel&&s.password===a.password)if(o?(s.hash=a.hash,s.keys.drive.edPrivate=a.keys.drive.edPrivate,s.keys.chat.edit=a.keys.chat.edit):(delete s.hash,delete s.keys.drive.edPrivate,delete s.keys.chat.edit),u||!Array.isArray(c))if(u){if(o){_(t,u,s.keys.drive,function(){u.manager.addPin(u.pin,u.unpin)});var f=n.getSecrets("team",a.hash,s.password);u.secondaryKey=f&&f.keys.secondaryKey;var l=v.createEncryptor(f.keys);u.listmap.setReadOnly(!1,l)}else delete u.secondaryKey,u.rpc&&u.rpc.destroy&&u.rpc.destroy(),u.manager.removePin(),u.listmap.setReadOnly(!0);R(t,r,a.hash),i(!0)}else i(!1);else c.push({cb:function(){P(t,r,o,a,i)}});else i(!1)}else i(!1)}else i(!1)},k=function(n,t,r,o,a){t?e.find(n,["store","proxy","teams",t])&&n.teams[t]?n.store.mailbox.sendTo("TEAM_EDIT_RIGHTS",{state:o,teamData:C(n,t,o)},{channel:r.notifications,curvePublic:r.curvePublic},a):a({error:"ENOENT"}):a({error:"EINVAL"})},M=function(n,t,r,o){var a=t.teamId;if(a){var i=e.find(n,["store","proxy","teams",a]),s=n.teams[a];if(i&&s)if(s.roster)if(t.curvePublic&&t.data){var c,u=s.roster.getState().members[t.curvePublic];g(function(e){n.Store.pad.getMetadata(null,{channel:i.channel},e(function(e){c=e&&e.error?s.listmap.metadata||{}:e}))}).nThen(function(){if(u.pendingOwner=Array.isArray(c.pending_owners)&&-1!==c.pending_owners.indexOf(u.edPublic),"OWNER"!==u.role||"OWNER"===t.data.role){"VIEWER"===u.role&&"VIEWER"!==t.data.role&&k(n,a,u,!0,function(e){o(e)}),"VIEWER"!==u.role&&"VIEWER"===t.data.role&&k(n,a,u,!1,function(e){o(e)});var r={};r[t.curvePublic]=t.data,s.roster.describe(r,function(e){e?o({error:e}):o()})}else!function(n,t,r,o){var a=e.once(o);if(t){var i=e.find(n,["store","proxy","teams",t]);if(i){var s=n.teams[t];if(s){var c=r.pendingOwner;g(function(t){var o=c?"RM_PENDING_OWNERS":"RM_OWNERS",s=function(e){var n=e&&e.error;if(n)return console.error(n),t.abort(),void a(n)},u=function(e){n.Store.pad.setMetadata(null,{channel:e,command:o,value:[r.edPublic]},t(s))};u(i.channel),u(e.find(i,["keys","roster","channel"])),u(e.find(i,["keys","chat","channel"]))}).nThen(function(e){var n={};n[r.curvePublic]={role:"ADMIN",pendingOwner:!1},s.roster.describe(n,e(function(e){e&&console.error(e)}))}).nThen(function(e){n.store.mailbox.sendTo("RM_OWNER",{teamChannel:i.channel,title:i.metadata.name,pending:c},{channel:r.notifications,curvePublic:r.curvePublic},e())}).nThen(function(){a()})}else a({error:"ENOENT"})}else a({error:"ENOENT"})}else a({error:"EINVAL"})}(n,a,u,function(e){e?(console.error(e),o({error:e})):o()})})}else o({error:"MISSING_DATA"});else o({error:"NO_ROSTER"});else o({error:"ENOENT"})}else o({error:"EINVAL"})},F=function(e,n){Object.keys(e.onReadyHandlers).forEach(function(t){var r=-1;e.onReadyHandlers[t].some(function(e,t){if(e.cId===n)return r=t,!0}),-1!==r&&e.onReadyHandlers[t].splice(r,1)}),Object.keys(e.teams).forEach(function(t){var r=e.teams[t].clients,o=r.indexOf(n);-1!==o&&r.splice(o,1)})},L=function(n,t,r,o){var a,i=t.seeds;try{a=f.derivePreviewKeys(i.preview)}catch(e){return void o({error:"INVALID_SEEDS"})}l.get({channel:a.channel,type:"pad",version:2,keys:{cryptKey:a.cryptKey}},function(n,t){if(n)o({error:n});else if(t){var r=e.tryParse(t);o(r||{error:"parseError"})}else o({error:"DELETED"})},{network:n.store.network,initialState:"{}"})},H=function(n,t,r,o){var a,i;g(function(r){!function(n,t,r,o){var a,i=t.bytes64;try{a=f.deriveInviteKeys(i)}catch(e){return void o({error:"INVALID_SEEDS"})}l.get({channel:a.channel,type:"pad",version:2,keys:{cryptKey:a.cryptKey}},function(n,t){if(n)o({error:n});else if(t){var r=e.tryParse(t);o(r||{error:"parseError"})}else o({error:"DELETED"})},{network:n.store.network,initialState:"{}"})}(n,t,0,r(function(e){if(e&&e.error)return r.abort(),void o(e);a=e}))}).nThen(function(t){var r=e.find(a,["teamData","channel"]),u=n.store.proxy.teams||{};if(Object.keys(u).some(function(e){return u[e].channel===r}))return t.abort(),void o({error:"ALREADY_MEMBER"});var f=e.find(a,["teamData","keys","roster"]),l=a.ephemeral;if(!f||!l)return t.abort(),void o({error:"INVALID_INVITE_CONTENT"});var h=v.Team.deriveMemberKeys(f.edit,l);s.create({network:n.store.network||n.store.networkPromise,channel:f.channel,keys:h,store:n.store,Cache:d},t(function(e,r){if(e)return t.abort(),console.error(e),void o({error:"ROSTER_ERROR"});var a=c.createData(n.store.proxy,!1),s=r.getState();i=s.members[l.curvePublic],r.accept(a.curvePublic,t(function(e){if(r.stop(),e)return t.abort(),console.error(e),void o({error:"ACCEPT_ERROR"})}))}))}).nThen(function(){var e={};i.remaining&&1!==i.remaining||_(n,e,a.ephemeral,function(n){if(!n){var t=e.rpc;i.inviteChannel&&t.removeOwnedChannel(i.inviteChannel,function(e){e&&console.error(e)}),i.previewChannel&&t.removeOwnedChannel(i.previewChannel,function(e){e&&console.error(e)})}}),x(n,{team:a.teamData},0,o)})},j=function(n){if(n){if(n.keys&&n.keys.mailbox)return n.keys.mailbox;var t=e.find(n,["keys","roster","edit"]);if(t){var r=E.hash(e.decodeUTF8(t)),o=r.slice(0,32),a=e.uint8ArrayToHex(r.slice(32,48)),i=E.box.keyPair.fromSecretKey(o);return{channel:a,viewed:[],keys:{curvePrivate:e.encodeBase64(i.secretKey),curvePublic:e.encodeBase64(i.publicKey)}}}}};return b.init=function(t,r,o){var a={},i=t.store;if(i.loggedIn&&i.proxy.edPublic&&!i.modules?.team){var h={store:i,Store:t.Store,pinPads:t.pinPads,emit:o,onReadyHandlers:{},teams:{},cache:{},nocache:{},updateMetadata:t.updateMetadata,updateProgress:t.updateLoadingProgress,progress:0};i.proxy.teams||(i.proxy.teams={});var b=i.proxy.teams;h.numberOfTeams=Object.keys(b).length,h.store.proxy.on("change",["teams"],function(e,n,t){"hash"===t[2]&&R(h,t[1],n)}),h.store.proxy.on("remove",["teams"],function(e,n){"hash"===n[2]&&R(h,n[1])});var w=function(n,t){if(!n||!t)return!0;try{var r=e.decodeBase64(n),o=E.sign.keyPair.fromSecretKey(r);return e.encodeBase64(o.publicKey)===t}catch(e){return!1}};Object.keys(b).forEach(function(n){h.onReadyHandlers[n]=[],e.find(b,[n,"keys","mailbox"])||(b[n].keys.mailbox=j(b[n])),I(h,b[n],n,r(function(e){if(e){delete h.onReadyHandlers[n],delete h.cache[n],"NOCACHE"===e?.error&&(h.nocache[n]=!0);var t="string"==typeof e?e:e.type||e.message;return u.send("TEAM_LOADING_ERROR="+t),void console.error(e)}console.debug("Team "+n+" cache ready")}),d.isEnabled())}),a.onReady=function(t){var r;r={},Object.keys(b).forEach(function(t){try{var o=b[t],a=r[o.channel],i=e.find(o,["keys","drive","edPrivate"]),s=e.find(o,["keys","drive","edPublic"]);if(s?i&&s&&!w(i,s)&&(u.send("TEAM_CORRUPTED_EDPRIVATE"),delete b[t].keys.drive.edPrivate,i=void 0):u.send("TEAM_CORRUPTED_EDPUBLIC"),o.hash&&2===n.parseTypeHash("drive",o.hash).version&&40!==o.hash.length&&u.send("TEAM_CORRUPTED_HASH"),!a)return void(r[o.channel]=t);var c=b[a],f=e.find(c,["keys","drive","edPrivate"]),l=e.find(c,["keys","chat","edit"]),d=e.find(o,["keys","chat","edit"]);!c.hash&&o.hash&&(c.hash=o.hash),!f&&i&&(c.keys.drive.edPrivate=i),!l&&d&&(c.keys.chat.edit=d),h.store.proxy.duplicateTeams=h.store.proxy.duplicateTeams||{},h.store.proxy.duplicateTeams[t]=b[t],delete b[t]}catch(e){console.error(e)}});var o=function(e){return!b[e]&&(D(h,e),delete h.onReadyHandlers[e],!0)};Object.keys(h.teams).forEach(o),Object.keys(h.onReadyHandlers).forEach(function(n){if(!o(n)){var r=h.store.proxy.teams[n],a=e.find(r,["keys","roster","channel"]),i=e.once(e.mkAsync(t()));g(function(e){N(h,n,r.channel,a,e,i)}),h.onReadyHandlers[n].push({cb:i})}}),Object.keys(b).forEach(function(n){h.onReadyHandlers[n]||h.teams[n]||(h.onReadyHandlers[n]=[],e.find(b,[n,"keys","mailbox"])||(b[n].keys.mailbox=j(b[n])),I(h,b[n],n,t(function(e){if(e){var t="string"==typeof e?e:e.type||e.message;return u.send("TEAM_LOADING_ERROR="+t),void console.error(e)}console.debug("Team "+n+" ready")})))}),A(),O.fire()},a.getTeam=function(e){return h.teams[e]},a.getTeamsData=function(n){var t={},r=!1;return-1!==["drive","teams","settings"].indexOf(n)&&(r=!0),Object.keys(b).forEach(function(n){if(h.teams[n]){var o=h.teams[n].proxy||{},a=o.drive&&Object.keys(o.drive.filesData||{}).length,i=o.drive&&Object.keys(o.drive.sharedFolders||{}).length;t[n]={owner:b[n].owner,name:b[n].metadata.name,channel:b[n].channel,numberPads:a,numberSf:i,roster:e.find(b[n],["keys","roster","channel"]),edPublic:e.find(b[n],["keys","drive","edPublic"]),avatar:e.find(b[n],["metadata","avatar"]),viewer:!e.find(b[n],["keys","drive","edPrivate"]),notifications:e.find(b[n],["keys","mailbox","channel"]),curvePublic:e.find(b[n],["keys","mailbox","keys","curvePublic"]),validKeys:w(e.find(b[n],["keys","drive","edPrivate"]),e.find(b[n],["keys","drive","edPublic"]))},r&&h.teams[n]&&(t[n].secondaryKey=h.teams[n].secondaryKey),h.teams[n]&&(t[n].hasSecondaryKey=Boolean(h.teams[n].secondaryKey))}}),t},a.getTeams=function(){return Object.keys(h.teams)};a.removeFromTeam=function(e,n,t){if(b[e]&&(!t||function(e,n){var t=h.teams[e];if(t){var r=t.roster&&t.roster.getState();if(r.members)return(r.members[n]||{}).pending}}(e,n)))if(h.onReadyHandlers[e])h.onReadyHandlers[e].push({cb:function(){h.teams[e].roster.remove([n],function(e){e&&"NO_CHANGE"!==e&&console.error(e)})}});else{var r=h.teams[e];r?r.roster.remove([n],function(e){e&&"NO_CHANGE"!==e&&console.error(e)}):console.error("TEAM MODULE ERROR")}},a.changeMyRights=function(e,n,t,r){P(h,e,n,t,r)},a.updateMyData=function(e){Object.keys(h.teams).forEach(function(n){var t=h.teams[n];if(t.roster){var r={};r[e.curvePublic]=e,t.roster.describe(r,function(e){e&&console.error(e)})}})},a.removeClient=function(e){F(h,e)};return a.execCommand=function(t,r,o){var a=r.cmd,i=r.data;if("SUBSCRIBE"!==a)if("LIST_TEAMS"!==a)if("OPEN_TEAM_CHAT"!==a)if("GET_TEAM_ROSTER"!==a)if("GET_TEAM_METADATA"!==a)if("SET_TEAM_METADATA"!==a){if("OFFER_OWNERSHIP"===a)return h.store.offline?void o({error:"OFFLINE"}):void function(n,t,r,o){var a=e.once(o),i=t.teamId;if(i){var s=e.find(n,["store","proxy","teams",i]);if(s){var c=n.teams[i];if(c)if(c.roster)if(t.curvePublic){var u=c.roster.getState().members[t.curvePublic];g(function(t){var r=function(e){var n=e&&e.error;if(n)return console.error(n),t.abort(),void a({error:n})},o=function(e){n.Store.pad.setMetadata(null,{channel:e,command:"ADD_PENDING_OWNERS",value:[u.edPublic]},t(r))};o(s.channel),o(e.find(s,["keys","roster","channel"])),o(e.find(s,["keys","chat","channel"]))}).nThen(function(e){var n={};n[u.curvePublic]={role:"OWNER"},c.roster.describe(n,e(function(e){e&&console.error(e)}))}).nThen(function(t){n.store.mailbox.sendTo("ADD_OWNER",{teamChannel:s.channel,chatChannel:e.find(s,["keys","chat","channel"]),rosterChannel:e.find(s,["keys","roster","channel"]),title:s.metadata.name},{channel:u.notifications,curvePublic:u.curvePublic},t())}).nThen(function(){a()})}else a({error:"MISSING_DATA"});else a({error:"NO_ROSTER"});else a({error:"ENOENT"})}else a({error:"ENOENT"})}else a({error:"EINVAL"})}(h,i,0,o);if("ANSWER_OWNERSHIP"===a)return h.store.offline?void o({error:"OFFLINE"}):void function(n,t,r,o){var a,i=n.store.proxy.teams;if(Object.keys(i).forEach(function(e){if(i[e].channel===t.teamChannel)return a=e,!0}),a){var s=e.find(n,["store","proxy","teams",a]);if(s){var c=n.teams[a];if(c)if(c.roster){var u={};t.answer?s.owner=!0:(u[n.store.proxy.curvePublic]={role:"ADMIN"},c.roster.describe(u,function(e){e?o({error:e}):o()}))}else o({error:"NO_ROSTER"});else o({error:"ENOENT"})}else o({error:"ENOENT"})}else o({error:"EINVAL"})}(h,i,0,o);if("DESCRIBE_USER"!==a){if("INVITE_TO_TEAM"===a)return h.store.offline?void o({error:"OFFLINE"}):void function(e,n,t,r){var o=n.teamId;if(o){var a=e.teams[o];if(a)if(a.roster){var i=n.user;if(i&&i.curvePublic&&i.notifications){delete i.channel,delete i.lastKnownHash,i.pending=!0;var s={};s[i.curvePublic]=i,s[i.curvePublic].role="VIEWER",a.roster.add(s,function(n){n&&"NO_CHANGE"!==n?r({error:n}):e.store.mailbox.sendTo("INVITE_TO_TEAM",{team:C(e,o)},{channel:i.notifications,curvePublic:i.curvePublic},function(e){r(e)})})}else r({error:"MISSING_DATA"})}else r({error:"NO_ROSTER"});else r({error:"ENOENT"})}else r({error:"EINVAL"})}(h,i,0,o);if("LEAVE_TEAM"!==a){if("JOIN_TEAM"===a)return h.store.offline?void o({error:"OFFLINE"}):void x(h,i,0,o);if("REMOVE_USER"!==a){if("DELETE_TEAM"===a)return h.store.offline?void o({error:"OFFLINE"}):void function(n,t,r,o){var a=t.teamId;if(a){var i=n.teams[a],s=e.find(n,["store","proxy","teams",a]);if(i&&s){var c=i.roster.getState(),f=e.find(n,["store","proxy","curvePublic"]),l=c.members[f];if(!l||"OWNER"!==l.role)return o({error:"EFORBIDDEN"});var d=e.find(n,["store","proxy","edPublic"]),h=e.find(s,["keys","drive","edPublic"]);g(function(e){n.Store.anonRpcMsg(null,{msg:"GET_METADATA",data:s.channel},e(function(n){if(n&&n.error)return e.abort(),o({error:n.error});var t=n[0];t&&Array.isArray(t.owners)&&-1!==t.owners.indexOf(d)||(e.abort(),o({error:"EFORBIDDEN"}))}))}).nThen(function(t){i.proxy.delete=!0;var r=i.manager.getChannelsList("owned"),o=e.Saferphore.create(10);r.forEach(function(e){var r=t();o.take(function(t){var o=!1;g(function(r){32===e.length&&n.Store.anonRpcMsg(null,{msg:"GET_METADATA",data:e},r(function(e){if(e&&e.error)return t(),void r.abort();var n=e[0];if(!n||!Array.isArray(n.owners)||-1===n.owners.indexOf(h))return t(),void r.abort();o=n.owners.some(function(e){return e!==h})}))}).nThen(function(t){o?n.Store.pad.setMetadata(null,{channel:e,command:"RM_OWNERS",value:[h]},t()):i.rpc.removeOwnedChannel(e,t(function(e){e&&console.error(e)}))}).nThen(function(){t(),r()})})})}).nThen(function(t){i.rpc.removePins(t(function(e){e&&console.error(e)}));var r=e.find(s,["keys","mailbox","channel"]);i.rpc.removeOwnedChannel(r,t(function(e){e&&console.error(e)}));var o=e.find(s,["keys","roster","channel"]);n.store.rpc.removeOwnedChannel(o,t(function(e){e&&console.error(e)}));var a=e.find(s,["keys","chat","channel"]);n.store.rpc.removeOwnedChannel(a,t(function(e){e&&console.error(e)})),n.store.rpc.removeOwnedChannel(s.channel,t(function(e){e&&console.error(e)}))}).nThen(function(){u.send("TEAM_DELETION"),D(n,a),o()})}else o({error:"ENOENT"})}else o({error:"EINVAL"})}(h,i,0,o);if("CREATE_TEAM"===a)return h.store.offline?void o({error:"OFFLINE"}):void function(t,r,o,a){var i,f=e.once(a),l=n.createChannelId(),h=n.createRandomHash("team",l),b=n.getSecrets("team",h,l),O=n.getViewHashFromKeys(b),A=E.sign.keyPair(),w=E.box.keyPair(),_=v.Team.createSeed(),T=v.Team.deriveMemberKeys(_,{curvePublic:t.store.proxy.curvePublic,curvePrivate:t.store.proxy.curvePrivate}),N=n.getSecrets("chat"),I=n.getHashes(N),x={network:t.store.network,channel:b.channel,data:{},validateKey:b.keys.validateKey,crypto:v.createEncryptor(b.keys),logLevel:1,classic:!0,ChainPad:m,Cache:d,owners:[t.store.proxy.edPublic]};g(function(e){s.create({network:t.store.network||t.store.networkPromise,channel:T.channel,owners:[t.store.proxy.edPublic],keys:T,store:t.store,lastKnownHash:void 0,newTeam:!0,Cache:d},e(function(n,r){if(n)return e.abort(),console.error(n),void f({error:"ROSTER_ERROR"});i=r;var o=c.createData(t.store.proxy);delete o.channel,i.init(o,e(function(n){if(n)return e.abort(),void f({error:"ROSTER_INIT_ERROR"})}))}));var n,r=v.createEncryptor(N.keys),o={network:t.store.network,channel:N.channel,noChainPad:!0,crypto:r,metadata:{validateKey:N.keys.validateKey,owners:[t.store.proxy.edPublic]}},a=e();o.onReady=function(){n&&n.stop(),a()},o.onError=function(){e.abort(),f({error:"CHAT_INIT_ERROR"})},n=y.start(o)}).nThen(function(e){i.metadata({name:r.name},e(function(n){if(n)return e.abort(),void f({error:"ROSTER_INIT_ERROR"})}))}).nThen(function(){var a=e.createRandomInteger();x.onMetadataUpdate=function(){var e=t.teams[a];e&&t.emit("ROSTER_CHANGE",a,e.clients)};var s=p.create(x),c=s.proxy;c.version=2,c.on("ready",function(){var d={mailbox:{channel:n.createChannelId(),viewed:[],keys:{curvePrivate:e.encodeBase64(w.secretKey),curvePublic:e.encodeBase64(w.publicKey)}},drive:{edPrivate:e.encodeBase64(A.secretKey),edPublic:e.encodeBase64(A.publicKey)},chat:{edit:I.editHash,view:I.viewHash,validateKey:N.keys.validateKey,channel:N.channel},roster:{channel:T.channel,edit:_,view:T.viewKeyStr}},p=t.store.proxy.teams[a]={owner:!0,channel:b.channel,hash:h,roHash:O,password:l,keys:d,metadata:{name:r.name}};c.drive={},S(t,a,s,i,d,o,function(){u.send("TEAM_CREATION"),t.store.mailbox.open("team-"+a,p.keys.mailbox,function(){},!0,{owners:p.keys.drive.edPublic}),t.updateMetadata(),f()})}).on("error",function(e){e&&void 0!==e.loaded&&!e.loaded&&f({error:"ECONNECT"}),e&&e.error&&"EDELETED"===e.error&&D(t,a)})})}(h,i,t,o);if("GET_EDITABLE_FOLDERS"!==a)if("CREATE_INVITE_LINK"!==a){if("GET_PREVIEW_CONTENT"!==a)return"ACCEPT_LINK_INVITATION"===a?h.store.offline?void o({error:"OFFLINE"}):void H(h,i,0,o):void 0;L(h,i,0,o)}else!function(n,t,r,o){var a=e.mkAsync(e.once(o)),i=t.teamId,s=n.teams[t.teamId],u=t.seeds,d=t.bytes64;if(i&&s){var h,p=s.roster;try{h=p.getState().metadata.name}catch(e){return void a({error:"TEAM_NAME_ERR"})}var v=t.message,y=t.name,m=t.hash,E=e.find(n,["store","proxy","teams",i]);try{var b=f.encryptHash(m,E.hash)}catch(e){console.error(e)}var O=f.derivePreviewKeys(u.preview),A=f.deriveInviteKeys(d),w=f.generateKeys(),D=t.role||"VIEWER",_=t.uses||1;g(function(e){!function(){var t=f.generateSignPair(),r={initialState:"{}",network:n.store.network,metadata:{owners:[n.store.proxy.edPublic,w.edPublic]}};r.metadata.validateKey=t.validateKey;var o={teamName:h,message:v,author:c.createData(n.store.proxy,!1),displayName:y},i={channel:O.channel,type:"pad",version:2,keys:{cryptKey:O.cryptKey,validateKey:t.validateKey,signKey:t.signKey}};l.put(i,JSON.stringify(o),e(function(n){if(n)return console.error("CRYPTPUT_ERR",n),e.abort(),void a({error:"SET_PREVIEW_CONTENT"})}),r)}(),function(){var t=f.generateSignPair(),r={initialState:"{}",network:n.store.network,metadata:{owners:[n.store.proxy.edPublic,w.edPublic]}};r.metadata.validateKey=t.validateKey;var o={teamData:C(n,i,"MEMBER"===D),ephemeral:{edPublic:w.edPublic,edPrivate:w.edPrivate,curvePublic:w.curvePublic,curvePrivate:w.curvePrivate}},s={channel:A.channel,type:"pad",version:2,keys:{cryptKey:A.cryptKey,validateKey:t.validateKey,signKey:t.signKey}};l.put(s,JSON.stringify(o),e(function(n){if(n)return console.error("CRYPTPUT_ERR",n),e.abort(),void a({error:"SET_PREVIEW_CONTENT"})}),r)}()}).nThen(function(e){s.pin([A.channel,O.channel],function(e){e&&e.error&&console.error(e.error)}),f.createRosterEntry(s.roster,{curvePublic:w.curvePublic,content:{curvePublic:w.curvePublic,displayName:t.name,pending:!0,remaining:_,totalUses:_,role:D,hash:b,inviteChannel:A.channel,previewChannel:O.channel}},e(function(n){n&&(e.abort(),a(n))}))}).nThen(function(){a()})}else a({error:"EINVAL"})}(h,i,0,o);else!function(n,t,r,o){var a=t.teamId;if(a){var i=n.teams[a];if(i){var s=i.manager.folders||{};o(Object.keys(s).filter(function(e){return!s[e].proxy.version}).map(function(n){var t=e.find(i,["user","userObject"]);return{name:e.find(s,[n,"proxy","metadata","title"]),path:t?t.findFile(n)[0]:[]}}))}else o({error:"ENOENT"})}else o({error:"EINVAL"})}(h,i,0,o)}else!function(e,n,t,r){var o=n.teamId;if(o){var a=e.teams[o];if(a)if(a.roster)if(n.curvePublic){var i=a.roster.getState().members[n.curvePublic];a.roster.remove([n.curvePublic],function(t){if(!t)return i&&i.notifications?void e.store.mailbox.sendTo("KICKED_FROM_TEAM",{pending:n.pending,teamChannel:C(e,o).channel,teamName:C(e,o).metadata.name},{channel:i.notifications,curvePublic:i.curvePublic},function(e){r(e)}):r();r({error:t})})}else r({error:"MISSING_DATA"});else r({error:"NO_ROSTER"});else r({error:"ENOENT"})}else r({error:"EINVAL"})}(h,i,0,o)}else!function(e,n,t,r){var o=n.teamId;if(o){var a=e.teams[o];if(a)if(a.roster){var i=e.store.proxy.curvePublic;a.roster.remove([i],function(n){n?r({error:n}):(D(e,o),r())})}else r({error:"NO_ROSTER"});else r({error:"ENOENT"})}else r({error:"EINVAL"})}(h,i,0,o)}else M(h,i,0,o)}else!function(e,n,t,r){var o=n.teamId;if(o){var a=e.teams[o];a?a.offline?r({error:"OFFLINE"}):a.roster?(n.metadata&&delete n.metadata.offline,a.roster.metadata(n.metadata,function(t){if(t)r({error:t});else{var a=e.store.proxy.teams[o];a&&(a.metadata=n.metadata),r()}})):r({error:"NO_ROSTER"}):r({error:"ENOENT"})}else r({error:"EINVAL"})}(h,i,0,o);else!function(e,n,t,r){var o=n.teamId;if(o){var a=e.teams[o];if(a)if(a.roster){var i=(a.roster.getState()||{}).metadata||{};i.offline=a.offline,r(i)}else r({error:"NO_ROSTER"});else r({error:"ENOENT"})}else r({error:"EINVAL"})}(h,i,0,o);else!function(n,t,r,o){var a=t.teamId;if(a){var i=e.find(n,["store","proxy","teams",a]);if(i){var s=n.teams[a];if(s)if(s.roster){var c,u=(s.roster.getState()||{}).members||{};g(function(e){n.Store.pad.getMetadata(null,{channel:i.channel},e(function(e){c=e&&e.error?s.listmap.metadata||{}:e}))}).nThen(function(){if(n.pending_owners=c.pending_owners,Array.isArray(c.pending_owners)&&c.pending_owners.forEach(function(t){var r;if(Object.keys(u).some(function(e){if(u[e].edPublic===t)return r=u[e],!0}),!r&&i.owner){var o=function(e){n.Store.pad.setMetadata(null,{channel:e,command:"RM_PENDING_OWNERS",value:[t]},function(){})};return o(i.channel),o(e.find(i,["keys","roster","channel"])),void o(e.find(i,["keys","chat","channel"]))}r.pendingOwner=!0}),n.store.messenger){var t=s.getChatData();(n.store.messenger.getOnlineList(t.channel)||[]).forEach(function(e){u[e]&&(u[e].online=!0)})}Object.keys(u).forEach(function(e){var n=u[e];if(n.inviteChannel&&n.hash)if(i.hash)try{n.hash=f.decryptHash(n.hash,i.hash)}catch(e){console.error(e)}else delete n.hash}),o(u)})}else o({error:"NO_ROSTER"});else o({error:"ENOENT"})}else o({error:"ENOENT"})}else o({error:"EINVAL"})}(h,i,0,o);else!function(e,n,t,r){var o=e.teams[n.teamId];if(o){var a=function(){e.emit("ROSTER_CHANGE",n.teamId,o.clients)};e.store.messenger?e.store.messenger.openTeamChat(o.getChatData(),a,t,r):A=function(){e.store.messenger.openTeamChat(o.getChatData(),a,t,r)}}else r({error:"ENOENT"})}(h,i,t,o);else!function(n){var t=e.clone(b);Object.keys(t).forEach(function(e){h.teams[e]?t[e].offline=h.teams[e].offline:(t[e].error=!0,h.nocache[e]&&(t[e].offline=!0))}),n(t)}(o);else!function(e,n,t,r){F(e,t);try{e.store.messenger.removeClient(t)}catch(e){}if(A=function(){},n)if(!e.onReadyHandlers[n]||e.teams[n])if(e.teams[n]){var o=e.teams[n].clients;-1===o.indexOf(t)&&o.push(t),r()}else r({error:"EINVAL"});else-1===e.onReadyHandlers[n].indexOf(t)&&e.onReadyHandlers[n].push({cId:t,cb:r});else r()}(h,i,t,o)},a}},b.anonGetPreviewContent=function(e,n,t){L(e,n,0,t)},b})(Z(),te(),Y(),je(),ze(),Ue(),We(),Ht(),On(),Ae(),(_t||(_t=1,Dt=function(e,n,t,r){var o={},a=e.encodeBase64,i=e.decodeBase64;o.generateKeys=function(){var e=t.sign.keyPair(),n=t.box.keyPair();return{edPublic:a(e.publicKey),edPrivate:a(e.secretKey),curvePublic:a(n.publicKey),curvePrivate:a(n.secretKey)}},o.generateSignPair=function(){var e=t.sign.keyPair();return{validateKey:a(e.publicKey),signKey:a(e.secretKey)}};var s=function(r){var o=n.dispenser(i(r));return{channel:e.uint8ArrayToHex(o(16)),cryptKey:o(t.secretbox.keyLength)}};o.deriveInviteKeys=s,o.derivePreviewKeys=s,o.createRosterEntry=function(e,n,t){var r={};r[n.curvePublic]=n.content,e.invite(r,t)};var c=e.decodeUTF8;return o.encryptHash=function(e,n){var o=c(n),a=t.hash(o).subarray(0,32);return r.encrypt(e,a)},o.decryptHash=function(e,n){var o=c(n),a=t.hash(o).subarray(0,32);return r.decrypt(e,a)},o}(Z(),Ie(),h(),M())),Dt),xn(),fe(),In(),T(),M(),D(),x(),qe(),h()),Tt}function Kt(){if(It)return Nt;It=1;return Nt=((e,n,t,r,o,a,i,s)=>{var c=e.Curve;const u={};let f={};u.setCustomize=e=>{f=e.Messages};var l="MSG",d="UNFRIEND",h="MAP_ID",p="MAP_ID_ACK",v=function(e){return JSON.parse(JSON.stringify(e))},y=function(e){for(var n=Object.keys(e).length,t=new Uint8Array(n),r=0;r<n;r++)t[r]=e[r];return t},m=o.createData,g=function(e,n){if(n===e.curvePublic){var t=m(e);return delete t.channel,t}return e.friends?e.friends[n]:void 0},E=u.getFriendList=function(e){return e.friends||(e.friends={}),e.friends},b=function(e,n){return e.messages.some(function(e){return e.sig===n})},O=function(e,n){var t,r=e.store.proxy,o=E(r);for(var a in o)if(o[a].channel===n){t=o[a];break}return t},A=function(e,n,t,r){e.range_requests||(e.range_requests={}),e.range_requests[n]={messages:[],cb:r,chanId:t}},w=function(e,n){delete e.range_requests[n]},D=function(e,n,r,o){var a=e.store.network;if(console.log("Fetching [%s] messages since [%s]",n.id,r.lastKnownHash||""),n.isPadChat||n.isTeamChat){var i=t.uid();A(e,i,n.id,void 0);var s=["GET_HISTORY_RANGE",n.id,{count:10,txid:i}];a.sendto(a.historyKeeper,JSON.stringify(s)).then(function(){},function(e){console.error(e)})}else{var c=e.store.proxy,u=O(e,n.id)||{},f={metadata:{validateKey:o?o.validateKey:void 0,owners:[c.edPublic,u.edPublic]},lastKnownHash:r.lastKnownHash},l=["GET_HISTORY",n.id,f];a.sendto(a.historyKeeper,JSON.stringify(l)).then(function(){},function(e){console.error(e)})}},_=function(e,n,t,r){var o=e.channels[n];if(o.isFriendChat){var a=O(e,n);if(!a)return void r({error:"NO_SUCH_FRIEND"});a.lastKnownHash=t}else if(o.isPadChat);else if(!o.isTeamChat)return void r({error:"NOT_IMPLEMENTED"});r()},T=function(e,n){var t=e.channels[n];t&&(t.ready=!0,t.onReady.fire())},S=function(e,n,t){var o=e.store.proxy.friends;o&&(delete o[n],r.whenRealtimeSyncs(e.store.realtime,function(){e.updateMetadata(),t()}))},N=function(e,n,t){var r=t.slice(0,64);if(!b(n,r)){var o,a=n.decrypt(t),i=JSON.parse(a);if(i[0]===l){var s={type:i[0],sig:r,author:i[1],time:i[2],text:i[3],channel:n.id,name:i[4]};return n.messages.push(s),n.ready&&e.emit("MESSAGE",s,n.clients),!0}var c=e.store.proxy;if(i[0]!==d);else{if((o=i[1])===c.curvePublic)return;S(e,o,function(){n.wc.leave(d);var t=e.store.network;n.onReconnect&&t.off("reconnect",n.onReconnect),delete e.channels[n.id],e.emit("UNFRIEND",{curvePublic:o,fromMe:!1},n.clients)})}}},I=function(e,n,r){if(r===e.store.network.historyKeeper){var o,a=JSON.parse(n);if(!a.validateKey&&!a.owners||!a.channel)if(/HISTORY_RANGE/.test(a[0])){var i=a[1],s=function(e,n){return e.range_requests[n]}(e,i),c=a[0];if(!s)return;if(!(o=e.channels[s.chanId]))return;if(!s.cb){if("HISTORY_RANGE"===c){if(!Array.isArray(a[2]))return;N(e,o,a[2][4])}else if("HISTORY_RANGE_END"===c)return T(e,s.chanId),w(e,i);return}if("HISTORY_RANGE"===c)s.messages.push(a[2]);else{if("HISTORY_RANGE_END"===c){var u=s.messages.map(function(e){if("MSG"===e[2])try{return{d:JSON.parse(o.decrypt(e[4])),sig:e[4].slice(0,64)}}catch(e){return void console.log("failed to decrypt")}}).filter(function(e){if(e&&e.d&&e.d[0]===l&&!b(o,e.sig))return e}).map(function(e){return{type:e.d[0],sig:e.sig,author:e.d[1],time:e.d[2],text:e.d[3],channel:s.chanId,name:e.d[4]}});return function(e,n){var t=e.messages;n.reverse().forEach(function(e){t.unshift(e)})}(o,u),s.cb(u),w(e,i)}console.log(a)}}else{if(a.channel&&e.channels[a.channel]){if(o=e.channels[a.channel],"ECLEARED"===a.error)return _(e,a.channel,"",function(){}),o.messages=[],void e.emit("CLEAR_CHANNEL",a.channel,o.clients);if(a.error&&("EINVAL"===a.error||"EUNKNOWN"===a.error))return void _(e,a.channel,"",function(){D(e,o,{},{})});if(a.state&&1===a.state&&a.channel)return void T(e,a.channel)}(o=e.channels[a[3]])&&N(e,o,a[4])}}else!function(e,n,r){var o,a;try{if(a=JSON.parse(n),!(o=e.channels[a.channel])||-1===o.wc.members.indexOf(r))return}catch(e){return void console.error(e,n)}var i=o.decrypt(a.msg);if(i){var s=t.tryParse(i);if(s){if((s[0]===h||s[0]===p)&&s[2]===r&&s[1]&&(o.mapId[r]=s[1],e.emit("JOIN",{info:s[1],id:o.id},o.clients),!o.readOnly&&s[0]===h)){var c=e.store.proxy||{},u=m(c);delete u.channel;var f=[p,u,o.wc.myID],l=JSON.stringify(f),d=o.encrypt(l),v={channel:o.id,msg:d};e.store.network.sendto(r,JSON.stringify(v))}}else console.error(i)}else console.error("Failed to decrypt message")}(e,n,r)},x=function(e,n,t){var r=e.channels[t];if(r){r.wc&&r.wc.leave(d);var o=e.store.network;r.onReconnect&&o.off("reconnect",r.onReconnect),delete e.channels[r.id],e.emit("UNFRIEND",{curvePublic:n,fromMe:!0},e.friendsClients)}},C=function(e){var n=[];return Array.prototype.push.apply(n,e.friendsClients),Object.keys(e.channels).forEach(function(t){Array.prototype.push.apply(n,e.channels[t].clients)}),t.deduplicateString(n)},R=function(e,n){var r=e.store.proxy,o=e.store.network,a=o.historyKeeper,i=n.keys,s=n.encryptor||c.createEncryptor(i),u={id:n.channel,isFriendChat:n.isFriendChat,isPadChat:n.isPadChat,isTeamChat:n.isTeamChat,padChan:n.padChan,readOnly:n.readOnly,ready:!1,onReady:t.mkEvent(!0),sending:!1,messages:[],clients:n.clients||[],onUserlistUpdate:n.onUserlistUpdate||function(){},mapId:{}};n.onReady&&u.onReady.reg(n.onReady),u.encrypt=function(e){if(!u.readOnly)return s.encrypt(e)},u.decrypt=n.decrypt||function(e){return s.decrypt(e)};var f=function(e){if(e!==a&&!u.readOnly&&!u.isPadChat){var n=m(r);delete n.channel;var t=[h,n,u.wc.myID],i=JSON.stringify(t),s=u.encrypt(i),c={channel:u.id,msg:s};o.sendto(e,JSON.stringify(c))}},l=function(n){if(n!==a){var t=u.mapId[n];t&&(u.wc.members.some(function(e){return u.mapId[e]&&u.mapId[e].curvePublic===t.curvePublic})||e.emit("LEAVE",{info:t,id:u.id},u.clients))}},d=function(t){u.wc=t,e.channels[n.channel]=u,t.on("message",function(n,r){!function(e,n,t,r){var o=e.channels[r.id];o&&N(e,o,n)}(e,n,0,t)}),t.on("join",f),t.on("leave",l),D(e,u,n,i)};o.join(n.channel).then(d,function(e){console.error(e)}),u.onReconnect=function(){u&&u.stopped||e.channels[n.channel]&&o.join(n.channel).then(d,function(e){console.error(e)})},o.on("reconnect",u.onReconnect)},P=function(e,n,r,o){var a=t.once(t.mkAsync(o)),i=r.channel,s=e.channels[i];if(s)s.onReady.reg(function(){-1===s.clients.indexOf(n)&&s.clients.push(n),a()});else{var u=e.store.proxy,f={keys:c.deriveKeys(r.curvePublic,u.curvePrivate),channel:r.channel,lastKnownHash:r.lastKnownHash,owners:[u.edPublic,r.edPublic],isFriendChat:!0,clients:n?[n]:e.friendsClients,onReady:a};R(e,f)}};return u.init=function(n,r,c){var u={},h=n.store;if(h.messenger)return h.messenger.addListener(),h.messenger;if(!i.isAvailable("contacts"))return;var p={store:h,Store:n.Store,updateMetadata:n.updateMetadata,pinPads:n.pinPads,emit:c,friendsClients:[],channels:{},validateKeys:{},range_requests:{}};u.addListener=function(){h.proxy&&h.proxy.on("change",["mutedUsers"],function(){p.emit("UPDATE_MUTED",null,C(p))})},u.addListener();let b=t.once(e=>{const n=p.store.network||e;n.on("message",function(e,n){I(p,e,n)}),n.on("disconnect",function(){p.emit("DISCONNECT",null,C(p))}),n.on("reconnect",function(){p.emit("RECONNECT",null,C(p))})});return h.networkPromise?.then(b),p.store.network&&b(),u.onFriendUpdate=function(e){var n=g(h.proxy,e);if(n&&n.channel){var t=p.channels[n.channel];t&&p.emit("UPDATE_DATA",{info:v(n),channel:n.channel},t.clients)}},u.onFriendAdded=function(e){if(p.friendsClients.length){var n=g(p.store.proxy,e.curvePublic);if("object"==typeof n)if(n.channel){var t=n.channel;p.channels[t]||P(p,null,n,function(){c("FRIEND",{curvePublic:n.curvePublic},p.friendsClients)})}}},u.onFriendRemoved=function(e,n){x(p,e,n)},u.getOnlineList=function(e){return function(e,n){var t=e.channels[n];if(t){var r=[],o=m(e.store.proxy,!1);return r.push(o.curvePublic),t.wc.members.forEach(function(n){if(n!==e.store.network.historyKeeper){var o=t.mapId[n]||{};o.curvePublic&&-1===r.indexOf(o.curvePublic)&&r.push(o.curvePublic)}}),r}}(p,e)},u.storeValidateKey=function(e,n){p.validateKeys[e]=n},u.leavePad=function(e){delete p.validateKeys[e],Object.keys(p.channels).some(function(n){var t=p.channels[n];if(t.padChan===e){t.wc&&t.wc.leave();var r=p.store.network;return t.onReconnect&&r.off("reconnect",t.onReconnect),t.stopped=!0,delete p.channels[n],!0}})},u.openTeamChat=function(n,r,o,a){!function(n,r,o,a,i){var s=o,c=s.channel,u=s.secret;if(c&&u){var f=t.once(t.mkAsync(function(){n.emit("TEAMCHAT_READY",c,[r]),i({readOnly:"object"==typeof u.keys&&!u.keys.validateKey,channel:c})})),l=n.channels[c];if(l)l.onReady.reg(function(){-1===l.clients.indexOf(r)&&l.clients.push(r),f()});else{u.keys.cryptKey&&(u.keys.cryptKey=y(u.keys.cryptKey));var d=e.createEncryptor(u.keys),h=u.keys&&u.keys.validateKey||s.validateKey,p={teamId:o.teamId,readOnly:"object"==typeof u.keys&&!u.keys.validateKey,encryptor:d,channel:c,isTeamChat:!0,decrypt:function(e){return d.decrypt(e,h)},clients:[r],onUserlistUpdate:a,onReady:f};R(n,p)}}else i({error:"EINVAL"})}(p,o,n,r,a)},u.removeClient=function(e){!function(e,n){var t=e.friendsClients.indexOf(n);-1!==t&&e.friendsClients.splice(t,1),Object.keys(e.channels).forEach(function(t){var r=e.channels[t],o=r.clients,a=o.indexOf(n);if(-1!==a&&o.splice(a,1),0===o.length){r.wc&&r.wc.leave();var i=e.store.network;return r.onReconnect&&i.off("reconnect",r.onReconnect),r.stopped=!0,delete e.channels[t],!0}})}(p,e)},u.execCommand=function(n,r,i){var c=r.cmd,u=r.data;"INIT_FRIENDS"!==c?"GET_ROOMS"!==c?"GET_MUTED_USERS"!==c?"GET_USERLIST"!==c?"OPEN_PAD_CHAT"!==c?"GET_MY_INFO"!==c?"REMOVE_FRIEND"!==c?"CANCEL_FRIEND"!==c?"MUTE_USER"!==c?"UNMUTE_USER"!==c?"GET_STATUS"!==c?"GET_MORE_HISTORY"!==c?"SEND_MESSAGE"!==c?"SET_CHANNEL_HEAD"!==c?"CLEAR_OWNED_CHANNEL"!==c||function(e,n,t){var r=e.channels[n];r?e.store.rpc?e.store.rpc.clearOwnedChannel(n,function(o){t({error:o}),o||(r.messages=[],e.emit("CLEAR_CHANNEL",n,r.clients))}):t({error:"RPC_NOT_READY"}):t({error:"NO_CHANNEL"})}(p,u,i):_(p,u.id,u.sig,i):function(e,n,t,r){var o=e.channels[n];if(o)if(o.readOnly)r({error:"FORBIDDEN"});else if(e.store.network.webChannels.some(function(e){if(e.id===o.wc.id)return!0})){var i=e.store.proxy||{},s=[l,i.curvePublic,+new Date,t];if(!o.isFriendChat){var c=i[a.displayNameKey]||f.anonymous+"#"+(i.uid||e.store.noDriveUid).slice(0,5);s.push(c)}var u=JSON.stringify(s),d=o.encrypt(u);o.wc.bcast(d).then(function(){N(e,o,d),r()},function(e){r({error:e})})}else r({error:"NO_SUCH_CHANNEL"});else r({error:"NO_CHANNEL"})}(p,u.id,u.content,i):function(e,n,r,o,a){if("function"==typeof a)if("string"==typeof r){var i=e.channels[n];if(void 0!==i){var s=t.uid();A(e,s,n,a);var c=["GET_HISTORY_RANGE",i.id,{from:r,count:o,txid:s}],u=e.store.network;u.sendto(u.historyKeeper,JSON.stringify(c)).then(function(){},function(e){console.error(e)})}else console.error("chan is undefined. we're going to have a problem here")}else a([])}(p,u.id,u.sig,u.count,i):function(e,n,t){var r=e.channels[n];if(r){r.onUserlistUpdate&&r.onUserlistUpdate();var o=e.store.proxy||{};t(r.wc.members.some(function(n){if(n!==e.store.network.historyKeeper){var t=r.mapId[n]||void 0;return!!t&&t.curvePublic!==o.curvePublic}}))}else t("NO_SUCH_CHANNEL")}(p,u,i):function(e,n,r){var o=t.once(t.mkAsync(r)),a=e.store.proxy,i=a.mutedUsers=a.mutedUsers||{};delete i[n],e.emit("UPDATE_MUTED",null,C(e)),o(Object.keys(i).length)}(p,u,i):function(e,n,r){var o=t.once(t.mkAsync(r)),a=e.store.proxy,i=a.mutedUsers=a.mutedUsers||{};i[n.curvePublic]||(i[n.curvePublic]=n,e.emit("UPDATE_MUTED",null,C(e))),o()}(p,u,i):function(e,n,r){var o=t.once(r);"function"==typeof o?e.Store.cancelFriendRequest(n,o):console.error("NO_CALLBACK")}(p,u,i):function(e,n,r){var a=t.once(r);if("function"==typeof a){var i=e.store.proxy,s=g(i,n);if(!s)return console.error("friend is not valid"),void a({error:"INVALID_FRIEND"});var c=e.channels[s.channel];if(e.store.mailbox&&s.curvePublic&&s.notifications)o.removeFriend(e.store,n,function(n){n&&n.error?a({error:n.error}):(e.updateMetadata(),a(n))});else if(c)try{var u=[d,i.curvePublic,+new Date],f=JSON.stringify(u),l=c.encrypt(f);c.wc.bcast(l).then(function(){x(e,n,s.channel),S(e,n,function(){a()})},function(t){t?a({error:t}):(x(e,n,s.channel),S(e,n,function(){a()}))})}catch(e){a({error:e})}else a({error:"NO_SUCH_CHANNEL"})}else console.error("NO_CALLBACK")}(p,u,i):function(e,n){var t=e.store.proxy||{};n({curvePublic:t.curvePublic,displayName:t[a.displayNameKey]})}(p,i):function(n,r,o,a){var i=o.channel,s=t.once(t.mkAsync(function(){n.emit("PADCHAT_READY",i,[r]),a()})),c=n.channels[i];if(c)c.onReady.reg(function(){-1===c.clients.indexOf(r)&&c.clients.push(r),s()});else{var u=o.secret;u.keys.cryptKey&&(u.keys.cryptKey=y(u.keys.cryptKey));var f=e.createEncryptor(u.keys),l=u.keys&&u.keys.validateKey||n.validateKeys[u.channel],d={padChan:o.secret&&o.secret.channel,readOnly:"object"==typeof u.keys&&!u.keys.validateKey,encryptor:f,channel:o.channel,isPadChat:!0,decrypt:function(e){return f.decrypt(e,l)},clients:[r],onReady:s};R(n,d)}}(p,n,u,i):function(e,n,t){var r=e.channels[n.id];if(r)if(r.isFriendChat){var o=O(e,n.id);if(!o)return void t({error:"NO_SUCH_FRIEND"});t([o])}else t([]);else t({error:"NO_SUCH_CHANNEL"})}(p,u,i):function(e,n){var t=e.store.proxy;if(!n)return t.mutedUsers||{};n(t.mutedUsers||{})}(p,i):function(e,n,t){var r=e.store.proxy;if(n&&n.curvePublic){var o=n.curvePublic,a=g(r,o);if(!a)return void t({error:"NO_SUCH_FRIEND"});var i=e.channels[a.channel];return i?void t([{id:i.id,isFriendChat:!0,name:a.displayName,lastKnownHash:a.lastKnownHash,curvePublic:a.curvePublic,messages:i.messages}]):void t({error:"NO_SUCH_CHANNEL"})}if(n&&n.padChat){var s=e.channels[n.padChat];return s?void t([{id:s.id,isPadChat:!0,messages:s.messages}]):void t({error:"NO_SUCH_CHANNEL"})}if(n&&n.teamChat){var c=e.channels[n.teamChat];return c?void t([{id:c.id,isTeamChat:!0,messages:c.messages}]):void t({error:"NO_SUCH_CHANNEL"})}var u=Object.keys(e.channels).map(function(n){var t,r,o,a=e.channels[n];if(a.isFriendChat){var i=O(e,n);if(!i)return null;t=i.displayName,r=i.lastKnownHash,o=i.curvePublic}else{if(a.isPadChat)return;if(a.isTeamChat)return}return{id:a.id,isFriendChat:a.isFriendChat,name:t,lastKnownHash:r,curvePublic:o,messages:a.messages}}).filter(function(e){return e});t(u)}(p,u,i):function(e,n,t){var r=E(e.store.proxy);s(function(t){Object.keys(r).forEach(function(o){if("me"!==o){var a=v(r[o]);"object"==typeof a&&a.channel&&P(e,n,a,t())}else delete r.me.channel})}).nThen(function(){-1===e.friendsClients.indexOf(n)&&e.friendsClients.push(n),t()})}(p,n,i)},u},u})(M(),te(),Z(),je(),On(),Y(),on(),qe()),Nt}function Ut(){if(Ct)return xt;Ct=1;return xt=((e,n,t,r)=>{const o={},a={};var i=function(n,t,o,a,i){var s,c=e.once(e.mkAsync(i)),u=function(n,t){if(!t)return e.find(n.store,["proxy","edPublic"]);var r=e.find(n,["store","proxy","teams",t]);return e.find(r,["keys","drive","edPublic"])}(n,a),f=n.Store,l=0,d=0,h=0;r(function(e){f.getFileSize(null,{channel:t},e(function(n){return n&&n.error?(e.abort(),void c(n)):void 0===n.size?(e.abort(),void c({error:"ENOENT"})):void(l=n.size)})),f.getHistory(null,{channel:t,lastKnownHash:o},e(function(n){if(n&&n.error)return e.abort(),void c(n);if(!Array.isArray(n))return e.abort(),void c({error:"EINVAL"});if(n.length){s=n[0].hash;var t=n.map(function(e){return e.msg});d=t.join("\n").length}}),!0),f.pad.getMetadata(null,{channel:t},e(function(n){if((!n||!n.error)&&n&&"object"==typeof n)return h=JSON.stringify(n).length,n&&Array.isArray(n.owners)&&-1!==n.owners.indexOf(u)?void 0:(e.abort(),void c({error:"INSUFFICIENT_PERMISSIONS"}))}))}).nThen(function(){c({size:l-h-d,hash:s})})};return a.GET_HISTORY_SIZE=function(o,a,s,c){if(o.store.loggedIn&&o.store.rpc){var u=a.channels;if(Array.isArray(u)){var f=[];a.account?u=function(r){var o=[],a=e.find(r.store,["proxy","edPublic"]);-1!==(e.find(r.store,["driveMetadata","owners"])||[]).indexOf(a)&&o.push(r.store.driveChannel);var i=r.store.proxy.profile;if(i){var s=i.edit?n.hrefToHexChannelId("/profile/#"+i.edit,null):null;s&&o.push(s)}r.store.proxy.todo&&o.push(n.hrefToHexChannelId("/todo/#"+r.store.proxy.todo,null));var c=r.store.proxy.mailboxes;if(c){var u=Object.keys(c).map(function(e){return{lastKnownHash:c[e].lastKnownHash,channel:c[e].channel}});Array.prototype.push.apply(o,u)}var f=r.store.proxy[t.SHARED_FOLDERS];if(f){var l=Object.keys(f).map(function(e){var n=f[e];if(n&&n.owners&&Array.isArray(n.owners)&&-1!==n.owners.indexOf(a))return n.channel}).filter(Boolean);Array.prototype.push.apply(o,l)}return o}(o):a.team&&(u=function(n,t){let r=e.find(n.store,["proxy","teams",t]);if(!r)return[];let o=[r.channel],a=r.keys.roster;return o.push({channel:a.channel,lastKnownHash:a.lastKnownHash}),o}(o,a.team));var l=0,d=[];r(function(e){u.forEach(function(n){var t,r=n;"object"==typeof n&&n.channel&&(r=n.channel,t=n.lastKnownHash),i(o,r,t,a.teamId,e(function(e){e&&e.error?f.push(e.error):(l+=e.size,e.hash&&d.push({channel:r,hash:e.hash}))}))})}).nThen(function(){c({warning:f.length?f:void 0,channels:d,size:l})})}else c({error:"EINVAL"})}else c({error:"INSUFFICIENT_PERMISSIONS"})},a.TRIM_HISTORY=function(e,n,t,o){if(e.store.loggedIn&&e.store.rpc){var a=n.channels;if(Array.isArray(a)){var i=function(e,n){if(!n)return e.store.rpc;var t=e.store.modules.team;if(t){var r=t.getTeam(n);if(r)return r.rpc}}(e,n.teamId);if(i){var s=[];r(function(e){a.forEach(function(n){i.trimHistory(n,e(function(e){e&&s.push(e)}))})}).nThen(function(){1===a.length&&s.length?o({error:s[0]}):o({warning:s.length?s:void 0})})}else o({error:"ENORPC"})}else o({error:"EINVAL"})}else o({error:"INSUFFICIENT_PERMISSIONS"})},o.init=function(e,n,t){var r={};if(e.store){var o={store:e.store,Store:e.Store,pinPads:e.pinPads,updateMetadata:e.updateMetadata,emit:t};return r.execCommand=function(e,n,t){var r=n.cmd,i=n.data;try{a[r](o,i,e,t)}catch(e){console.error(e)}},r}},o})(Z(),te(),Ue(),qe()),xt}var Bt,Vt={exports:{}};function Yt(){return Bt||(Bt=1,function(e){(()=>{const n=e=>{var n={};const t=globalThis;var r=function(){},o=n.getWeekNo=function(e,n){"number"!=typeof n&&(n=1);var t=new Date(e.getFullYear(),0,1),r=t.getDay()-n;r=r>=0?r:r+7;var o,a=Math.floor((e.getTime()-t.getTime())/864e5)+1;if(r<4){if((o=Math.floor((a+r-1)/7)+1)>52){var i=new Date(e.getFullYear()+1,0,1).getDay()-n;o=(i=i>=0?i:i+7)<4?1:53}}else o=Math.floor((a+r-1)/7);return o},a=function(e){var n=new Date(e.getFullYear(),0,0),t=e-n+60*(n.getTimezoneOffset()-e.getTimezoneOffset())*1e3;return Math.floor(t/864e5)},i=n.DAYORDER=["SU","MO","TU","WE","TH","FR","SA"],s=function(e){var n=Number(e.slice(0,-2)),t=i.indexOf(e.slice(-2));return n?[n,t]:t},c=function(e,n){var t=e.getDay();t>=(n="number"==typeof n?n:1)?e.setDate(e.getDate()-(t-n)):e.setDate(e.getDate()-(7+t-n))},u=function(e){return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()},f={daily:function(e,n){e.setDate(e.getDate()+n)},weekly:function(e,n){e.setDate(e.getDate()+7*n)},monthly:function(e,n){e.setMonth(e.getMonth()+n)},yearly:function(e,n){e.setFullYear(e.getFullYear()+n)}},l={month:function(e,n,t){var r=new Date(n.start),o=(t-(e.getMonth()+1)+12)%12,a=e.getMonth()+o;if(e.setMonth(a),e.setDate(r.getDate()),e.getMonth()===a)return!0},weekno:function(e,n,t,r){var a=r&&r.wkst;"number"!=typeof a&&(a=1);var i=new Date(n.start),s=new Date(e.getFullYear(),11,31),u=o(s,a),f=1===u;1===u&&(u=52);var l=o(e,a);if(!t||t>u)return!1;t<0&&(t=u+t+1);var d=t-l,h=new Date(+e);h.setDate(h.getDate()+7*d),c(h,a);var p="aaaaaaa".split("").map(function(n,t){var r=new Date(+h);if(r.setDate(r.getDate()+t),r.getFullYear()===e.getFullYear())return r.toLocaleDateString()!==i.toLocaleDateString()&&r}).filter(Boolean);return 1===t&&f&&(c(s,a),"aaaaaaa".split("").some(function(n,t){var r=new Date(+s);if(r.setDate(r.getDate()+t),r.toLocaleDateString()!==i.toLocaleDateString())return r.getFullYear()>e.getFullYear()||void p.push(r)})),p.length?p:void 0}};l.yearday=function(e,n,t){var r=e.getFullYear();if(function(e,n){if(!("number"!=typeof n||Math.abs(n)<1||Math.abs(n)>366))return n<0&&(n=a(new Date(e.getFullYear(),11,31))+n+1),e.setMonth(0),e.setDate(n),!0}(e,t)&&e.getFullYear()===r)return!0},l.monthday=function(e,n,t,r){if("number"!=typeof t||Math.abs(t)<1||Math.abs(t)>31)return!1;var o=function(e,n){var t=e.getMonth();n<0&&(n=new Date(e.getFullYear(),e.getMonth()+1,0).getDate()+n+1);return e.setDate(n),e.getMonth()===t};if("monthly"===r.freq)return o(e,t);var a="aaaaaaaaaaaa".split("").map(function(n,r){var a=new Date(e.getFullYear(),r,1);return o(a,t)?a:void 0}).filter(Boolean);return a.length?a:void 0},l.day=function(e,n,t,r){var o,a=s(t);Array.isArray(a)&&(o=a[0],a=a[1]);var i=[];if(![0,1,2,3,4,5,6].includes(a))return!1;var c,u=function(e){if(o){var n=[];"aaaaaaaaaaaa".split("").some(function(t,r){if(void 0===e||r===e){var a,s=i.filter(function(e){return e.getMonth()===r});return a=o<0?s.length+o:o-1,n.push(s[a]),void 0!==e&&r===e}}),i=n.filter(Boolean)}};if("yearly"===r.freq){c=new Date(+e);for(var f=e.getFullYear();c.getDay()!==a;)c.setDate(c.getDate()+1);for(;c.getFullYear()===f;)i.push(new Date(+c)),c.setDate(c.getDate()+7);return u(),i}if("monthly"===r.freq){c=new Date(+e);for(var l=e.getMonth();c.getDay()!==a;)c.setDate(c.getDate()+1);for(;c.getMonth()===l;)i.push(new Date(+c)),c.setDate(c.getDate()+7);return u(l),i}if("weekly"===r.freq)for(;e.getDay()!==a;)e.setDate(e.getDate()+1);return!0};var d={month:function(e,n){return e.filter(function(e){return n.includes(e.getMonth()+1)})},weekno:function(e,n,t){return e.filter(function(e){var r=t&&t.wkst;"number"!=typeof r&&(r=1);var a=new Date(e.getFullYear(),11,31),i=o(a,r);1===i&&(i=52);var s=o(e,r);return n.some(function(e){return e>0?e===s:s===i+e+1})})},yearday:function(e,n){return e.filter(function(e){var t=a(e),r=a(new Date(e.getFullYear(),11,31));return n.some(function(e){return e>0?e===t:t===r+e+1})})},monthday:function(n,t){return n.filter(function(n){var r=e.clone(t);return(r=r.map(function(e){e<0&&(e=new Date(n.getFullYear(),n.getMonth()+1,0).getDate()+e+1);return e})).includes(n.getDate())})},day:function(e,n,t){return e.filter(function(e){var r=e.toLocaleDateString(),o="yearly";return("monthly"===t.freq||"yearly"===t.freq&&t.by&&t.by.month)&&(o="monthly"),n.some(function(n){var t,a=s(n);if(Array.isArray(a)&&(t=a[0],a=a[1]),!t)return e.getDay()===a;var i=new Date(e.getFullYear(),e.getMonth(),1);return"yearly"===o&&i.setMonth(0),l.day(i,{},n,{freq:o}).some(function(e){return e.toLocaleDateString()===r})})})},setpos:function(n,t){var r=n.slice(),o=e.deduplicateString(t.slice().map(function(e){return e>0?e-1:0!==e?r.length+e:void 0}));return n.filter(function(e){var n=r.indexOf(e);return o.includes(n)})}},h=["month","weekno","yearday","monthday","day"],p=["month","monthday","day"];n.getMonthId=function(e){return e.getFullYear()+"-"+e.getMonth()};var v=t.CP_calendar_cache={},y={};n.resetCache=function(){v=t.CP_calendar_cache={},y={}};var m=function(n){if(!n.recUpdate)return[];var t={},r=n.recUpdate.from;return Object.keys(r||{}).forEach(function(e){var n=r[e];n.recurrenceRule&&(t[e]=n.recurrenceRule)}),Object.keys(t).sort(function(e,n){return Number(e)-Number(n)}).map(function(n){var r=e.clone(t[n]);if(f[r.freq]&&!(r.interval&&r.interval<1))return r._start=Number(n),r}).filter(Boolean)};n.getRecurring=function(o,i){t.CP_DEV_MODE&&(r=console.warn);var s=[];return o.forEach(function(t){var o=t.split("-"),g=new Date(o[0],o[1]),E=new Date(+g);E.setMonth(E.getMonth()+1),E.setMilliseconds(-1),r("Compute month",g.toLocaleDateString()),(i||[]).forEach(function(t){var o=new Date(t.start),i=new Date(t.end),b=t,O=t.recurrenceRule;if(O){var A=m(t),w=A.shift();if(!(o>=E)){for(var D=O.until,_=A.slice(),T=w;T&&T._start&&T._start<g;)D=w.until,T=_.shift();if(!(D<g)){var S=function(e,n){if(!(e>n)){var t;if(n.getFullYear()===e.getFullYear())t=a(n)-a(e);else{var r=new Date(e.getFullYear(),11,31);for(t=a(r)-a(e)+a(n);r.getFullYear()+1<n.getFullYear();)r.setFullYear(r.getFullYear()+1),t+=a(r)}return{h:n.getHours(),m:n.getMinutes(),days:t}}console.error("Wrong data")}(o,i);if(!(O.interval&&O.interval<1)&&f[O.freq]){r("Iterate over",t.title,t),r("Use rule",O);var N=O.count,I=1,x=function(a){var i=new Date(+a);if(!(N&&I>=N)){r("Start iteration",i.toLocaleDateString());var m=function(n,t,o){var a=e.clone(t),i=new Date(a.start),s=a.id.split("|")[0],u=o.toLocaleDateString();v[s]=v[s]||{};var y=n.interval||1,m=n.freq,g=[],E=function(e,t){g=d[e](g,t,n)},b=function(e){return function(t){var r=new Date(+o);"yearly"===n.freq?(r.setMonth(0),r.setDate(1)):"monthly"===n.freq?r.setDate(1):"weekly"===n.freq?c(r,n.wkst):n.freq;var s=l[e](r,a,t,n);if(s)if(Array.isArray(s))s=s.filter(function(e){return e.toLocaleDateString()!==i.toLocaleDateString()}),Array.prototype.push.apply(g,s);else{if(r.toLocaleDateString()===i.toLocaleDateString())return;g.push(r)}}},O=e.once(function(){f[m](o,y)}),A=function(){"monthly"===m?o.setDate(15):"yearly"===m&&1===i.getMonth()&&29===i.getDate()&&o.setDate(28),O();var e=new Date(+o);if("monthly"===m||"yearly"===m){if(e.setDate(i.getDate()),e.getDate()!==i.getDate())return;if("yearly"===m&&e.getMonth()!==i.getMonth())return}g.push(e)};if(Array.isArray(v[s][u]))return r("Get cache",s,u),"monthly"===m?o.setDate(15):"yearly"===m&&1===i.getMonth()&&29===i.getDate()&&o.setDate(28),O(),v[s][u];if(n.by&&"yearly"===m){var w=h.slice(),D=!1;(n.by.weekno||n.by.yearday||n.by.monthday||n.by.day)&&(w.shift(),D=!0);var _=!0;w.forEach(function(e){var t=n.by[e];t&&(_?(t.forEach(b(e)),_=!1):"day"===e?n.by.yearday||n.by.monthday||n.by.weekno?E("day",n.by.day):n.by.day.forEach(b("day")):E(e,t))}),n.by.month&&D&&E("month",n.by.month)}n.by&&"monthly"===m&&(n.by.monthday||n.by.day?n.by.monthday?n.by.monthday.forEach(b("monthday")):n.by.day&&n.by.day.forEach(b("day")):A(),n.by.month&&E("month",n.by.month),n.by.day&&n.by.monthday&&E("day",n.by.day)),n.by&&"weekly"===m&&(n.by.day?n.by.day.forEach(b("day")):A(),n.by.month&&E("month",n.by.month)),n.by&&"daily"===m&&(A(),p.forEach(function(e){var t=n.by[e];t&&E(e,t)})),g.sort(function(e,n){return e-n}),n.by&&n.by.setpos&&E("setpos",n.by.setpos),n.by&&Object.keys(n.by).length?O():A();var T=[];return g=g.filter(function(e){var n=new Date(+e).toLocaleDateString();return!T.includes(n)&&(T.push(n),!0)}),r("Set cache",s,u),v[s][u]=g,g}(O,t,i);if(r("Iteration results",JSON.stringify(m.map(function(e){return new Date(e).toLocaleDateString()}))),!m.length)return i.getFullYear()<g.getFullYear()||i<E?void x(i):void 0;var D=!1,_=!1;m.some(function(a){var c=e.clone(t);c.id=b.id+"|"+ +a;var f,l,d,h=new Date(+a),p=new Date(+a);f=h,d=S,(l=p).setTime(+f),d&&(l.setHours(d.h),l.setMinutes(d.m),l.setSeconds(0),l.setDate(f.getDate()+d.days)),c.start=+h,c.end=+p,c._count=I,n.applyUpdates([c]),h=new Date(c.start),p=new Date(c.end),c.isAllDay&&c.startDay&&(c.startDay=u(h)),c.isAllDay&&c.endDay&&(c.endDay=u(p)),w&&c.start===w._start&&(_=!0);var v=function(){_&&(r("Use new rule",w),c._count=I,N=w.count,I=1,i=+h,t=c,O=w,w=A.shift())};if(I>=N)return r(h.toLocaleDateString(),"count"),D=!0,!0;if(h>=E)return r(h.toLocaleDateString(),"endMonth"),D=!0,!0;if(O.until&&h>O.until)return r(h.toLocaleDateString(),"until"),D=!0,!0;if(!(h<o)){if(I++,p<g)return r(h.toLocaleDateString(),"startMonth"),void(_&&v());if(h<E&&p>=E||h<g&&p>=g){if(y[c.id]&&y[c.id].includes(c.start))return;y[c.id]=y[c.id]||[],y[c.id].push(c.start)}if(b.timeZone&&!c.isAllDay){var m=function(e,n,t){var r=function(e,n){let t=e.toLocaleString("en-CA",{timeZone:n,hour12:!1}).replace(", ","T");return t+="."+e.getMilliseconds().toString().padStart(3,"0"),-(new Date(t+"Z")-e)},o=Intl.DateTimeFormat().resolvedOptions().timeZone,a=r(n,e)-r(t,e);return r(n,o)-r(t,o)-a}(b.timeZone,o,h);c.start+=m,c.end+=m}return s.push(c),_?(v(),!0):void 0}r(h.toLocaleDateString(),"start")}),D||x(i)}};x(o),r("Added this month (all events)",s.map(function(e){return new Date(e.start).toLocaleDateString()}))}}}}})}),s},n.getAllOccurrences=function(e){if(!e.recurrenceRule)return[e.start];var t=e.recurrenceRule;if(!t.until&&!t.count)return!1;var r=[e.start],o=new Date(e.start);o.setDate(15);for(var a=[],i=0,s=function(){return t.count?r.length<t.count:+o<=t.until};(a=n.getRecurring([n.getMonthId(o)],[e]))&&s()&&i<12*t.count;)Array.prototype.push.apply(r,a.map(function(e){return e.start})),o.setMonth(o.getMonth()+1),i++;return r},n.diffDate=function(e,n){for(var t=new Date(n),r=new Date(e),o=0,a=t<r?-1:1;t.toLocaleDateString()!==r.toLocaleDateString()||a>=1e4;)t.setDate(t.getDate()-a),o++;return{d:o*=a,h:(t=new Date(n)).getHours()-r.getHours(),m:t.getMinutes()-r.getMinutes()}};return n.applyUpdates=function(e){return e.forEach(function(e){if(e.raw={start:e.start,end:e.end},e.recUpdate){var n,t=e.recUpdate.from||{},r=e.recUpdate.one||{},o=e.start,a=m(e).filter(function(e){return e._start>o}).shift(),i=function(n,t){var r=n[t],o=new Date(e.raw[t]);o.setDate(o.getDate()+r.d),o.setHours(o.getHours()+r.h),o.setMinutes(o.getMinutes()+r.m),e[t]=+o};(n=t,Object.keys(n).sort(function(e,n){return Number(e)-Number(n)})).forEach(function(n){o<Number(n)||Object.keys(t[n]).forEach(function(r){"start"!==r&&"end"!==r?("recurrenceRule"!==r||t[n][r])&&(e[r]=t[n][r]):i(t[n],r)})}),Object.keys(r[o]||{}).forEach(function(n){"start"!==n&&"end"!==n?("recurrenceRule"!==n||r[o][n])&&(e[n]=r[o][n]):i(r[o],n)}),e.deleted&&Object.keys(e).forEach(function(n){delete e[n]}),a&&e.recurrenceRule&&(e.recurrenceRule._next=a._start-1),e.reminders&&(e.raw.reminders=e.reminders)}}),e},n};e.exports&&(e.exports=n(Z()))})()}(Vt)),Vt.exports}var Gt,Jt,qt,Wt={exports:{}};function zt(){return Gt||(Gt=1,function(e){e.exports=function(){var e=function(){return(e=Object.assign||function(e){for(var n,t=1,r=arguments.length;t<r;t++)for(var o in n=arguments[t])Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o]);return e}).apply(this,arguments)};function n(){for(var e=0,n=0,t=arguments.length;n<t;n++)e+=arguments[n].length;var r=Array(e),o=0;for(n=0;n<t;n++)for(var a=arguments[n],i=0,s=a.length;i<s;i++,o++)r[o]=a[i];return r}var t=["onChange","onClose","onDayCreate","onDestroy","onKeyDown","onMonthChange","onOpen","onParseConfig","onReady","onValueUpdate","onYearChange","onPreCalendarPosition"],r={_disable:[],allowInput:!1,allowInvalidPreload:!1,altFormat:"F j, Y",altInput:!1,altInputClass:"form-control input",animate:"object"==typeof window&&-1===window.navigator.userAgent.indexOf("MSIE"),ariaDateFormat:"F j, Y",autoFillDefaultTime:!0,clickOpens:!0,closeOnSelect:!0,conjunction:", ",dateFormat:"Y-m-d",defaultHour:12,defaultMinute:0,defaultSeconds:0,disable:[],disableMobile:!1,enableSeconds:!1,enableTime:!1,errorHandler:function(e){return"undefined"!=typeof console&&console.warn(e)},getWeek:function(e){var n=new Date(e.getTime());n.setHours(0,0,0,0),n.setDate(n.getDate()+3-(n.getDay()+6)%7);var t=new Date(n.getFullYear(),0,4);return 1+Math.round(((n.getTime()-t.getTime())/864e5-3+(t.getDay()+6)%7)/7)},hourIncrement:1,ignoredFocusElements:[],inline:!1,locale:"default",minuteIncrement:5,mode:"single",monthSelectorType:"dropdown",nextArrow:"<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' viewBox='0 0 17 17'><g></g><path d='M13.207 8.472l-7.854 7.854-0.707-0.707 7.146-7.146-7.146-7.148 0.707-0.707 7.854 7.854z' /></svg>",noCalendar:!1,now:new Date,onChange:[],onClose:[],onDayCreate:[],onDestroy:[],onKeyDown:[],onMonthChange:[],onOpen:[],onParseConfig:[],onReady:[],onValueUpdate:[],onYearChange:[],onPreCalendarPosition:[],plugins:[],position:"auto",positionElement:void 0,prevArrow:"<svg version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' viewBox='0 0 17 17'><g></g><path d='M5.207 8.471l7.146 7.147-0.707 0.707-7.853-7.854 7.854-7.853 0.707 0.707-7.147 7.146z' /></svg>",shorthandCurrentMonth:!1,showMonths:1,static:!1,time_24hr:!1,weekNumbers:!1,wrap:!1},o={weekdays:{shorthand:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],longhand:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},months:{shorthand:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],longhand:["January","February","March","April","May","June","July","August","September","October","November","December"]},daysInMonth:[31,28,31,30,31,30,31,31,30,31,30,31],firstDayOfWeek:0,ordinal:function(e){var n=e%100;if(n>3&&n<21)return"th";switch(n%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}},rangeSeparator:" to ",weekAbbreviation:"Wk",scrollTitle:"Scroll to increment",toggleTitle:"Click to toggle",amPM:["AM","PM"],yearAriaLabel:"Year",monthAriaLabel:"Month",hourAriaLabel:"Hour",minuteAriaLabel:"Minute",time_24hr:!1},a=function(e,n){return void 0===n&&(n=2),("000"+e).slice(-1*n)},i=function(e){return!0===e?1:0};function s(e,n){var t;return function(){var r=this;clearTimeout(t),t=setTimeout(function(){return e.apply(r,arguments)},n)}}var c=function(e){return e instanceof Array?e:[e]};function u(e,n,t){if(!0===t)return e.classList.add(n);e.classList.remove(n)}function f(e,n,t){var r=window.document.createElement(e);return n=n||"",t=t||"",r.className=n,void 0!==t&&(r.textContent=t),r}function l(e){for(;e.firstChild;)e.removeChild(e.firstChild)}function d(e,n){return n(e)?e:e.parentNode?d(e.parentNode,n):void 0}function h(e,n){var t=f("div","numInputWrapper"),r=f("input","numInput "+e),o=f("span","arrowUp"),a=f("span","arrowDown");if(-1===navigator.userAgent.indexOf("MSIE 9.0")?r.type="number":(r.type="text",r.pattern="\\d*"),void 0!==n)for(var i in n)r.setAttribute(i,n[i]);return t.appendChild(r),t.appendChild(o),t.appendChild(a),t}function p(e){try{return"function"==typeof e.composedPath?e.composedPath()[0]:e.target}catch(n){return e.target}}var v=function(){},y=function(e,n,t){return t.months[n?"shorthand":"longhand"][e]},m={D:v,F:function(e,n,t){e.setMonth(t.months.longhand.indexOf(n))},G:function(e,n){e.setHours(parseFloat(n))},H:function(e,n){e.setHours(parseFloat(n))},J:function(e,n){e.setDate(parseFloat(n))},K:function(e,n,t){e.setHours(e.getHours()%12+12*i(new RegExp(t.amPM[1],"i").test(n)))},M:function(e,n,t){e.setMonth(t.months.shorthand.indexOf(n))},S:function(e,n){e.setSeconds(parseFloat(n))},U:function(e,n){return new Date(1e3*parseFloat(n))},W:function(e,n,t){var r=parseInt(n),o=new Date(e.getFullYear(),0,2+7*(r-1),0,0,0,0);return o.setDate(o.getDate()-o.getDay()+t.firstDayOfWeek),o},Y:function(e,n){e.setFullYear(parseFloat(n))},Z:function(e,n){return new Date(n)},d:function(e,n){e.setDate(parseFloat(n))},h:function(e,n){e.setHours(parseFloat(n))},i:function(e,n){e.setMinutes(parseFloat(n))},j:function(e,n){e.setDate(parseFloat(n))},l:v,m:function(e,n){e.setMonth(parseFloat(n)-1)},n:function(e,n){e.setMonth(parseFloat(n)-1)},s:function(e,n){e.setSeconds(parseFloat(n))},u:function(e,n){return new Date(parseFloat(n))},w:v,y:function(e,n){e.setFullYear(2e3+parseFloat(n))}},g={D:"(\\w+)",F:"(\\w+)",G:"(\\d\\d|\\d)",H:"(\\d\\d|\\d)",J:"(\\d\\d|\\d)\\w+",K:"",M:"(\\w+)",S:"(\\d\\d|\\d)",U:"(.+)",W:"(\\d\\d|\\d)",Y:"(\\d{4})",Z:"(.+)",d:"(\\d\\d|\\d)",h:"(\\d\\d|\\d)",i:"(\\d\\d|\\d)",j:"(\\d\\d|\\d)",l:"(\\w+)",m:"(\\d\\d|\\d)",n:"(\\d\\d|\\d)",s:"(\\d\\d|\\d)",u:"(.+)",w:"(\\d\\d|\\d)",y:"(\\d{2})"},E={Z:function(e){return e.toISOString()},D:function(e,n,t){return n.weekdays.shorthand[E.w(e,n,t)]},F:function(e,n,t){return y(E.n(e,n,t)-1,!1,n)},G:function(e,n,t){return a(E.h(e,n,t))},H:function(e){return a(e.getHours())},J:function(e,n){return void 0!==n.ordinal?e.getDate()+n.ordinal(e.getDate()):e.getDate()},K:function(e,n){return n.amPM[i(e.getHours()>11)]},M:function(e,n){return y(e.getMonth(),!0,n)},S:function(e){return a(e.getSeconds())},U:function(e){return e.getTime()/1e3},W:function(e,n,t){return t.getWeek(e)},Y:function(e){return a(e.getFullYear(),4)},d:function(e){return a(e.getDate())},h:function(e){return e.getHours()%12?e.getHours()%12:12},i:function(e){return a(e.getMinutes())},j:function(e){return e.getDate()},l:function(e,n){return n.weekdays.longhand[e.getDay()]},m:function(e){return a(e.getMonth()+1)},n:function(e){return e.getMonth()+1},s:function(e){return e.getSeconds()},u:function(e){return e.getTime()},w:function(e){return e.getDay()},y:function(e){return String(e.getFullYear()).substring(2)}},b=function(e){var n=e.config,t=void 0===n?r:n,a=e.l10n,i=void 0===a?o:a,s=e.isMobile,c=void 0!==s&&s;return function(e,n,r){var o=r||i;return void 0===t.formatDate||c?n.split("").map(function(n,r,a){return E[n]&&"\\"!==a[r-1]?E[n](e,o,t):"\\"!==n?n:""}).join(""):t.formatDate(e,n,o)}},O=function(e){var n=e.config,t=void 0===n?r:n,a=e.l10n,i=void 0===a?o:a;return function(e,n,o,a){if(0===e||e){var s,c=a||i,u=e;if(e instanceof Date)s=new Date(e.getTime());else if("string"!=typeof e&&void 0!==e.toFixed)s=new Date(e);else if("string"==typeof e){var f=n||(t||r).dateFormat,l=String(e).trim();if("today"===l)s=new Date,o=!0;else if(/Z$/.test(l)||/GMT$/.test(l))s=new Date(e);else if(t&&t.parseDate)s=t.parseDate(e,f);else{s=t&&t.noCalendar?new Date((new Date).setHours(0,0,0,0)):new Date((new Date).getFullYear(),0,1,0,0,0,0);for(var d=void 0,h=[],p=0,v=0,y="";p<f.length;p++){var E=f[p],b="\\"===E,O="\\"===f[p-1]||b;if(g[E]&&!O){y+=g[E];var A=new RegExp(y).exec(e);A&&(d=!0)&&h["Y"!==E?"push":"unshift"]({fn:m[E],val:A[++v]})}else b||(y+=".");h.forEach(function(e){var n=e.fn,t=e.val;return s=n(s,t,c)||s})}s=d?s:void 0}}if(s instanceof Date&&!isNaN(s.getTime()))return!0===o&&s.setHours(0,0,0,0),s;t.errorHandler(new Error("Invalid date provided: "+u))}}};function A(e,n,t){return void 0===t&&(t=!0),!1!==t?new Date(e.getTime()).setHours(0,0,0,0)-new Date(n.getTime()).setHours(0,0,0,0):e.getTime()-n.getTime()}var w=864e5;function D(e){var n=e.defaultHour,t=e.defaultMinute,r=e.defaultSeconds;if(void 0!==e.minDate){var o=e.minDate.getHours(),a=e.minDate.getMinutes(),i=e.minDate.getSeconds();n<o&&(n=o),n===o&&t<a&&(t=a),n===o&&t===a&&r<i&&(r=e.minDate.getSeconds())}if(void 0!==e.maxDate){var s=e.maxDate.getHours(),c=e.maxDate.getMinutes();(n=Math.min(n,s))===s&&(t=Math.min(c,t)),n===s&&t===c&&(r=e.maxDate.getSeconds())}return{hours:n,minutes:t,seconds:r}}function _(v,m){var E={config:e(e({},r),S.defaultConfig),l10n:o};function _(e){return e.bind(E)}function T(){var e=E.config;!1===e.weekNumbers&&1===e.showMonths||!0!==e.noCalendar&&window.requestAnimationFrame(function(){if(void 0!==E.calendarContainer&&(E.calendarContainer.style.visibility="hidden",E.calendarContainer.style.display="block"),void 0!==E.daysContainer){var n=(E.days.offsetWidth+1)*e.showMonths;E.daysContainer.style.width=n+"px",E.calendarContainer.style.width=n+(void 0!==E.weekWrapper?E.weekWrapper.offsetWidth:0)+"px",E.calendarContainer.style.removeProperty("visibility"),E.calendarContainer.style.removeProperty("display")}})}function N(e){if(0===E.selectedDates.length){var n=void 0===E.config.minDate||A(new Date,E.config.minDate)>=0?new Date:new Date(E.config.minDate.getTime()),t=D(E.config);n.setHours(t.hours,t.minutes,t.seconds,n.getMilliseconds()),E.selectedDates=[n],E.latestSelectedDateObj=n}void 0!==e&&"blur"!==e.type&&function(e){e.preventDefault();var n="keydown"===e.type,t=p(e),r=t;void 0!==E.amPM&&t===E.amPM&&(E.amPM.textContent=E.l10n.amPM[i(E.amPM.textContent===E.l10n.amPM[0])]);var o=parseFloat(r.getAttribute("min")),s=parseFloat(r.getAttribute("max")),c=parseFloat(r.getAttribute("step")),u=parseInt(r.value,10),f=u+c*(e.delta||(n?38===e.which?1:-1:0));if(void 0!==r.value&&2===r.value.length){var l=r===E.hourElement,d=r===E.minuteElement;f<o?(f=s+f+i(!l)+(i(l)&&i(!E.amPM)),d&&L(void 0,-1,E.hourElement)):f>s&&(f=r===E.hourElement?f-s-i(!E.amPM):o,d&&L(void 0,1,E.hourElement)),E.amPM&&l&&(1===c?f+u===23:Math.abs(f-u)>c)&&(E.amPM.textContent=E.l10n.amPM[i(E.amPM.textContent===E.l10n.amPM[0])]),r.value=a(f)}}(e);var r=E._input.value;I(),be(),E._input.value!==r&&E._debouncedChange()}function I(){if(void 0!==E.hourElement&&void 0!==E.minuteElement){var e,n,t=(parseInt(E.hourElement.value.slice(-2),10)||0)%24,r=(parseInt(E.minuteElement.value,10)||0)%60,o=void 0!==E.secondElement?(parseInt(E.secondElement.value,10)||0)%60:0;void 0!==E.amPM&&(e=t,n=E.amPM.textContent,t=e%12+12*i(n===E.l10n.amPM[1]));var a=void 0!==E.config.minTime||E.config.minDate&&E.minDateHasTime&&E.latestSelectedDateObj&&0===A(E.latestSelectedDateObj,E.config.minDate,!0);if(void 0!==E.config.maxTime||E.config.maxDate&&E.maxDateHasTime&&E.latestSelectedDateObj&&0===A(E.latestSelectedDateObj,E.config.maxDate,!0)){var s=void 0!==E.config.maxTime?E.config.maxTime:E.config.maxDate;(t=Math.min(t,s.getHours()))===s.getHours()&&(r=Math.min(r,s.getMinutes())),r===s.getMinutes()&&(o=Math.min(o,s.getSeconds()))}if(a){var c=void 0!==E.config.minTime?E.config.minTime:E.config.minDate;(t=Math.max(t,c.getHours()))===c.getHours()&&r<c.getMinutes()&&(r=c.getMinutes()),r===c.getMinutes()&&(o=Math.max(o,c.getSeconds()))}C(t,r,o)}}function x(e){var n=e||E.latestSelectedDateObj;n&&C(n.getHours(),n.getMinutes(),n.getSeconds())}function C(e,n,t){void 0!==E.latestSelectedDateObj&&E.latestSelectedDateObj.setHours(e%24,n,t||0,0),E.hourElement&&E.minuteElement&&!E.isMobile&&(E.hourElement.value=a(E.config.time_24hr?e:(12+e)%12+12*i(e%12==0)),E.minuteElement.value=a(n),void 0!==E.amPM&&(E.amPM.textContent=E.l10n.amPM[i(e>=12)]),void 0!==E.secondElement&&(E.secondElement.value=a(t)))}function R(e){var n=p(e),t=parseInt(n.value)+(e.delta||0);(t/1e3>1||"Enter"===e.key&&!/[^\d]/.test(t.toString()))&&X(t)}function P(e,n,t,r){return n instanceof Array?n.forEach(function(n){return P(e,n,t,r)}):e instanceof Array?e.forEach(function(e){return P(e,n,t,r)}):(e.addEventListener(n,t,r),void E._handlers.push({remove:function(){return e.removeEventListener(n,t)}}))}function k(){ve("onChange")}function M(e,n){var t=void 0!==e?E.parseDate(e):E.latestSelectedDateObj||(E.config.minDate&&E.config.minDate>E.now?E.config.minDate:E.config.maxDate&&E.config.maxDate<E.now?E.config.maxDate:E.now),r=E.currentYear,o=E.currentMonth;try{void 0!==t&&(E.currentYear=t.getFullYear(),E.currentMonth=t.getMonth())}catch(e){e.message="Invalid date supplied: "+t,E.config.errorHandler(e)}n&&E.currentYear!==r&&(ve("onYearChange"),Y()),!n||E.currentYear===r&&E.currentMonth===o||ve("onMonthChange"),E.redraw()}function F(e){var n=p(e);~n.className.indexOf("arrow")&&L(e,n.classList.contains("arrowUp")?1:-1)}function L(e,n,t){var r=e&&p(e),o=t||r&&r.parentNode&&r.parentNode.firstChild,a=ye("increment");a.delta=n,o&&o.dispatchEvent(a)}function H(e,n,t,r){var o=$(n,!0),a=f("span","flatpickr-day "+e,n.getDate().toString());return a.dateObj=n,a.$i=r,a.setAttribute("aria-label",E.formatDate(n,E.config.ariaDateFormat)),-1===e.indexOf("hidden")&&0===A(n,E.now)&&(E.todayDateElem=a,a.classList.add("today"),a.setAttribute("aria-current","date")),o?(a.tabIndex=-1,me(n)&&(a.classList.add("selected"),E.selectedDateElem=a,"range"===E.config.mode&&(u(a,"startRange",E.selectedDates[0]&&0===A(n,E.selectedDates[0],!0)),u(a,"endRange",E.selectedDates[1]&&0===A(n,E.selectedDates[1],!0)),"nextMonthDay"===e&&a.classList.add("inRange")))):a.classList.add("flatpickr-disabled"),"range"===E.config.mode&&function(e){return!("range"!==E.config.mode||E.selectedDates.length<2)&&A(e,E.selectedDates[0])>=0&&A(e,E.selectedDates[1])<=0}(n)&&!me(n)&&a.classList.add("inRange"),E.weekNumbers&&1===E.config.showMonths&&"prevMonthDay"!==e&&t%7==1&&E.weekNumbers.insertAdjacentHTML("beforeend","<span class='flatpickr-day'>"+E.config.getWeek(n)+"</span>"),ve("onDayCreate",a),a}function j(e){e.focus(),"range"===E.config.mode&&re(e)}function K(e){for(var n=e>0?0:E.config.showMonths-1,t=e>0?E.config.showMonths:-1,r=n;r!=t;r+=e)for(var o=E.daysContainer.children[r],a=e>0?0:o.children.length-1,i=e>0?o.children.length:-1,s=a;s!=i;s+=e){var c=o.children[s];if(-1===c.className.indexOf("hidden")&&$(c.dateObj))return c}}function U(e,n){var t=ee(document.activeElement||document.body),r=void 0!==e?e:t?document.activeElement:void 0!==E.selectedDateElem&&ee(E.selectedDateElem)?E.selectedDateElem:void 0!==E.todayDateElem&&ee(E.todayDateElem)?E.todayDateElem:K(n>0?1:-1);void 0===r?E._input.focus():t?function(e,n){for(var t=-1===e.className.indexOf("Month")?e.dateObj.getMonth():E.currentMonth,r=n>0?E.config.showMonths:-1,o=n>0?1:-1,a=t-E.currentMonth;a!=r;a+=o)for(var i=E.daysContainer.children[a],s=t-E.currentMonth===a?e.$i+n:n<0?i.children.length-1:0,c=i.children.length,u=s;u>=0&&u<c&&u!=(n>0?c:-1);u+=o){var f=i.children[u];if(-1===f.className.indexOf("hidden")&&$(f.dateObj)&&Math.abs(e.$i-u)>=Math.abs(n))return j(f)}E.changeMonth(o),U(K(o),0)}(r,n):j(r)}function B(e,n){for(var t=(new Date(e,n,1).getDay()-E.l10n.firstDayOfWeek+7)%7,r=E.utils.getDaysInMonth((n-1+12)%12,e),o=E.utils.getDaysInMonth(n,e),a=window.document.createDocumentFragment(),i=E.config.showMonths>1,s=i?"prevMonthDay hidden":"prevMonthDay",c=i?"nextMonthDay hidden":"nextMonthDay",u=r+1-t,l=0;u<=r;u++,l++)a.appendChild(H(s,new Date(e,n-1,u),u,l));for(u=1;u<=o;u++,l++)a.appendChild(H("",new Date(e,n,u),u,l));for(var d=o+1;d<=42-t&&(1===E.config.showMonths||l%7!=0);d++,l++)a.appendChild(H(c,new Date(e,n+1,d%o),d,l));var h=f("div","dayContainer");return h.appendChild(a),h}function V(){if(void 0!==E.daysContainer){l(E.daysContainer),E.weekNumbers&&l(E.weekNumbers);for(var e=document.createDocumentFragment(),n=0;n<E.config.showMonths;n++){var t=new Date(E.currentYear,E.currentMonth,1);t.setMonth(E.currentMonth+n),e.appendChild(B(t.getFullYear(),t.getMonth()))}E.daysContainer.appendChild(e),E.days=E.daysContainer.firstChild,"range"===E.config.mode&&1===E.selectedDates.length&&re()}}function Y(){if(!(E.config.showMonths>1||"dropdown"!==E.config.monthSelectorType)){var e=function(e){return!(void 0!==E.config.minDate&&E.currentYear===E.config.minDate.getFullYear()&&e<E.config.minDate.getMonth()||void 0!==E.config.maxDate&&E.currentYear===E.config.maxDate.getFullYear()&&e>E.config.maxDate.getMonth())};E.monthsDropdownContainer.tabIndex=-1,E.monthsDropdownContainer.innerHTML="";for(var n=0;n<12;n++)if(e(n)){var t=f("option","flatpickr-monthDropdown-month");t.value=new Date(E.currentYear,n).getMonth().toString(),t.textContent=y(n,E.config.shorthandCurrentMonth,E.l10n),t.tabIndex=-1,E.currentMonth===n&&(t.selected=!0),E.monthsDropdownContainer.appendChild(t)}}}function G(){var e,n=f("div","flatpickr-month"),t=window.document.createDocumentFragment();E.config.showMonths>1||"static"===E.config.monthSelectorType?e=f("span","cur-month"):(E.monthsDropdownContainer=f("select","flatpickr-monthDropdown-months"),E.monthsDropdownContainer.setAttribute("aria-label",E.l10n.monthAriaLabel),P(E.monthsDropdownContainer,"change",function(e){var n=p(e),t=parseInt(n.value,10);E.changeMonth(t-E.currentMonth),ve("onMonthChange")}),Y(),e=E.monthsDropdownContainer);var r=h("cur-year",{tabindex:"-1"}),o=r.getElementsByTagName("input")[0];o.setAttribute("aria-label",E.l10n.yearAriaLabel),E.config.minDate&&o.setAttribute("min",E.config.minDate.getFullYear().toString()),E.config.maxDate&&(o.setAttribute("max",E.config.maxDate.getFullYear().toString()),o.disabled=!!E.config.minDate&&E.config.minDate.getFullYear()===E.config.maxDate.getFullYear());var a=f("div","flatpickr-current-month");return a.appendChild(e),a.appendChild(r),t.appendChild(a),n.appendChild(t),{container:n,yearElement:o,monthElement:e}}function J(){l(E.monthNav),E.monthNav.appendChild(E.prevMonthNav),E.config.showMonths&&(E.yearElements=[],E.monthElements=[]);for(var e=E.config.showMonths;e--;){var n=G();E.yearElements.push(n.yearElement),E.monthElements.push(n.monthElement),E.monthNav.appendChild(n.container)}E.monthNav.appendChild(E.nextMonthNav)}function q(){E.weekdayContainer?l(E.weekdayContainer):E.weekdayContainer=f("div","flatpickr-weekdays");for(var e=E.config.showMonths;e--;){var n=f("div","flatpickr-weekdaycontainer");E.weekdayContainer.appendChild(n)}return W(),E.weekdayContainer}function W(){if(E.weekdayContainer){var e=E.l10n.firstDayOfWeek,t=n(E.l10n.weekdays.shorthand);e>0&&e<t.length&&(t=n(t.splice(e,t.length),t.splice(0,e)));for(var r=E.config.showMonths;r--;)E.weekdayContainer.children[r].innerHTML="\n      <span class='flatpickr-weekday'>\n        "+t.join("</span><span class='flatpickr-weekday'>")+"\n      </span>\n      "}}function z(e,n){void 0===n&&(n=!0);var t=n?e:e-E.currentMonth;t<0&&!0===E._hidePrevMonthArrow||t>0&&!0===E._hideNextMonthArrow||(E.currentMonth+=t,(E.currentMonth<0||E.currentMonth>11)&&(E.currentYear+=E.currentMonth>11?1:-1,E.currentMonth=(E.currentMonth+12)%12,ve("onYearChange"),Y()),V(),ve("onMonthChange"),ge())}function Q(e){return!(!E.config.appendTo||!E.config.appendTo.contains(e))||E.calendarContainer.contains(e)}function Z(e){if(E.isOpen&&!E.config.inline){var n=p(e),t=Q(n),r=n===E.input||n===E.altInput||E.element.contains(n)||e.path&&e.path.indexOf&&(~e.path.indexOf(E.input)||~e.path.indexOf(E.altInput)),o="blur"===e.type?r&&e.relatedTarget&&!Q(e.relatedTarget):!r&&!t&&!Q(e.relatedTarget),a=!E.config.ignoredFocusElements.some(function(e){return e.contains(n)});o&&a&&(void 0!==E.timeContainer&&void 0!==E.minuteElement&&void 0!==E.hourElement&&""!==E.input.value&&void 0!==E.input.value&&N(),E.close(),E.config&&"range"===E.config.mode&&1===E.selectedDates.length&&(E.clear(!1),E.redraw()))}}function X(e){if(!(!e||E.config.minDate&&e<E.config.minDate.getFullYear()||E.config.maxDate&&e>E.config.maxDate.getFullYear())){var n=e,t=E.currentYear!==n;E.currentYear=n||E.currentYear,E.config.maxDate&&E.currentYear===E.config.maxDate.getFullYear()?E.currentMonth=Math.min(E.config.maxDate.getMonth(),E.currentMonth):E.config.minDate&&E.currentYear===E.config.minDate.getFullYear()&&(E.currentMonth=Math.max(E.config.minDate.getMonth(),E.currentMonth)),t&&(E.redraw(),ve("onYearChange"),Y())}}function $(e,n){var t;void 0===n&&(n=!0);var r=E.parseDate(e,void 0,n);if(E.config.minDate&&r&&A(r,E.config.minDate,void 0!==n?n:!E.minDateHasTime)<0||E.config.maxDate&&r&&A(r,E.config.maxDate,void 0!==n?n:!E.maxDateHasTime)>0)return!1;if(!E.config.enable&&0===E.config.disable.length)return!0;if(void 0===r)return!1;for(var o=!!E.config.enable,a=null!==(t=E.config.enable)&&void 0!==t?t:E.config.disable,i=0,s=void 0;i<a.length;i++){if("function"==typeof(s=a[i])&&s(r))return o;if(s instanceof Date&&void 0!==r&&s.getTime()===r.getTime())return o;if("string"==typeof s){var c=E.parseDate(s,void 0,!0);return c&&c.getTime()===r.getTime()?o:!o}if("object"==typeof s&&void 0!==r&&s.from&&s.to&&r.getTime()>=s.from.getTime()&&r.getTime()<=s.to.getTime())return o}return!o}function ee(e){return void 0!==E.daysContainer&&-1===e.className.indexOf("hidden")&&-1===e.className.indexOf("flatpickr-disabled")&&E.daysContainer.contains(e)}function ne(e){e.target!==E._input||!(E.selectedDates.length>0||E._input.value.length>0)||e.relatedTarget&&Q(e.relatedTarget)||E.setDate(E._input.value,!0,e.target===E.altInput?E.config.altFormat:E.config.dateFormat)}function te(e){var n=p(e),t=E.config.wrap?v.contains(n):n===E._input,r=E.config.allowInput,o=E.isOpen&&(!r||!t),a=E.config.inline&&t&&!r;if(13===e.keyCode&&t){if(r)return E.setDate(E._input.value,!0,n===E.altInput?E.config.altFormat:E.config.dateFormat),n.blur();E.open()}else if(Q(n)||o||a){var i=!!E.timeContainer&&E.timeContainer.contains(n);switch(e.keyCode){case 13:i?(e.preventDefault(),N(),fe()):le(e);break;case 27:e.preventDefault(),fe();break;case 8:case 46:t&&!E.config.allowInput&&(e.preventDefault(),E.clear());break;case 37:case 39:if(i||t)E.hourElement&&E.hourElement.focus();else if(e.preventDefault(),void 0!==E.daysContainer&&(!1===r||document.activeElement&&ee(document.activeElement))){var s=39===e.keyCode?1:-1;e.ctrlKey?(e.stopPropagation(),z(s),U(K(1),0)):U(void 0,s)}break;case 38:case 40:e.preventDefault();var c=40===e.keyCode?1:-1;E.daysContainer&&void 0!==n.$i||n===E.input||n===E.altInput?e.ctrlKey?(e.stopPropagation(),X(E.currentYear-c),U(K(1),0)):i||U(void 0,7*c):n===E.currentYearElement?X(E.currentYear-c):E.config.enableTime&&(!i&&E.hourElement&&E.hourElement.focus(),N(e),E._debouncedChange());break;case 9:if(i){var u=[E.hourElement,E.minuteElement,E.secondElement,E.amPM].concat(E.pluginElements).filter(function(e){return e}),f=u.indexOf(n);if(-1!==f){var l=u[f+(e.shiftKey?-1:1)];e.preventDefault(),(l||E._input).focus()}}else!E.config.noCalendar&&E.daysContainer&&E.daysContainer.contains(n)&&e.shiftKey&&(e.preventDefault(),E._input.focus())}}if(void 0!==E.amPM&&n===E.amPM)switch(e.key){case E.l10n.amPM[0].charAt(0):case E.l10n.amPM[0].charAt(0).toLowerCase():E.amPM.textContent=E.l10n.amPM[0],I(),be();break;case E.l10n.amPM[1].charAt(0):case E.l10n.amPM[1].charAt(0).toLowerCase():E.amPM.textContent=E.l10n.amPM[1],I(),be()}(t||Q(n))&&ve("onKeyDown",e)}function re(e){if(1===E.selectedDates.length&&(!e||e.classList.contains("flatpickr-day")&&!e.classList.contains("flatpickr-disabled"))){for(var n=e?e.dateObj.getTime():E.days.firstElementChild.dateObj.getTime(),t=E.parseDate(E.selectedDates[0],void 0,!0).getTime(),r=Math.min(n,E.selectedDates[0].getTime()),o=Math.max(n,E.selectedDates[0].getTime()),a=!1,i=0,s=0,c=r;c<o;c+=w)$(new Date(c),!0)||(a=a||c>r&&c<o,c<t&&(!i||c>i)?i=c:c>t&&(!s||c<s)&&(s=c));for(var u=0;u<E.config.showMonths;u++)for(var f=E.daysContainer.children[u],l=function(r,o){var c,u,l,d=f.children[r],h=d.dateObj.getTime(),p=i>0&&h<i||s>0&&h>s;return p?(d.classList.add("notAllowed"),["inRange","startRange","endRange"].forEach(function(e){d.classList.remove(e)}),"continue"):a&&!p?"continue":(["startRange","inRange","endRange","notAllowed"].forEach(function(e){d.classList.remove(e)}),void(void 0!==e&&(e.classList.add(n<=E.selectedDates[0].getTime()?"startRange":"endRange"),t<n&&h===t?d.classList.add("startRange"):t>n&&h===t&&d.classList.add("endRange"),h>=i&&(0===s||h<=s)&&(u=t,l=n,(c=h)>Math.min(u,l)&&c<Math.max(u,l))&&d.classList.add("inRange"))))},d=0,h=f.children.length;d<h;d++)l(d)}}function oe(){!E.isOpen||E.config.static||E.config.inline||ce()}function ae(e){return function(n){var t=E.config["_"+e+"Date"]=E.parseDate(n,E.config.dateFormat),r=E.config["_"+("min"===e?"max":"min")+"Date"];void 0!==t&&(E["min"===e?"minDateHasTime":"maxDateHasTime"]=t.getHours()>0||t.getMinutes()>0||t.getSeconds()>0),E.selectedDates&&(E.selectedDates=E.selectedDates.filter(function(e){return $(e)}),E.selectedDates.length||"min"!==e||x(t),be()),E.daysContainer&&(ue(),void 0!==t?E.currentYearElement[e]=t.getFullYear().toString():E.currentYearElement.removeAttribute(e),E.currentYearElement.disabled=!!r&&void 0!==t&&r.getFullYear()===t.getFullYear())}}function ie(){return E.config.wrap?v.querySelector("[data-input]"):v}function se(){"object"!=typeof E.config.locale&&void 0===S.l10ns[E.config.locale]&&E.config.errorHandler(new Error("flatpickr: invalid locale "+E.config.locale)),E.l10n=e(e({},S.l10ns.default),"object"==typeof E.config.locale?E.config.locale:"default"!==E.config.locale?S.l10ns[E.config.locale]:void 0),g.K="("+E.l10n.amPM[0]+"|"+E.l10n.amPM[1]+"|"+E.l10n.amPM[0].toLowerCase()+"|"+E.l10n.amPM[1].toLowerCase()+")",void 0===e(e({},m),JSON.parse(JSON.stringify(v.dataset||{}))).time_24hr&&void 0===S.defaultConfig.time_24hr&&(E.config.time_24hr=E.l10n.time_24hr),E.formatDate=b(E),E.parseDate=O({config:E.config,l10n:E.l10n})}function ce(e){if("function"!=typeof E.config.position){if(void 0!==E.calendarContainer){ve("onPreCalendarPosition");var n=e||E._positionElement,t=Array.prototype.reduce.call(E.calendarContainer.children,function(e,n){return e+n.offsetHeight},0),r=E.calendarContainer.offsetWidth,o=E.config.position.split(" "),a=o[0],i=o.length>1?o[1]:null,s=n.getBoundingClientRect(),c=window.innerHeight-s.bottom,f="above"===a||"below"!==a&&c<t&&s.top>t,l=window.pageYOffset+s.top+(f?-t-2:n.offsetHeight+2);if(u(E.calendarContainer,"arrowTop",!f),u(E.calendarContainer,"arrowBottom",f),!E.config.inline){var d=window.pageXOffset+s.left,h=!1,p=!1;"center"===i?(d-=(r-s.width)/2,h=!0):"right"===i&&(d-=r-s.width,p=!0),u(E.calendarContainer,"arrowLeft",!h&&!p),u(E.calendarContainer,"arrowCenter",h),u(E.calendarContainer,"arrowRight",p);var v=window.document.body.offsetWidth-(window.pageXOffset+s.right),y=d+r>window.document.body.offsetWidth,m=v+r>window.document.body.offsetWidth;if(u(E.calendarContainer,"rightMost",y),!E.config.static)if(E.calendarContainer.style.top=l+"px",y)if(m){var g=function(){for(var e=null,n=0;n<document.styleSheets.length;n++){var t=document.styleSheets[n];try{t.cssRules}catch(e){continue}e=t;break}return null!=e?e:(r=document.createElement("style"),document.head.appendChild(r),r.sheet);var r}();if(void 0===g)return;var b=window.document.body.offsetWidth,O=Math.max(0,b/2-r/2),A=g.cssRules.length,w="{left:"+s.left+"px;right:auto;}";u(E.calendarContainer,"rightMost",!1),u(E.calendarContainer,"centerMost",!0),g.insertRule(".flatpickr-calendar.centerMost:before,.flatpickr-calendar.centerMost:after"+w,A),E.calendarContainer.style.left=O+"px",E.calendarContainer.style.right="auto"}else E.calendarContainer.style.left="auto",E.calendarContainer.style.right=v+"px";else E.calendarContainer.style.left=d+"px",E.calendarContainer.style.right="auto"}}}else E.config.position(E,e)}function ue(){E.config.noCalendar||E.isMobile||(Y(),ge(),V())}function fe(){E._input.focus(),-1!==window.navigator.userAgent.indexOf("MSIE")||void 0!==navigator.msMaxTouchPoints?setTimeout(E.close,0):E.close()}function le(e){e.preventDefault(),e.stopPropagation();var n=d(p(e),function(e){return e.classList&&e.classList.contains("flatpickr-day")&&!e.classList.contains("flatpickr-disabled")&&!e.classList.contains("notAllowed")});if(void 0!==n){var t=n,r=E.latestSelectedDateObj=new Date(t.dateObj.getTime()),o=(r.getMonth()<E.currentMonth||r.getMonth()>E.currentMonth+E.config.showMonths-1)&&"range"!==E.config.mode;if(E.selectedDateElem=t,"single"===E.config.mode)E.selectedDates=[r];else if("multiple"===E.config.mode){var a=me(r);a?E.selectedDates.splice(parseInt(a),1):E.selectedDates.push(r)}else"range"===E.config.mode&&(2===E.selectedDates.length&&E.clear(!1,!1),E.latestSelectedDateObj=r,E.selectedDates.push(r),0!==A(r,E.selectedDates[0],!0)&&E.selectedDates.sort(function(e,n){return e.getTime()-n.getTime()}));if(I(),o){var i=E.currentYear!==r.getFullYear();E.currentYear=r.getFullYear(),E.currentMonth=r.getMonth(),i&&(ve("onYearChange"),Y()),ve("onMonthChange")}if(ge(),V(),be(),o||"range"===E.config.mode||1!==E.config.showMonths?void 0!==E.selectedDateElem&&void 0===E.hourElement&&E.selectedDateElem&&E.selectedDateElem.focus():j(t),void 0!==E.hourElement&&void 0!==E.hourElement&&E.hourElement.focus(),E.config.closeOnSelect){var s="single"===E.config.mode&&!E.config.enableTime,c="range"===E.config.mode&&2===E.selectedDates.length&&!E.config.enableTime;(s||c)&&fe()}k()}}E.parseDate=O({config:E.config,l10n:E.l10n}),E._handlers=[],E.pluginElements=[],E.loadedPlugins=[],E._bind=P,E._setHoursFromDate=x,E._positionCalendar=ce,E.changeMonth=z,E.changeYear=X,E.clear=function(e,n){if(void 0===e&&(e=!0),void 0===n&&(n=!0),E.input.value="",void 0!==E.altInput&&(E.altInput.value=""),void 0!==E.mobileInput&&(E.mobileInput.value=""),E.selectedDates=[],E.latestSelectedDateObj=void 0,!0===n&&(E.currentYear=E._initialDate.getFullYear(),E.currentMonth=E._initialDate.getMonth()),!0===E.config.enableTime){var t=D(E.config);C(t.hours,t.minutes,t.seconds)}E.redraw(),e&&ve("onChange")},E.close=function(){E.isOpen=!1,E.isMobile||(void 0!==E.calendarContainer&&E.calendarContainer.classList.remove("open"),void 0!==E._input&&E._input.classList.remove("active")),ve("onClose")},E._createElement=f,E.destroy=function(){void 0!==E.config&&ve("onDestroy");for(var e=E._handlers.length;e--;)E._handlers[e].remove();if(E._handlers=[],E.mobileInput)E.mobileInput.parentNode&&E.mobileInput.parentNode.removeChild(E.mobileInput),E.mobileInput=void 0;else if(E.calendarContainer&&E.calendarContainer.parentNode)if(E.config.static&&E.calendarContainer.parentNode){var n=E.calendarContainer.parentNode;if(n.lastChild&&n.removeChild(n.lastChild),n.parentNode){for(;n.firstChild;)n.parentNode.insertBefore(n.firstChild,n);n.parentNode.removeChild(n)}}else E.calendarContainer.parentNode.removeChild(E.calendarContainer);E.altInput&&(E.input.type="text",E.altInput.parentNode&&E.altInput.parentNode.removeChild(E.altInput),delete E.altInput),E.input&&(E.input.type=E.input._type,E.input.classList.remove("flatpickr-input"),E.input.removeAttribute("readonly")),["_showTimeInput","latestSelectedDateObj","_hideNextMonthArrow","_hidePrevMonthArrow","__hideNextMonthArrow","__hidePrevMonthArrow","isMobile","isOpen","selectedDateElem","minDateHasTime","maxDateHasTime","days","daysContainer","_input","_positionElement","innerContainer","rContainer","monthNav","todayDateElem","calendarContainer","weekdayContainer","prevMonthNav","nextMonthNav","monthsDropdownContainer","currentMonthElement","currentYearElement","navigationCurrentMonth","selectedDateElem","config"].forEach(function(e){try{delete E[e]}catch(e){}})},E.isEnabled=$,E.jumpToDate=M,E.open=function(e,n){if(void 0===n&&(n=E._positionElement),!0===E.isMobile){if(e){e.preventDefault();var t=p(e);t&&t.blur()}return void 0!==E.mobileInput&&(E.mobileInput.focus(),E.mobileInput.click()),void ve("onOpen")}if(!E._input.disabled&&!E.config.inline){var r=E.isOpen;E.isOpen=!0,r||(E.calendarContainer.classList.add("open"),E._input.classList.add("active"),ve("onOpen"),ce(n)),!0===E.config.enableTime&&!0===E.config.noCalendar&&(!1!==E.config.allowInput||void 0!==e&&E.timeContainer.contains(e.relatedTarget)||setTimeout(function(){return E.hourElement.select()},50))}},E.redraw=ue,E.set=function(e,n){if(null!==e&&"object"==typeof e)for(var r in Object.assign(E.config,e),e)void 0!==de[r]&&de[r].forEach(function(e){return e()});else E.config[e]=n,void 0!==de[e]?de[e].forEach(function(e){return e()}):t.indexOf(e)>-1&&(E.config[e]=c(n));E.redraw(),be(!0)},E.setDate=function(e,n,t){if(void 0===n&&(n=!1),void 0===t&&(t=E.config.dateFormat),0!==e&&!e||e instanceof Array&&0===e.length)return E.clear(n);he(e,t),E.latestSelectedDateObj=E.selectedDates[E.selectedDates.length-1],E.redraw(),M(void 0,n),x(),0===E.selectedDates.length&&E.clear(!1),be(n),n&&ve("onChange")},E.toggle=function(e){if(!0===E.isOpen)return E.close();E.open(e)};var de={locale:[se,W],showMonths:[J,T,q],minDate:[M],maxDate:[M],clickOpens:[function(){!0===E.config.clickOpens?(P(E._input,"focus",E.open),P(E._input,"click",E.open)):(E._input.removeEventListener("focus",E.open),E._input.removeEventListener("click",E.open))}]};function he(e,n){var t=[];if(e instanceof Array)t=e.map(function(e){return E.parseDate(e,n)});else if(e instanceof Date||"number"==typeof e)t=[E.parseDate(e,n)];else if("string"==typeof e)switch(E.config.mode){case"single":case"time":t=[E.parseDate(e,n)];break;case"multiple":t=e.split(E.config.conjunction).map(function(e){return E.parseDate(e,n)});break;case"range":t=e.split(E.l10n.rangeSeparator).map(function(e){return E.parseDate(e,n)})}else E.config.errorHandler(new Error("Invalid date supplied: "+JSON.stringify(e)));E.selectedDates=E.config.allowInvalidPreload?t:t.filter(function(e){return e instanceof Date&&$(e,!1)}),"range"===E.config.mode&&E.selectedDates.sort(function(e,n){return e.getTime()-n.getTime()})}function pe(e){return e.slice().map(function(e){return"string"==typeof e||"number"==typeof e||e instanceof Date?E.parseDate(e,void 0,!0):e&&"object"==typeof e&&e.from&&e.to?{from:E.parseDate(e.from,void 0),to:E.parseDate(e.to,void 0)}:e}).filter(function(e){return e})}function ve(e,n){if(void 0!==E.config){var t=E.config[e];if(void 0!==t&&t.length>0)for(var r=0;t[r]&&r<t.length;r++)t[r](E.selectedDates,E.input.value,E,n);"onChange"===e&&(E.input.dispatchEvent(ye("change")),E.input.dispatchEvent(ye("input")))}}function ye(e){var n=document.createEvent("Event");return n.initEvent(e,!0,!0),n}function me(e){for(var n=0;n<E.selectedDates.length;n++)if(0===A(E.selectedDates[n],e))return""+n;return!1}function ge(){E.config.noCalendar||E.isMobile||!E.monthNav||(E.yearElements.forEach(function(e,n){var t=new Date(E.currentYear,E.currentMonth,1);t.setMonth(E.currentMonth+n),E.config.showMonths>1||"static"===E.config.monthSelectorType?E.monthElements[n].textContent=y(t.getMonth(),E.config.shorthandCurrentMonth,E.l10n)+" ":E.monthsDropdownContainer.value=t.getMonth().toString(),e.value=t.getFullYear().toString()}),E._hidePrevMonthArrow=void 0!==E.config.minDate&&(E.currentYear===E.config.minDate.getFullYear()?E.currentMonth<=E.config.minDate.getMonth():E.currentYear<E.config.minDate.getFullYear()),E._hideNextMonthArrow=void 0!==E.config.maxDate&&(E.currentYear===E.config.maxDate.getFullYear()?E.currentMonth+1>E.config.maxDate.getMonth():E.currentYear>E.config.maxDate.getFullYear()))}function Ee(e){return E.selectedDates.map(function(n){return E.formatDate(n,e)}).filter(function(e,n,t){return"range"!==E.config.mode||E.config.enableTime||t.indexOf(e)===n}).join("range"!==E.config.mode?E.config.conjunction:E.l10n.rangeSeparator)}function be(e){void 0===e&&(e=!0),void 0!==E.mobileInput&&E.mobileFormatStr&&(E.mobileInput.value=void 0!==E.latestSelectedDateObj?E.formatDate(E.latestSelectedDateObj,E.mobileFormatStr):""),E.input.value=Ee(E.config.dateFormat),void 0!==E.altInput&&(E.altInput.value=Ee(E.config.altFormat)),!1!==e&&ve("onValueUpdate")}function Oe(e){var n=p(e),t=E.prevMonthNav.contains(n),r=E.nextMonthNav.contains(n);t||r?z(t?-1:1):E.yearElements.indexOf(n)>=0?n.select():n.classList.contains("arrowUp")?E.changeYear(E.currentYear+1):n.classList.contains("arrowDown")&&E.changeYear(E.currentYear-1)}return function(){E.element=E.input=v,E.isOpen=!1,function(){var n=["wrap","weekNumbers","allowInput","allowInvalidPreload","clickOpens","time_24hr","enableTime","noCalendar","altInput","shorthandCurrentMonth","inline","static","enableSeconds","disableMobile"],o=e(e({},JSON.parse(JSON.stringify(v.dataset||{}))),m),a={};E.config.parseDate=o.parseDate,E.config.formatDate=o.formatDate,Object.defineProperty(E.config,"enable",{get:function(){return E.config._enable},set:function(e){E.config._enable=pe(e)}}),Object.defineProperty(E.config,"disable",{get:function(){return E.config._disable},set:function(e){E.config._disable=pe(e)}});var i="time"===o.mode;if(!o.dateFormat&&(o.enableTime||i)){var s=S.defaultConfig.dateFormat||r.dateFormat;a.dateFormat=o.noCalendar||i?"H:i"+(o.enableSeconds?":S":""):s+" H:i"+(o.enableSeconds?":S":"")}if(o.altInput&&(o.enableTime||i)&&!o.altFormat){var u=S.defaultConfig.altFormat||r.altFormat;a.altFormat=o.noCalendar||i?"h:i"+(o.enableSeconds?":S K":" K"):u+" h:i"+(o.enableSeconds?":S":"")+" K"}Object.defineProperty(E.config,"minDate",{get:function(){return E.config._minDate},set:ae("min")}),Object.defineProperty(E.config,"maxDate",{get:function(){return E.config._maxDate},set:ae("max")});var f=function(e){return function(n){E.config["min"===e?"_minTime":"_maxTime"]=E.parseDate(n,"H:i:S")}};Object.defineProperty(E.config,"minTime",{get:function(){return E.config._minTime},set:f("min")}),Object.defineProperty(E.config,"maxTime",{get:function(){return E.config._maxTime},set:f("max")}),"time"===o.mode&&(E.config.noCalendar=!0,E.config.enableTime=!0),Object.assign(E.config,a,o);for(var l=0;l<n.length;l++)E.config[n[l]]=!0===E.config[n[l]]||"true"===E.config[n[l]];for(t.filter(function(e){return void 0!==E.config[e]}).forEach(function(e){E.config[e]=c(E.config[e]||[]).map(_)}),E.isMobile=!E.config.disableMobile&&!E.config.inline&&"single"===E.config.mode&&!E.config.disable.length&&!E.config.enable&&!E.config.weekNumbers&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),l=0;l<E.config.plugins.length;l++){var d=E.config.plugins[l](E)||{};for(var h in d)t.indexOf(h)>-1?E.config[h]=c(d[h]).map(_).concat(E.config[h]):void 0===o[h]&&(E.config[h]=d[h])}o.altInputClass||(E.config.altInputClass=ie().className+" "+E.config.altInputClass),ve("onParseConfig")}(),se(),E.input=ie(),E.input?(E.input._type=E.input.type,E.input.type="text",E.input.classList.add("flatpickr-input"),E._input=E.input,E.config.altInput&&(E.altInput=f(E.input.nodeName,E.config.altInputClass),E._input=E.altInput,E.altInput.placeholder=E.input.placeholder,E.altInput.disabled=E.input.disabled,E.altInput.required=E.input.required,E.altInput.tabIndex=E.input.tabIndex,E.altInput.type="text",E.input.setAttribute("type","hidden"),!E.config.static&&E.input.parentNode&&E.input.parentNode.insertBefore(E.altInput,E.input.nextSibling)),E.config.allowInput||E._input.setAttribute("readonly","readonly"),E._positionElement=E.config.positionElement||E._input):E.config.errorHandler(new Error("Invalid input element specified")),function(){E.selectedDates=[],E.now=E.parseDate(E.config.now)||new Date;var e=E.config.defaultDate||("INPUT"!==E.input.nodeName&&"TEXTAREA"!==E.input.nodeName||!E.input.placeholder||E.input.value!==E.input.placeholder?E.input.value:null);e&&he(e,E.config.dateFormat),E._initialDate=E.selectedDates.length>0?E.selectedDates[0]:E.config.minDate&&E.config.minDate.getTime()>E.now.getTime()?E.config.minDate:E.config.maxDate&&E.config.maxDate.getTime()<E.now.getTime()?E.config.maxDate:E.now,E.currentYear=E._initialDate.getFullYear(),E.currentMonth=E._initialDate.getMonth(),E.selectedDates.length>0&&(E.latestSelectedDateObj=E.selectedDates[0]),void 0!==E.config.minTime&&(E.config.minTime=E.parseDate(E.config.minTime,"H:i")),void 0!==E.config.maxTime&&(E.config.maxTime=E.parseDate(E.config.maxTime,"H:i")),E.minDateHasTime=!!E.config.minDate&&(E.config.minDate.getHours()>0||E.config.minDate.getMinutes()>0||E.config.minDate.getSeconds()>0),E.maxDateHasTime=!!E.config.maxDate&&(E.config.maxDate.getHours()>0||E.config.maxDate.getMinutes()>0||E.config.maxDate.getSeconds()>0)}(),E.utils={getDaysInMonth:function(e,n){return void 0===e&&(e=E.currentMonth),void 0===n&&(n=E.currentYear),1===e&&(n%4==0&&n%100!=0||n%400==0)?29:E.l10n.daysInMonth[e]}},E.isMobile||function(){var e=window.document.createDocumentFragment();if(E.calendarContainer=f("div","flatpickr-calendar"),E.calendarContainer.tabIndex=-1,!E.config.noCalendar){if(e.appendChild((E.monthNav=f("div","flatpickr-months"),E.yearElements=[],E.monthElements=[],E.prevMonthNav=f("span","flatpickr-prev-month"),E.prevMonthNav.innerHTML=E.config.prevArrow,E.nextMonthNav=f("span","flatpickr-next-month"),E.nextMonthNav.innerHTML=E.config.nextArrow,J(),Object.defineProperty(E,"_hidePrevMonthArrow",{get:function(){return E.__hidePrevMonthArrow},set:function(e){E.__hidePrevMonthArrow!==e&&(u(E.prevMonthNav,"flatpickr-disabled",e),E.__hidePrevMonthArrow=e)}}),Object.defineProperty(E,"_hideNextMonthArrow",{get:function(){return E.__hideNextMonthArrow},set:function(e){E.__hideNextMonthArrow!==e&&(u(E.nextMonthNav,"flatpickr-disabled",e),E.__hideNextMonthArrow=e)}}),E.currentYearElement=E.yearElements[0],ge(),E.monthNav)),E.innerContainer=f("div","flatpickr-innerContainer"),E.config.weekNumbers){var n=function(){E.calendarContainer.classList.add("hasWeeks");var e=f("div","flatpickr-weekwrapper");e.appendChild(f("span","flatpickr-weekday",E.l10n.weekAbbreviation));var n=f("div","flatpickr-weeks");return e.appendChild(n),{weekWrapper:e,weekNumbers:n}}(),t=n.weekWrapper,r=n.weekNumbers;E.innerContainer.appendChild(t),E.weekNumbers=r,E.weekWrapper=t}E.rContainer=f("div","flatpickr-rContainer"),E.rContainer.appendChild(q()),E.daysContainer||(E.daysContainer=f("div","flatpickr-days"),E.daysContainer.tabIndex=-1),V(),E.rContainer.appendChild(E.daysContainer),E.innerContainer.appendChild(E.rContainer),e.appendChild(E.innerContainer)}E.config.enableTime&&e.appendChild(function(){E.calendarContainer.classList.add("hasTime"),E.config.noCalendar&&E.calendarContainer.classList.add("noCalendar");var e=D(E.config);E.timeContainer=f("div","flatpickr-time"),E.timeContainer.tabIndex=-1;var n=f("span","flatpickr-time-separator",":"),t=h("flatpickr-hour",{"aria-label":E.l10n.hourAriaLabel});E.hourElement=t.getElementsByTagName("input")[0];var r=h("flatpickr-minute",{"aria-label":E.l10n.minuteAriaLabel});if(E.minuteElement=r.getElementsByTagName("input")[0],E.hourElement.tabIndex=E.minuteElement.tabIndex=-1,E.hourElement.value=a(E.latestSelectedDateObj?E.latestSelectedDateObj.getHours():E.config.time_24hr?e.hours:function(e){switch(e%24){case 0:case 12:return 12;default:return e%12}}(e.hours)),E.minuteElement.value=a(E.latestSelectedDateObj?E.latestSelectedDateObj.getMinutes():e.minutes),E.hourElement.setAttribute("step",E.config.hourIncrement.toString()),E.minuteElement.setAttribute("step",E.config.minuteIncrement.toString()),E.hourElement.setAttribute("min",E.config.time_24hr?"0":"1"),E.hourElement.setAttribute("max",E.config.time_24hr?"23":"12"),E.hourElement.setAttribute("maxlength","2"),E.minuteElement.setAttribute("min","0"),E.minuteElement.setAttribute("max","59"),E.minuteElement.setAttribute("maxlength","2"),E.timeContainer.appendChild(t),E.timeContainer.appendChild(n),E.timeContainer.appendChild(r),E.config.time_24hr&&E.timeContainer.classList.add("time24hr"),E.config.enableSeconds){E.timeContainer.classList.add("hasSeconds");var o=h("flatpickr-second");E.secondElement=o.getElementsByTagName("input")[0],E.secondElement.value=a(E.latestSelectedDateObj?E.latestSelectedDateObj.getSeconds():e.seconds),E.secondElement.setAttribute("step",E.minuteElement.getAttribute("step")),E.secondElement.setAttribute("min","0"),E.secondElement.setAttribute("max","59"),E.secondElement.setAttribute("maxlength","2"),E.timeContainer.appendChild(f("span","flatpickr-time-separator",":")),E.timeContainer.appendChild(o)}return E.config.time_24hr||(E.amPM=f("span","flatpickr-am-pm",E.l10n.amPM[i((E.latestSelectedDateObj?E.hourElement.value:E.config.defaultHour)>11)]),E.amPM.title=E.l10n.toggleTitle,E.amPM.tabIndex=-1,E.timeContainer.appendChild(E.amPM)),E.timeContainer}()),u(E.calendarContainer,"rangeMode","range"===E.config.mode),u(E.calendarContainer,"animate",!0===E.config.animate),u(E.calendarContainer,"multiMonth",E.config.showMonths>1),E.calendarContainer.appendChild(e);var o=void 0!==E.config.appendTo&&void 0!==E.config.appendTo.nodeType;if((E.config.inline||E.config.static)&&(E.calendarContainer.classList.add(E.config.inline?"inline":"static"),E.config.inline&&(!o&&E.element.parentNode?E.element.parentNode.insertBefore(E.calendarContainer,E._input.nextSibling):void 0!==E.config.appendTo&&E.config.appendTo.appendChild(E.calendarContainer)),E.config.static)){var s=f("div","flatpickr-wrapper");E.element.parentNode&&E.element.parentNode.insertBefore(s,E.element),s.appendChild(E.element),E.altInput&&s.appendChild(E.altInput),s.appendChild(E.calendarContainer)}E.config.static||E.config.inline||(void 0!==E.config.appendTo?E.config.appendTo:window.document.body).appendChild(E.calendarContainer)}(),function(){if(E.config.wrap&&["open","close","toggle","clear"].forEach(function(e){Array.prototype.forEach.call(E.element.querySelectorAll("[data-"+e+"]"),function(n){return P(n,"click",E[e])})}),E.isMobile)!function(){var e=E.config.enableTime?E.config.noCalendar?"time":"datetime-local":"date";E.mobileInput=f("input",E.input.className+" flatpickr-mobile"),E.mobileInput.tabIndex=1,E.mobileInput.type=e,E.mobileInput.disabled=E.input.disabled,E.mobileInput.required=E.input.required,E.mobileInput.placeholder=E.input.placeholder,E.mobileFormatStr="datetime-local"===e?"Y-m-d\\TH:i:S":"date"===e?"Y-m-d":"H:i:S",E.selectedDates.length>0&&(E.mobileInput.defaultValue=E.mobileInput.value=E.formatDate(E.selectedDates[0],E.mobileFormatStr)),E.config.minDate&&(E.mobileInput.min=E.formatDate(E.config.minDate,"Y-m-d")),E.config.maxDate&&(E.mobileInput.max=E.formatDate(E.config.maxDate,"Y-m-d")),E.input.getAttribute("step")&&(E.mobileInput.step=String(E.input.getAttribute("step"))),E.input.type="hidden",void 0!==E.altInput&&(E.altInput.type="hidden");try{E.input.parentNode&&E.input.parentNode.insertBefore(E.mobileInput,E.input.nextSibling)}catch(e){}P(E.mobileInput,"change",function(e){E.setDate(p(e).value,!1,E.mobileFormatStr),ve("onChange"),ve("onClose")})}();else{var e=s(oe,50);if(E._debouncedChange=s(k,300),E.daysContainer&&!/iPhone|iPad|iPod/i.test(navigator.userAgent)&&P(E.daysContainer,"mouseover",function(e){"range"===E.config.mode&&re(p(e))}),P(window.document.body,"keydown",te),E.config.inline||E.config.static||P(window,"resize",e),void 0!==window.ontouchstart?P(window.document,"touchstart",Z):P(window.document,"mousedown",Z),P(window.document,"focus",Z,{capture:!0}),!0===E.config.clickOpens&&(P(E._input,"focus",E.open),P(E._input,"click",E.open)),void 0!==E.daysContainer&&(P(E.monthNav,"click",Oe),P(E.monthNav,["keyup","increment"],R),P(E.daysContainer,"click",le)),void 0!==E.timeContainer&&void 0!==E.minuteElement&&void 0!==E.hourElement){var n=function(e){return p(e).select()};P(E.timeContainer,["increment"],N),P(E.timeContainer,"blur",N,{capture:!0}),P(E.timeContainer,"click",F),P([E.hourElement,E.minuteElement],["focus","click"],n),void 0!==E.secondElement&&P(E.secondElement,"focus",function(){return E.secondElement&&E.secondElement.select()}),void 0!==E.amPM&&P(E.amPM,"click",function(e){N(e),k()})}E.config.allowInput&&P(E._input,"blur",ne)}}(),(E.selectedDates.length||E.config.noCalendar)&&(E.config.enableTime&&x(E.config.noCalendar?E.latestSelectedDateObj:void 0),be(!1)),T();var n=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);!E.isMobile&&n&&ce(),ve("onReady")}(),E}function T(e,n){for(var t=Array.prototype.slice.call(e).filter(function(e){return e instanceof HTMLElement}),r=[],o=0;o<t.length;o++){var a=t[o];try{if(null!==a.getAttribute("data-fp-omit"))continue;void 0!==a._flatpickr&&(a._flatpickr.destroy(),a._flatpickr=void 0),a._flatpickr=_(a,n||{}),r.push(a._flatpickr)}catch(e){console.error(e)}}return 1===r.length?r[0]:r}"function"!=typeof Object.assign&&(Object.assign=function(e){for(var n=[],t=1;t<arguments.length;t++)n[t-1]=arguments[t];if(!e)throw TypeError("Cannot convert undefined or null to object");for(var r=function(n){n&&Object.keys(n).forEach(function(t){return e[t]=n[t]})},o=0,a=n;o<a.length;o++)r(a[o]);return e}),"undefined"!=typeof HTMLElement&&"undefined"!=typeof HTMLCollection&&"undefined"!=typeof NodeList&&(HTMLCollection.prototype.flatpickr=NodeList.prototype.flatpickr=function(e){return T(this,e)},HTMLElement.prototype.flatpickr=function(e){return T([this],e)});var S=function(e,n){return"string"==typeof e?T(window.document.querySelectorAll(e),n):e instanceof Node?T([e],n):T(e,n)};return S.defaultConfig={},S.l10ns={en:e({},o),default:e({},o)},S.localize=function(n){S.l10ns.default=e(e({},S.l10ns.default),n)},S.setDefaults=function(n){S.defaultConfig=e(e({},S.defaultConfig),n)},S.parseDate=O({}),S.formatDate=b({}),S.compareDates=A,"undefined"!=typeof jQuery&&void 0!==jQuery.fn&&(jQuery.fn.flatpickr=function(e){return T(this,e)}),Date.prototype.fp_incr=function(e){return new Date(this.getFullYear(),this.getMonth(),this.getDate()+("string"==typeof e?parseInt(e,10):e))},"undefined"!=typeof window&&(window.flatpickr=S),S}()}(Wt)),Wt.exports}function Qt(){if(qt)return Jt;qt=1;return Jt=((e,n,t,r,o,a,i,s,c,u,f)=>{var l={setCustomize:()=>{}},d=function(e,n){if(!n||1===n)return e.store;var t=e.store.modules&&e.store.modules.team;return t?t.getTeam(n):void 0},h=function(n,t){n.emit("UPDATE",{teams:t.stores,roTeams:t.roStores,id:t.channel,loading:!t.ready&&!t.cacheready,readOnly:t.readOnly||!t.ready&&t.cacheready||t.offline,offline:t.offline,deleted:!t.stores.length,restricted:t.restricted,owned:n.Store.isOwned(t.owners),content:e.clone(t.proxy),hashes:t.hashes},n.clients)},p=function(e,n){var t=e.calendars[n];t&&t.reminders&&Object.keys(t.reminders).forEach(function(e){Array.isArray(t.reminders[e])&&t.reminders[e].forEach(function(e){clearTimeout(e)})})},v=function(e,n){var t=e.calendars[n];t&&(t.stores.length||(t.lm.stop(),p(e,n),delete e.calendars[n]))},y=function(e,n,t){n.stores.forEach(function(r){var o=d(e,r);if(o&&o.proxy&&o.rpc&&o.proxy.calendars){var a=o.proxy.calendars[n.channel];a&&(a.color!==t.color&&(a.color=t.color),a.title!==t.title&&(a.title=t.title))}})},m=function(n,t,r,o){var a=+new Date,i=e.clone(r),s=i.id;if(Array.isArray(t[s])&&t[s].forEach(function(e){clearTimeout(e)}),t[s]=[],!r.deleted){var u=e.find(n,["store","proxy","hideReminders",s])||[],f=n.store.data.lastVisit;if(i.isAllDay&&(i.startDay&&(i.start=+c.parseDate(i.startDay)),i.endDay)){var l=c.parseDate(i.endDay);l.setHours(23),l.setMinutes(59),l.setSeconds(59),i.end=+l}var d=a-6048e5,h=o&&i.start>f&&i.end<=a&&i.end>d;if(i.end<=a&&!h)return delete t[s],void function(n,t){var r=e.find(n,["store","proxy","hideReminders"])||{};Object.keys(r).filter(function(e){return e===t}).forEach(function(e){delete r[e]})}(n,s);var p=!1,v=function(t){p=!0,n.Store.onReadyEvt.reg(function(){!function(t){if(!e.find(n,["store","proxy","settings","general","calendar","hideNotif"])){var r=i.start<=a?i.start:+new Date;n.store.mailbox.showMessage("reminders",{msg:{ctime:r,type:"REMINDER",missed:Boolean(h),content:i},hash:"REMINDER|"+s+"-"+t},null,function(){})}}(t)})},y=i.reminders||[];y.sort(function(e,n){return e-n}),y.some(function(e){var n=a+6e4*e;if(!u.some(function(n){return e>=n}))return i.start-n>=2147483647||(i.start<=n?(v(e),!0):void t[s].push(setTimeout(function(){v(e)},i.start-n)))}),p||n.Store.onReadyEvt.reg(function(){n.store.mailbox.hideMessage("reminders",{hash:"REMINDER|"+s},null,function(){})})}},g=function(n,t,r,o){var i=function(e){var n=new Date,t=new Date(n.getFullYear(),n.getMonth()-1,15),r=new Date(n.getFullYear(),n.getMonth()+1,15),o=a.getMonthId(t),i=a.getMonthId(n),s=a.getMonthId(r),c=a.getRecurring([o,i,s],[e]),u=[e];return Array.prototype.push.apply(u,c),u}(e.clone(r));i.forEach(function(e){m(n,t,e,o)})},E=function(e,n,t){var r=e.calendars[n];t&&r&&r.reminders&&(1===r.stores.length&&0===r.stores[0]||g(e,r.reminders,t))},b=function(n,t,r){var o=n.calendars[t];if(o&&o.reminders&&!Object.keys(o.reminders).length&&(1!==o.stores.length||0!==o.stores[0])){var a=e.find(o,["proxy","content"]);a&&Object.keys(a).forEach(function(e){g(n,o.reminders,a[e],r)})}},O=function(t,r,a){var c=e.once(e.mkAsync(a||function(){})),l=r.storeId,v=r.data,m=v.channel;if(m){var g=t.calendars[m],O=function(){h(t,g)};if(g){if(g.readOnly&&v.href){var A=n.parsePadUrl(v.href),w=n.getSecrets("calendar",A.hash,v.password),D=u.createEncryptor(w.keys);g.hashes.editHash=n.getEditHashFromKeys(w),g.lm.setReadOnly(!1,D),g.readOnly=!1}else if(0===l)return 1===g.stores.length&&0===g.stores[0]&&g.tempId.length&&r.cId&&g.tempId.push(r.cId),void c();return-1!==g.roStores.indexOf(l)&&v.href&&(g.roStores.splice(g.roStores.indexOf(l),1),-1!==g.stores.indexOf(0)&&g.stores.splice(g.stores.indexOf(0),1),O()),g.stores&&-1!==g.stores.indexOf(l)?void c():(-1!==g.stores.indexOf(0)&&(g.stores.splice(g.stores.indexOf(0),1),g.tempId=[]),g.stores.push(l),v.href||g.roStores.push(l),O(),void c())}g=t.calendars[m]={ready:!1,channel:m,readOnly:!v.href,tempId:[],stores:[l],roStores:v.href?[]:[l],reminders:{},hashes:{}},0===l&&g.tempId.push(r.cId);var _=n.parsePadUrl(v.href||v.roHref),T=n.getSecrets("calendar",_.hash,v.password),S=u.createEncryptor(T.keys);g.hashes.viewHash=n.getViewHashFromKeys(T),v.href&&(g.hashes.editHash=n.getEditHashFromKeys(T)),g.proxy={metadata:{color:v.color,title:v.title}},O();var N=function(){g.stores.forEach(function(e){var n=d(t,e);n&&n.rpc&&n.proxy.calendars&&(delete n.proxy.calendars[m],(n.unpin||t.unpinPads)([m],function(e){e&&e.error&&console.error(e.error)}))}),g.lm&&g.lm.stop(),g.stores=[],h(t,g),p(t,m),delete t.calendars[m]};i(function(e){t.store.network&&!r.isNew&&t.Store.isNewChannel(null,m,e(function(n){if(!n||!n.error)return n&&"boolean"==typeof n.isNew&&n.isNew?(N(),c({error:"EDELETED"}),void e.abort()):void 0}))}).nThen(function(){var e;if(1!==l&&l){var n=t.store.modules.team&&t.store.modules.team.getTeamsData(),a=n&&n[l];e=a?a.edPublic:void 0}else e=t.store.proxy.edPublic;var i={data:{},network:t.store.network||t.store.networkPromise,channel:T.channel,crypto:S,owners:[e],ChainPad:f,validateKey:T.keys.validateKey||void 0,userName:"calendar",Cache:o,classic:!0,onRejected:t.Store&&t.Store.onRejected},u=s.create(i);g.lm=u;var d=g.proxy=u.proxy,h=!1,p=function(){h||(h=!0,setTimeout(function(){h=!1,O()}))};u.proxy.on("cacheready",function(){d.metadata&&(g.cacheready=!0,p(),c&&c(null,u.proxy),b(t,m,r.lastVisitNotif))}).on("ready",function(e){var n=e.metadata;if(g.owners=n.owners||[],g.ready=!0,!d.metadata){if(!r.isNew)return void N();d.metadata={color:v.color,title:v.title}}p(),c&&c(null,u.proxy),b(t,m,r.lastVisitNotif)}).on("change",[],function(){g.ready&&p()}).on("change",["content"],function(e,n,r){2!==r.length||!n||e?2!==r.length||n||!e?(r.length>=3&&["start","reminders","isAllDay"].includes(r[2])||r.length>=6&&["start","reminders","isAllDay"].includes(r[5]))&&setTimeout(function(){E(t,m,d.content[r[1]])}):E(t,m,{id:r[1],start:0}):E(t,m,n)}).on("remove",["content"],function(e,n){p(),(n.length>=3&&"reminders"===n[2]||n.length>=6&&"reminders"===n[5])&&setTimeout(function(){E(t,m,d.content[n[1]])})}).on("change",["metadata"],function(){var e=d.metadata;e&&e.title&&e.color&&y(t,g,e)}).on("disconnect",function(){g.offline=!0,p()}).on("reconnect",function(){g.offline=!1,p()}).on("error",function(e){e&&e.error&&("EDELETED"!==e.error?("ERESTRICTED"===e.error&&(g.restricted=!0,p()),c(e)):N())})})}},A=function(e,n){if(n.href&&-1===n.href.indexOf("#"))if(e.secondaryKey)try{n.href=e.userObject.cryptor.decrypt(n.href)}catch(e){console.error(e),delete n.href}else delete n.href},w=function(n,t){var r=t.proxy.calendars,o=t.id||1;t.proxy.on("change",["calendars"],function(r,a,i){i.length<2||(r&&!a&&function(){var e=i[1],t=n.calendars[e];if(t){var r=t.stores.indexOf(o);if(-1!==r){t.stores.splice(r,1);var a=t.roStores.indexOf(o);-1!==a&&t.roStores.splice(a,1),v(n,e),h(n,t)}}}(),!r&&a&&function(){var r=i[1],a=t.proxy.calendars[r];if(a){var s=e.clone(a);A(t,s),O(n,{storeId:o,data:s})}}())}),Object.keys(r||{}).forEach(function(a){var i=e.clone(r[a]);A(t,i),O(n,{storeId:o,lastVisitNotif:!0,data:i})})},D=function(e,t,o,a){var i=d(e,t.teamId);if(i)if(i.rpc){var s,c,u,f=i.proxy.calendars=i.proxy.calendars||{},l=(s=n.createRandomHash("calendar"),c=n.getSecrets("calendar",s),u=n.getViewHashFromKeys(c),{href:n.hashToHref(s,"calendar"),roHref:n.hashToHref(u,"calendar"),channel:c.channel});l.color=t.color,l.title=t.title,O(e,{storeId:i.id||1,data:l,isNew:!0},function(n){if(n)return console.error(n),void a({error:n.error});var t=e.calendars[l.channel];r.whenRealtimeSyncs(t.lm.realtime,function(){f[l.channel]=l,(i.pin||e.pinPads)([l.channel],function(e){e&&e.error&&console.error(e.error)}),e.Store.onSync(i.id,a)})})}else a({error:"EFORBIDDEN"});else a({error:"NO_STORE"})};return l.init=function(t,o,a){var s={},c=t.store,u={loggedIn:c.loggedIn&&c.proxy.edPublic,store:c,Store:t.Store,pinPads:t.pinPads,unpinPads:t.unpinPads,updateMetadata:t.updateMetadata,emit:a,onReady:e.mkEvent(!0),calendars:{},clients:[]};return function(e,n){var t=e.store.proxy;t.calendars=t.calendars||{},setTimeout(n)}(u,o(function(e){e||function(e){w(e,e.store);var n=e.store.modules.team&&e.store.modules.team.getTeamsData();n&&Object.keys(n).forEach(function(n){var t=d(e,n);w(e,t)})}(u)})),u.store.proxy.on("change",["hideReminders"],function(e,n,t){var r=t[1].split("|")[0];Object.keys(u.calendars).some(function(e){var n=u.calendars[e];if(n&&n.proxy&&n.proxy.content)return n.proxy.content[r]?(setTimeout(function(){E(u,e,n.proxy.content[r])}),!0):void 0})}),s.closeTeam=function(e){Object.keys(u.calendars).forEach(function(n){var t=u.calendars[n],r=t.stores.indexOf(e);if(-1!==r){t.stores.splice(r,1);var o=t.roStores.indexOf(e);-1!==o&&t.roStores.splice(o,1),v(u,n),h(u,t)}})},s.openTeam=function(e){var n=d(u,e);n&&w(u,n)},s.upgradeTeam=function(n){if(n){var t=d(u,n);t&&Object.keys(u.calendars).forEach(function(r){var o=u.calendars[r];if(-1!==o.stores.indexOf(n)){var a=t.proxy.calendars[r],i=e.clone(a);A(t,i),O(u,{storeId:n,data:i}),h(u,o)}})}},s.removeClient=function(e){!function(e,n){var t=e.clients.indexOf(n);-1!==t&&e.clients.splice(t,1),Object.keys(e.calendars).forEach(function(t){var r=e.calendars[t];if(1===r.stores.length&&0===r.stores[0]&&r.tempId.length){var o=r.tempId.indexOf(n);-1!==o&&r.tempId.splice(o,1),r.tempId.length||(r.stores=[],v(e,t))}})}(u,e)},s.execCommand=function(t,o,a){var s=o.cmd,c=o.data;if("SUBSCRIBE"!==s){if("OPEN"!==s)return"IMPORT"===s?u.store.offline?void a({error:"OFFLINE"}):u.loggedIn?void function(t,r,o,a){var i=r.id,s=t.calendars[i];if(s)if(Array.isArray(s.stores)&&-1!==s.stores.indexOf(r.teamId)){var c=t.store,u=c.proxy.calendars=c.proxy.calendars||{},f=s.hashes.editHash,l=s.hashes.viewHash;u[i]={href:f&&n.hashToHref(f,"calendar"),roHref:l&&n.hashToHref(l,"calendar"),channel:i,color:e.find(s,["proxy","metadata","color"])||e.getRandomColor(),title:e.find(s,["proxy","metadata","title"])||"..."},t.Store.onSync(null,a),O(t,{storeId:1,data:{href:u[i].href,toHref:u[i].roHref,channel:i}})}else a({error:"EINVAL"});else a({error:"ENOENT"})}(u,c,0,a):void a({error:"NOT_LOGGED_IN"}):"IMPORT_ICS"===s?u.store.offline?void a({error:"OFFLINE"}):void function(e,n,t,o){var a=n.id,i=e.calendars[a];if(i&&i.proxy){var s=n.json;i.proxy.content=i.proxy.content||{},Object.keys(s).forEach(function(n){i.proxy.content[n]=s[n],E(e,a,s[n])}),r.whenRealtimeSyncs(i.lm.realtime,function(){h(e,i),o()})}else o({error:"ENOENT"})}(u,c,0,a):"ADD"===s?u.store.offline?void a({error:"OFFLINE"}):u.loggedIn?void function(t,r,o,a){var i=d(t,r.teamId);if(i)if(i.rpc){var s=i.proxy.calendars=i.proxy.calendars||{},c=n.parsePadUrl(r.href),u=n.getSecrets(c.type,c.hash,r.password);if(u.channel===r.channel){var f=n.getEditHashFromKeys(u),l=n.getViewHashFromKeys(u),h=f&&n.hashToHref(f,"calendar"),p={href:h,roHref:l&&n.hashToHref(l,"calendar"),color:r.color,title:r.title,channel:r.channel};!s[r.channel]||!s[r.channel].href&&p.href?(p.color=r.color,p.title=r.title,O(t,{storeId:i.id||1,data:e.clone(p)},function(e){if(e)return console.error(e),void a({error:e.error});if(h&&i.id&&i.secondaryKey)try{p.href=i.userObject.cryptor.encrypt(h)}catch(e){console.error(e)}s[p.channel]=p,(i.pin||t.pinPads)([p.channel],function(e){e&&e.error&&console.error(e.error)}),t.Store.onSync(i.id,a)})):a()}else a({error:"EINVAL"})}else a({error:"EFORBIDDEN"});else a({error:"NO_STORE"})}(u,c,0,a):void a({error:"NOT_LOGGED_IN"}):"CREATE"===s?u.loggedIn?c.initialCalendar?void u.Store.onReadyEvt.reg(function(){D(u,c,0,a)}):u.store.offline?void a({error:"OFFLINE"}):void D(u,c,0,a):void a({error:"NOT_LOGGED_IN"}):"UPDATE"===s?u.store.offline?void a({error:"OFFLINE"}):void function(n,t,o,a){var i=t.id,s=n.calendars[i];if(s){var c=e.find(s,["proxy","metadata"]);c?(c.title=t.title,c.color=t.color,r.whenRealtimeSyncs(s.lm.realtime,a),h(n,s),y(n,s,t)):a({error:"EINVAL"})}else a({error:"ENOENT"})}(u,c,0,a):"DELETE"===s?u.store.offline?void a({error:"OFFLINE"}):u.loggedIn?void function(e,n,t,r){var o=d(e,n.teamId);if(o)if(o.rpc){if(o.proxy.calendars){var a=n.id;if(o.proxy.calendars[a]){delete o.proxy.calendars[a],(o.unpin||e.unpinPads)([a],function(e){e&&e.error&&console.error(e.error)});var i=e.calendars[a],s=i.stores.indexOf(o.id||1);i.stores.splice(s,1),v(e,a),e.Store.onSync(o.id,function(){h(e,i),r()})}else r()}}else r({error:"EFORBIDDEN"});else r({error:"NO_STORE"})}(u,c,0,a):void a({error:"NOT_LOGGED_IN"}):"CREATE_EVENT"===s?u.store.offline?void a({error:"OFFLINE"}):void function(e,n,t,o){var a=n.calendarId,i=e.calendars[a];if(i){var s=new Date(n.start),c=new Date(n.end);n.isAllDay?(n.startDay=s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate(),n.endDay=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate()):(delete n.startDay,delete n.endDay),i.proxy.content=i.proxy.content||{},i.proxy.content[n.id]=n,r.whenRealtimeSyncs(i.lm.realtime,function(){E(e,a,n),h(e,i),o()})}else o({error:"ENOENT"})}(u,c,0,a):"UPDATE_EVENT"===s?u.store.offline?void a({error:"OFFLINE"}):void function(n,t,o,a){if(t&&t.ev){var s=t.ev.calendarId,c=n.calendars[s];if(c&&c.proxy&&c.proxy.content){var u=c.proxy.content[t.ev.id];if(u){t.rawData=t.rawData||{};var f,l=t.changes||{},d=t.type||{};if(l.calendarId){if(!(f=n.calendars[l.calendarId])||!f.proxy)return void a({error:"ENOENT"});f.proxy.content=f.proxy.content||{}}var p={one:{},from:{}};["one","from","all"].includes(d.which)&&(u.recUpdate=u.recUpdate||p,u.recUpdate.one||(u.recUpdate.one={}),u.recUpdate.from||(u.recUpdate.from={}));var v=u.recUpdate,y=["calendarId"],m=Object.keys(l).filter(function(e){return!y.includes(e)}),g=function(e){[v.from,v.one].forEach(function(n){Object.keys(n).forEach(function(t){Number(t)<e||delete n[t]})})},b=function(e,n){Object.keys(e).forEach(function(t){n&&Number(t)<n||m.forEach(function(n){delete e[t][n]})})};if(void 0!==l.recurrenceRule&&("all"===d.which&&l.recurrenceRule.until?g(l.recurrenceRule.until):["one","from"].includes(d.which)&&!t.rawData.isOrigin?g(d.when+1):v=u.recUpdate=p),"one"===d.which?v.one[d.when]=v.one[d.when]||{}:"from"===d.which?(v.from[d.when]=v.from[d.when]||{},b(v.from,d.when),b(v.one,d.when)):"all"===d.which&&(b(v.from),b(v.one)),l.start&&v&&(!d.which||"all"===d.which)){var O=l.start-u.start,A={},w={};Object.keys(v.one||{}).forEach(function(e){A[Number(e)+O]=v.one[e]}),Object.keys(v.from||{}).forEach(function(e){w[Number(e)+O]=v.from[e]}),v.one=A,v.from=w}var D=e.find(n,["store","proxy","hideReminders"])||{};l.reminders&&("one"===d.which?d.when&&d.when!==u.start?delete D[t.ev.id+"|"+d.when]:delete D[t.ev.id]:"from"===d.which?Object.keys(D).filter(function(e){return 0===e.indexOf(t.ev.id)}).forEach(function(e){var n=Number(e.split("|")[1]);n&&(n<d.when||delete D[e])}):Object.keys(D).filter(function(e){return 0===e.indexOf(t.ev.id)}).forEach(function(e){delete D[e]})),Object.keys(l).forEach(function(e){if(!y.includes(e)&&"one"===d.which)return"recurrenceRule"===e?t.rawData&&t.rawData.isOrigin?u[e]=l[e]:(v.from[d.when]=v.from[d.when]||{},v.from[d.when][e]=l[e]):void(v.one[d.when][e]=l[e]);y.includes(e)||"from"!==d.which?u[e]=l[e]:v.from[d.when][e]=l[e]});var _=new Date(u.start),T=new Date(u.end);u.isAllDay?(u.startDay=_.getFullYear()+"-"+(_.getMonth()+1)+"-"+_.getDate(),u.endDay=T.getFullYear()+"-"+(T.getMonth()+1)+"-"+T.getDate()):(delete u.startDay,delete u.endDay),l.calendarId&&f&&(f.proxy.content[t.ev.id]=e.clone(u),delete c.proxy.content[t.ev.id]),i(function(e){r.whenRealtimeSyncs(c.lm.realtime,e()),f&&r.whenRealtimeSyncs(f.lm.realtime,e())}).nThen(function(){f?(E(n,s,{id:u.id,start:0}),E(n,u.calendarId,u)):(l.start||l.reminders||l.isAllDay)&&E(n,s,u),h(n,c),f&&h(n,f),a()})}else a({error:"EINVAL"})}else a({error:"ENOENT"})}else a({error:"EINVAL"})}(u,c,0,a):"DELETE_EVENT"===s?u.store.offline?void a({error:"OFFLINE"}):void function(e,n,t,o){var a=n.calendarId,i=e.calendars[a];if(i){i.proxy.content=i.proxy.content||{};var s=n.id.split("|")[0];if(n.id===s)delete i.proxy.content[n.id];else{var c=i.proxy.content[s],u=n.raw&&n.raw.start;u&&(c.recUpdate=c.recUpdate||{one:{},from:{}},c.recUpdate.one[u]={deleted:!0})}r.whenRealtimeSyncs(i.lm.realtime,function(){E(e,a,{id:n.id,start:0}),h(e,i),o()})}else o({error:"ENOENT"})}(u,c,0,a):void 0;u.Store.onReadyEvt.reg(function(){!function(t,r,o,a){var i=n.getSecrets("calendar",r.hash,r.password),s=n.getEditHashFromKeys(i),c=n.getViewHashFromKeys(i),u={href:s&&n.hashToHref(s,"calendar"),roHref:c&&n.hashToHref(c,"calendar"),channel:i.channel,color:e.getRandomColor(),title:"..."};O(t,{cId:o,storeId:0,data:u},a)}(u,c,t,a)})}else!function(e,n,t,r){-1===e.clients.indexOf(t)&&e.clients.push(t),r({length:Object.keys(e.calendars).length}),Object.keys(e.calendars).forEach(function(n){var t=e.calendars[n]||{};h(e,t)})}(u,0,t,a)},s},l})(Z(),te(),Y(),je(),fe(),Yt(),qe(),T(),zt(),M(),x()),Jt}var Zt=r(h());let Xt={};const $t=(e,n,t)=>{const r=[],o=null==Xt?void 0:Xt.httpUnsafeOrigin;ie.fetchApi(o,"config",!0,e=>{var o,a;(null===(o=null==e?void 0:e.adminKeys)||void 0===o?void 0:o.includes(n))&&r.push("admin");(null===(a=null==e?void 0:e.moderatorKeys)||void 0===a?void 0:a.includes(n))&&r.push("moderator"),t(r)})},er=(e,n,t)=>{e.Store.anonRpcMsg("",{msg:"IS_PREMIUM",data:n},e=>{let n=Array.isArray(e)&&e[0];t(n?["premium"]:[])})},nr=(e,n,t,r)=>{var o,a;const i=[];null==Xt||Xt.httpUnsafeOrigin;const s=n.edPublic||(null===(a=null===(o=e.store)||void 0===o?void 0:o.proxy)||void 0===a?void 0:a.edPublic);rt(e=>{$t(0,s,e(e=>{Array.prototype.push.apply(i,e)}))}).nThen(n=>{er(e,s,n(e=>{Array.prototype.push.apply(i,e)}))}).nThen(()=>{r(i)})},tr={admin:$t,moderator:$t,premium:er},rr={init:(e,n,t)=>{const r={store:e.store,Store:e.Store,updateMetadata:e.updateMetadata},o=r.Store;return o.onReadyEvt.reg(()=>{var e;const n=o.getMetadata(void 0,"drive",()=>{}),t=(null===(e=null==n?void 0:n.user)||void 0===e?void 0:e.badge)||"";t&&nr(r,{},0,e=>{var n,o;if(!e.includes(t)){const e=null===(o=null===(n=null==r?void 0:r.store)||void 0===n?void 0:n.modules)||void 0===o?void 0:o.profile;null==e||e.execCommand(void 0,{cmd:"SET",data:{key:"badge",value:""}},()=>{})}})}),{listBadges:(e,n)=>{nr(r,e,0,n)},removeClient:()=>{},execCommand:(e,n,t)=>{const o=n.cmd,a=n.data;"LIST_BADGES"!==o?"CHECK_BADGE"!==o?t():((e,n,t,r)=>{const{badge:o,ed:a,sig:i,nid:s}=n,c=ie.decodeBase64(a),u=ie.decodeBase64(i),f=Zt.sign.open(u,c);if(!f)return void r({verified:!1});if(ie.encodeUTF8(f)!==s)return void r({verified:!1});let l=tr[o];l?l(e,a,e=>{r({verified:e.includes(o),badge:o})}):r({verified:!1,error:"EINVAL"})})(r,a,0,t):nr(r,a,0,t)}}},setCustomize:e=>{Xt=null==e?void 0:e.ApiConfig}};var or,ar,ir=o(Object.freeze({__proto__:null,Badge:rr}));function sr(){if(ar)return or;ar=1;return or=((e,n,t,r,o,a,i,s,c,u,f,l,d,h,p,v,y,m,g,E,b,O,A,w,D,_,T,S,N,I,x,C,R,P,k,M)=>{const F=p.Account,L=v.Drive,H=y.Pad,j=S.Badge,K=globalThis;globalThis.nacl=globalThis.nacl||x.Nacl;let U={},B={};const V=a.Saferphore;var Y=a.mkEvent(!0),G=a.mkEvent(!0),J=a.mkEvent(!0);var q={drive:{hideDuplicate:!0},pad:{width:!0,spellcheck:!0},security:{unsafeLinks:!1},general:{allowUserFeedback:!0}};return{setCustomize:e=>{U=e.ApiConfig,B=e.AppConfig},create:function(p){var v=K.Cryptpad_Store={};let y=p.query||function(){},S=p.broadcast||function(){};var C=K.CryptPad_AsyncStore={modules:{}};v.onReadyEvt=Y,v.pad=H.init({Store:v,store:C,postMessage:y,broadcast:S}),v.drive=L.initAPI({Store:v,store:C,postMessage:y,broadcast:S});var R=[],P=C.sendDriveEvent=function(e,n,t){R.forEach(function(r){r!==t&&y(r,e,n)})},W=v.getStore=function(e){if(!e)return C;try{var n=C.modules.team.getTeam(e);return n||void console.error("Team not found",e)}catch(n){return console.error(n),void console.error("Team not found",e)}},z=v.onSync=function(e,n){var t=W(e);t?M(function(e){if(t.realtime&&c.whenRealtimeSyncs(t.realtime,e()),!t.id&&t.drive?.realtime&&c.whenRealtimeSyncs(t.drive.realtime,e()),t.sharedFolders&&"object"==typeof t.sharedFolders)for(var n in t.sharedFolders)t.sharedFolders[n].realtime&&c.whenRealtimeSyncs(t.sharedFolders[n].realtime,e())}).nThen(function(){n()}):n({error:"ENOTFOUND"})};v.get=function(e,n,t){var r=W(n.teamId);r?r.proxy?t(a.find(r.proxy,n.key)):t({error:"ENODRIVE"}):t({error:"ENOTFOUND"})},v.set=function(e,n,t){var r=W(n.teamId);if(r)if(r.proxy){var o=n.key.slice(),i=o.pop(),s=a.find(r.proxy,o);s&&"object"==typeof s?(void 0===n.value?delete s[i]:s[i]=n.value,n.teamId||(S([e],"UPDATE_METADATA"),Array.isArray(o)&&"profile"===o[0]&&C.messenger&&u.updateMyData(C)),z(n.teamId,t)):t({error:"INVALID_PATH"})}else t({error:"ENODRIVE"});else t({error:"ENOTFOUND"})},v.getSharedFolder=function(e,t,r){var o,i=W(t.teamId),s=t.id;if(i&&i.manager){if(i.manager.folders[s])return(o=a.clone(i.manager.folders[s].proxy)).offline=Boolean(i.manager.folders[s].offline),void r(o);var c=a.find(i.proxy,["drive",n.SHARED_FOLDERS])||{};c[s]?v.loadSharedFolder(t.teamId,s,c[s],function(){r(i.manager.folders[s].proxy)}):r({})}else r({error:"ENOTFOUND"})},v.restoreSharedFolder=function(e,n,t){if(n.sfId&&n.drive){var r=W(n.teamId);r.sharedFolders[n.sfId]&&(Object.keys(n.drive).forEach(function(e){r.sharedFolders[n.sfId].proxy[e]=n.drive[e]}),Object.keys(r.sharedFolders[n.sfId].proxy).forEach(function(e){n.drive[e]||delete r.sharedFolders[n.sfId].proxy[e]})),z(n.teamId,t)}else t({error:"EINVAL"})},v.hasSigningKeys=function(){if(C.proxy)return"string"==typeof C.proxy.edPrivate&&"string"==typeof C.proxy.edPublic},v.hasCurveKeys=function(){if(C.proxy)return"string"==typeof C.proxy.curvePrivate&&"string"==typeof C.proxy.curvePublic},v.isOwned=function(e){var n=C.proxy.edPublic;if(!n)return!1;if(!Array.isArray(e)||!e.length)return!1;if(-1!==e.indexOf(n))return!0;var t=C.proxy.teams;return!!t&&Object.keys(t).some(function(n){var r=a.find(t[n],["keys","drive","edPublic"]);return r&&-1!==e.indexOf(r)})};var Q=function(e){var n=e?C.manager.getChannelsList("expirable"):function(){var e=`${C.driveChannel}#drive`;if(!e)return null;var n=C.manager.getChannelsList("pin"),t=C.proxy.profile;if(t){var r=t.edit?o.hrefToHexChannelId("/profile/#"+t.edit,null):null;r&&n.push(r);var a=t.avatar?o.hrefToHexChannelId(t.avatar,null):null;a&&n.push(a)}if(C.proxy.todo&&n.push(o.hrefToHexChannelId("/todo/#"+C.proxy.todo,null)),C.proxy.friends){var i=u.getFriendChannelsList(C.proxy);n=n.concat(i)}if(C.proxy.mailboxes){var s=Object.keys(C.proxy.mailboxes).map(function(e){if("broadcast"!==e||C.isAdmin)return C.proxy.mailboxes[e].channel}).filter(Boolean);n=n.concat(s)}if(C.proxy.calendars){var c=Object.keys(C.proxy.calendars).map(function(e){return C.proxy.calendars[e].channel});n=n.concat(c)}return n.push(e),C.data&&C.data.blockId&&n.push(`${C.data.blockId}#block`),n.sort(),n}();return a.deduplicateString(n).sort()};v.pinPads=function(e,n,t){if(n){var r=W(n&&n.teamId);if(r.rpc){"function"!=typeof t&&(console.error("expected a callback"),t=function(){});var o=n.pads||n;r.rpc.pin(o,function(e){t(e?{error:e}:{})})}else t({error:"RPC_NOT_READY"})}else t({error:"EINVAL"})},v.unpinPads=function(e,n,t){if(n){var r=W(n&&n.teamId);if(r.rpc){var o=n.pads||n;r.rpc.unpin(o,function(e){t(e?{error:e}:{})})}else t({error:"RPC_NOT_READY"})}else t({error:"EINVAL"})};var Z=C.account={};v.getPinnedUsage=function(e,n,t){var r=W(n&&n.teamId);r&&r.rpc?r.rpc.getFileListSize(function(e,n){r.id||"number"!=typeof n||(Z.usage=n),t({bytes:n})}):t({error:"RPC_NOT_READY"})},v.getPinLimit=function(e,n,t){var r=W(n&&n.teamId);r.rpc?r.rpc.getLimit(function(e,n,o,a){if(e)t({error:e});else{var i=r.id?{}:Z;i.limit=n,i.plan=o,i.note=a,t(i)}}):t({error:"RPC_NOT_READY"})};v.uploadComplete=function(e,n,t){var r=W(n.teamId);r?r.rpc?n.owned?r.rpc.ownedUploadComplete(n.id,function(e,n){t(e?{error:e}:n)}):r.rpc.uploadComplete(n.id,function(e,n){t(e?{error:e}:n)}):t({error:"RPC_NOT_READY"}):t({error:"ENOTFOUND"})},v.uploadStatus=function(e,n,t){var r=W(n.teamId);r?r.rpc?r.rpc.uploadStatus(n.size,function(e,n){t(e?{error:e}:n)}):t({error:"RPC_NOT_READY"}):t({error:"ENOTFOUND"})},v.uploadCancel=function(e,n,t){var r=W(n.teamId);r?r.rpc?r.rpc.uploadCancel(n.size,function(e,n){t(e?{error:e}:n)}):t({error:"RPC_NOT_READY"}):t({error:"ENOTFOUND"})},v.uploadChunk=function(e,n,t){var r=W(n.teamId);r?r.rpc?r.rpc.send.unauthenticated("UPLOAD",n.chunk,function(e,n){t({error:e,msg:n})}):t({error:"RPC_NOT_READY"}):t({error:"ENOTFOUND"})};v.anonRpcMsg=function(e,n,t){C.anon_rpc?C.anon_rpc.send(n.msg,n.data,function(e,n){t(e?{error:e}:n)}):t({error:"ANON_RPC_NOT_READY"})},v.getFileSize=function(e,n,t){var r=a.once(a.mkAsync(t));if(C.anon_rpc){var i=n.channel||o.hrefToHexChannelId(n.href,n.password);C.anon_rpc.send("GET_FILE_SIZE",i,function(e,n){if(!e)return n&&n.length&&"number"==typeof n[0]?(0===n[0]&&d.clearChannel(i),void r({size:n[0]})):void r({error:"INVALID_RESPONSE"});r({error:e})})}else r({error:"ANON_RPC_NOT_READY"})},v.isNewChannel=function(e,n,t){if(C.anon_rpc){var r=n.channel||o.hrefToHexChannelId(n.href,n.password);C.anon_rpc.send("IS_NEW_CHANNEL",r,function(e,n){if(!e)return n&&n.length&&"object"==typeof n[0]?(n[0].isNew&&d.clearChannel(r),void t(n[0])):void t({error:"INVALID_RESPONSE"});t({error:e})})}else t({error:"ANON_RPC_NOT_READY"})},v.getMultipleFileSize=function(e,n,t){C.anon_rpc?Array.isArray(n.files)?C.anon_rpc.send("GET_MULTIPLE_FILE_SIZE",n.files,function(e,n){e?t({error:e}):n&&n.length&&"object"==typeof n[0]?t({size:n[0]}):t({error:"UNEXPECTED_RESPONSE"})}):t({error:"INVALID_FILE_LIST"}):t({error:"ANON_RPC_NOT_READY"})},v.getDeletedPads=function(e,n,t){if(C.anon_rpc){var r=n&&n.list||Q(!0);Array.isArray(r)?C.anon_rpc.send("GET_DELETED_PADS",r,function(e,n){e?t({error:e}):n&&n.length&&Array.isArray(n[0])?t(n[0]):t({error:"UNEXPECTED_RESPONSE"})}):t({error:"INVALID_FILE_LIST"})}else t({error:"ANON_RPC_NOT_READY"})};var X=function(e,n,t){C.anon_rpc?t():l.createAnonymous(C.network,function(e,n){e?t({error:e}):(C.anon_rpc=n,t())})},$=v.getAllStores=function(){if(!C.proxy||!C.manager)return[];var e=[C],n=C.modules.team;if(n){var t=n.getTeams().map(function(e){return n.getTeam(e)});Array.prototype.push.apply(e,t)}return e};v.getUserColor=function(){var e=a.find(C,["proxy","settings","general","cursor","color"]);return e||(e=a.getRandomColor(!0),v.setAttribute(null,{attr:["general","cursor","color"],value:e},function(){})),e},v.getMetadata=function(e,n,t){var r=C.proxy||{},s=a.find(r,["settings","general","disableThumbnails"]),c=C.modules.team&&C.modules.team.getTeamsData(n)||{};r.uid||(C.noDriveUid=C.noDriveUid||o.createChannelId());var u={user:{name:r[i.displayNameKey]||C.noDriveName||"",uid:r.uid||C.noDriveUid,avatar:a.find(r,["profile","avatar"]),profile:a.find(r,["profile","view"]),color:v.getUserColor(),notifications:a.find(r,["mailboxes","notifications","channel"]),curvePublic:r.curvePublic,edPublic:r.edPublic,netfluxId:C?.network?.webChannels?.[0]?.myID,badge:a.find(r,["profile","badge"])},priv:{clientId:e,edPublic:r.edPublic,edPrivate:r.edPrivate,friends:r.friends||{},settings:r.settings||q,thumbnails:!1===s,isDriveOwned:Boolean(a.find(C,["driveMetadata","owners"])),driveChannel:C.driveChannel,pendingFriends:r.friends_pending||{},supportPrivateKey:a.find(r,["mailboxes","supportadmin","keys","curvePrivate"]),accountName:r.login_name||"",offline:C.proxy&&C.offline,teams:c,plan:C.ready?Z.plan||"":void 0,mutedChannels:r.mutedChannels}};return t(JSON.parse(JSON.stringify(u))),u},v.onMaintenanceUpdate=function(){let e=U.httpUnsafeOrigin;a.fetchApi(e,"broadcast",!0,e=>{e&&S([],"UNIVERSAL_EVENT",{type:"broadcast",data:{ev:"MAINTENANCE",data:e.maintenance}})})},v.onSurveyUpdate=function(){let e=U.httpUnsafeOrigin;a.fetchApi(e,"broadcast",!0,e=>{S([],"UNIVERSAL_EVENT",{type:"broadcast",data:{ev:"SURVEY",data:e.surveyURL}})})};v.addPad=function(e,t,r){if(t.href||t.roHref){var a;if(!t.roHref){var i=o.parsePadUrl(t.href);"pad"===i.hashData.type&&(a=o.getSecrets(i.type,i.hash,t.password),t.roHref="/"+i.type+"/#"+o.getViewHashFromKeys(a))}var s,c,u,f,l=(s=t.href,c=t.roHref,u=t.title,f=+new Date,{href:s,roHref:c,atime:f,ctime:f,title:u||n.getDefaultName(o.parsePadUrl(s))});t.owners&&(l.owners=t.owners),t.expire&&(l.expire=t.expire),t.password&&(l.password=t.password),(t.channel||a)&&(l.channel=t.channel||a.channel),t.readme&&(l.readme=1),Object.keys(t.attributes||{}).forEach(e=>{t.attributes[e]&&(l[e]=t.attributes[e])}),-1===t.teamId&&(t.teamId=void 0);var d=W(t.teamId);d&&d.manager?d.manager.addPad(t.path,l,function(o){o?r({error:o}):($().forEach(function(t){(t.id?t.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e)}),z(t.teamId,r))}):r({error:"ENOTFOUND"})}else r({error:"NO_HREF"})};var ee=function(e,n){var t=a.find(C,["proxy","edPublic"]),r=function(e){var n=[];return e?(C.proxy.todo&&n.push(o.hrefToHexChannelId("/todo/#"+C.proxy.todo,null)),C.proxy.profile&&C.proxy.profile.edit&&n.push(o.hrefToHexChannelId("/profile/#"+C.proxy.profile.edit,null)),C.proxy.mailboxes&&Object.keys(C.proxy.mailboxes||{}).forEach(function(e){if("supportadmin"!==e){var t=C.proxy.mailboxes[e];n.push(t.channel)}})):n=C.manager.getChannelsList("owned"),n.filter(function(e){if("string"==typeof e)return-1!==[32,48].indexOf(e.length)})}(e),i=V.create(10),s=function(n){e||C.manager.findChannel(n).forEach(function(e){var n=C.manager.findFile(e.id);C.manager.delete({paths:n})})};r.forEach(function(e){var r=n();i.take(function(n){var o=!1;M(function(a){32===e.length&&v.anonRpcMsg(null,{msg:"GET_METADATA",data:e},a(function(i){if(i&&i.error)return n(),r(),void a.abort();var c=i[0];return Object.keys(c||{}).length?c&&Array.isArray(c.owners)&&-1!==c.owners.indexOf(t)?void(o=c.owners.some(function(e){return e!==t})):(n(),r(),void a.abort()):(s(e),n(),r(),void a.abort())}))}).nThen(function(n){o?v.pad.setMetadata(null,{channel:e,command:"RM_OWNERS",value:[t]},n()):C.rpc.removeOwnedChannel(e,n(function(n){n?console.error(n):s(e)}))}).nThen(function(){n(),r()})})})};v.removeOwnedPads=function(e,n,t){C.proxy.edPublic?M(function(e){ee(!1,e)}).nThen(t):t({error:"NOT_LOGGED_IN"})},v.deleteAccount=function(n,t,r){var o=C.proxy.edPublic,s=t&&t.keys,c=t&&t.auth;v.anonRpcMsg(n,{msg:"GET_METADATA",data:C.driveChannel},function(t){var u=t[0];if(u&&u.owners&&1===u.owners.length&&-1!==u.owners.indexOf(o))M(function(e){N.checkRights({auth:c,blockKeys:s},e(function(n){if(n)return e.abort(),console.error(n),void r({error:"INVALID_CODE"})}))}).nThen(function(e){globalThis.accountDeletion=n,C.proxy[i.tokenKey]="DELETED",z(null,e())}).nThen(function(e){C.rpc.removePins(e(function(e){e&&console.error(e)}))}).nThen(function(e){C.ownDeletion=!0,v.pad.destroy(n,{channel:C.driveChannel,force:!0},e())}).nThen(function(e){s&&N.removeLoginBlock({reason:"ARCHIVE_OWNED",auth:c,edPublic:o,blockKeys:s},e(function(e){e&&console.error(e)}))}).nThen(function(e){ee(!0,e)}).nThen(function(){S([n],"DRIVE_DELETED","ARCHIVE_OWNED"),y(n,"DELETE_ACCOUNT","DELETED",function(){}),C.network.disconnect(),r({state:!0})});else{var f={intent:"Please delete my account."};f.drive=C.driveChannel,f.edPublic=o;var l=a.decodeBase64(C.proxy.edPrivate),d=x.Nacl.sign.detached(a.decodeUTF8(e(f)),l);x.Nacl.sign.detached.verify(a.decodeUTF8(e(f)),d,a.decodeBase64(o))||console.error("signed message failed verification");var h=a.encodeBase64(d);r({proof:h,toSign:JSON.parse(e(f))})}})},v.setDisplayName=function(e,n,t){if(!C.proxy)return C.noDriveName=n,S([e],"UPDATE_METADATA"),void t();C.modules.profile&&C.modules.profile.setName(n),C.proxy[i.displayNameKey]=n,S([e],"UPDATE_METADATA"),u.updateMyData(C),z(null,t)},v.resetDrive=function(e,n,t){M(function(e){ee(e)}).nThen(function(){C.proxy.drive=C.userObject.getStructure(),P("DRIVE_CHANGE",{path:["drive","filesData"]},e),z(null,t)})},v.setPadAttribute=function(e,t,r){M(function(r){$().forEach(function(o){o.manager.setPadAttribute(t,r(function(){(o.id?o.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e),z(o.id,r())}))})}).nThen(r)},v.getPadAttribute=function(e,n,t){var r={};M(function(e){$().forEach(function(t){t.manager.getPadAttribute(n,e(function(e,n){e||(n&&"object"==typeof n?(!r.value||r.atime<n.atime)&&(r.atime=n.atime,r.value=n.value):console.error("Not an object!"))}))})}).nThen(function(){t(r.value)})};var ne=function(e){if("string"==typeof e)return console.error("DEPRECATED: use setAttribute with an array, not a string"),{path:["settings"],obj:C.proxy?.settings,key:e};if(Array.isArray(e))if(0!==e.length){var n=C.proxy?.settings;if(n)return e.forEach(function(t,r){if(r!==e.length-1){if(n[t]){if("object"!=typeof n[t])return void console.error("Wrong attribute")}else n[t]={};n=n[t]}}),{path:["settings"].concat(e),obj:n,key:e[e.length-1]}}else console.error("Attribute can't be empty");else console.error("Attribute must be string or array")};v.setAttribute=function(e,n,t){try{var r=ne(n.attr);r.obj[r.key]=n.value}catch(e){return void t({error:e})}z(null,function(){t(),S([],"UPDATE_METADATA")})},v.getAttribute=function(e,n,t){var r;try{r=ne(n.attr)}catch(e){return void t({error:e})}t(r?.obj[r.key])},v.listAllTags=function(e,n,t){var r={};$().forEach(function(e){var n=e.manager.getTagsList();Object.keys(n).forEach(function(e){r[e]=(r[e]||0)+n[e]})}),t(r)},v.getTemplates=function(e,n,t){var r=[],o=[];$().forEach(function(e){e.userObject.getFiles(["template"]).forEach(function(n){var t=e.userObject.getFileData(n);-1===o.indexOf(t.channel)&&(o.push(t.channel),r.push(JSON.parse(JSON.stringify(t))))})}),t(r)},v.incrementTemplateUse=function(e,n){$().forEach(function(e){e.userObject.getPadAttribute(n,"used",function(t,r){if(!t){var o="number"==typeof r?++r:1;e.userObject.setPadAttribute(n,"used",o)}})})},v.isOnlyInSharedFolder=function(e,n,t){var r=!1,o=function(e){return!e.fId};return $().some(function(e){var t=e.manager.findChannel(n);if(t.length)return t.some(o)?(r=!1,!0):void(r=!0)}),t(r)},v.moveToTrash=function(e,t,r){var a=o.getRelativeHref(t.href),i=!0;M(function(t){$().forEach(function(r){r.userObject.forget(a)&&(i=!1,(r.id?r.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e),z(r.id,t()))})}).nThen(function(){r({error:i?"FORBIDDEN":void 0})})},v.setPadTitle=function(e,t,r){Y.reg(function(){var i=t.title,c=t.href,u=t.channel,f=o.parsePadUrl(c),l=f.hashData;if(""===i.trim()&&(i=n.getDefaultName(f)),!B.disableAnonymousStore||C.loggedIn)if("debug"!==f.type){var d,h,p=v.pad.getChannels()[u];p&&p.wc&&u===p.wc.id&&(d=p.data.owners||void 0),t.owners&&(d=t.owners),p&&p.wc&&u===p.wc.id&&(h=+p.data.expire||void 0),t.expire&&(h=t.expire),t.teamId&&(t.teamId=Number(t.teamId));var m,g,E=[],b=[];$().forEach(function(e){if("edit"!==l.mode||!e.id||e.secondaryKey){var n=e.manager.findChannel(u,!0);n.length&&b.push(e.id),(e.id||t.teamId&&-1!==t.teamId)&&Number(e.id)!==t.teamId||m||(m=n.length),e.id||(g=n.length),Array.prototype.push.apply(E,n)}});var O=0!==E.length;if(!C.offline||O)if(C.offline)r();else{if(E.forEach(function(e){var n=e.data;n.atime=+new Date,n.title=i,(d||"file"!==l.type)&&(n.owners=d),n.expire=h,n.readme&&(delete n.readme,s.send("OPEN_README")),"view"!==l.mode&&(n.href||e.userObject.restoreHref(c),e.userObject.setHref(u,null,c))}),!O||t.forceSave&&!m){var A,w=a.find(C.proxy,["settings","general","autostore"]);return 1===w||t.forceSave||t.path?("view"===l.mode&&(A=c,c=void 0),v.addPad(e,{teamId:t.teamId,href:c,roHref:A,channel:u,title:i,owners:d,expire:h,password:t.password,path:t.path,attributes:t.attributes},r),void y(e,"AUTOSTORE_DISPLAY_POPUP",{stored:!0,inMyDrive:g||!O&&!t.teamId})):(y(e,"AUTOSTORE_DISPLAY_POPUP",{autoStore:w}),void r({notStored:!0}))}b.forEach(function(t){(t?W(t).sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e)}),y(e,"AUTOSTORE_DISPLAY_POPUP",{stored:!0,inMyDrive:g}),M(function(e){b.forEach(function(n){z(n,e())})}).nThen(r)}else r({error:"OFFLINE"})}else r({notStored:!0});else r({notStored:!0})})},v.getSecureFilesList=function(e,n,t){var r={},a=n.types,i=n.where,s=n.filter||{},c=[];$().forEach(function(e){e.manager.getSecureFilesList(i).forEach(function(e){var n=e.data;if(-1===c.indexOf(n.channel||n.id)){var t=e.id;if(n.channel&&c.push(n.channel||n.id),n.static)-1!==a.indexOf("link")&&(r[t]=n);else{var i=o.parsePadUrl(n.href||n.roHref);a&&0!==a.length&&-1===a.indexOf(i.type)||function(e,n){var t,r=s.fileType||[];if("file"===e&&r.length){if(!n.fileType)return!0;t=!r.some(function(e){return 0===n.fileType.indexOf(e)})}return t}(i.type,n)||(r[t]=n)}}})}),t(r)},v.getPadData=function(e,n,t){var r={};$().some(function(e){var t=e.userObject.getFileData(n);if(t.roHref||t.href)return r=t,!0}),t(r)},v.getPadDataFromChannel=function(e,n,t){var r,o,a=n.channel,i=n.edit,s=n.file;$().some(function(e){var n=e.manager.findChannel(a);if(Array.isArray(n))return n.some(function(e){if(e&&e.data){var n=e.data;if(i&&n.href||!i&&n.roHref||s)return r=n,!0;i&&!o&&n.roHref&&(o=n)}})});var c=r||o;c||!C.offline?t(c||{}):Y.reg(function(){v.getPadDataFromChannel(e,n,t)})},v.checkDeletedPad=function(e,n){e&&v.getPadDataFromChannel(null,{channel:e,isFile:!0},function(t){"function"==typeof n&&setTimeout(n),Object.keys(t).length||S([],"CHANNEL_DELETED",e)})},v.answerFriendRequest=function(e,n,t){var r=n.value,o=n.data;if("notifications"===o.type){var a=o.content.hash,i=o.content.msg,s=function(e){e=e||function(){},C.mailbox.dismiss({hash:a,type:"notifications"},e)};r?u.acceptFriendRequest(C,i.content.user,function(e){e&&e.error?t(e):u.addToFriendList({proxy:C.proxy,realtime:C.realtime,pinPads:function(e,n){v.pinPads(null,e,n)}},i.content.user,function(e){C.messenger&&C.messenger.onFriendAdded(i.content.user),S([],"UPDATE_METADATA"),e?t({error:e}):s(t)})}):(u.declineFriendRequest(C,i.content.user,function(e){S([],"UPDATE_METADATA"),t(e)}),s())}else t({error:"EINVAL"})},v.sendFriendRequest=function(e,n,t){u.getFriend(C.proxy,n.curvePublic)?t({error:"ALREADY_FRIEND"}):n.notifications&&n.curvePublic?(C.proxy.friends_pending=C.proxy.friends_pending||{},C.proxy.friends_pending[n.curvePublic]?t({error:"ALREADY_SENT"}):(C.proxy.friends_pending[n.curvePublic]={time:+new Date,channel:n.notifications,curvePublic:n.curvePublic},S([],"UPDATE_METADATA"),C.mailbox.sendTo("FRIEND_REQUEST",{user:u.createData(C.proxy)},{channel:n.notifications,curvePublic:n.curvePublic},function(e){t(e)}))):t({error:"INVALID_USER"})},v.cancelFriendRequest=function(e,n){if(e.curvePublic&&e.notifications){var t=C.proxy;if(u.getFriend(t,e.curvePublic))return console.error("You can't cancel an accepted friend request"),void n({error:"ALREADY_FRIEND"});a.find(C,["proxy","friends_pending"])||{}?C.mailbox.sendTo("CANCEL_FRIEND_REQUEST",{user:u.createData(C.proxy)},{channel:e.notifications,curvePublic:e.curvePublic},function(t){t&&t.error?n(t):(delete C.proxy.friends_pending[e.curvePublic],S([],"UPDATE_METADATA"),z(null,function(){n(t)}))}):n()}else n({error:"EINVAL"})},v.anonGetPreviewContent=function(e,n,t){w.anonGetPreviewContent({store:C},n,t)},v.getStrongerHash=function(e,n,t){var r=a.once(t);$().some(function(e){var t=e.manager.getEditHash(n.channel);if(t)return r(t),!0})||r()},v.universal={execCommand:function(e,n,t){var r=function(){var r=n.type,o=n.data;C.modules[r]?C.modules[r].execCommand(e,o,t):t({error:r+" is disabled"})};-1===["team","calendar"].indexOf(n.type)&&C.proxy?Y.reg(r):r()}};var te=function(e,n,t,r){C.modules[n]||(C.modules[n]=e.init({Store:v,store:C,updateLoadingProgress:function(e){e.type="team",y(r,"LOADING_DRIVE",e)},updateMetadata:function(){S([],"UPDATE_METADATA")},pinPads:function(e,n){v.pinPads(null,e,n)},unpinPads:function(e,n){v.unpinPads(null,e,n)}},t,function(e,t,r){r.forEach(function(r){y(r,"UNIVERSAL_EVENT",{type:n,data:{ev:e,data:t}})})}))};v.onlyoffice={execCommand:function(e,n,t){C.onlyoffice?C.onlyoffice.execCommand(e,n,t):t({error:"OnlyOffice is disabled"})}},v.mailbox={execCommand:function(e,n,t){Y.reg(function(){C.mailbox?C.mailbox.execCommand(e,n,t):t({error:"Mailbox is disabled"})})}},v.adminRpc=function(e,n,t){C.rpc.adminRpc(n,function(e,n){t(e?{error:e}:n)})},v.addAdminMailbox=function(e,n,t){var r=n&&n.priv,a=o.getBoxPublicFromSecret(r),i=n&&2===n.version;if(r&&a){var s=o.getChannelIdFromKey(a),c=i?"supportteam":"supportadmin",u=(C.proxy.mailboxes=C.proxy.mailboxes||{})[c]={channel:s,viewed:[],lastKnownHash:n.lastKnownHash||"",keys:{curvePublic:a,curvePrivate:r}};v.pinPads(null,[s],function(){}),C.mailbox.open(c,u,function(){console.log("ready")}),z(null,t)}else t({error:"EINVAL"})},v.getSnapshot=function(e,n,t){v.getHistoryRange(e,{cpCount:1,channel:n.channel,lastKnownHash:n.hash},t)},v.onRejected=function(e,n){var t=a.once(a.mkAsync(n));Array.isArray(e)?(J.fire(),Y.reg(()=>{if(C.loggedIn&&C.proxy.edPublic){var n,r=C.modules.team,o=r&&r.getTeams()||[];-1!==e.indexOf(C.proxy.edPublic)?n=C:o.some(function(t){var o=a.find(C,["proxy","teams",t,"keys","drive","edPublic"]),i=a.find(C,["proxy","teams",t,"keys","drive","edPrivate"]);if(-1===e.indexOf(o))return!1;if(!i)return!1;var s=r.getTeam(t);return n=s,!0});var i=function(){if(n){var e=n.rpc;e?e.send("COOKIE","",function(e){t(e)}):t("ERESTRICTED")}else t("ERESTRICTED")};n&&n.onRpcReadyEvt?n.onRpcReadyEvt.reg(function(){i()}):i()}else t("ERESTRICTED")})):t("ERESTRICTED")},v.changePadPasswordPin=function(e,n,t){var r=n.oldChannel,o=n.channel;M(function(e){$().forEach(function(n){n.manager.findChannel(o).length&&(n.rpc.unpin([r],e()),n.rpc.pin([o],e()))})}).nThen(t)},v.contactPadOwner=function(e,n,t){var r=n.owners;if(!Array.isArray(r)||!r.length)return t({state:!1});n.send?M(function(e){r.forEach(function(t){!function(e,t,r,o){if(C.mailbox&&!n.anon)return C.mailbox.sendTo(e,t,r,o);O.sendToAnon(C.anon_rpc,e,t,r,o)}(n.query,{channel:n.channel,data:n.msgData},{channel:t.notifications,curvePublic:t.curvePublic},e())})}).nThen(function(){t({state:!0})}):t({state:!0})},v.givePadAccess=function(e,n,t){var r,o,a=C.proxy.edPublic,i=n.channel,s=C.manager.findChannel(i);n.user&&n.user.notifications&&n.user.curvePublic?s.some(function(e){if(e.data&&Array.isArray(e.data.owners)&&-1!==e.data.owners.indexOf(a)&&e.data.href)return r=e.data.href,o=e.data.title,!0})?(C.mailbox.sendTo("GIVE_PAD_ACCESS",{channel:i,href:r,title:o},{channel:n.user.notifications,curvePublic:n.user.curvePublic}),t()):t({error:"ENOTFOUND"}):t({error:"EINVAL"})};v.burnPad=function(e,n){var t=n.channel,r=x.b64AddSlashes(n.ownerKey||"");if(t&&r)try{var a=o.decodeBase64(r),i=x.Nacl.sign.keyPair.fromSecretKey(a);f.create(C.network,{edPublic:o.encodeBase64(i.publicKey),edPrivate:o.encodeBase64(i.secretKey)},function(e,r){e?console.error(e):v.pad.getMetadata(null,{channel:t},function(e){r.removeOwnedChannel(t,function(t){t?console.error(t):function(e,n){var t=e.channel,r=e.href,a=o.parsePadUrl(r),i=o.getSecrets(a.type,a.hash,e.password);if((!n||!n.error)&&n.mailbox){var s,c=x.createEncryptor(i.keys),u=[];try{"string"==typeof n.mailbox?u.push(c.decrypt(n.mailbox,!0,!0)):Object.keys(n.mailbox).forEach(function(e){u.push(c.decrypt(n.mailbox[e],!0,!0))})}catch(e){console.error(e)}try{s=C.proxy.curvePublic}catch(e){return void console.error(e)}u.forEach(function(e){var n=JSON.parse(e);n.curvePublic!==s&&C.mailbox.sendTo("OWNED_PAD_REMOVED",{channel:t},{channel:n.notifications,curvePublic:n.curvePublic},function(){})})}}(n,e)})})})}catch(e){console.error(e)}else console.error("Can't delete BAR pad")},v.deleteMailboxMessage=function(e,n,t){C.anon_rpc?C.anon_rpc.send("DELETE_MAILBOX_MESSAGE",n,function(e){t({error:e})}):t({error:"RPC_NOT_READY"})},v.getFullHistory=function(e,n,t){var r=C.network,o=r.historyKeeper,a=[],i=!1,s=function(e){if(!i){var o=function(e){try{return JSON.parse(e)}catch(e){return null}}(e);if(o)return"FULL_HISTORY_END"===o[0]?(t(a),r.off("message",s),void(i=!0)):void("FULL_HISTORY"===o[0]&&(o[1]&&o[1].validateKey||o[1][3]===n.channel&&(e=o[1][4])&&(e=e.replace(/cp\|(([A-Za-z0-9+\/=]+)\|)?/,""),n.debug?a.push({serverHash:e.slice(0,64),msg:e,author:o[1][1],time:o[1][5]}):a.push(e))))}};r.on("message",s),r.sendto(o,JSON.stringify(["GET_FULL_HISTORY",n.channel,n.validateKey]))},v.getHistory=function(e,n,t,r){var o=a.once(a.mkAsync(t)),i=C.network,s=i.historyKeeper,c=Math.floor(1e6*Math.random()),u=[],f=!1,l=function(e,t){if(!f&&t===s){var a=function(e){try{return JSON.parse(e)}catch(e){return null}}(e);if(a&&!(a.txid&&a.txid!==c||a.validateKey&&a.channel))if(a.error&&a.channel)a.channel===n.channel&&(i.off("message",l),f=!0,o({error:a.error}));else{if(1===a.state&&a.channel){if(a.channel!==n.channel)return;return o(u),i.off("message",l),void(f=!0)}Array.isArray(a)&&a[0]&&a[0]!==c||a[3]===n.channel&&(a[4]&&r?u.push({msg:e,hash:a[4].slice(0,64)}):(e=a[4])&&(e=e.replace(/cp\|(([A-Za-z0-9+\/=]+)\|)?/,""),u.push(e)))}}};i.on("message",l);var d={txid:c,lastKnownHash:n.lastKnownHash},h=["GET_HISTORY",n.channel,d];i.sendto(s,JSON.stringify(h))},v.getHistoryRange=function(e,n,t){var r,o=C.network,i=o.historyKeeper,s=[],c=!0,u=!1,f=!1,l=a.uid();o.on("message",function(e){if(!f){var o=function(e){try{return JSON.parse(e)}catch(e){return null}}(e);if(o[1]===l){if("HISTORY_RANGE_ERROR"===o[0]){let e=o[2];return"ENOENT"===e?.code?(f=!0,void t({messages:s,isFull:!0})):void t({error:o[2]})}if("HISTORY_RANGE_END"===o[0])return t({messages:s,isFull:u,lastKnownHash:r}),void(f=!0);"HISTORY_RANGE"===o[0]&&(o[2]&&o[1].validateKey||o[2][3]===n.channel&&(e=o[2][4])&&(c&&(/^cp\|/.test(e)||n.toHash||(u=!0),r=e.slice(0,64),c=!1),e=e.replace(/cp\|(([A-Za-z0-9+\/=]+)\|)?/,""),s.push({serverHash:e.slice(0,64),msg:e,author:o[2][1],time:o[2][5]})))}else console.log("bad txid")}}),o.sendto(i,JSON.stringify(["GET_HISTORY_RANGE",n.channel,{from:n.lastKnownHash,to:n.toHash,cpCount:n.cpCount||2,txid:l}]))};var re=function(e,t){e&&(e.deprecated||e.restricted||(t||e.on("change",["drive",n.SHARED_FOLDERS],function(t,r,a){if(a.length>3&&"password"===a[3]){var i=a[2],s=e.drive[n.SHARED_FOLDERS][i],c=C.manager.user.userObject.getHref?C.manager.user.userObject.getHref(s):s.href,u=o.parsePadUrl(c),f=o.getSecrets(u.type,u.hash,t);return h.updatePassword(v,{oldChannel:f.channel,password:r,href:c},C.network,function(){console.log("Shared folder password changed")}),!1}}),e.on("change",[],function(e,r,o){if(t){if(o[0]===n.FILES_DATA&&"object"==typeof r&&r.channel&&!r.owners){var a=[r.channel];r.rtChannel&&a.push(r.rtChannel),r.lastVersion&&a.push(r.lastVersion),v.pinPads(null,a,function(e){console.error(e)})}if(o[0]===n.FILES_DATA&&"object"==typeof e&&e.channel&&!r){var i=[e.channel];C.manager.findChannel(e.channel).some(function(e){return e.fId!==t})||(e.rtChannel&&i.push(e.rtChannel),e.lastVersion&&i.push(e.lastVersion),v.unpinPads(null,i,function(e){console.error(e)}))}}e&&!r&&Array.isArray(o)&&(o[0]===n.FILES_DATA||"drive"===o[0]&&o[1]===n.FILES_DATA)&&setTimeout(function(){v.checkDeletedPad(e&&e.channel)}),P("DRIVE_CHANGE",{id:t,old:e,new:r,path:o})}),e.on("remove",[],function(e,n){P("DRIVE_REMOVE",{id:t,old:e,path:n})})))};v.loadSharedFolder=function(e,n,t,r,a){var i=W(e);if(i){var s=o.parsePadUrl(t.href||t.roHref);s||s.hashData?h.load({isNew:a,network:C.network||C.networkPromise,store:i,Store:v,isNewChannel:v.isNewChannel},n,t,r):r({error:"EINVAL"})}else r({error:"ENOTFOUND"})};var oe=function(e,n,t,r){v.loadSharedFolder(null,e,n,t,r)};v.loadSharedFolderAnon=function(e,n,t){v.loadSharedFolder(null,n.id,n.data,function(e){t({error:e?void 0:"EDELETED"})})},v.addSharedFolder=function(e,t,r){Y.reg(function(){var o=W(t.teamId);o.manager.addSharedFolder(t,function(a){a&&"object"==typeof a&&a.error?r(a):((t.teamId?o.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e),r(a))})})},v.updateSharedFolderPassword=function(e,n,t){h.updatePassword(v,n,C.network,t)},v.userObjectCommand=function(e,t,r){if(t&&t.cmd){var o=W(t.teamId);if(o.offline)return(o.id?o.sendEvent:P)("NETWORK_DISCONNECT"),void r({error:"OFFLINE"});o.manager.command(t,function(o){$().forEach(function(t){(t.id?t.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]},e)}),z(t.teamId,function(){r(o)})})}},v._removeClient=function(e){var n=R.indexOf(e);-1!==n&&R.splice(n,1),C.onlyoffice?.removeClient?.(e),C.mailbox?.removeClient?.(e),Object.keys(C.modules).forEach(function(n){C.modules[n]?.removeClient?.(e)}),v.pad?.removeClient?.(e)};v.refreshDriveUI=function(){$().forEach(function(e){(e.id?e.sendEvent:P)("DRIVE_CHANGE",{path:["drive",n.FILES_DATA]})})};var ae=function(e,n){const r=a.mkAsync(n);var o=C.proxy,i=C.drive;if(C.manager)r();else{var s=C.manager=t.create(i.proxy,{onSync:function(e){z(null,e)},edPublic:o.edPublic,pin:function(e,n){C.loggedIn?v.pinPads(null,e,n):n()},unpin:function(e,n){C.loggedIn?v.unpinPads(null,e,n):n()},loadSharedFolder:oe,settings:o.settings,removeOwnedChannel:function(e,n){v.pad.destroy("",e,n)},store:C,Store:v},{outer:!0,edPublic:C.proxy.edPublic,loggedIn:C.loggedIn,log:function(e){P("DRIVE_LOG",e)},rt:i.realtime}),c=C.userObject=s.user.userObject;M(function(e){C.sharedFolders={},C.handleSharedFolder=function(e,n){n?(C.sharedFolders[e]=n,C.driveEvents&&re(n.proxy,e)):delete C.sharedFolders[e]},c.migrate(e())}).nThen(function(n){var t=C.network||C.networkPromise;h.loadSharedFolders(v,t,C,i.proxy,c,n,n=>{var t={type:"sf",progress:100*n.progress/n.max};y(e,"LOADING_DRIVE",t)},!0)}).nThen(function(n){te(w,"team",n,e)}).nThen(function(e){te(T,"calendar",e)}).nThen(function(){r()})}};const ie=(e=function(){})=>{te(m,"cursor",e),te(E,"integration",e),te(D,"messenger",e),te(_,"history",e),te(j,"badge",e),C.onlyoffice||(C.onlyoffice=b.init(C,function(e,n,t){t.forEach(function(t){y(t,"OO_EVENT",{ev:e,data:n})})})),C&&(C.messenger=C.modules.messenger)},se=(e,n,t)=>{const r=a.mkAsync(t);ae(e,function(){G.fire(),r(n)})};var ce=function(e,n,t){C.ready=!0;var c=C.proxy,u=C.manager,l=C.userObject;M(function(t){c.settings||(c.settings=q),c.forms||(c.forms={}),c.friends_pending||(c.friends_pending={}),c.form_seed||(c.form_seed=o.createChannelId()),u||(se(e,n,t()),u=C.manager,l=C.userObject),X(0,0,t()),function(e,n,t){if(!C.loggedIn)return t();C.rpc?t(Z):f.create(C.network,C.proxy,function(e,n){e?t({error:e}):(C.rpc=n,C.onRpcReadyEvt.fire(),v.getPinLimit(null,null,function(e){e.error&&console.error(e.error),Z.limit=e.limit,Z.plan=e.plan,Z.note=e.note,t(e)}))},d)}(0,0,t()),y(e,"LOADING_DRIVE",{type:"migrate",progress:0})}).nThen(function(n){void 0===c.version&&(c.version=11),r(c,n(),function(n,t){y(e,"LOADING_DRIVE",{type:"migrate",progress:t})},C)}).nThen(function(n){y(e,"LOADING_DRIVE",{type:"sf",progress:0}),l.fixFiles(),h.loadSharedFolders(v,C.network,C,C.drive.proxy,l,n,n=>{var t={type:"sf",progress:100*n.progress/n.max};y(e,"LOADING_DRIVE",t)}),ie(n),te(A,"profile",n),te(T,"calendar",n),te(g,"support",n),M(e=>{C.modules.team&&C.modules.team.onReady(e)})}).nThen(function(){var e,r=function(){S([],"REQUEST_LOGIN")};C.loggedIn&&(function(e){if(C.rpc){var n=Q(!1),t=o.hashChannelList(n);C.rpc.getServerHash(function(n,r){n?e(n):e(null,r===t)})}else e({error:"RPC_NOT_READY"})}(function(e,n){n||function(e){if(C.rpc){var n=Q(!1);C.rpc.reset(n,function(n){e(n||null)})}else e({error:"RPC_NOT_READY"})}(function(e){if(e)return console.error(e);console.log("RESET DONE")})}),"number"!=typeof c.loginToken&&(c[i.tokenKey]=C.data.localToken||Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)),n[i.tokenKey]=c[i.tokenKey],C.data.localToken&&C.data.localToken!==c[i.tokenKey])?r():(n.feedback=a.find(c,["settings","general","allowUserFeedback"]),s.init(n.feedback),C.returned=n,"function"==typeof t&&t(n),C.offline=!1,P("NETWORK_RECONNECT"),S([],"UPDATE_METADATA"),S([],"STORE_READY",n),"string"==typeof c.uid&&32===c.uid.length||(console.log("generating a persistent identifier"),c.uid=o.createChannelId()),!C.loggedIn||v.hasSigningKeys()&&v.hasCurveKeys()?(c.on("change",[i.displayNameKey],function(e,n){"string"==typeof n&&S([],"UPDATE_METADATA")}),c.on("change",["profile"],function(){S([],"UPDATE_METADATA")}),c.on("change",["friends"],function(e,n,t){if(S([],"UPDATE_METADATA"),C.messenger&&void 0===e){var r=t.slice(-1)[0],o=c.friends&&c.friends[r];C.messenger.onFriendAdded(o)}}),c.on("remove",["friends"],function(e,n){if(S([],"UPDATE_METADATA"),C.messenger){var t=n[1];t&&"channel"===n[2]&&C.messenger.onFriendRemoved(t,e)}}),c.on("change",["friends_pending"],function(){S([],"UPDATE_METADATA")}),c.on("remove",["friends_pending"],function(){S([],"UPDATE_METADATA")}),c.on("change",["settings"],function(){S([],"UPDATE_METADATA")}),c.on("change",[i.tokenKey],function(){C.isDeleted||"DELETED"===c[i.tokenKey]||S([],"UPDATE_TOKEN",{token:c[i.tokenKey]})}),C.mailbox=O.init({Store:v,store:C,updateMetadata:function(){S([],"UPDATE_METADATA")},updateDrive:function(){P("DRIVE_CHANGE",{path:["drive","filesData"]})},pinPads:function(e,n){v.pinPads(null,e,n)}},e,function(e,n,t,r){var o=a.once(r||function(){});t.forEach(function(t){y(t,"MAILBOX_EVENT",{ev:e,data:n},o)})}),Y.fire()):r())})};const ue=(e,n,t,r)=>{if(C.accountModule)return C.accountModule;const o=F.init({userHash:n.userHash,anonHash:n.anonHash,cache:n.cache,form_seed:n.form_seed,store:C,broadcast:S,postMessage:y});C.accountModule=o;const{channel:i,onAccountReady:s,onAccountCacheReady:c,onDisconnect:u,onReconnect:f}=o;C.driveChannel=i,c(e=>{C.cacheReturned||=e,t(e)}),s(e=>{C.returned||=e,r(e)}),u(()=>{P("NETWORK_DISCONNECT")}),f(()=>{P("NETWORK_RECONNECT")});return setInterval(function(){var e=[];const n=v.pad.getChannels();Object.keys(n).forEach(function(t){var r=n[t].clients;Array.prototype.push.apply(e,r)}),(e=a.deduplicateString(e)).forEach(function(e){var n=0,t=function(){if(n>=2)return v._removeClient(e),y(e,"TIMEOUT"),void console.error("TIMEOUT",e);n++;var r=setTimeout(t,3e4);y(e,"PING",null,function(e){e&&console.error(e),clearTimeout(r)})};t()})},12e4),o},fe=(e,n,t,r)=>{const o=a.once(e=>{const n=L.init({account:e,store:C,broadcast:S,postMessage:y}),{onDriveReady:o,onDriveCacheReady:a,onDisconnect:i,onReconnect:s}=n;a(()=>{t(C.cacheReturned||C.returned)}),o(()=>{r(C.returned)}),i(()=>{}),s(()=>{})}),i=()=>{},s=ue(0,n,i,i);s.onAccountCacheReady(()=>{o(s)}),s.onAccountReady(()=>{o(s)})};v.disableCache=function(e,n,t){n?d.disable():d.enable(),t()};var le=!1;const de=e=>{if(C?.network?.historyKeeper)return setTimeout(e);const n=n=>{C.network||=n;n.join("0000000000000000000000000000000000").then(function(t){let r;t.members.forEach(e=>{16===e.length&&(r=e)}),n.historyKeeper=r,t.leave(),e()},function(n){console.error(n),e({error:"GET_HK"})})};if(C.network)return n(C.network);C.networkPromise?.then(n)};var he=function(e,n,t){const r=a.once(n);var o=function(){ie();let e=()=>{X(0,0,function(){s.send("NO_DRIVE",!0),r({})})};de(n=>{if(!n)return t?((e,n)=>{if(C.rpc)n(C.rpc);else{var t=x.Nacl.sign.keyPair(),r=C.tempKeys={edPublic:a.encodeBase64(t.publicKey),edPrivate:a.encodeBase64(t.secretKey)};f.create(C.network,r,function(e,t){e?n({error:e}):(C.rpc=t,n(t))})}})(0,e):void e()}),C.network||t||r({})};if(!C.network){var i=I.getWebsocketURL();return C.networkPromise=k.connect(i),o(),C.networkPromise.then(e=>{C.network!==e&&(C.network?(e.disconnect(),e=C.network):C.network=e)},function(e){console.error(e),r({error:"OFFLINE"})})}o()};const pe=(e,n,t)=>{C.manager?G.reg(function(){de(r=>{C.network||=r,ce(e,n,()=>{t(n)})})}):ce(e,n,()=>{t(n)})};return v.init=function(e,n,t){var r=a.once(function(r){n.driveEvents&&function(e){G.reg(()=>{-1===R.indexOf(e)&&R.push(e),C.driveEvents||(C.driveEvents=!0,re(C.proxy),Object.keys(C.manager.folders).forEach(function(e){var n=C.manager.folders[e].proxy;re(n,e)}))})}(e),t(r)});if(le&&!C.returned&&n.cache)G.reg(function(){r({state:"ALREADY_INIT",returned:C.cacheReturned})});else{if(le)return C.networkTimeout&&y(e,"LOADING_DRIVE",{type:"offline"}),void Y.reg(function(){r({state:"ALREADY_INIT",returned:C.returned})});n.disableCache&&d.disable(),n.noDrive&&!n.requires&&(n.requires="pad"),((e,n,t)=>{if(n.neverDrive||n.noDrive&&!n.userHash&&!n.anonHash)return n.neverDrive&&(C.neverCache=!0),void he(0,e=>{e?.error&&s.send("NO_DRIVE_ERROR",!0),n.neverDrive&&(e.tempKeys=C?.tempKeys),t(e)},!!n.neverDrive);const r=n.requires,o=!n.noDrive;le=!0,C.data=n;let c=e=>{1===Object.keys(C.proxy).length&&s.send("FIRST_APP_USE",!0),e&&e.error&&(le=!1)};if("pad"===r&&!o)return void he(0,function(r){if(r&&r.error)return;t(r);let o=a.once(()=>{fe(0,n,n=>{se(e,n,c)},n=>{pe(e,n,c)})});v.pad.onCacheReady(()=>{C.network||o()}),v.pad.onJoined(o),J.reg(o)});if("file"===r&&!o)return void he(0,function(r){r&&r.error||(t(r),fe(0,n,n=>{se(e,n,c)},n=>{pe(e,n,c)}))});if("team"===r){let r=!1;const o=o=>a=>{r||(r=!0,M(e=>{o||X(0,0,e())}).nThen(n=>{te(w,"team",n,e)}).nThen(e=>{!o&&C.modules.team&&C.modules.team.onReady(e)}).nThen(()=>{t(a),fe(0,n,n=>{se(e,n,c)},n=>{pe(e,n,c)})}))};return void ue(0,n,o(!0),o(!1))}if("drive"===r)return void fe(0,n,n=>{t(n),se(e,n,c)},n=>{t(n),pe(e,n,c)});let u=e=>{c(e);const n=i.prefersDriveRedirectKey,r=a.find(C,["proxy","settings","general",n]);e[n]=r,t(e)};fe(0,n,n=>{se(e,n,u)},n=>{pe(e,n,u)})})(e,n,a.once(e=>{"GET_HK"!==e.error?r(e):r({error:"ERROR"})}))}},Y.reg(function(){var e=+new Date-7776e6;d.getKeys(function(n,t){if(n)console.error(n);else{var r=function(){if(t.length){var n=t.pop();d.getTime(n,function(t,o){t?r():!o||o<e?d.clearChannel(n,r()):r()})}};r()}})}),v.disconnect=function(){globalThis.accountDeletion||C.network&&C.network.disconnect()},v}}})(bn(),Ue(),ze(),Kn(),te(),Z(),Y(),Ae(),je(),On(),In(),Nn(),fe(),We(),Vn,nt,Rt,Pt(),kt(),Mt(),Ft(),jn(),Lt(),jt(),Kt(),Ut(),Qt(),ir,hn(),j(),M(),x(),D(),T(),u(),qe()),or}var cr,ur,fr=sr(),lr=n({__proto__:null,default:r(fr)},[fr]);var dr,hr,pr,vr,yr,mr={exports:{}};function gr(){return dr||(dr=1,function(e){(()=>{const n=(e,n={})=>({create:function(t,r,o){var a,i=[],s=e.mkEvent(!0);t.reg(function(e){if(!a){var n=e.data;if("_READY"===n)return r("_READY"),a=!0,s.fire(),void i.forEach(function(e){t.fire(e)});i.push(n)}});var c={},u={},f={},l=[],d={},h={};h.query=function(e,n,t,o){var a,i=Math.random().toString(16).replace("0.","")+Math.random().toString(16).replace("0.",""),c=(o=o||{}).timeout||3e4;c>0&&(a=setTimeout(function(){delete u[i],t("TIMEOUT")},c)),f[i]=function(e){clearTimeout(a),delete f[i],e&&(delete u[i],t("UNHANDLED"))},u[i]=function(e,n){delete u[i],t(void 0,e.content,n)},s.reg(function(){var t={txid:i,content:n,q:e,raw:o.raw};r(o.raw?t:JSON.stringify(t))})};var p=h.event=function(e,n,t){t=t||{},s.reg(function(){var o={content:n,q:e,raw:t.raw};r(t.raw?o:JSON.stringify(o))})};h.on=function(e,n,t){var o=function(e,t,o){n(e.content,function(n){var t={txid:e.txid,content:n};r(o?t:JSON.stringify(t))},t)};return(c[e]=c[e]||[]).push(o),t||p("EV_REGISTER_HANDLER",e),{stop:function(){var n=c[e].indexOf(o);-1!==n&&c[e].splice(n,1)}}},h.whenReg=function(e,n,t){var r=t;l.indexOf(e)>-1?n():r=!0,r&&(d[e]=d[e]||[]).push(n)},h.onReg=function(e,n){h.whenReg(e,n,!0)},h.on("EV_REGISTER_HANDLER",function(e){d[e]&&(d[e].forEach(function(e){e()}),delete d[e]),l.push(e)});var v=!1;h.onReady=function(e){v?e():"function"==typeof e&&h.on("EV_RPC_READY",function(){v=!0,e()})},h.ready=function(){h.whenReg("EV_RPC_READY",function(){h.event("EV_RPC_READY")})};var y=[""];n.httpUnsafeOrigin?(y.push(n.httpUnsafeOrigin),y.push(n.httpSafeOrigin)):globalThis.location&&y.push(globalThis.location.origin),t.reg(function(e){if(a&&e.data&&"_READY"!==e.data&&y.includes(e.origin)){var n;try{n="object"==typeof e.data?e.data:JSON.parse(e.data)}catch(e){return void console.warn(e)}void 0!==n.ack?f[n.txid]&&f[n.txid](!n.ack):"string"==typeof n.q?c[n.q]?(n.txid&&r(JSON.stringify({txid:n.txid,ack:!0})),c[n.q].forEach(function(t){t(n||JSON.parse(e.data),e,n&&n.raw),n=void 0})):n.txid&&r(JSON.stringify({txid:n.txid,ack:!1})):void 0===n.q&&u[n.txid]&&u[n.txid](n,e)}}),r("_READY"),o(h)}});e.exports&&(e.exports=n(Z()))})()}(mr)),mr.exports}function Er(){if(pr)return hr;pr=1;var e;return hr=((e,n,t)=>{const r={};let o,a,i={},s=()=>{};return r.init=n=>{if(a)return;a=e.create({query:(e,n,t,r)=>{r=r||function(){},i[e].chan.query(n,t,function(e,n){r(e?{error:e}:n)})},broadcast:(e,n,t,r)=>{r=r||function(){},Object.keys(i).forEach(o=>{-1===e.indexOf(+o)&&i[o].chan.query(n,t,(e,n)=>{r(e?{error:e}:n)})})}}),s=n},r.initClient=(e,r)=>{if(!a)return console.error("Not initialized"),void r("NOT_INIT");const{postMsg:c}=e,u=t.mkEvent(),f=Number(Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)),l=()=>{a._removeClient(f)};n.create(u,c,function(e){let n=i[f]={chan:e};console.debug("SharedW Channel created"),Object.keys(a.queries).forEach(function(t){"CONNECT"!==t&&"JOIN_PAD"!==t&&"SEND_PAD_MSG"!==t&&"STOPWORKER"!==t&&e.on(t,function(e,r){try{a.queries[t](f,e,r)}catch(n){console.error("Error in webworker when executing query "+t),console.error(n),console.log(e)}"DISCONNECT"===t&&(l(),globalThis.accountDeletion&&globalThis.accountDeletion===n.id&&(a=void 0,o=void 0))})}),e.on("STOPWORKER",function(e,n){s(),a.queries.DISCONNECT(f,e,n)}),e.on("CONNECT",function(e,n){console.debug("Connecting to store..."),a.queries.CONNECT(f,e,function(e){if(e&&"ALREADY_INIT"===e.state)return console.debug("Store already exists!"),o=o||e.returned,void n(e);o=e,n(e)})}),e.on("JOIN_PAD",function(e,t){n.channelId=e.channel;try{a.queries.JOIN_PAD(f,e,t)}catch(n){console.error("Error in webworker when executing query JOIN_PAD"),console.error(n),console.log(e)}}),e.on("SEND_PAD_MSG",function(e,t){var r={msg:e,channel:n.channelId};try{a.queries.SEND_PAD_MSG(f,r,t)}catch(e){console.error("Error in webworker when executing query SEND_PAD_MSG"),console.error(e),console.log(r)}}),r(u,l)},!0)},r})((ur||(ur=1,e=sr(),cr={create:function(n){var t=e.create(n),r={},o=r.queries={CONNECT:t.init,DISCONNECT:t.disconnect,PING:function(e,n,t){t()},CACHE_DISABLE:t.disableCache,GET_PIN_LIMIT:t.getPinLimit,PIN_PADS:t.pinPads,UNPIN_PADS:t.unpinPads,GET_PINNED_USAGE:t.getPinnedUsage,GET_DELETED_PADS:t.getDeletedPads,UPLOAD_CHUNK:t.uploadChunk,UPLOAD_COMPLETE:t.uploadComplete,UPLOAD_STATUS:t.uploadStatus,UPLOAD_CANCEL:t.uploadCancel,ANON_RPC_MESSAGE:t.anonRpcMsg,GET_FILE_SIZE:t.getFileSize,GET_MULTIPLE_FILE_SIZE:t.getMultipleFileSize,GET:t.get,SET:t.set,ADD_PAD:t.addPad,SET_PAD_TITLE:t.setPadTitle,MOVE_TO_TRASH:t.moveToTrash,RESET_DRIVE:t.resetDrive,GET_METADATA:t.getMetadata,IS_ONLY_IN_SHARED_FOLDER:t.isOnlyInSharedFolder,SET_DISPLAY_NAME:t.setDisplayName,SET_PAD_ATTRIBUTE:t.setPadAttribute,GET_PAD_ATTRIBUTE:t.getPadAttribute,SET_ATTRIBUTE:t.setAttribute,GET_ATTRIBUTE:t.getAttribute,LIST_ALL_TAGS:t.listAllTags,GET_TEMPLATES:t.getTemplates,GET_SECURE_FILES_LIST:t.getSecureFilesList,GET_PAD_DATA:t.getPadData,GET_PAD_DATA_FROM_CHANNEL:t.getPadDataFromChannel,GET_STRONGER_HASH:t.getStrongerHash,INCREMENT_TEMPLATE_USE:t.incrementTemplateUse,GET_SHARED_FOLDER:t.getSharedFolder,ADD_SHARED_FOLDER:t.addSharedFolder,LOAD_SHARED_FOLDER:t.loadSharedFolderAnon,RESTORE_SHARED_FOLDER:t.restoreSharedFolder,UPDATE_SHARED_FOLDER_PASSWORD:t.updateSharedFolderPassword,ANSWER_FRIEND_REQUEST:t.answerFriendRequest,SEND_FRIEND_REQUEST:t.sendFriendRequest,ANON_GET_PREVIEW_CONTENT:t.anonGetPreviewContent,OO_COMMAND:t.onlyoffice.execCommand,MAILBOX_COMMAND:t.mailbox.execCommand,UNIVERSAL_COMMAND:t.universal.execCommand,SEND_PAD_MSG:t.pad.sendMessage,JOIN_PAD:t.pad.join,LEAVE_PAD:t.pad.leave,REMOVE_OWNED_CHANNEL:t.pad.destroy,CLEAR_OWNED_CHANNEL:t.pad.clear,CORRUPTED_CACHE:t.pad.onCorruptedCache,GET_LAST_HASH:t.pad.getLastHash,GET_FULL_HISTORY:t.getFullHistory,GET_HISTORY:t.getHistory,GET_HISTORY_RANGE:t.getHistoryRange,IS_NEW_CHANNEL:t.isNewChannel,CONTACT_PAD_OWNER:t.contactPadOwner,GIVE_PAD_ACCESS:t.givePadAccess,BURN_PAD:t.burnPad,GET_PAD_METADATA:t.pad?.getMetadata,SET_PAD_METADATA:t.pad?.setMetadata,CHANGE_PAD_PASSWORD_PIN:t.changePadPasswordPin,GET_SNAPSHOT:t.getSnapshot,DELETE_MAILBOX_MESSAGE:t.deleteMailboxMessage,DRIVE_USEROBJECT:t.userObjectCommand,GET_DRIVE:t.drive.get,SET_DRIVE:t.drive.set,MIGRATE_ANON_DRIVE:t.drive.migrateAnon,HAS_DRIVE:t.drive.exists,DELETE_ACCOUNT:t.deleteAccount,REMOVE_OWNED_PADS:t.removeOwnedPads,ADMIN_RPC:t.adminRpc,ADMIN_ADD_MAILBOX:t.addAdminMailbox};return r.query=function(e,n,t){o[e]?o[e]("0",n,t):console.error("UNHANDLED_STORE_RPC")},r._removeClient=t._removeClient,r}}),cr),gr(),Z()),hr}var br,Or,Ar=function(){if(yr)return vr;yr=1;const e=Er();return vr={start:n=>{let t=!1,r=()=>{globalThis.close()};globalThis.window=globalThis,addEventListener("connect",o=>{console.debug("New SharedWorker client");const a=o.ports[0],i=e=>{a.postMessage(e)};let s,c=!1,u=()=>{};a.onmessage=function(o){if("INIT"===o.data?.type){if((o=>{t||(n(o),e.init(r),t=!0)})(o.data.cfg),c)return;c=!0,e.initClient({postMsg:i},function(e,n){s=e,u=n,i("SW_READY")})}else"CLOSE"===o.data?(console.debug("leave"),u()):s&&s.fire(o)}})}}}();var wr,Dr,_r=function(){if(Or)return br;Or=1;const e=Er();return br={start:n=>{let t,r=!1;const o=()=>{globalThis.close()},a=e=>{postMessage(e)};globalThis.window=globalThis,onmessage=function(i){if("INIT"===i.data?.type){let s=i.data.cfg;if(r)return;return n(s),e.init(o),r=!0,void e.initClient({postMsg:a},function(e){t=e,a("WW_READY")})}t&&t.fire(i)}}}}();var Tr=function(){if(Dr)return wr;Dr=1;const e=Er(),n=Z();return wr={start:t=>{let r,o=!1,a=!1;const i=n.mkEvent(),s=()=>{a=!0},c=e=>{a||i.fire(e)};return{init:n=>{o||(t(n),e.init(s),o=!0,e.initClient({postMsg:c},function(e){r=e,c("STORE_READY")}))},onMessage:e=>{i.reg(n=>{setTimeout(()=>{e(n)})})},query:e=>{r&&!a&&r.fire({data:e,origin:""})}}}}}(),Sr=Kn(),Nr=n({__proto__:null,default:r(Sr)},[Sr]),Ir=jn(),xr=n({__proto__:null,default:r(Ir)},[Ir]),Cr=Pt(),Rr=n({__proto__:null,default:r(Cr)},[Cr]),Pr=kt(),kr=n({__proto__:null,default:r(Pr)},[Pr]),Mr=Kt(),Fr=n({__proto__:null,default:r(Mr)},[Mr]),Lr=Qt(),Hr=n({__proto__:null,default:r(Lr)},[Lr]);let jr=e=>{[Te,nn,q,$e,B,Nr,gn,un,ke,Rr,kr,Hr,lr,ge,xr,Fr,rr].forEach(n=>{"function"==typeof n.setCustomize&&n.setCustomize(e)})},Kr="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,Ur="undefined"!=typeof SharedWorkerGlobalScope&&self instanceof SharedWorkerGlobalScope;e.store={},Ur?Ar.start(jr):Kr?_r.start(jr):("undefined"!=typeof module&&module.exports,e.store=Tr.start(jr)),e.start=jr});
